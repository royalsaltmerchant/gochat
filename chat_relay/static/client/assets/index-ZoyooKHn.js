var ve=Object.defineProperty;var Ce=(n,e,t)=>e in n?ve(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var c=(n,e,t)=>Ce(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();const X="https://chat.parchchat.com",ke="wss://chat.parchchat.com/ws",z="5837a5c3-5268-45e1-9ea4-ee87d959d067",we="Parch Community";function a(n,e,t,s){if(typeof n>"u")return!1;var i=document.createElement(n);if(typeof e=="object")for(var o in e)i.setAttribute(o,e[o]);if(t)if(typeof t=="string"&&/<[^>]+>/.test(t))i.innerHTML=t;else{Array.isArray(t)||(t=[t]);for(var l=0;l<t.length;l++)t[l]instanceof Node?i.appendChild(t[l]):i.appendChild(document.createTextNode(t[l]))}if(s){Array.isArray(s)||(s=[s]);for(var r of s)i.addEventListener(r.type,r.event)}return i}const Q="parch.hosts";function B(){try{const n=localStorage.getItem(Q);if(!n)return[];const e=JSON.parse(n);return Array.isArray(e)?e:[]}catch{return[]}}function R(n){localStorage.setItem(Q,JSON.stringify(n))}const p={async greet(n){return`Hello ${n}, It's show time!`},async alert(n){window.alert(n)},async confirm(n){return window.confirm(n)},async openExternal(n){window.open(n,"_blank","noopener,noreferrer")},async getHosts(){const n=B();return n.some(e=>e.uuid===z)||(n.push({uuid:z,name:we}),R(n)),n},async verifyHostKey(n){const e=await fetch(`${X}/api/host/${n}`);if(!e.ok)throw new Error("host not found");const t=await e.json(),s=B();return s.some(i=>i.uuid===n)||(s.push({uuid:t.uuid,name:t.name}),R(s)),t},async removeHost(n){const e=B(),t=e.filter(s=>s.uuid!==n);if(t.length===e.length)throw new Error(`host with UUID ${n} not found`);R(t)}},_="parch.chat.identity",O="parch.chat.identity.sealed",G="parch.chat.device_id",Z="parch.chat.identity.last_exported_at",Se="parch.chat.identity.keys",_e=1,S="kv",F="device_wrap_key",ee=21e4;let v=null,U=null,A=null,M=null,L=null,D=null;function y(){const n=globalThis==null?void 0:globalThis.crypto;if(!(n!=null&&n.subtle))throw new Error("WebCrypto API is not available");return n}function C(n){let e="";const t=n instanceof Uint8Array?n:new Uint8Array(n);for(let s=0;s<t.length;s+=1)e+=String.fromCharCode(t[s]);return btoa(e).replace(/=+$/g,"")}function k(n){const e=(4-n.length%4)%4,t=n+"=".repeat(e),s=atob(t),i=new Uint8Array(s.length);for(let o=0;o<s.length;o+=1)i[o]=s.charCodeAt(o);return i}function te(){return typeof indexedDB<"u"}function ne(){return te()}function J(n){try{const e=localStorage.getItem(n);if(!e)return null;const t=JSON.parse(e);return!t||typeof t!="object"?null:t}catch{return null}}function P(n,e){localStorage.setItem(n,JSON.stringify(e))}function Ue(){v=null,U=null,A=null,M=null}function T(n){if(!n||typeof n!="object")throw new Error("Identity payload must be an object");const e=typeof n.publicKey=="string"?n.publicKey.trim():"",t=typeof n.privateKey=="string"?n.privateKey.trim():"",s=typeof n.encPublicKey=="string"?n.encPublicKey.trim():"",i=typeof n.encPrivateKey=="string"?n.encPrivateKey.trim():"",o=typeof n.username=="string"?n.username.trim():"";if(!e||!t||!s||!i)throw new Error("Identity must include auth and encryption keypairs");return{publicKey:e,privateKey:t,encPublicKey:s,encPrivateKey:i,username:o}}function se(n){if(!n||typeof n!="object")return null;const e=typeof n.publicKey=="string"?n.publicKey.trim():"",t=typeof n.encPublicKey=="string"?n.encPublicKey.trim():"",s=typeof n.username=="string"?n.username.trim():"";return!e||!t?null:{version:2,publicKey:e,encPublicKey:t,username:s}}function Ie(n){if(!n||typeof n!="object")throw new Error("Invalid private key bundle");const e=typeof n.privateKey=="string"?n.privateKey.trim():"",t=typeof n.encPrivateKey=="string"?n.encPrivateKey.trim():"";if(!e||!t)throw new Error("Private key bundle is incomplete");return{privateKey:e,encPrivateKey:t}}function Ke(){const n=localStorage.getItem(G);if(typeof n=="string"&&n.trim()!=="")return n.trim();const e=C(y().getRandomValues(new Uint8Array(16)));return localStorage.setItem(G,e),e}function xe(){var e;const n=(((e=globalThis==null?void 0:globalThis.navigator)==null?void 0:e.userAgent)||"").toLowerCase();return n.includes("edg/")?"Edge":n.includes("firefox/")?"Firefox":n.includes("safari/")&&!n.includes("chrome/")?"Safari":n.includes("chrome/")?"Chrome":"Browser"}function De(){var i;const n=Ke(),e=xe(),t=String(((i=globalThis==null?void 0:globalThis.navigator)==null?void 0:i.platform)||"Unknown"),s=`${e} on ${t}`.slice(0,80);return{deviceId:n,deviceName:s}}function Ee(){localStorage.setItem(Z,new Date().toISOString())}function Pe(){const n=localStorage.getItem(Z);return typeof n=="string"?n:""}function ae(n){const e=typeof n=="string"?n:"";if(e.length<8)throw new Error("Passphrase must be at least 8 characters");return e}async function j(n){return y().subtle.importKey("pkcs8",k(n),{name:"Ed25519"},!1,["sign"])}async function W(n){return y().subtle.importKey("pkcs8",k(n),{name:"ECDH",namedCurve:"P-256"},!1,["deriveBits"])}async function Ae(n){return y().subtle.importKey("raw",k(n),{name:"Ed25519"},!1,["verify"])}async function Me(n){return y().subtle.importKey("spki",k(n),{name:"ECDH",namedCurve:"P-256"},!1,[])}async function ie(n){const e=await j(n.privateKey),t=await Ae(n.publicKey),s=new TextEncoder().encode("parch-identity-check"),i=await y().subtle.sign({name:"Ed25519"},e,s);if(!await y().subtle.verify({name:"Ed25519"},t,i,s))throw new Error("Public/private key mismatch");await W(n.encPrivateKey),await Me(n.encPublicKey)}async function Te(){const n=y(),e=await n.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveBits"]),t=await n.subtle.exportKey("spki",e.publicKey),s=await n.subtle.exportKey("pkcs8",e.privateKey);return{encPublicKey:C(t),encPrivateKey:C(s)}}async function re(){return te()?L||(L=new Promise(n=>{try{const e=indexedDB.open(Se,_e);e.onerror=()=>n(null),e.onupgradeneeded=()=>{const t=e.result;t.objectStoreNames.contains(S)||t.createObjectStore(S)},e.onsuccess=()=>n(e.result)}catch{n(null)}}),L):null}async function Ne(n,e){return new Promise(t=>{try{const o=n.transaction(S,"readonly").objectStore(S).get(e);o.onsuccess=()=>t(o.result||null),o.onerror=()=>t(null)}catch{t(null)}})}async function Le(n,e,t){return new Promise(s=>{try{const i=n.transaction(S,"readwrite");i.oncomplete=()=>s(!0),i.onerror=()=>s(!1),i.objectStore(S).put(t,e)}catch{s(!1)}})}async function Oe(n,e){return new Promise(t=>{try{const s=n.transaction(S,"readwrite");s.oncomplete=()=>t(!0),s.onerror=()=>t(!1),s.objectStore(S).delete(e)}catch{t(!1)}})}async function oe(){return ne()?D||(D=(async()=>{const n=await re();if(!n)return null;const e=await Ne(n,F);if(e)return e;const t=await y().subtle.generateKey({name:"AES-GCM",length:256},!1,["encrypt","decrypt"]);return await Le(n,F,t)?t:null})().catch(()=>null),D):null}async function He(n,e,t){const s=new TextEncoder().encode(n),i=await y().subtle.importKey("raw",s,"PBKDF2",!1,["deriveKey"]);return y().subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",iterations:ee,salt:e},i,{name:"AES-GCM",length:256},!1,t)}async function Be(n,e){const t=y().getRandomValues(new Uint8Array(16)),s=y().getRandomValues(new Uint8Array(12)),i=await He(e,t,["encrypt"]),o=await y().subtle.encrypt({name:"AES-GCM",iv:s},i,n);return{type:"parch.encrypted_identity_backup.v1",kdf:{name:"PBKDF2",hash:"SHA-256",iterations:ee,salt:C(t)},cipher:{name:"AES-GCM",iv:C(s),ciphertext:C(o)}}}async function Re(n,e){var d,u,f,b;if(!n||n.type!=="parch.encrypted_identity_backup.v1")throw new Error("Unsupported backup format");const t=Number((d=n==null?void 0:n.kdf)==null?void 0:d.iterations);if(!Number.isInteger(t)||t<1e5)throw new Error("Invalid backup key derivation settings");const s=k(String(((u=n==null?void 0:n.kdf)==null?void 0:u.salt)||"")),i=k(String(((f=n==null?void 0:n.cipher)==null?void 0:f.iv)||"")),o=k(String(((b=n==null?void 0:n.cipher)==null?void 0:b.ciphertext)||"")),l=new TextEncoder().encode(e),r=await y().subtle.importKey("raw",l,"PBKDF2",!1,["deriveKey"]),h=await y().subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",iterations:t,salt:s},r,{name:"AES-GCM",length:256},!1,["decrypt"]);return y().subtle.decrypt({name:"AES-GCM",iv:i},h,o)}async function Fe(n){const e=await oe();if(!e)return null;const t=y().getRandomValues(new Uint8Array(12)),s=new TextEncoder().encode(JSON.stringify(n)),i=await y().subtle.encrypt({name:"AES-GCM",iv:t},e,s);return{type:"parch.identity.sealed.v1",iv:C(t),ciphertext:C(i)}}async function Je(n){if(!n||n.type!=="parch.identity.sealed.v1")throw new Error("Missing sealed private key material");const e=await oe();if(!e)throw new Error("Secure key vault unavailable");const t=k(String(n.iv||"")),s=k(String(n.ciphertext||"")),i=await y().subtle.decrypt({name:"AES-GCM",iv:t},e,s),o=JSON.parse(new TextDecoder().decode(i));return Ie(o)}function je(n){const e={publicKey:n.publicKey,encPublicKey:n.encPublicKey,username:n.username||""};return ne()||(e.privateKey=n.privateKey,e.encPrivateKey=n.encPrivateKey),e}async function ce(n){v=je(n),U={privateKey:n.privateKey,encPrivateKey:n.encPrivateKey},A=await j(n.privateKey),M=await W(n.encPrivateKey)}async function H(n){const e=T(n);await ie(e);const t={version:2,publicKey:e.publicKey,encPublicKey:e.encPublicKey,username:e.username||""},s=await Fe({privateKey:e.privateKey,encPrivateKey:e.encPrivateKey});return s?(P(_,t),P(O,s)):(P(_,e),localStorage.removeItem(O)),await ce(e),v}async function V(){const n=y(),e=await n.subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),t=await n.subtle.exportKey("raw",e.publicKey),s=await n.subtle.exportKey("pkcs8",e.privateKey),i=await Te();return H({publicKey:C(t),privateKey:C(s),encPublicKey:i.encPublicKey,encPrivateKey:i.encPrivateKey,username:""})}async function N(){if(v&&A&&M&&U)return v;const n=J(_);if(!n)return V();if(typeof n.privateKey=="string"&&typeof n.encPrivateKey=="string"){const o=T(n);return H(o)}const e=se(n);if(!e)return V();const t=J(O);if(!t)throw new Error("Identity private keys are unavailable on this device. Import an encrypted backup or reset identity.");const s=await Je(t),i=T({publicKey:e.publicKey,privateKey:s.privateKey,encPublicKey:e.encPublicKey,encPrivateKey:s.encPrivateKey,username:e.username||""});return await ie(i),await ce(i),v}async function le(n){if(n!=null&&n.privateKey)return j(n.privateKey);if(await N(),!A)throw new Error("Signing key unavailable");return A}async function We(n){if(n!=null&&n.encPrivateKey)return W(n.encPrivateKey);if(await N(),!M)throw new Error("Encryption key unavailable");return M}async function $e(){return N()}async function qe(n,e){if(!e||typeof e!="string")throw new Error("Missing auth message");const t=new TextEncoder().encode(e),s=await le(n),i=await y().subtle.sign({name:"Ed25519"},s,t);return C(i)}async function ze(n,e,t){const s=y(),i=k(n),o=k(t),l=await s.subtle.importKey("raw",i,{name:"Ed25519"},!1,["verify"]),r=new TextEncoder().encode(e);return s.subtle.verify({name:"Ed25519"},l,o,r)}async function Ge(){if(await N(),!v||!U)throw new Error("Identity not available");return JSON.stringify({...v,...U},null,2)}async function Ve(n){const e=ae(n);if(await N(),!v||!U)throw new Error("Identity not available");const t=new TextEncoder().encode(JSON.stringify({...v,...U})),s=await Be(t,e);return JSON.stringify(s,null,2)}async function Ye(n){let e=n;if(typeof n=="string")try{e=JSON.parse(n)}catch{throw new Error("Identity import text must be valid JSON")}if((e==null?void 0:e.type)==="parch.encrypted_identity_backup.v1")throw new Error("Encrypted backup detected. Use passphrase import.");const t=T(e);return H(t)}async function Xe(n,e){const t=ae(e);let s=n;if(typeof n=="string")try{s=JSON.parse(n)}catch{throw new Error("Backup import text must be valid JSON")}const i=await Re(s,t);let o;try{o=JSON.parse(new TextDecoder().decode(i))}catch{throw new Error("Invalid backup payload")}const l=T(o);return H(l)}function Qe(n){const e=(n||"").trim(),t=J(_);if(t&&typeof t.privateKey=="string"&&typeof t.encPrivateKey=="string")t.username=e,P(_,t);else if(t&&typeof t=="object"){const s=se(t);s&&(s.username=e,P(_,s))}v&&(v.username=e)}function Ze(){Ue(),localStorage.removeItem(_),localStorage.removeItem(O),re().then(n=>n?Oe(n,F):!1).catch(()=>!1),D=null}const m={getOrCreateIdentity:$e,getDeviceMetadata:De,getSigningPrivateKey:le,getEncryptionPrivateKey:We,signAuthMessage:qe,verifyAuthSignature:ze,exportIdentity:Ge,exportEncryptedIdentity:Ve,markIdentityExportedNow:Ee,getLastExportedAt:Pe,importIdentity:Ye,importEncryptedIdentity:Xe,setIdentityUsername:Qe,clearIdentity:Ze};class et{constructor(e,t){c(this,"open",e=>(this.domComponent.style.display="block",this.render(e)));c(this,"close",()=>{this.domComponent.style.display="none"});c(this,"renderPrompt",e=>new Promise(t=>{this.promptResolver=t,this.domComponent.append(a("div",{class:"modal-content"},[a("div",{class:"modal-header"},[a("h2",{},e||"Enter a value")]),a("div",{class:"modal-body"},[a("input",{id:"prompt-input",type:"text",style:"width: 100%; margin-bottom: 10px;"}),a("div",{style:"text-align: right;"},[a("button",{class:"btn"},"OK",{type:"click",event:()=>{const s=this.domComponent.querySelector("#prompt-input").value;this.close(),this.promptResolver(s)}}),a("button",{class:"btn btn-red",style:"margin-left: 10px;"},"Cancel",{type:"click",event:()=>{this.close(),this.promptResolver(null)}})])])]))}));c(this,"renderAuthorSettings",e=>[a("div",{class:"settings-section"},[a("h3",{},"Space Management"),a("div",{class:"settings-actions"},[a("button",{class:"btn"},"Invite User",{type:"click",event:()=>{this.render({type:"prompt",data:{message:"Enter recipient public key"}}).then(t=>{t&&this.socketConn.inviteUser({public_key:t.trim(),space_uuid:e.uuid})})}}),a("button",{class:"btn btn-red"},"Delete Space",{type:"click",event:()=>{p.confirm("Are you sure you want to delete this space?").then(t=>{t&&this.socketConn.deleteSpace({uuid:e.uuid})})}})])]),a("div",{class:"settings-section"},[a("h3",{},"Channel Management"),a("div",{class:"settings-actions"},[a("button",{class:"btn"},"+ Create Channel",{type:"click",event:()=>{this.render({type:"prompt",data:{message:"Please enter Channel name"}}).then(t=>{t&&this.socketConn.createChannel({name:t.trim(),space_uuid:e.uuid})})}})]),a("div",{class:"channels-list"},e.channels.map(t=>a("div",{class:"channel-item"},[a("span",{},t.name),a("button",{class:"btn-small btn-red"},"Delete",{type:"click",event:()=>{p.confirm("Are you sure you want to delete this channel?").then(s=>{s&&this.socketConn.deleteChannel({uuid:t.uuid})})}})])))])]);c(this,"renderSpaceUserSettings",(e,t)=>[a("div",{class:"settings-section"},[a("h3",{},"Space Management"),a("div",{class:"settings-actions"},[a("button",{class:"btn btn-red"},"Leave Space",{type:"click",event:()=>{p.confirm("Are you sure you want to leave this space?").then(s=>{s&&this.socketConn.leaveSpace({space_uuid:e.uuid,user_id:t.id,user_public_key:t.public_key||"",user_enc_public_key:t.enc_public_key||""})})}})])])]);c(this,"renderAccount",(e,t=[])=>{const s=async(r,h)=>{if(!r){p.alert("No backup data provided");return}if(!h||h.length<8){p.alert("Enter an import passphrase (8+ chars)");return}if(await p.confirm("Import identity and replace the current local identity on this browser?"))try{await m.importEncryptedIdentity(r,h),p.alert("Identity imported. Reloading..."),window.location.reload()}catch(u){console.error(u),p.alert((u==null?void 0:u.message)||"Failed to import encrypted backup")}},i=r=>{if(!r)return"Never";const h=new Date(r);return Number.isNaN(h.getTime())?"Unknown":h.toLocaleString()},o=()=>{const r=this.domComponent.querySelector("#last-exported-at");r&&(r.textContent=i(m.getLastExportedAt()))},l=()=>{const r=this.domComponent.querySelector("#active-devices-list");if(!r)return;if(r.innerHTML="",!Array.isArray(t)||t.length===0){r.append(a("div",{style:"font-size: 0.85rem; color: var(--main-gray);"},"No active device sessions detected on this host."));return}const h=t.map(d=>{const u=`${d.device_name||"Unknown Device"}${d.is_current?" (This device)":""}`,f=`Last seen: ${i(d.last_seen||"")}`;return a("div",{class:"channel-item"},[a("div",{style:"font-size: 0.92rem; color: var(--bright-white);"},u),a("div",{style:"font-size: 0.8rem; color: var(--main-gray);"},f)])});r.append(...h)};this.domComponent.append(a("div",{class:"modal-content"},[a("div",{class:"modal-header"},[a("h2",{},"Account"),a("button",{class:"close-modal"},"×",{type:"click",event:this.close})]),a("div",{class:"modal-body"},[a("h3",{},`Username: "${e.username}"`),a("div",{class:"settings-section"},[a("h3",{},"Public Key (Share for Invites)"),a("p",{style:"display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--main-gray);"},"Share this public key with space admins so they can invite you."),a("textarea",{id:"public-key-display",readonly:"readonly",rows:"4",style:"width: 100%; font-size: 0.8rem; padding: 8px; background: var(--second-dark); color: var(--a-blue); border: 1px solid var(--main-gray); border-radius: 4px; resize: vertical;"}),a("br"),a("button",{class:"btn",id:"copy-public-key-btn"},"Copy Public Key",{type:"click",event:async()=>{var d;const r=this.domComponent.querySelector("#public-key-display"),h=((r==null?void 0:r.value)||"").trim();if(!h){p.alert("Public key not available yet");return}try{(d=navigator.clipboard)!=null&&d.writeText?await navigator.clipboard.writeText(h):(r.focus(),r.select(),document.execCommand("copy")),p.alert("Public key copied")}catch{p.alert("Failed to copy public key")}}})]),a("div",{class:"settings-section"},[a("h3",{},"Encrypted Identity Backup"),a("p",{style:"display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--light-red);"},"Backups are encrypted with your passphrase. If you lose the passphrase and backup file, your identity cannot be recovered."),a("p",{style:"display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--main-gray);"},"Private keys stay non-exportable during normal use. Export creates an encrypted backup file for device transfer."),a("div",{class:"input-container"},[a("label",{for:"identity-export-passphrase"},"Backup Passphrase"),a("input",{id:"identity-export-passphrase",type:"password",placeholder:"At least 8 characters",autocomplete:"new-password"})]),a("br"),a("textarea",{id:"identity-export-display",readonly:"readonly",rows:"6",placeholder:"Encrypted backup JSON appears here after generation",style:"width: 100%; font-size: 0.78rem; padding: 8px; background: var(--second-dark); color: var(--main-white); border: 1px solid var(--main-gray); border-radius: 4px; resize: vertical; margin-bottom: 8px;"}),a("button",{class:"btn",id:"generate-identity-backup-btn"},"Generate Encrypted Backup",{type:"click",event:async()=>{const r=this.domComponent.querySelector("#identity-export-passphrase"),h=this.domComponent.querySelector("#identity-export-display"),d=((r==null?void 0:r.value)||"").trim();if(d.length<8){p.alert("Enter a backup passphrase (8+ chars)");return}try{const u=await m.exportEncryptedIdentity(d);h&&(h.value=u)}catch(u){console.error(u),p.alert((u==null?void 0:u.message)||"Failed to generate encrypted backup")}}}),a("button",{class:"btn",id:"copy-identity-btn",style:"margin-left: 8px;"},"Copy Backup JSON",{type:"click",event:async()=>{var d;const r=this.domComponent.querySelector("#identity-export-display"),h=((r==null?void 0:r.value)||"").trim();if(!h){p.alert("Generate backup first");return}try{(d=navigator.clipboard)!=null&&d.writeText?await navigator.clipboard.writeText(h):(r.focus(),r.select(),document.execCommand("copy")),m.markIdentityExportedNow(),o(),p.alert("Encrypted backup copied")}catch{p.alert("Failed to copy backup")}}}),a("button",{class:"btn",id:"download-identity-btn",style:"margin-left: 8px;"},"Download Backup File",{type:"click",event:async()=>{const r=this.domComponent.querySelector("#identity-export-passphrase"),h=this.domComponent.querySelector("#identity-export-display"),d=((r==null?void 0:r.value)||"").trim();if(d.length<8){p.alert("Enter your backup passphrase first");return}try{const u=((h==null?void 0:h.value)||"").trim()||await m.exportEncryptedIdentity(d);h&&!h.value&&(h.value=u);const f=new Blob([u],{type:"application/json"}),b=URL.createObjectURL(f),w=document.createElement("a");w.href=b,w.download="parch-identity-backup.enc.json",document.body.appendChild(w),w.click(),w.remove(),URL.revokeObjectURL(b),m.markIdentityExportedNow(),o()}catch(u){console.error(u),p.alert((u==null?void 0:u.message)||"Failed to generate backup file")}}}),a("p",{style:"display: block; margin: 8px 0 6px; font-size: 0.82rem; color: var(--main-gray);"},["Last exported: ",a("span",{id:"last-exported-at"},"Never")]),a("br"),a("div",{class:"input-container"},[a("label",{for:"identity-import-passphrase"},"Import Passphrase"),a("input",{id:"identity-import-passphrase",type:"password",placeholder:"Passphrase used to encrypt the backup",autocomplete:"off"})]),a("br"),a("textarea",{id:"identity-import-input",rows:"6",placeholder:"Paste encrypted backup JSON here to import",style:"width: 100%; font-size: 0.78rem; padding: 8px; background: var(--second-dark); color: var(--a-blue); border: 1px solid var(--main-gray); border-radius: 4px; resize: vertical; margin-bottom: 8px;"}),a("button",{class:"btn",id:"import-identity-btn"},"Import Encrypted Backup",{type:"click",event:async()=>{const r=this.domComponent.querySelector("#identity-import-input"),h=this.domComponent.querySelector("#identity-import-passphrase"),d=((r==null?void 0:r.value)||"").trim(),u=((h==null?void 0:h.value)||"").trim();if(!d){p.alert("Paste encrypted backup JSON to import");return}await s(d,u)}}),a("button",{class:"btn",id:"import-identity-file-btn",style:"margin-left: 8px;"},"Import Backup File",{type:"click",event:()=>{const r=this.domComponent.querySelector("#identity-import-file");r&&(r.value="",r.click())}}),a("input",{id:"identity-import-file",type:"file",accept:"application/json,.json",style:"display: none;"},null,{type:"change",event:async r=>{var d,u;const h=(u=(d=r==null?void 0:r.target)==null?void 0:d.files)==null?void 0:u[0];if(h)try{const f=await h.text(),b=this.domComponent.querySelector("#identity-import-input");b&&(b.value=f)}catch{p.alert("Failed to read backup file")}}})]),a("div",{class:"settings-section"},[a("h3",{},"Active Devices"),a("p",{style:"display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--main-gray);"},"Shows active sessions for this identity on this host."),a("div",{id:"active-devices-list",class:"channels-list"})]),a("div",{class:"settings-section"},[a("h3",{},"Local Fallback Username"),a("p",{style:"display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--main-gray);"},"Used as the default username sent during auth when joining a host for the first time."),a("div",{class:"input-container"},[a("label",{for:"local-identity-username"},"Local Username"),a("input",{id:"local-identity-username",name:"localIdentityUsername",type:"text",value:"",placeholder:"Set local fallback username"})]),a("br"),a("button",{class:"btn"},"Save Local Username",{type:"click",event:()=>{const r=this.domComponent.querySelector("#local-identity-username"),h=((r==null?void 0:r.value)||"").trim();m.setIdentityUsername(h),p.alert("Local fallback username saved")}})]),a("form",{id:"update-username-form"},[a("fieldset",{},[a("legend",{},"Update Username"),a("div",{class:"input-container"},[a("label",{for:"username"},"Username"),a("input",{id:"username",name:"username",type:"text",required:!0,autofocus:!0,value:e.username||""})]),a("br"),a("button",{type:"submit"},"Submit")])],{type:"submit",event:r=>{r.preventDefault();const h=new FormData(r.target),d=Object.fromEntries(h.entries());d.user_id=e.id,d.user_public_key=e.public_key||"",d.user_enc_public_key=e.enc_public_key||"",this.socketConn.updateUsername(d)}}),a("br"),a("button",{class:"btn-red"},"Reset Identity",{type:"click",event:()=>{p.confirm("Reset local identity key? This creates a new account identity.").then(r=>{r&&(m.clearIdentity(),window.location.reload())})}})])])),m.getOrCreateIdentity().then(r=>{const h=this.domComponent.querySelector("#public-key-display"),d=this.domComponent.querySelector("#local-identity-username");h&&(h.value=r.publicKey||""),d&&(d.value=r.username||"")}).catch(()=>{const r=this.domComponent.querySelector("#public-key-display"),h=this.domComponent.querySelector("#identity-export-display"),d=this.domComponent.querySelector("#local-identity-username");r&&(r.value=""),d&&(d.value=""),h&&(h.value="")}),o(),l()});c(this,"renderInvites",(e,t)=>{this.domComponent.append(a("div",{class:"modal-content"},[a("div",{class:"modal-header"},[a("h2",{},"Space Invites"),a("button",{class:"close-modal"},"×",{type:"click",event:this.close})]),a("div",{class:"modal-body"},e&&e.length&&t?a("div",{class:"invites-section"},[...e.map(s=>a("div",{class:"pending-invites-item"},[a("span",{},s.name),a("div",{},[a("button",{class:"btn-small accept-invite"},"Accept",{type:"click",event:()=>this.socketConn.acceptInvite({space_user_id:s.id,user_id:t.id,user_public_key:t.public_key||"",user_enc_public_key:t.enc_public_key||""})}),a("button",{class:"btn-small btn-red decline-invite"},"Decline",{type:"click",event:()=>this.socketConn.declineInvite({space_user_id:s.id,user_id:t.id,user_public_key:t.public_key||"",user_enc_public_key:t.enc_public_key||""})})])]))]):"...No Invite Yet")]))});c(this,"render",e=>{var t;switch(this.domComponent.innerHTML="",e.type){case"prompt":if((t=e.data)!=null&&t.message)return this.renderPrompt(e.data.message);break;case"account":e.data.user&&this.renderAccount(e.data.user,e.data.active_devices||[]);break;case"invites":this.renderInvites(e.data.invites,e.data.user);break;case"space-settings":if(e.data.space&&e.data.user){const s=e.data.space,i=e.data.user,o=s.author_id===i.id;this.domComponent.append(a("div",{class:"modal-content"},[a("div",{class:"modal-header"},[a("h2",{},`Space Settings: ${s.name}`),a("button",{class:"close-modal"},"×",{type:"click",event:this.close})]),a("div",{class:"modal-body"},o?this.renderAuthorSettings(s):this.renderSpaceUserSettings(s,i))]))}break}});this.app=e,this.socketConn=t,this.domComponent=a("div",{class:"modal"}),this.promptResolver=null}}class tt{constructor(e){c(this,"initSpaceComponents",()=>{this.data.spaces&&(this.spaceComponents=this.data.spaces.map(e=>new Y({domComponent:a("div",{class:"space-item"}),space:e,user:this.data.user,openSpaceSettings:this.openSpaceSettings,loadChannel:this.loadChannel})))});c(this,"addSpace",e=>{const t=new Y({domComponent:a("div",{class:"space-item"}),space:e,user:this.data.user,openSpaceSettings:this.openSpaceSettings,loadChannel:this.loadChannel});this.spaceComponents.push(t),this.render()});c(this,"render",()=>{this.domComponent.innerHTML="",this.initSpaceComponents(),this.userAccountComponent=new nt({data:this.data,returnToHostList:this.returnToHostList,openDashModal:this.openDashModal,domComponent:a("div",{class:"user-component"})}),this.spaceUserListComponent=new st({data:this.data,socketConn:this.socketConn,getCurrentSpaceUUID:this.getCurrentSpaceUUID,domComponent:a("div",{class:"space-users-list",id:"space-users-list"})}),this.domComponent.append(a("div",{class:"sidebar-spaces-container"},[a("div",{id:"spaces-list"},this.spaceComponents.map(e=>e.domComponent)),a("button",{class:"create-space-btn",id:"new-space-btn"},"+ Create New Space",{type:"click",event:()=>{this.openDashModal({type:"prompt",data:{message:"Please enter Space 'Name'"}}).then(e=>{e&&(e.trim(),this.socketConn.createSpace({name:e}))})}})]),a("br"),this.spaceUserListComponent.domComponent,a("hr"),this.userAccountComponent.domComponent)});this.data=e.data,this.socketConn=e.socketConn,this.returnToHostList=e.returnToHostList,this.openDashModal=e.openDashModal,this.closeDashModal=e.closeDashModal,this.getCurrentSpaceUUID=e.getCurrentSpaceUUID,this.spaceComponents=[],this.domComponent=e.domComponent,this.openSpaceSettings=e.openSpaceSettings,this.loadChannel=e.loadChannel,this.render()}}class nt{constructor(e){c(this,"render",()=>{this.domComponent.innerHTML="",this.domComponent.append(a("a",{href:"#"},"Account",{type:"click",event:e=>{this.openDashModal({type:"account",data:{user:this.data.user,active_devices:this.data.active_devices||[]}})}}),a("a",{href:"#"},"Invites",{type:"click",event:e=>{this.openDashModal({type:"invites",data:{invites:this.data.invites,user:this.data.user}})}}),a("a",{href:"#"},"<- Host List",{type:"click",event:e=>{this.returnToHostList()}}))});this.data=e.data,this.returnToHostList=e.returnToHostList,this.openDashModal=e.openDashModal,this.domComponent=e.domComponent,this.render()}}class st{constructor(e){c(this,"isAuthor",(e,t)=>String(e.author_id)===String(t.id));c(this,"renderUserElement",(e,t)=>a("div",{class:"space-user-item",id:"space-user-item"},`${t.username} ${this.isAuthor(e,t)?"*":""}`,{type:"click",event:async()=>{this.isAuthor(e,this.data.user)&&this.data.user.id!=t.id&&p.confirm("Are you sure you want to remove this user?").then(s=>{s&&this.socketConn.removeSpaceUser({space_uuid:e.uuid,user_id:t.id,user_public_key:t.public_key||""})})}}));c(this,"renderSpaceUsersList",e=>{const t=[];return e.users&&e.users.map(s=>{t.push(this.renderUserElement(e,s))}),t});c(this,"render",()=>{this.domComponent.innerHTML="";const e=this.getCurrentSpaceUUID();if(e){const t=this.data.spaces.find(s=>s.uuid===e);if(!t)return;this.domComponent.append(a("h3",{},"Users"),...this.renderSpaceUsersList(t))}});this.data=e.data,this.socketConn=e.socketConn,this.getCurrentSpaceUUID=e.getCurrentSpaceUUID,this.domComponent=e.domComponent,this.render()}}class Y{constructor(e){c(this,"isAuthor",()=>String(this.space.author_id)===String(this.user.id));c(this,"renderChannelList",()=>a("div",{class:"channel-list"},(this.space.channels||[]).map(e=>a("div",{class:"channel-item"},[a("span",{class:"channel-hash"},"#"),a("span",{},e.name)],{type:"click",event:()=>this.loadChannel(this.space.uuid,e.uuid)}))));c(this,"toggleChannels",()=>{this.channelsOpen=!this.channelsOpen,this.render()});c(this,"render",()=>{this.domComponent.textContent="",this.domComponent.className=`space-item${this.channelsOpen?" space-item--open":""}`,this.domComponent.append(a("div",{class:"space-header"},[a("span",{class:"space-chevron"}),a("span",{},this.space.name),a("div",{class:"space-actions"},a("button",{class:"btn-icon open-settings"},"⚙️",{type:"click",event:e=>{e.stopPropagation(),this.openSpaceSettings(this.space)}}))],{type:"click",event:this.toggleChannels}),...this.channelsOpen?[this.renderChannelList()]:[])});this.space=e.space,this.user=e.user,this.openSpaceSettings=e.openSpaceSettings,this.loadChannel=e.loadChannel,this.channelsOpen=!1,this.domComponent=e.domComponent,this.render()}}function at(n){const e=new Date(n),t=e.getFullYear(),s=(e.getMonth()+1).toString().padStart(2,"0"),i=e.getDate().toString().padStart(2,"0"),o=e.getHours(),l=e.getMinutes(),r=o%12||12,h=o<12?"am":"pm",d=l.toString().padStart(2,"0");return`${s}-${i}-${t} ${r}:${d}${h}`}const it="data:image/svg+xml;base64,"+btoa(`
    <svg xmlns="http://www.w3.org/2000/svg" width="150" height="100" viewBox="0 0 150 100">
      <rect width="150" height="100" fill="#aaaaa" />
      <text x="75" y="55" font-size="14" text-anchor="middle" fill="#a00" font-family="sans-serif">Image not found</text>
    </svg>
  `);function rt(n){const e=document.createElement("img");return e.src=n,e.alt="Image",e.style="max-width: 100%; max-height: 250px; margin: 5px; cursor: pointer;",e.onerror=()=>{e.src=it},e}function ot(n){const e=n.split(".");if(e.length<2)return!1;const t=e[e.length-1].toLowerCase().split("?")[0];return["jpg","jpeg","png","gif","webp","svg","tiff"].includes(t)}function K(){const n=globalThis==null?void 0:globalThis.crypto;if(!(n!=null&&n.subtle))throw new Error("WebCrypto API is not available");return n}function E(n){let e="";const t=n instanceof Uint8Array?n:new Uint8Array(n);for(let s=0;s<t.length;s+=1)e+=String.fromCharCode(t[s]);return btoa(e).replace(/=+$/g,"")}function I(n){const e=(4-n.length%4)%4,t=n+"=".repeat(e),s=atob(t),i=new Uint8Array(s.length);for(let o=0;o<s.length;o+=1)i[o]=s.charCodeAt(o);return i}function $(n){const e=Array.isArray(n.wrapped_keys)?[...n.wrapped_keys].sort((s,i)=>String(s.recipient_auth_public_key).localeCompare(String(i.recipient_auth_public_key))):[],t={v:n.v,alg:n.alg,message_id:n.message_id,sender_timestamp:n.sender_timestamp,space_uuid:n.space_uuid,channel_uuid:n.channel_uuid,sender_auth_public_key:n.sender_auth_public_key,sender_enc_public_key:n.sender_enc_public_key,content_iv:n.content_iv,ciphertext:n.ciphertext,wrapped_keys:e.map(s=>({recipient_auth_public_key:s.recipient_auth_public_key,iv:s.iv,ciphertext:s.ciphertext}))};return JSON.stringify(t)}function ct(){const n=K();return E(n.getRandomValues(new Uint8Array(16)))}async function de(n){return K().subtle.importKey("spki",I(n),{name:"ECDH",namedCurve:"P-256"},!1,[])}async function lt(n){return de(n)}async function dt(n){return K().subtle.importKey("pkcs8",I(n),{name:"ECDH",namedCurve:"P-256"},!1,["deriveBits"])}async function he(n){return n!=null&&n.encPrivateKey?dt(n.encPrivateKey):m.getEncryptionPrivateKey(n)}async function pe(n,e,t){const s=K(),i=await s.subtle.deriveBits({name:"ECDH",public:e},n,256),o=await s.subtle.importKey("raw",i,"HKDF",!1,["deriveKey"]),l=new TextEncoder().encode(`parch-e2ee-wrap-salt:${t.space_uuid}:${t.channel_uuid}`),r=new TextEncoder().encode(`parch-e2ee-wrap-info:${t.sender_auth_public_key}`);return s.subtle.deriveKey({name:"HKDF",hash:"SHA-256",salt:l,info:r},o,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async function ht(n){const e=K(),{plaintext:t,spaceUUID:s,channelUUID:i,identity:o,recipients:l}=n;if(!(o!=null&&o.publicKey)||!(o!=null&&o.encPublicKey))throw new Error("Missing sender identity keys");if(!s||!i)throw new Error("Missing space/channel context");if(!Array.isArray(l)||l.length===0)throw new Error("No recipient keys available for encryption");const r=[],h=new Set;for(const g of l)!(g!=null&&g.authPublicKey)||!(g!=null&&g.encPublicKey)||h.has(g.authPublicKey)||(h.add(g.authPublicKey),r.push(g));h.has(o.publicKey)||r.push({authPublicKey:o.publicKey,encPublicKey:o.encPublicKey});const d=await e.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),u=new Uint8Array(await e.subtle.exportKey("raw",d)),f=e.getRandomValues(new Uint8Array(12)),b=new TextEncoder().encode(t),w=await e.subtle.encrypt({name:"AES-GCM",iv:f},d,b),ye=await he(o),x={v:1,alg:"p256-hkdf-aesgcm+ed25519",message_id:ct(),sender_timestamp:new Date().toISOString(),space_uuid:s,channel_uuid:i,sender_auth_public_key:o.publicKey,sender_enc_public_key:o.encPublicKey,content_iv:E(f),ciphertext:E(w),wrapped_keys:[]};for(const g of r){const fe=await de(g.encPublicKey),be=await pe(ye,fe,x),q=e.getRandomValues(new Uint8Array(12)),ge=await e.subtle.encrypt({name:"AES-GCM",iv:q},be,u);x.wrapped_keys.push({recipient_auth_public_key:g.authPublicKey,iv:E(q),ciphertext:E(ge)})}const me=$(x);return x.sig=await m.signAuthMessage(o,me),x}async function pt(n){const e=K(),{envelope:t,identity:s}=n;if(!(t!=null&&t.sender_auth_public_key)||!(t!=null&&t.sender_enc_public_key)||!(t!=null&&t.sig))throw new Error("Invalid encrypted envelope");if(!(s!=null&&s.publicKey))throw new Error("Missing recipient identity");const i=$(t);if(!await m.verifyAuthSignature(t.sender_auth_public_key,i,t.sig))throw new Error("Invalid message signature");const l=(t.wrapped_keys||[]).find(w=>w.recipient_auth_public_key===s.publicKey);if(!l)throw new Error("No wrapped key for this identity");const r=await he(s),h=await lt(t.sender_enc_public_key),d=await pe(r,h,t),u=await e.subtle.decrypt({name:"AES-GCM",iv:I(l.iv)},d,I(l.ciphertext)),f=await e.subtle.importKey("raw",u,{name:"AES-GCM",length:256},!1,["decrypt"]),b=await e.subtle.decrypt({name:"AES-GCM",iv:I(t.content_iv)},f,I(t.ciphertext));return new TextDecoder().decode(b)}const ue={encryptMessageForSpace:ht,decryptMessageForIdentity:pt,canonicalEnvelopeForSignature:$};class ut{constructor(e){c(this,"initialize",e=>{this.chatBoxComponent=new yt({domComponent:a("div"),data:this.data,socketConn:this.socketConn,channelUUID:e}),this.render();const t=new Date().toISOString();this.socketConn.getMessages(t)});c(this,"render",()=>{this.domComponent.innerHTML="",this.chatBoxComponent&&this.domComponent.append(this.chatBoxComponent.domComponent)});this.domComponent=e.domComponent,this.data=e.data,this.socketConn=e.socketConn,this.chatBoxComponent=null}}class yt{constructor(e){c(this,"render",()=>{this.domComponent.innerHTML="",this.domComponent.append(a("div",{class:"chatapp-channel-title"},this.channel.name),this.chatBoxMessagesComponent.domComponent,a("div",{class:"chat-box-form"},[a("textarea",{id:"chat-box-form-input",class:"chat-box-form-input",autofocus:!0,type:"text",required:!0,autocomplete:"off",placeholder:"Type message here..."},null,[{type:"input",event:e=>{const t=e.target;t.style.height="auto",t.style.height=`${t.scrollHeight}px`}},{type:"keydown",event:async e=>{var t,s;if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();const i=e.target,o=i.value.trim();if(o)try{const l=await m.getOrCreateIdentity(),r=(((t=this.space)==null?void 0:t.users)||[]).filter(d=>(d==null?void 0:d.public_key)&&(d==null?void 0:d.enc_public_key)).map(d=>({authPublicKey:d.public_key,encPublicKey:d.enc_public_key})),h=await ue.encryptMessageForSpace({plaintext:o,spaceUUID:(s=this.space)==null?void 0:s.uuid,channelUUID:this.channelUUID,identity:l,recipients:r});this.socketConn.sendMessage({envelope:h}),i.value="",i.style.height="auto",i.focus()}catch(l){console.error(l),p.alert((l==null?void 0:l.message)||"Failed to encrypt message")}}}}])]))});this.domComponent=e.domComponent,this.domComponent.className="chat-box-container",this.data=e.data,this.socketConn=e.socketConn,this.channelUUID=e.channelUUID;for(const t of this.data.spaces){const s=t.channels.find(i=>i.uuid===this.channelUUID);if(s){this.space=t,this.channel=s;break}}this.chatBoxMessagesComponent=new mt({domComponent:a("div",{class:"chat-box-messages",id:"chat-box-messages"}),channelUUID:this.channelUUID,socketConn:this.socketConn}),this.render()}}class mt{constructor(e){c(this,"getPreviousMessagesDebounce",()=>{this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.debounceTimeout=setTimeout(()=>{this.getPreviousMessages()},300)});c(this,"getPreviousMessages",()=>{if(this.isLoading||!this.hasMoreMessages||!this.chatBoxMessages.length||!this.isScrolledToTop())return;this.isLoading=!0;const e=this.chatBoxMessages[0].timestamp;this.socketConn.getMessages(e)});c(this,"scrollDown",()=>{this.domComponent.scrollTop=this.domComponent.scrollHeight});c(this,"isScrolledToTop",()=>this.domComponent.scrollTop<=20);c(this,"isScrolledToBottom",()=>this.domComponent.scrollHeight-this.domComponent.scrollTop<=this.domComponent.clientHeight+40);c(this,"appendNewMessage",e=>{const t=this.isScrolledToBottom();this.chatBoxMessages.push(e),this.render(),t&&requestAnimationFrame(()=>this.scrollDown())});c(this,"createMessage",e=>{const t=s=>{const i=/(https?:\/\/[^\s]+)/g,o=/^https?:\/\/[^\s]+$/;return s.split(i).map(r=>o.test(r)?ot(r)?rt(r):a("a",{href:r,target:"_blank",rel:"noopener noreferrer",style:"margin: 0 5px;"},r):r)};return a("div",{class:"chat-box-message-content"},[a("div",{style:"display: flex; align-items: flex-end;"},[a("small",{style:"margin-right: var(--main-distance); color: var(--main-gray);"},at(e.timestamp)),a("div",{style:"font-weight: bold; margin-right: var(--main-distance); color: var(--light-yellow);"},e.username)]),a("div",{class:"chat-box-message-text"},[...t(e.content)]),a("hr")])});c(this,"render",()=>{this.domComponent.innerHTML="";const e=this.chatBoxMessages.map(t=>this.createMessage(t));this.domComponent.append(...e)});this.chatBoxMessages=[],this.channelUUID=e.channelUUID,this.socketConn=e.socketConn,this.messageRequestSize=50,this.hasMoreMessages=!0,this.debounceTimeout=null,this.isLoading=!1,this.domComponent=a("div",{class:"chat-box-messages",id:"chat-box-messages"},null,{type:"scroll",event:()=>{this.getPreviousMessagesDebounce()}})}}class ft{constructor(e){c(this,"renderChannel",e=>{this.currentChannelUUID=e,this.domComponent.innerHTML="";const t=a("div",{class:"chatapp-container"});this.domComponent.append(t),this.chatApp?this.chatApp.domComponent=t:this.chatApp=new ut({domComponent:t,data:this.data,socketConn:this.socketConn}),this.chatApp.initialize(e)});c(this,"cleanup",()=>{var e,t;this.chatApp&&((t=(e=this.chatApp).cleanup)==null||t.call(e),this.chatApp=null),this.currentChannelUUID=null});c(this,"render",()=>{this.cleanup(),this.domComponent.innerHTML="",this.domComponent.append(a("div",{class:"no-channel-selected"},[a("h2",{},"Select a channel to start chatting")]))});this.domComponent=e.domComponent,this.data=e.data,this.socketConn=e.socketConn,this.chatApp=null,this.currentChannelUUID=null,this.render()}}class bt{constructor(e){c(this,"retryConnection",()=>{if(this.retryCount+=1,this.retryCount>this.maxRetries){p.alert("Unable to reconnect to host. Returning to home."),this.returnToHostList();return}setTimeout(()=>{var t;((t=this.socket)==null?void 0:t.readyState)!==WebSocket.OPEN&&this.connect()},2e3)});c(this,"connect",()=>{this.socket=new WebSocket(ke),this.socket.onopen=()=>{this.joinHost()},this.socket.onerror=e=>{console.error("WebSocket error:",e)},this.socket.onclose=()=>{this.manualClose||this.retryConnection()},this.socket.onmessage=async e=>{var t,s;try{const i=JSON.parse(e.data);switch(i.type){case"join_ack":break;case"join_error":p.alert(((t=i.data)==null?void 0:t.error)||"Failed to join host"),this.returnToHostList();break;case"auth_challenge":await this.authenticateWithPublicKey((s=i.data)==null?void 0:s.challenge);break;case"auth_pubkey_success":this.closeDashModal(),this.getDashboardData();break;case"dash_data_payload":this.dashboardInitialRender(i.data),this.joinAllSpaces(i);break;case"update_username_success":this.updateAccountUsername(i,this.hostUUID),m.setIdentityUsername(i.data.username);break;case"create_space_success":this.handleCreateSpace(i);break;case"delete_space_success":this.handleDeleteSpace();break;case"create_channel_success":this.handleCreateChannel(i);break;case"create_channel_update":this.handleCreateChannelUpdate(i);break;case"delete_channel_success":this.handleDeleteChannel(i);break;case"delete_channel_update":this.handleDeleteChannelUpdate(i);break;case"invite_user_success":this.handleInviteUser(i);break;case"invite_user_update":this.handleAddInvite(i);break;case"accept_invite_success":this.handleAcceptInvite(i);break;case"accept_invite_update":this.handleAcceptInviteUpdate(i);break;case"decline_invite_success":this.handleDeclineInvite(i);break;case"leave_space_success":this.handleLeaveSpace();break;case"leave_space_update":this.handleLeaveSpaceUpdate(i);break;case"chat":await this.renderChatAppMessage(i);break;case"get_messages_success":await this.handleIncomingMessages(i);break;case"error":p.alert(i.data.error);break;case"authentication-error":p.alert(i.data.error||"Authentication failed");break;case"author_error":p.alert("Failed to connect to host. Host is offline."),this.returnToHostList();break;default:break}}catch(i){console.error("JSON parsing error:",i)}}});c(this,"authenticateWithPublicKey",async e=>{if(!e){p.alert("Missing auth challenge from server");return}try{const t=await m.getOrCreateIdentity(),s=m.getDeviceMetadata(),i=`parch-chat-auth:${this.hostUUID}:${e}:${t.encPublicKey}`,o=await m.signAuthMessage(t,i),l={type:"auth_pubkey",data:{public_key:t.publicKey,enc_public_key:t.encPublicKey,device_id:s.deviceId,device_name:s.deviceName,username:t.username||"",challenge:e,signature:o}};this.socket.send(JSON.stringify(l))}catch(t){console.error(t),p.alert("Failed to initialize public-key identity")}});c(this,"joinHost",()=>{var e;((e=this.socket)==null?void 0:e.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"join_host",data:{uuid:this.hostUUID}}))});c(this,"getDashboardData",()=>{var e;((e=this.socket)==null?void 0:e.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"get_dash_data",data:""}))});c(this,"joinAllSpaces",e=>{var t;if(((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const s=e.data.spaces.map(i=>i.uuid);this.socket.send(JSON.stringify({type:"join_all_spaces",data:{space_uuids:s}}))}});c(this,"updateUsername",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"update_username",data:e}))});c(this,"createSpace",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"create_space",data:e}))});c(this,"deleteSpace",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"delete_space",data:e}))});c(this,"createChannel",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"create_channel",data:e}))});c(this,"deleteChannel",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"delete_channel",data:e}))});c(this,"inviteUser",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"invite_user",data:e}))});c(this,"acceptInvite",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"accept_invite",data:e}))});c(this,"declineInvite",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"decline_invite",data:e}))});c(this,"leaveSpace",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"leave_space",data:e}))});c(this,"removeSpaceUser",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"remove_space_user",data:e}))});c(this,"joinChannel",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"join_channel",data:{uuid:e}}))});c(this,"sendMessage",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"chat",data:e}))});c(this,"getMessages",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"get_messages",data:{before_unix_time:e}}))});c(this,"hardClose",()=>{this.manualClose=!0,this.close()});c(this,"close",()=>{this.socket&&this.socket.close()});this.returnToHostList=e.returnToHostList,this.updateAccountUsername=e.updateAccountUsername,this.dashboardInitialRender=e.dashboardInitialRender,this.openDashModal=e.openDashModal,this.closeDashModal=e.closeDashModal,this.renderChatAppMessage=e.renderChatAppMessage,this.handleCreateSpace=e.handleCreateSpace,this.handleCreateChannel=e.handleCreateChannel,this.handleDeleteSpace=e.handleDeleteSpace,this.handleDeleteChannel=e.handleDeleteChannel,this.handleCreateChannelUpdate=e.handleCreateChannelUpdate,this.handleDeleteChannelUpdate=e.handleDeleteChannelUpdate,this.handleInviteUser=e.handleInviteUser,this.handleAddInvite=e.handleAddInvite,this.handleAcceptInvite=e.handleAcceptInvite,this.handleAcceptInviteUpdate=e.handleAcceptInviteUpdate,this.handleDeclineInvite=e.handleDeclineInvite,this.handleLeaveSpace=e.handleLeaveSpace,this.handleLeaveSpaceUpdate=e.handleLeaveSpaceUpdate,this.handleIncomingMessages=e.handleIncomingMessages,this.socket=null,this.manualClose=!1,this.retryCount=0,this.maxRetries=2,this.hostUUID=localStorage.getItem("hostUUID"),this.hostUUID?this.connect():(p.alert("Missing host key"),this.returnToHostList())}}class gt{constructor(e){c(this,"initialize",()=>{this.domComponent.append(a("div",{class:"initial-spinner"},[a("div",{},"Connecting To Host..."),a("br"),a("div",{class:"lds-dual-ring"})])),this.socketConn=new bt({returnToHostList:this.returnToHostList,updateAccountUsername:this.updateAccountUsername,dashboardInitialRender:this.initialRender,openDashModal:this.openDashModal,closeDashModal:this.closeDashModal,renderChatAppMessage:this.renderChatAppMessage,handleCreateSpace:this.handleCreateSpace,handleDeleteSpace:this.handleDeleteSpace,handleCreateChannel:this.handleCreateChannel,handleCreateChannelUpdate:this.handleCreateChannelUpdate,handleDeleteChannel:this.handleDeleteChannel,handleDeleteChannelUpdate:this.handleDeleteChannelUpdate,handleInviteUser:this.handleInviteUser,handleAddInvite:this.handleAddInvite,handleAcceptInvite:this.handleAcceptInvite,handleAcceptInviteUpdate:this.handleAcceptInviteUpdate,handleDeclineInvite:this.handleDeclineInvite,handleLeaveSpace:this.handleLeaveSpace,handleLeaveSpaceUpdate:this.handleLeaveSpaceUpdate,handleIncomingMessages:this.handleIncomingMessages}),this.dashModal=new et(this,this.socketConn),this.domComponent.append(this.dashModal.domComponent)});c(this,"initialRender",e=>{this.data=e,this.data.spaces||(this.data.spaces=[]),Array.isArray(this.data.active_devices)||(this.data.active_devices=[]),this.sidebar=new tt({data:this.data,socketConn:this.socketConn,returnToHostList:this.returnToHostList,domComponent:a("div",{class:"sidebar"}),openDashModal:this.openDashModal,closeDashModal:this.closeDashModal,getCurrentSpaceUUID:this.getCurrentSpaceUUID,openSpaceSettings:this.openSpaceSettings,loadChannel:this.loadChannel}),this.mainContent=new ft({socketConn:this.socketConn,data:this.data,domComponent:a("div",{id:"channel-content",class:"channel-content"})}),this.render()});c(this,"updateAccountUsername",(e,t)=>{this.data.user.username=e.data.username,this.sidebar.userAccountComponent.render(),this.openDashModal({type:"account",data:{user:this.data.user,active_devices:this.data.active_devices||[]}})});c(this,"getCurrentSpaceUUID",()=>this.currentSpaceUUID);c(this,"loadChannel",(e,t)=>{this.currentSpaceUUID=e,this.socketConn.joinChannel(t),this.sidebar.spaceUserListComponent.render(),this.mainContent.renderChannel(t)});c(this,"openDashModal",e=>this.dashModal.open(e));c(this,"closeDashModal",()=>{this.dashModal.close()});c(this,"openSpaceSettings",e=>{this.currentSpaceUUID=e.uuid,this.openDashModal({type:"space-settings",data:{space:e,user:this.data.user}})});c(this,"closeSpaceSettings",()=>{this.closeDashModal(),this.currentSpaceUUID=null});c(this,"handleCreateSpace",async e=>{this.data.spaces.push(e.data.space),this.sidebar.render()});c(this,"handleDeleteSpace",async()=>{if(!this.currentSpaceUUID)return;this.data.spaces=this.data.spaces.filter(t=>t.uuid!==this.currentSpaceUUID);const e=this.sidebar.spaceComponents.filter(t=>t.space.uuid!==this.currentSpaceUUID);this.sidebar.spaceComponents=e,this.currentSpaceUUID=null,this.mainContent.render(),this.sidebar.render(),this.sidebar.spaceUserListComponent.render(),this.closeSpaceSettings()});c(this,"handleInviteUser",e=>{window.alert("Invite sent")});c(this,"handleAddInvite",e=>{this.data.invites||(this.data.invites=[]),this.data.invites.push(e.data.invite)});c(this,"handleAcceptInvite",e=>{this.data.invites=this.data.invites.filter(t=>t.id!==e.data.space_user_id),this.data.spaces.push(e.data.space),this.sidebar.render(),this.openDashModal({type:"invites",data:{invites:this.data.invites,user:this.data.user}})});c(this,"handleAcceptInviteUpdate",e=>{console.log("invite update",e);const t=this.data.spaces.find(s=>s.uuid===e.data.space_uuid);t.users.find(s=>s.id===e.data.user.id||s.public_key&&e.data.user.public_key&&s.public_key===e.data.user.public_key)||t.users.push(e.data.user),t&&this.currentSpaceUUID===t.uuid&&this.data.user.id!==e.data.user.id&&this.sidebar.spaceUserListComponent.render()});c(this,"handleDeclineInvite",e=>{this.data.invites=this.data.invites.filter(t=>t.id!==e.data.space_user_id),this.openDashModal({type:"invites",data:{invites:this.data.invites,user:this.data.user}})});c(this,"handleLeaveSpace",()=>{this.data.spaces=this.data.spaces.filter(e=>e.uuid!==this.currentSpaceUUID),this.currentSpaceUUID=null,this.sidebar.render(),this.mainContent.render()});c(this,"handleLeaveSpaceUpdate",e=>{const t=this.data.spaces.find(s=>s.uuid===e.data.space_uuid);if(t&&this.currentSpaceUUID===t.uuid){const s=t.users.findIndex(i=>i.id===e.data.user_id||i.public_key&&e.data.user_public_key&&i.public_key===e.data.user_public_key);s>=0&&(t.users.splice(s,1),this.sidebar.spaceUserListComponent.render())}});c(this,"handleCreateChannel",e=>{const{space_uuid:t,channel:s}=e.data,i=this.data.spaces.find(l=>l.uuid===t);if(!i)return;i.channels.push(s);const o=this.sidebar.spaceComponents.find(l=>l.space.uuid===t);o&&o.render(),this.openDashModal({type:"space-settings",data:{space:i,user:this.data.user}})});c(this,"handleCreateChannelUpdate",e=>{const{space_uuid:t,channel:s}=e.data,i=this.data.spaces.find(r=>r.uuid===t);if(!i||i.channels.some(r=>r.uuid===s.uuid))return;i.channels.push(s);const l=this.sidebar.spaceComponents.find(r=>r.space.uuid===t);l&&l.render()});c(this,"handleDeleteChannel",e=>{const{uuid:t,space_uuid:s}=e.data,i=this.data.spaces.find(r=>r.uuid===s);if(!i)return;const o=i.channels.findIndex(r=>r.uuid===t);if(o===-1)return;i.channels.splice(o,1);const l=this.sidebar.spaceComponents.find(r=>r.space.uuid===s);l&&l.render(),this.openDashModal({type:"space-settings",data:{space:i,user:this.data.user}}),this.mainContent.currentChannelUUID===t&&(this.mainContent.currentChannelUUID=null,this.mainContent.chatApp=null,this.mainContent.render())});c(this,"handleDeleteChannelUpdate",e=>{const{uuid:t,space_uuid:s}=e.data,i=this.data.spaces.find(r=>r.uuid===s);if(!i)return;const o=i.channels.findIndex(r=>r.uuid===t);if(o===-1)return;i.channels.splice(o,1);const l=this.sidebar.spaceComponents.find(r=>r.space.uuid===s);l&&l.render(),this.mainContent.currentChannelUUID===t&&(this.mainContent.currentChannelUUID=null,this.mainContent.chatApp=null,this.mainContent.render())});c(this,"findSpaceByChannelUUID",e=>{var t;return!((t=this.data)!=null&&t.spaces)||!e?null:this.data.spaces.find(s=>(s.channels||[]).some(i=>i.uuid===e))||null});c(this,"resolveUsernameForAuthPublicKey",(e,t)=>{var i;if(!e||!((i=this.data)!=null&&i.spaces))return"unknown";const s=t?this.data.spaces.filter(o=>o.uuid===t):this.data.spaces;for(const o of s){const l=(o.users||[]).find(r=>r.public_key===e);if(l!=null&&l.username)return l.username}return"unknown"});c(this,"decryptWireMessage",async(e,t)=>{const s=await m.getOrCreateIdentity(),i=e==null?void 0:e.envelope;if(!i)throw new Error("Missing encrypted envelope");const o=await ue.decryptMessageForIdentity({envelope:i,identity:s}),l=i.sender_auth_public_key||"";return{...e,content:o,sender_auth_public_key:l,username:this.resolveUsernameForAuthPublicKey(l,t)}});c(this,"renderChatAppMessage",async e=>{if(this.mainContent.chatApp)try{const t=await this.decryptWireMessage(e.data,this.currentSpaceUUID),s=this.mainContent.chatApp.chatBoxComponent.chatBoxMessagesComponent;s.appendNewMessage(t),(t.sender_auth_public_key===this.data.user.public_key||s.isScrolledToBottom())&&s.scrollDown()}catch(t){console.error(t)}});c(this,"handleIncomingMessages",async e=>{if(e.data.messages&&this.mainContent.chatApp&&this.mainContent.chatApp.chatBoxComponent.channelUUID===e.data.channel_uuid){const t=this.mainContent.chatApp.chatBoxComponent.chatBoxMessagesComponent,s=t.domComponent,i=s.scrollHeight,o=s.scrollTop;t.hasMoreMessages=e.data.has_more_messages,t.isLoading=!1;const l=this.findSpaceByChannelUUID(e.data.channel_uuid),r=await Promise.all(e.data.messages.map(async d=>{try{return await this.decryptWireMessage(d,(l==null?void 0:l.uuid)||null)}catch(u){return console.error(u),{...d,content:"[Unable to decrypt message]",username:"unknown",sender_auth_public_key:""}}}));t.chatBoxMessages=[...r,...t.chatBoxMessages],t.render();const h=s.scrollHeight;s.scrollTop=h-i+o}});this.domComponent=a("div",{class:"dashboard-container"}),this.returnToHostList=e.returnToHostList,this.data=null,this.sidebar=null,this.dashModal=null,this.mainContent=null,this.currentSpaceUUID=null,this.socketConn=null}render(){this.domComponent.innerHTML="",this.domComponent.append(this.sidebar.domComponent,this.mainContent.domComponent,this.dashModal.domComponent)}}class vt{constructor(){c(this,"returnToHostList",async()=>{var e,t;localStorage.removeItem("hostUUID"),(e=this.dashboard)!=null&&e.socketConn&&this.dashboard.socketConn.hardClose(),(t=this.dashboard)!=null&&t.domComponent&&(this.dashboard.domComponent.innerHTML=""),this.dashboard=null,this.render({type:"host_form"})});c(this,"render",e=>{switch(this.domComponent.innerHTML="",e.type){case"dash":this.dashboard=new gt({returnToHostList:this.returnToHostList}),this.domComponent.append(this.dashboard.domComponent),this.dashboard.initialize();break;case"host_form":this.domComponent.append(this.hostForm.domComponent),this.hostForm.render({type:"known"});break;default:this.domComponent.append(this.hostForm.domComponent),this.hostForm.render({type:"known"})}});p.greet("Hello Parch").then(e=>console.log(e)),this.domComponent=document.getElementById("app"),this.hostForm=new Ct(this),this.render({type:"host_form"})}}class Ct{constructor(e){c(this,"renderHostList",e=>!e||!e.hosts||!e.hosts.length?[a("div",{},"...No Hosts")]:e.hosts.map(s=>{const i=s.online==1;return a("div",{class:"host-item"},[a("div",{style:"display: flex; align-items: baseline"},[a("span",{class:i?"host-online-span":"host-offline-span"}),a("div",{class:"host-item-name"},`${s.name} `)]),a("button",{class:"btn-small btn-red"},"Remove",{type:"click",event:o=>{o.stopPropagation(),p.confirm("Are you sure you want to remove this host?").then(l=>{l&&(p.removeHost(s.uuid),o.target.parentElement.remove())})}})],{type:"click",event:()=>{i?(localStorage.setItem("hostUUID",s.uuid),this.app.render({type:"dash"})):p.alert("Host is not online")}})}));c(this,"renderKnownHosts",async()=>{const t=(await p.getHosts()).map(i=>i.uuid);let s=[];try{s=await(await fetch(`${X}/api/hosts_by_uuids`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uuids:t})})).json()}catch(i){console.log(i),p.alert("Failed to connect to relay server")}this.domComponent.append(a("h2",{},"Select From Known Hosts"),a("br"),a("button",{},"Refresh",{type:"click",event:()=>{this.render({type:"known"})}}),a("br"),a("div",{class:"host-list-index"},[...this.renderHostList(s)]),a("br"),a("div",{},"Or"),a("br"),a("button",{class:""},"Add New Host",{type:"click",event:()=>{this.render({type:"new"})}}))});c(this,"renderNewHostForm",()=>{this.domComponent.append(a("h2",{},"Enter Host Key"),a("form",{id:"hostForm",onsubmit:this.handleSubmit},[a("fieldset",{},[a("legend",{},"New Host"),a("div",{class:"input-container"},[a("label",{for:"hostKey"},"Host Key"),a("input",{type:"text",id:"hostKey",name:"hostKey",required:!0})]),a("br"),a("button",{type:"submit"},"Continue")])],{type:"submit",event:e=>{e.preventDefault();const t=this.domComponent.querySelector("#hostKey").value;if(!t)return!1;p.verifyHostKey(t).then(s=>{this.render({type:"known"})}).catch(s=>{p.alert("Invalid host key"),console.error(s)})}}),a("br"),a("button",{},"Return To List",{type:"click",event:()=>{this.render({type:"known"})}}))});c(this,"render",e=>{switch(this.domComponent.innerHTML="",e.type){case"known":this.renderKnownHosts();break;case"new":this.renderNewHostForm();break;default:this.renderKnownHosts()}});this.app=e,this.domComponent=a("div",{class:"host-form-container"})}}new vt;
