var ge=Object.defineProperty;var Ce=(n,e,t)=>e in n?ge(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var o=(n,e,t)=>Ce(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const d of r.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&s(d)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();const Z="https://chat.parchchat.com",we="wss://chat.parchchat.com/ws",V="5837a5c3-5268-45e1-9ea4-ee87d959d067",ke="Parch Community";function a(n,e,t,s){if(typeof n>"u")return!1;var i=document.createElement(n);if(typeof e=="object")for(var r in e)i.setAttribute(r,e[r]);if(t)if(typeof t=="string"&&/<[^>]+>/.test(t))i.innerHTML=t;else{Array.isArray(t)||(t=[t]);for(var d=0;d<t.length;d++)t[d]instanceof Node?i.appendChild(t[d]):i.appendChild(document.createTextNode(t[d]))}if(s){Array.isArray(s)||(s=[s]);for(var l of s)i.addEventListener(l.type,l.event)}return i}const Q="parch.hosts";function B(){try{const n=localStorage.getItem(Q);if(!n)return[];const e=JSON.parse(n);return Array.isArray(e)?e:[]}catch{return[]}}function F(n){localStorage.setItem(Q,JSON.stringify(n))}const p={async greet(n){return`Hello ${n}, It's show time!`},async alert(n){window.alert(n)},async confirm(n){return window.confirm(n)},async openExternal(n){window.open(n,"_blank","noopener,noreferrer")},async getHosts(){const n=B();return n.some(e=>e.uuid===V)||(n.push({uuid:V,name:ke}),F(n)),n},async verifyHostKey(n){const e=await fetch(`${Z}/api/host/${n}`);if(!e.ok)throw new Error("host not found");const t=await e.json(),s=B();return s.some(i=>i.uuid===n)||(s.push({uuid:t.uuid,name:t.name}),F(s)),t},async removeHost(n){const e=B(),t=e.filter(s=>s.uuid!==n);if(t.length===e.length)throw new Error(`host with UUID ${n} not found`);F(t)}},I="parch.chat.identity",H="parch.chat.identity.sealed",z="parch.chat.device_id",ee="parch.chat.identity.last_exported_at",Se="parch.chat.identity.keys",_e=1,U="kv",j="device_wrap_key",te=21e4;let w=null,D=null,M=null,T=null,L=null,x=null;function m(){const n=globalThis==null?void 0:globalThis.crypto;if(!(n!=null&&n.subtle))throw new Error("WebCrypto API is not available");return n}function k(n){let e="";const t=n instanceof Uint8Array?n:new Uint8Array(n);for(let s=0;s<t.length;s+=1)e+=String.fromCharCode(t[s]);return btoa(e).replace(/=+$/g,"")}function S(n){const e=(4-n.length%4)%4,t=n+"=".repeat(e),s=atob(t),i=new Uint8Array(s.length);for(let r=0;r<s.length;r+=1)i[r]=s.charCodeAt(r);return i}function ne(){return typeof indexedDB<"u"}function se(){return ne()}function W(n){try{const e=localStorage.getItem(n);if(!e)return null;const t=JSON.parse(e);return!t||typeof t!="object"?null:t}catch{return null}}function A(n,e){localStorage.setItem(n,JSON.stringify(e))}function Ue(){w=null,D=null,M=null,T=null}function R(n){if(!n||typeof n!="object")throw new Error("Identity payload must be an object");const e=typeof n.publicKey=="string"?n.publicKey.trim():"",t=typeof n.privateKey=="string"?n.privateKey.trim():"",s=typeof n.encPublicKey=="string"?n.encPublicKey.trim():"",i=typeof n.encPrivateKey=="string"?n.encPrivateKey.trim():"",r=typeof n.username=="string"?n.username.trim():"";if(!e||!t||!s||!i)throw new Error("Identity must include auth and encryption keypairs");return{publicKey:e,privateKey:t,encPublicKey:s,encPrivateKey:i,username:r}}function ae(n){if(!n||typeof n!="object")return null;const e=typeof n.publicKey=="string"?n.publicKey.trim():"",t=typeof n.encPublicKey=="string"?n.encPublicKey.trim():"",s=typeof n.username=="string"?n.username.trim():"";return!e||!t?null:{version:2,publicKey:e,encPublicKey:t,username:s}}function Ie(n){if(!n||typeof n!="object")throw new Error("Invalid private key bundle");const e=typeof n.privateKey=="string"?n.privateKey.trim():"",t=typeof n.encPrivateKey=="string"?n.encPrivateKey.trim():"";if(!e||!t)throw new Error("Private key bundle is incomplete");return{privateKey:e,encPrivateKey:t}}function De(){const n=localStorage.getItem(z);if(typeof n=="string"&&n.trim()!=="")return n.trim();const e=k(m().getRandomValues(new Uint8Array(16)));return localStorage.setItem(z,e),e}function Ke(){var e;const n=(((e=globalThis==null?void 0:globalThis.navigator)==null?void 0:e.userAgent)||"").toLowerCase();return n.includes("edg/")?"Edge":n.includes("firefox/")?"Firefox":n.includes("safari/")&&!n.includes("chrome/")?"Safari":n.includes("chrome/")?"Chrome":"Browser"}function Pe(){var i;const n=De(),e=Ke(),t=String(((i=globalThis==null?void 0:globalThis.navigator)==null?void 0:i.platform)||"Unknown"),s=`${e} on ${t}`.slice(0,80);return{deviceId:n,deviceName:s}}function xe(){localStorage.setItem(ee,new Date().toISOString())}function Ee(){const n=localStorage.getItem(ee);return typeof n=="string"?n:""}function ie(n){const e=typeof n=="string"?n:"";if(e.length<8)throw new Error("Passphrase must be at least 8 characters");return e}async function q(n){return m().subtle.importKey("pkcs8",S(n),{name:"Ed25519"},!1,["sign"])}async function J(n){return m().subtle.importKey("pkcs8",S(n),{name:"ECDH",namedCurve:"P-256"},!1,["deriveBits"])}async function Ae(n){return m().subtle.importKey("raw",S(n),{name:"Ed25519"},!1,["verify"])}async function Me(n){return m().subtle.importKey("spki",S(n),{name:"ECDH",namedCurve:"P-256"},!1,[])}async function re(n){const e=await q(n.privateKey),t=await Ae(n.publicKey),s=new TextEncoder().encode("parch-identity-check"),i=await m().subtle.sign({name:"Ed25519"},e,s);if(!await m().subtle.verify({name:"Ed25519"},t,i,s))throw new Error("Public/private key mismatch");await J(n.encPrivateKey),await Me(n.encPublicKey)}async function Te(){const n=m(),e=await n.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveBits"]),t=await n.subtle.exportKey("spki",e.publicKey),s=await n.subtle.exportKey("pkcs8",e.privateKey);return{encPublicKey:k(t),encPrivateKey:k(s)}}async function oe(){return ne()?L||(L=new Promise(n=>{try{const e=indexedDB.open(Se,_e);e.onerror=()=>n(null),e.onupgradeneeded=()=>{const t=e.result;t.objectStoreNames.contains(U)||t.createObjectStore(U)},e.onsuccess=()=>n(e.result)}catch{n(null)}}),L):null}async function Re(n,e){return new Promise(t=>{try{const r=n.transaction(U,"readonly").objectStore(U).get(e);r.onsuccess=()=>t(r.result||null),r.onerror=()=>t(null)}catch{t(null)}})}async function Ne(n,e,t){return new Promise(s=>{try{const i=n.transaction(U,"readwrite");i.oncomplete=()=>s(!0),i.onerror=()=>s(!1),i.objectStore(U).put(t,e)}catch{s(!1)}})}async function Le(n,e){return new Promise(t=>{try{const s=n.transaction(U,"readwrite");s.oncomplete=()=>t(!0),s.onerror=()=>t(!1),s.objectStore(U).delete(e)}catch{t(!1)}})}async function ce(){return se()?x||(x=(async()=>{const n=await oe();if(!n)return null;const e=await Re(n,j);if(e)return e;const t=await m().subtle.generateKey({name:"AES-GCM",length:256},!1,["encrypt","decrypt"]);return await Ne(n,j,t)?t:null})().catch(()=>null),x):null}async function He(n,e,t){const s=new TextEncoder().encode(n),i=await m().subtle.importKey("raw",s,"PBKDF2",!1,["deriveKey"]);return m().subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",iterations:te,salt:e},i,{name:"AES-GCM",length:256},!1,t)}async function Oe(n,e){const t=m().getRandomValues(new Uint8Array(16)),s=m().getRandomValues(new Uint8Array(12)),i=await He(e,t,["encrypt"]),r=await m().subtle.encrypt({name:"AES-GCM",iv:s},i,n);return{type:"parch.encrypted_identity_backup.v1",kdf:{name:"PBKDF2",hash:"SHA-256",iterations:te,salt:k(t)},cipher:{name:"AES-GCM",iv:k(s),ciphertext:k(r)}}}async function Be(n,e){var v,c,h,u;if(!n||n.type!=="parch.encrypted_identity_backup.v1")throw new Error("Unsupported backup format");const t=Number((v=n==null?void 0:n.kdf)==null?void 0:v.iterations);if(!Number.isInteger(t)||t<1e5)throw new Error("Invalid backup key derivation settings");const s=S(String(((c=n==null?void 0:n.kdf)==null?void 0:c.salt)||"")),i=S(String(((h=n==null?void 0:n.cipher)==null?void 0:h.iv)||"")),r=S(String(((u=n==null?void 0:n.cipher)==null?void 0:u.ciphertext)||"")),d=new TextEncoder().encode(e),l=await m().subtle.importKey("raw",d,"PBKDF2",!1,["deriveKey"]),f=await m().subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",iterations:t,salt:s},l,{name:"AES-GCM",length:256},!1,["decrypt"]);return m().subtle.decrypt({name:"AES-GCM",iv:i},f,r)}async function Fe(n){const e=await ce();if(!e)return null;const t=m().getRandomValues(new Uint8Array(12)),s=new TextEncoder().encode(JSON.stringify(n)),i=await m().subtle.encrypt({name:"AES-GCM",iv:t},e,s);return{type:"parch.identity.sealed.v1",iv:k(t),ciphertext:k(i)}}async function je(n){if(!n||n.type!=="parch.identity.sealed.v1")throw new Error("Missing sealed private key material");const e=await ce();if(!e)throw new Error("Secure key vault unavailable");const t=S(String(n.iv||"")),s=S(String(n.ciphertext||"")),i=await m().subtle.decrypt({name:"AES-GCM",iv:t},e,s),r=JSON.parse(new TextDecoder().decode(i));return Ie(r)}function We(n){const e={publicKey:n.publicKey,encPublicKey:n.encPublicKey,username:n.username||""};return se()||(e.privateKey=n.privateKey,e.encPrivateKey=n.encPrivateKey),e}async function le(n){w=We(n),D={privateKey:n.privateKey,encPrivateKey:n.encPrivateKey},M=await q(n.privateKey),T=await J(n.encPrivateKey)}async function O(n){const e=R(n);await re(e);const t={version:2,publicKey:e.publicKey,encPublicKey:e.encPublicKey,username:e.username||""},s=await Fe({privateKey:e.privateKey,encPrivateKey:e.encPrivateKey});return s?(A(I,t),A(H,s)):(A(I,e),localStorage.removeItem(H)),await le(e),w}async function Y(){const n=m(),e=await n.subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),t=await n.subtle.exportKey("raw",e.publicKey),s=await n.subtle.exportKey("pkcs8",e.privateKey),i=await Te();return O({publicKey:k(t),privateKey:k(s),encPublicKey:i.encPublicKey,encPrivateKey:i.encPrivateKey,username:""})}async function N(){if(w&&M&&T&&D)return w;const n=W(I);if(!n)return Y();if(typeof n.privateKey=="string"&&typeof n.encPrivateKey=="string"){const r=R(n);return O(r)}const e=ae(n);if(!e)return Y();const t=W(H);if(!t)throw new Error("Identity private keys are unavailable on this device. Import an encrypted backup or reset identity.");const s=await je(t),i=R({publicKey:e.publicKey,privateKey:s.privateKey,encPublicKey:e.encPublicKey,encPrivateKey:s.encPrivateKey,username:e.username||""});return await re(i),await le(i),w}async function de(n){if(n!=null&&n.privateKey)return q(n.privateKey);if(await N(),!M)throw new Error("Signing key unavailable");return M}async function qe(n){if(n!=null&&n.encPrivateKey)return J(n.encPrivateKey);if(await N(),!T)throw new Error("Encryption key unavailable");return T}async function Je(){return N()}async function $e(n,e){if(!e||typeof e!="string")throw new Error("Missing auth message");const t=new TextEncoder().encode(e),s=await de(n),i=await m().subtle.sign({name:"Ed25519"},s,t);return k(i)}async function Ge(n,e,t){const s=m(),i=S(n),r=S(t),d=await s.subtle.importKey("raw",i,{name:"Ed25519"},!1,["verify"]),l=new TextEncoder().encode(e);return s.subtle.verify({name:"Ed25519"},d,r,l)}async function Ve(){if(await N(),!w||!D)throw new Error("Identity not available");return JSON.stringify({...w,...D},null,2)}async function ze(n){const e=ie(n);if(await N(),!w||!D)throw new Error("Identity not available");const t=new TextEncoder().encode(JSON.stringify({...w,...D})),s=await Oe(t,e);return JSON.stringify(s,null,2)}async function Ye(n){let e=n;if(typeof n=="string")try{e=JSON.parse(n)}catch{throw new Error("Identity import text must be valid JSON")}if((e==null?void 0:e.type)==="parch.encrypted_identity_backup.v1")throw new Error("Encrypted backup detected. Use passphrase import.");const t=R(e);return O(t)}async function Xe(n,e){const t=ie(e);let s=n;if(typeof n=="string")try{s=JSON.parse(n)}catch{throw new Error("Backup import text must be valid JSON")}const i=await Be(s,t);let r;try{r=JSON.parse(new TextDecoder().decode(i))}catch{throw new Error("Invalid backup payload")}const d=R(r);return O(d)}function Ze(n){const e=(n||"").trim(),t=W(I);if(t&&typeof t.privateKey=="string"&&typeof t.encPrivateKey=="string")t.username=e,A(I,t);else if(t&&typeof t=="object"){const s=ae(t);s&&(s.username=e,A(I,s))}w&&(w.username=e)}function Qe(){Ue(),localStorage.removeItem(I),localStorage.removeItem(H),oe().then(n=>n?Le(n,j):!1).catch(()=>!1),x=null}const b={getOrCreateIdentity:Je,getDeviceMetadata:Pe,getSigningPrivateKey:de,getEncryptionPrivateKey:qe,signAuthMessage:$e,verifyAuthSignature:Ge,exportIdentity:Ve,exportEncryptedIdentity:ze,markIdentityExportedNow:xe,getLastExportedAt:Ee,importIdentity:Ye,importEncryptedIdentity:Xe,setIdentityUsername:Ze,clearIdentity:Qe};class et{constructor(e,t){o(this,"open",e=>(this.domComponent.style.display="block",this.render(e)));o(this,"close",()=>{this.domComponent.style.display="none"});o(this,"renderPrompt",e=>new Promise(t=>{this.promptResolver=t,this.domComponent.append(a("div",{class:"modal-content"},[a("div",{class:"modal-header"},[a("h2",{},e||"Enter a value")]),a("div",{class:"modal-body"},[a("input",{id:"prompt-input",type:"text",style:"width: 100%; margin-bottom: 10px;"}),a("div",{style:"text-align: right;"},[a("button",{class:"btn"},"OK",{type:"click",event:()=>{const s=this.domComponent.querySelector("#prompt-input").value;this.close(),this.promptResolver(s)}}),a("button",{class:"btn btn-red",style:"margin-left: 10px;"},"Cancel",{type:"click",event:()=>{this.close(),this.promptResolver(null)}})])])]))}));o(this,"renderAuthorSettings",e=>[a("div",{class:"settings-section"},[a("h3",{},"Space Management"),a("div",{class:"settings-actions"},[a("button",{class:"btn"},"Invite User",{type:"click",event:()=>{this.render({type:"prompt",data:{message:"Enter recipient public key"}}).then(t=>{t&&this.socketConn.inviteUser({public_key:t.trim(),space_uuid:e.uuid})})}}),a("button",{class:"btn btn-red"},"Delete Space",{type:"click",event:()=>{p.confirm("Are you sure you want to delete this space?").then(t=>{t&&this.socketConn.deleteSpace({uuid:e.uuid})})}})])]),a("div",{class:"settings-section"},[a("h3",{},"Channel Management"),a("div",{class:"settings-actions"},[a("button",{class:"btn"},"+ Create Channel",{type:"click",event:()=>{this.render({type:"prompt",data:{message:"Please enter Channel name"}}).then(t=>{t&&this.socketConn.createChannel({name:t.trim(),space_uuid:e.uuid})})}})]),a("div",{class:"channels-list"},e.channels.map(t=>a("div",{class:"channel-item"},[a("span",{},t.name),a("button",{class:"btn-small btn-red"},"Delete",{type:"click",event:()=>{p.confirm("Are you sure you want to delete this channel?").then(s=>{s&&this.socketConn.deleteChannel({uuid:t.uuid,space_uuid:e.uuid})})}})])))])]);o(this,"renderSpaceUserSettings",(e,t)=>[a("div",{class:"settings-section"},[a("h3",{},"Space Management"),a("div",{class:"settings-actions"},[a("button",{class:"btn btn-red"},"Leave Space",{type:"click",event:()=>{p.confirm("Are you sure you want to leave this space?").then(s=>{s&&this.socketConn.leaveSpace({space_uuid:e.uuid,user_id:t.id,user_public_key:t.public_key||"",user_enc_public_key:t.enc_public_key||""})})}})])])]);o(this,"renderAccount",(e,t=[])=>{const s=c=>{if(!c)return"Never";const h=new Date(c);return Number.isNaN(h.getTime())?"Unknown":h.toLocaleString()},i=c=>!c||typeof c!="string"?"Unknown":c.length<=20?c:`${c.slice(0,10)}...${c.slice(-8)}`,r=async(c,h)=>{var u;if((u=navigator.clipboard)!=null&&u.writeText){await navigator.clipboard.writeText(c);return}if(!h)throw new Error("No copy source");h.focus(),h.select(),document.execCommand("copy")},d=async()=>{const c=this.domComponent.querySelector("#identity-export-passphrase"),h=this.domComponent.querySelector("#identity-export-display"),u=((c==null?void 0:c.value)||"").trim();if(u.length<8)throw new Error("Enter a backup passphrase (8+ chars)");const y=await b.exportEncryptedIdentity(u);return h&&(h.value=y),y},l=async(c,h)=>{if(!c){p.alert("No backup data provided");return}if(!h||h.length<8){p.alert("Enter an import passphrase (8+ chars)");return}if(await p.confirm("Import identity and replace the current local identity on this browser?"))try{await b.importEncryptedIdentity(c,h),p.alert("Identity imported. Reloading..."),window.location.reload()}catch(y){console.error(y),p.alert((y==null?void 0:y.message)||"Failed to import encrypted backup")}},f=()=>{const c=this.domComponent.querySelector("#last-exported-at");c&&(c.textContent=s(b.getLastExportedAt()))},v=()=>{const c=this.domComponent.querySelector("#active-devices-list");if(!c)return;if(c.innerHTML="",!Array.isArray(t)||t.length===0){c.append(a("div",{class:"account-device-empty"},"No active device sessions detected on this host."));return}const h=t.map(u=>{const y=`${u.device_name||"Unknown Device"}${u.is_current?" (This device)":""}`,g=`Last seen: ${s(u.last_seen||"")}`;return a("div",{class:"account-device-item"},[a("div",{class:"account-device-name"},y),a("div",{class:"account-device-meta"},g)])});c.append(...h)};this.domComponent.append(a("div",{class:"modal-content account-modal-content"},[a("div",{class:"modal-header"},[a("h2",{},"Account"),a("button",{class:"close-modal"},"×",{type:"click",event:this.close})]),a("div",{class:"modal-body account-modal-body"},[a("div",{class:"account-overview"},[a("div",{class:"account-overview-row"},[a("div",{class:"account-overview-title"},e.username||"unknown"),a("div",{class:"account-overview-subtitle"},`Host User ID: ${e.id||"unknown"}`)]),a("div",{class:"account-overview-meta"},[a("span",{class:"account-meta-label"},"Last Exported"),a("span",{id:"last-exported-at",class:"account-meta-value"},"Never")])]),a("div",{class:"account-grid"},[a("div",{class:"settings-section account-card"},[a("div",{class:"account-card-title"},"Public Key"),a("p",{class:"account-help"},"Share this public key with space admins so they can invite this identity."),a("textarea",{id:"public-key-display",class:"account-textarea account-textarea--compact",readonly:"readonly",rows:"4"}),a("div",{class:"account-actions"},[a("button",{class:"btn",id:"copy-public-key-btn"},"Copy Public Key",{type:"click",event:async()=>{const c=this.domComponent.querySelector("#public-key-display"),h=((c==null?void 0:c.value)||"").trim();if(!h){p.alert("Public key not available yet");return}try{await r(h,c),p.alert("Public key copied")}catch{p.alert("Failed to copy public key")}}})]),a("p",{id:"account-key-fingerprint",class:"account-inline-mono"},`Fingerprint: ${i(e.public_key||"")}`)]),a("div",{class:"settings-section account-card"},[a("div",{class:"account-card-title"},"Active Devices"),a("p",{class:"account-help"},"Sessions currently active for this identity on this host."),a("div",{id:"active-devices-list",class:"account-device-list"})])]),a("div",{class:"account-grid"},[a("div",{class:"settings-section account-card"},[a("div",{class:"account-card-title"},"Create Encrypted Backup"),a("p",{class:"account-warning"},"If you lose both backup file and passphrase, this identity cannot be recovered."),a("div",{class:"input-container account-input-wrap"},[a("label",{for:"identity-export-passphrase"},"Backup Passphrase"),a("input",{id:"identity-export-passphrase",class:"account-input",type:"password",placeholder:"At least 8 characters",autocomplete:"new-password"})]),a("textarea",{id:"identity-export-display",class:"account-textarea",readonly:"readonly",rows:"6",placeholder:"Encrypted backup JSON appears here after generation"}),a("div",{class:"account-actions"},[a("button",{class:"btn",id:"generate-identity-backup-btn"},"Generate",{type:"click",event:async()=>{try{await d()}catch(c){p.alert((c==null?void 0:c.message)||"Failed to generate encrypted backup")}}}),a("button",{class:"btn",id:"copy-identity-btn"},"Copy Backup",{type:"click",event:async()=>{const c=this.domComponent.querySelector("#identity-export-display"),h=((c==null?void 0:c.value)||"").trim();if(!h){p.alert("Generate backup first");return}try{await r(h,c),b.markIdentityExportedNow(),f(),p.alert("Encrypted backup copied")}catch{p.alert("Failed to copy backup")}}}),a("button",{class:"btn",id:"download-identity-btn"},"Download File",{type:"click",event:async()=>{try{const c=this.domComponent.querySelector("#identity-export-display"),h=((c==null?void 0:c.value)||"").trim()||await d(),u=new Blob([h],{type:"application/json"}),y=URL.createObjectURL(u),g=document.createElement("a");g.href=y,g.download="parch-identity-backup.enc.json",document.body.appendChild(g),g.click(),g.remove(),URL.revokeObjectURL(y),b.markIdentityExportedNow(),f()}catch(c){p.alert((c==null?void 0:c.message)||"Failed to generate backup file")}}})])]),a("div",{class:"settings-section account-card"},[a("div",{class:"account-card-title"},"Restore Encrypted Backup"),a("p",{class:"account-help"},"Importing will replace the current local identity on this browser."),a("div",{class:"input-container account-input-wrap"},[a("label",{for:"identity-import-passphrase"},"Import Passphrase"),a("input",{id:"identity-import-passphrase",class:"account-input",type:"password",placeholder:"Passphrase used for backup",autocomplete:"off"})]),a("textarea",{id:"identity-import-input",class:"account-textarea",rows:"6",placeholder:"Paste encrypted backup JSON here to import"}),a("div",{class:"account-actions"},[a("button",{class:"btn",id:"import-identity-btn"},"Import Backup",{type:"click",event:async()=>{const c=this.domComponent.querySelector("#identity-import-input"),h=this.domComponent.querySelector("#identity-import-passphrase"),u=((c==null?void 0:c.value)||"").trim(),y=((h==null?void 0:h.value)||"").trim();if(!u){p.alert("Paste encrypted backup JSON to import");return}await l(u,y)}}),a("button",{class:"btn",id:"import-identity-file-btn"},"Load File",{type:"click",event:()=>{const c=this.domComponent.querySelector("#identity-import-file");c&&(c.value="",c.click())}})]),a("input",{id:"identity-import-file",type:"file",accept:"application/json,.json",style:"display: none;"},null,{type:"change",event:async c=>{var u,y;const h=(y=(u=c==null?void 0:c.target)==null?void 0:u.files)==null?void 0:y[0];if(h)try{const g=await h.text(),_=this.domComponent.querySelector("#identity-import-input");_&&(_.value=g)}catch{p.alert("Failed to read backup file")}}})])]),a("div",{class:"account-grid"},[a("div",{class:"settings-section account-card"},[a("div",{class:"account-card-title"},"Local Fallback Username"),a("p",{class:"account-help"},"Used as the default username sent during auth when this browser joins a host."),a("div",{class:"input-container account-input-wrap"},[a("label",{for:"local-identity-username"},"Local Username"),a("input",{id:"local-identity-username",name:"localIdentityUsername",class:"account-input",type:"text",value:"",placeholder:"Set local fallback username"})]),a("div",{class:"account-actions"},[a("button",{class:"btn"},"Save Local Username",{type:"click",event:()=>{const c=this.domComponent.querySelector("#local-identity-username"),h=((c==null?void 0:c.value)||"").trim();b.setIdentityUsername(h),p.alert("Local fallback username saved")}})])]),a("div",{class:"settings-section account-card"},[a("div",{class:"account-card-title"},"Host Profile Username"),a("p",{class:"account-help"},"This updates your username for this host only."),a("form",{id:"update-username-form",class:"account-form"},[a("div",{class:"input-container account-input-wrap"},[a("label",{for:"username"},"Host Username"),a("input",{id:"username",name:"username",class:"account-input",type:"text",required:!0,value:e.username||""})]),a("div",{class:"account-actions"},[a("button",{type:"submit"},"Update Username")])],{type:"submit",event:c=>{c.preventDefault();const h=new FormData(c.target),u=Object.fromEntries(h.entries());u.user_id=e.id,u.user_public_key=e.public_key||"",u.user_enc_public_key=e.enc_public_key||"",this.socketConn.updateUsername(u)}})])]),a("div",{class:"settings-section account-card account-danger-zone"},[a("div",{class:"account-card-title account-card-title--danger"},"Danger Zone"),a("p",{class:"account-help"},"Reset identity creates a new keypair and account identity for this browser."),a("div",{class:"account-actions"},[a("button",{class:"btn-red"},"Reset Identity",{type:"click",event:()=>{p.confirm("Reset local identity key? This creates a new account identity.").then(c=>{c&&(b.clearIdentity(),window.location.reload())})}})])])])])),b.getOrCreateIdentity().then(c=>{const h=this.domComponent.querySelector("#public-key-display"),u=this.domComponent.querySelector("#local-identity-username"),y=this.domComponent.querySelector("#account-key-fingerprint");h&&(h.value=c.publicKey||""),u&&(u.value=c.username||""),y&&(y.textContent=`Fingerprint: ${i(c.publicKey||"")}`)}).catch(()=>{const c=this.domComponent.querySelector("#public-key-display"),h=this.domComponent.querySelector("#local-identity-username"),u=this.domComponent.querySelector("#identity-export-display");c&&(c.value=""),h&&(h.value=""),u&&(u.value="")}),f(),v()});o(this,"renderInvites",(e,t)=>{this.domComponent.append(a("div",{class:"modal-content"},[a("div",{class:"modal-header"},[a("h2",{},"Space Invites"),a("button",{class:"close-modal"},"×",{type:"click",event:this.close})]),a("div",{class:"modal-body"},e&&e.length&&t?a("div",{class:"invites-section"},[...e.map(s=>a("div",{class:"pending-invites-item"},[a("span",{},s.name),a("div",{},[a("button",{class:"btn-small accept-invite"},"Accept",{type:"click",event:()=>this.socketConn.acceptInvite({space_user_id:s.id,user_id:t.id,user_public_key:t.public_key||"",user_enc_public_key:t.enc_public_key||""})}),a("button",{class:"btn-small btn-red decline-invite"},"Decline",{type:"click",event:()=>this.socketConn.declineInvite({space_user_id:s.id,user_id:t.id,user_public_key:t.public_key||"",user_enc_public_key:t.enc_public_key||""})})])]))]):"...No Invite Yet")]))});o(this,"render",e=>{var t;switch(this.domComponent.innerHTML="",e.type){case"prompt":if((t=e.data)!=null&&t.message)return this.renderPrompt(e.data.message);break;case"account":e.data.user&&this.renderAccount(e.data.user,e.data.active_devices||[]);break;case"invites":this.renderInvites(e.data.invites,e.data.user);break;case"space-settings":if(e.data.space&&e.data.user){const s=e.data.space,i=e.data.user,r=s.author_id===i.id;this.domComponent.append(a("div",{class:"modal-content"},[a("div",{class:"modal-header"},[a("h2",{},`Space Settings: ${s.name}`),a("button",{class:"close-modal"},"×",{type:"click",event:this.close})]),a("div",{class:"modal-body"},r?this.renderAuthorSettings(s):this.renderSpaceUserSettings(s,i))]))}break}});this.app=e,this.socketConn=t,this.domComponent=a("div",{class:"modal"}),this.promptResolver=null}}class tt{constructor(e){o(this,"initSpaceComponents",()=>{this.data.spaces&&(this.spaceComponents=this.data.spaces.map(e=>new X({domComponent:a("div",{class:"space-item"}),space:e,user:this.data.user,openSpaceSettings:this.openSpaceSettings,loadChannel:this.loadChannel})))});o(this,"addSpace",e=>{const t=new X({domComponent:a("div",{class:"space-item"}),space:e,user:this.data.user,openSpaceSettings:this.openSpaceSettings,loadChannel:this.loadChannel});this.spaceComponents.push(t),this.render()});o(this,"render",()=>{this.domComponent.innerHTML="",this.initSpaceComponents(),this.userAccountComponent=new nt({data:this.data,returnToHostList:this.returnToHostList,openDashModal:this.openDashModal,domComponent:a("div",{class:"user-component"})}),this.spaceUserListComponent=new st({data:this.data,socketConn:this.socketConn,getCurrentSpaceUUID:this.getCurrentSpaceUUID,domComponent:a("div",{class:"space-users-list",id:"space-users-list"})}),this.domComponent.append(a("div",{class:"sidebar-spaces-container"},[a("div",{id:"spaces-list"},this.spaceComponents.map(e=>e.domComponent)),a("button",{class:"create-space-btn",id:"new-space-btn"},"+ Create New Space",{type:"click",event:()=>{this.openDashModal({type:"prompt",data:{message:"Please enter Space 'Name'"}}).then(e=>{e&&(e.trim(),this.socketConn.createSpace({name:e}))})}})]),a("br"),this.spaceUserListComponent.domComponent,a("hr"),this.userAccountComponent.domComponent)});this.data=e.data,this.socketConn=e.socketConn,this.returnToHostList=e.returnToHostList,this.openDashModal=e.openDashModal,this.closeDashModal=e.closeDashModal,this.getCurrentSpaceUUID=e.getCurrentSpaceUUID,this.spaceComponents=[],this.domComponent=e.domComponent,this.openSpaceSettings=e.openSpaceSettings,this.loadChannel=e.loadChannel,this.render()}}class nt{constructor(e){o(this,"render",()=>{this.domComponent.innerHTML="",this.domComponent.append(a("a",{href:"#"},"Account",{type:"click",event:e=>{this.openDashModal({type:"account",data:{user:this.data.user,active_devices:this.data.active_devices||[]}})}}),a("a",{href:"#"},"Invites",{type:"click",event:e=>{this.openDashModal({type:"invites",data:{invites:this.data.invites,user:this.data.user}})}}),a("a",{href:"#"},"<- Host List",{type:"click",event:e=>{this.returnToHostList()}}))});this.data=e.data,this.returnToHostList=e.returnToHostList,this.openDashModal=e.openDashModal,this.domComponent=e.domComponent,this.render()}}class st{constructor(e){o(this,"isAuthor",(e,t)=>String(e.author_id)===String(t.id));o(this,"renderUserElement",(e,t)=>a("div",{class:"space-user-item",id:"space-user-item"},`${t.username} ${this.isAuthor(e,t)?"*":""}`,{type:"click",event:async()=>{this.isAuthor(e,this.data.user)&&this.data.user.id!=t.id&&p.confirm("Are you sure you want to remove this user?").then(s=>{s&&this.socketConn.removeSpaceUser({space_uuid:e.uuid,user_id:t.id,user_public_key:t.public_key||""})})}}));o(this,"renderSpaceUsersList",e=>{const t=[];return e.users&&e.users.map(s=>{t.push(this.renderUserElement(e,s))}),t});o(this,"render",()=>{this.domComponent.innerHTML="";const e=this.getCurrentSpaceUUID();if(e){const t=this.data.spaces.find(s=>s.uuid===e);if(!t)return;this.domComponent.append(a("h3",{},"Users"),...this.renderSpaceUsersList(t))}});this.data=e.data,this.socketConn=e.socketConn,this.getCurrentSpaceUUID=e.getCurrentSpaceUUID,this.domComponent=e.domComponent,this.render()}}class X{constructor(e){o(this,"isAuthor",()=>String(this.space.author_id)===String(this.user.id));o(this,"renderChannelList",()=>a("div",{class:"channel-list"},(this.space.channels||[]).map(e=>a("div",{class:"channel-item"},[a("span",{class:"channel-hash"},"#"),a("span",{},e.name)],{type:"click",event:()=>this.loadChannel(this.space.uuid,e.uuid)}))));o(this,"toggleChannels",()=>{this.channelsOpen=!this.channelsOpen,this.render()});o(this,"render",()=>{this.domComponent.textContent="",this.domComponent.className=`space-item${this.channelsOpen?" space-item--open":""}`,this.domComponent.append(a("div",{class:"space-header"},[a("span",{class:"space-chevron"}),a("span",{},this.space.name),a("div",{class:"space-actions"},a("button",{class:"btn-icon open-settings"},"⚙️",{type:"click",event:e=>{e.stopPropagation(),this.openSpaceSettings(this.space)}}))],{type:"click",event:this.toggleChannels}),...this.channelsOpen?[this.renderChannelList()]:[])});this.space=e.space,this.user=e.user,this.openSpaceSettings=e.openSpaceSettings,this.loadChannel=e.loadChannel,this.channelsOpen=!1,this.domComponent=e.domComponent,this.render()}}function at(n){const e=new Date(n),t=e.getFullYear(),s=(e.getMonth()+1).toString().padStart(2,"0"),i=e.getDate().toString().padStart(2,"0"),r=e.getHours(),d=e.getMinutes(),l=r%12||12,f=r<12?"am":"pm",v=d.toString().padStart(2,"0");return`${s}-${i}-${t} ${l}:${v}${f}`}const it="data:image/svg+xml;base64,"+btoa(`
    <svg xmlns="http://www.w3.org/2000/svg" width="150" height="100" viewBox="0 0 150 100">
      <rect width="150" height="100" fill="#aaaaa" />
      <text x="75" y="55" font-size="14" text-anchor="middle" fill="#a00" font-family="sans-serif">Image not found</text>
    </svg>
  `);function rt(n){const e=document.createElement("img");return e.src=n,e.alt="Image",e.style="max-width: 100%; max-height: 250px; margin: 5px; cursor: pointer;",e.onerror=()=>{e.src=it},e}function ot(n){const e=n.split(".");if(e.length<2)return!1;const t=e[e.length-1].toLowerCase().split("?")[0];return["jpg","jpeg","png","gif","webp","svg","tiff"].includes(t)}function P(){const n=globalThis==null?void 0:globalThis.crypto;if(!(n!=null&&n.subtle))throw new Error("WebCrypto API is not available");return n}function E(n){let e="";const t=n instanceof Uint8Array?n:new Uint8Array(n);for(let s=0;s<t.length;s+=1)e+=String.fromCharCode(t[s]);return btoa(e).replace(/=+$/g,"")}function K(n){const e=(4-n.length%4)%4,t=n+"=".repeat(e),s=atob(t),i=new Uint8Array(s.length);for(let r=0;r<s.length;r+=1)i[r]=s.charCodeAt(r);return i}function $(n){const e=Array.isArray(n.wrapped_keys)?[...n.wrapped_keys].sort((s,i)=>String(s.recipient_auth_public_key).localeCompare(String(i.recipient_auth_public_key))):[],t={v:n.v,alg:n.alg,message_id:n.message_id,sender_timestamp:n.sender_timestamp,space_uuid:n.space_uuid,channel_uuid:n.channel_uuid,sender_auth_public_key:n.sender_auth_public_key,sender_enc_public_key:n.sender_enc_public_key,content_iv:n.content_iv,ciphertext:n.ciphertext,wrapped_keys:e.map(s=>({recipient_auth_public_key:s.recipient_auth_public_key,iv:s.iv,ciphertext:s.ciphertext}))};return JSON.stringify(t)}function ct(){const n=P();return E(n.getRandomValues(new Uint8Array(16)))}async function he(n){return P().subtle.importKey("spki",K(n),{name:"ECDH",namedCurve:"P-256"},!1,[])}async function lt(n){return he(n)}async function dt(n){return P().subtle.importKey("pkcs8",K(n),{name:"ECDH",namedCurve:"P-256"},!1,["deriveBits"])}async function pe(n){return n!=null&&n.encPrivateKey?dt(n.encPrivateKey):b.getEncryptionPrivateKey(n)}async function ue(n,e,t){const s=P(),i=await s.subtle.deriveBits({name:"ECDH",public:e},n,256),r=await s.subtle.importKey("raw",i,"HKDF",!1,["deriveKey"]),d=new TextEncoder().encode(`parch-e2ee-wrap-salt:${t.space_uuid}:${t.channel_uuid}`),l=new TextEncoder().encode(`parch-e2ee-wrap-info:${t.sender_auth_public_key}`);return s.subtle.deriveKey({name:"HKDF",hash:"SHA-256",salt:d,info:l},r,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async function ht(n){const e=P(),{plaintext:t,spaceUUID:s,channelUUID:i,identity:r,recipients:d}=n;if(!(r!=null&&r.publicKey)||!(r!=null&&r.encPublicKey))throw new Error("Missing sender identity keys");if(!s||!i)throw new Error("Missing space/channel context");if(!Array.isArray(d)||d.length===0)throw new Error("No recipient keys available for encryption");const l=[],f=new Set;for(const C of d)!(C!=null&&C.authPublicKey)||!(C!=null&&C.encPublicKey)||f.has(C.authPublicKey)||(f.add(C.authPublicKey),l.push(C));f.has(r.publicKey)||l.push({authPublicKey:r.publicKey,encPublicKey:r.encPublicKey});const v=await e.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),c=new Uint8Array(await e.subtle.exportKey("raw",v)),h=e.getRandomValues(new Uint8Array(12)),u=new TextEncoder().encode(t),y=await e.subtle.encrypt({name:"AES-GCM",iv:h},v,u),g=await pe(r),_={v:1,alg:"p256-hkdf-aesgcm+ed25519",message_id:ct(),sender_timestamp:new Date().toISOString(),space_uuid:s,channel_uuid:i,sender_auth_public_key:r.publicKey,sender_enc_public_key:r.encPublicKey,content_iv:E(h),ciphertext:E(y),wrapped_keys:[]};for(const C of l){const fe=await he(C.encPublicKey),be=await ue(g,fe,_),G=e.getRandomValues(new Uint8Array(12)),ve=await e.subtle.encrypt({name:"AES-GCM",iv:G},be,c);_.wrapped_keys.push({recipient_auth_public_key:C.authPublicKey,iv:E(G),ciphertext:E(ve)})}const me=$(_);return _.sig=await b.signAuthMessage(r,me),_}async function pt(n){const e=P(),{envelope:t,identity:s}=n;if(!(t!=null&&t.sender_auth_public_key)||!(t!=null&&t.sender_enc_public_key)||!(t!=null&&t.sig))throw new Error("Invalid encrypted envelope");if(!(s!=null&&s.publicKey))throw new Error("Missing recipient identity");const i=$(t);if(!await b.verifyAuthSignature(t.sender_auth_public_key,i,t.sig))throw new Error("Invalid message signature");const d=(t.wrapped_keys||[]).find(y=>y.recipient_auth_public_key===s.publicKey);if(!d)throw new Error("No wrapped key for this identity");const l=await pe(s),f=await lt(t.sender_enc_public_key),v=await ue(l,f,t),c=await e.subtle.decrypt({name:"AES-GCM",iv:K(d.iv)},v,K(d.ciphertext)),h=await e.subtle.importKey("raw",c,{name:"AES-GCM",length:256},!1,["decrypt"]),u=await e.subtle.decrypt({name:"AES-GCM",iv:K(t.content_iv)},h,K(t.ciphertext));return new TextDecoder().decode(u)}const ye={encryptMessageForSpace:ht,decryptMessageForIdentity:pt,canonicalEnvelopeForSignature:$};class ut{constructor(e){o(this,"initialize",e=>{var s,i;this.chatBoxComponent=new yt({domComponent:a("div"),data:this.data,socketConn:this.socketConn,channelUUID:e}),this.render();const t=new Date().toISOString();this.socketConn.getMessages(t,(i=(s=this.chatBoxComponent)==null?void 0:s.space)==null?void 0:i.uuid)});o(this,"render",()=>{this.domComponent.innerHTML="",this.chatBoxComponent&&this.domComponent.append(this.chatBoxComponent.domComponent)});this.domComponent=e.domComponent,this.data=e.data,this.socketConn=e.socketConn,this.chatBoxComponent=null}}class yt{constructor(e){o(this,"render",()=>{this.domComponent.innerHTML="",this.domComponent.append(a("div",{class:"chatapp-channel-title"},this.channel.name),this.chatBoxMessagesComponent.domComponent,a("div",{class:"chat-box-form"},[a("textarea",{id:"chat-box-form-input",class:"chat-box-form-input",autofocus:!0,type:"text",required:!0,autocomplete:"off",placeholder:"Type message here..."},null,[{type:"input",event:e=>{const t=e.target;t.style.height="auto",t.style.height=`${t.scrollHeight}px`}},{type:"keydown",event:async e=>{var t,s,i;if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();const r=e.target,d=r.value.trim();if(d)try{const l=await b.getOrCreateIdentity(),f=(((t=this.space)==null?void 0:t.users)||[]).filter(c=>(c==null?void 0:c.public_key)&&(c==null?void 0:c.enc_public_key)).map(c=>({authPublicKey:c.public_key,encPublicKey:c.enc_public_key})),v=await ye.encryptMessageForSpace({plaintext:d,spaceUUID:(s=this.space)==null?void 0:s.uuid,channelUUID:this.channelUUID,identity:l,recipients:f});this.socketConn.sendMessage({envelope:v},(i=this.space)==null?void 0:i.uuid),r.value="",r.style.height="auto",r.focus()}catch(l){console.error(l),p.alert((l==null?void 0:l.message)||"Failed to encrypt message")}}}}])]))});var t;this.domComponent=e.domComponent,this.domComponent.className="chat-box-container",this.data=e.data,this.socketConn=e.socketConn,this.channelUUID=e.channelUUID;for(const s of this.data.spaces){const i=s.channels.find(r=>r.uuid===this.channelUUID);if(i){this.space=s,this.channel=i;break}}this.chatBoxMessagesComponent=new mt({domComponent:a("div",{class:"chat-box-messages",id:"chat-box-messages"}),channelUUID:this.channelUUID,spaceUUID:((t=this.space)==null?void 0:t.uuid)||"",socketConn:this.socketConn}),this.render()}}class mt{constructor(e){o(this,"getPreviousMessagesDebounce",()=>{this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.debounceTimeout=setTimeout(()=>{this.getPreviousMessages()},300)});o(this,"getPreviousMessages",()=>{if(this.isLoading||!this.hasMoreMessages||!this.chatBoxMessages.length||!this.isScrolledToTop())return;this.isLoading=!0;const e=this.chatBoxMessages[0].timestamp;this.socketConn.getMessages(e,this.spaceUUID)});o(this,"scrollDown",()=>{this.domComponent.scrollTop=this.domComponent.scrollHeight});o(this,"isScrolledToTop",()=>this.domComponent.scrollTop<=20);o(this,"isScrolledToBottom",()=>this.domComponent.scrollHeight-this.domComponent.scrollTop<=this.domComponent.clientHeight+40);o(this,"appendNewMessage",e=>{const t=this.isScrolledToBottom();this.chatBoxMessages.push(e),this.render(),t&&requestAnimationFrame(()=>this.scrollDown())});o(this,"createMessage",e=>{const t=s=>{const i=/(https?:\/\/[^\s]+)/g,r=/^https?:\/\/[^\s]+$/;return s.split(i).map(l=>r.test(l)?ot(l)?rt(l):a("a",{href:l,target:"_blank",rel:"noopener noreferrer",style:"margin: 0 5px;"},l):l)};return a("div",{class:"chat-box-message-content"},[a("div",{style:"display: flex; align-items: flex-end;"},[a("small",{style:"margin-right: var(--main-distance); color: var(--main-gray);"},at(e.timestamp)),a("div",{style:"font-weight: bold; margin-right: var(--main-distance); color: var(--light-yellow);"},e.username)]),a("div",{class:"chat-box-message-text"},[...t(e.content)]),a("hr")])});o(this,"render",()=>{this.domComponent.innerHTML="";const e=this.chatBoxMessages.map(t=>this.createMessage(t));this.domComponent.append(...e)});this.chatBoxMessages=[],this.channelUUID=e.channelUUID,this.spaceUUID=e.spaceUUID||"",this.socketConn=e.socketConn,this.messageRequestSize=50,this.hasMoreMessages=!0,this.debounceTimeout=null,this.isLoading=!1,this.domComponent=a("div",{class:"chat-box-messages",id:"chat-box-messages"},null,{type:"scroll",event:()=>{this.getPreviousMessagesDebounce()}})}}class ft{constructor(e){o(this,"renderChannel",e=>{this.currentChannelUUID=e,this.domComponent.innerHTML="";const t=a("div",{class:"chatapp-container"});this.domComponent.append(t),this.chatApp?this.chatApp.domComponent=t:this.chatApp=new ut({domComponent:t,data:this.data,socketConn:this.socketConn}),this.chatApp.initialize(e)});o(this,"cleanup",()=>{var e,t;this.chatApp&&((t=(e=this.chatApp).cleanup)==null||t.call(e),this.chatApp=null),this.currentChannelUUID=null});o(this,"render",()=>{this.cleanup(),this.domComponent.innerHTML="",this.domComponent.append(a("div",{class:"no-channel-selected"},[a("h2",{},"Select a channel to start chatting")]))});this.domComponent=e.domComponent,this.data=e.data,this.socketConn=e.socketConn,this.chatApp=null,this.currentChannelUUID=null,this.render()}}class bt{constructor(e){o(this,"retryConnection",()=>{if(this.retryCount+=1,this.retryCount>this.maxRetries){p.alert("Unable to reconnect to host. Returning to home."),this.returnToHostList();return}setTimeout(()=>{var t;((t=this.socket)==null?void 0:t.readyState)!==WebSocket.OPEN&&this.connect()},2e3)});o(this,"connect",()=>{this.socket=new WebSocket(we),this.socket.onopen=()=>{this.joinHost()},this.socket.onerror=e=>{console.error("WebSocket error:",e)},this.socket.onmessage=async e=>{var t,s,i,r,d;try{const l=JSON.parse(e.data);switch(l.type){case"join_ack":break;case"join_error":p.alert(((t=l.data)==null?void 0:t.error)||"Failed to join host"),this.returnToHostList();break;case"auth_challenge":await this.authenticateWithPublicKey((s=l.data)==null?void 0:s.challenge);break;case"auth_pubkey_success":this.closeDashModal(),this.getDashboardData();break;case"dash_data_payload":this.syncCapabilities(l.data),this.resolveCapabilityRefreshRequest(),this.hasInitialDashboardData||(this.hasInitialDashboardData=!0,this.dashboardInitialRender(l.data),this.joinAllSpaces(l));break;case"update_username_success":this.updateAccountUsername(l,this.hostUUID),b.setIdentityUsername(l.data.username);break;case"create_space_success":this.setCapability((i=l.data)==null?void 0:i.capability),this.handleCreateSpace(l);break;case"delete_space_success":this.handleDeleteSpace();break;case"create_channel_success":this.handleCreateChannel(l);break;case"create_channel_update":this.handleCreateChannelUpdate(l);break;case"delete_channel_success":this.handleDeleteChannel(l);break;case"delete_channel_update":this.handleDeleteChannelUpdate(l);break;case"invite_user_success":this.handleInviteUser(l);break;case"invite_user_update":this.handleAddInvite(l);break;case"accept_invite_success":this.setCapability((r=l.data)==null?void 0:r.capability),this.handleAcceptInvite(l);break;case"accept_invite_update":this.handleAcceptInviteUpdate(l);break;case"decline_invite_success":this.handleDeclineInvite(l);break;case"leave_space_success":this.handleLeaveSpace();break;case"leave_space_update":this.handleLeaveSpaceUpdate(l);break;case"chat":await this.renderChatAppMessage(l);break;case"get_messages_success":await this.handleIncomingMessages(l);break;case"error":this.retryCapabilityActionFromError(((d=l.data)==null?void 0:d.error)||"")||p.alert(l.data.error);break;case"authentication-error":p.alert(l.data.error||"Authentication failed");break;case"author_error":p.alert("Failed to connect to host. Host is offline."),this.rejectCapabilityRefreshRequest(new Error("host unavailable")),this.returnToHostList();break;default:break}}catch(l){console.error("JSON parsing error:",l)}},this.socket.onclose=()=>{this.rejectCapabilityRefreshRequest(new Error("socket closed")),!this.manualClose&&this.retryConnection()}});o(this,"authenticateWithPublicKey",async e=>{if(!e){p.alert("Missing auth challenge from server");return}try{const t=await b.getOrCreateIdentity(),s=b.getDeviceMetadata(),i=`parch-chat-auth:${this.hostUUID}:${e}:${t.encPublicKey}`,r=await b.signAuthMessage(t,i),d={type:"auth_pubkey",data:{public_key:t.publicKey,enc_public_key:t.encPublicKey,device_id:s.deviceId,device_name:s.deviceName,username:t.username||"",challenge:e,signature:r}};this.socket.send(JSON.stringify(d))}catch(t){console.error(t),p.alert("Failed to initialize public-key identity")}});o(this,"joinHost",()=>{var e;((e=this.socket)==null?void 0:e.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"join_host",data:{uuid:this.hostUUID}}))});o(this,"getDashboardData",()=>{var e;((e=this.socket)==null?void 0:e.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"get_dash_data",data:""}))});o(this,"syncCapabilities",(e={})=>{const t=(e==null?void 0:e.capabilities)||[];this.capabilityBySpaceUUID.clear(),t.forEach(s=>this.setCapability(s)),this.scheduleCapabilityRefresh()});o(this,"setCapability",e=>{!e||!e.space_uuid||!e.token||(this.capabilityBySpaceUUID.set(e.space_uuid,e),this.scheduleCapabilityRefresh())});o(this,"getCapabilityToken",e=>{if(!e)return"";const t=this.capabilityBySpaceUUID.get(e);return!t||!t.token?"":t.token});o(this,"hasFreshCapability",e=>{const t=this.capabilityBySpaceUUID.get(e);if(!t||!t.token)return!1;const s=Number(t.expires_at||0)*1e3;return!Number.isFinite(s)||s<=0?!1:s>Date.now()+this.capabilitySkewMs});o(this,"resolveCapabilityRefreshRequest",()=>{if(!this.capabilityRefreshResolve)return;const e=this.capabilityRefreshResolve;this.capabilityRefreshPromise=null,this.capabilityRefreshResolve=null,this.capabilityRefreshReject=null,e()});o(this,"rejectCapabilityRefreshRequest",e=>{if(!this.capabilityRefreshReject)return;const t=this.capabilityRefreshReject;this.capabilityRefreshPromise=null,this.capabilityRefreshResolve=null,this.capabilityRefreshReject=null,t(e)});o(this,"requestCapabilityRefresh",()=>{var e;return this.capabilityRefreshPromise?this.capabilityRefreshPromise:((e=this.socket)==null?void 0:e.readyState)!==WebSocket.OPEN?Promise.reject(new Error("socket not connected")):(this.capabilityRefreshPromise=new Promise((t,s)=>{this.capabilityRefreshResolve=t,this.capabilityRefreshReject=s,setTimeout(()=>{this.capabilityRefreshPromise&&this.rejectCapabilityRefreshRequest(new Error("capability refresh timed out"))},this.capabilityRefreshTimeoutMs),this.getDashboardData()}),this.capabilityRefreshPromise)});o(this,"scheduleCapabilityRefresh",()=>{if(this.capabilityRefreshTimer&&(clearTimeout(this.capabilityRefreshTimer),this.capabilityRefreshTimer=null),this.capabilityBySpaceUUID.size===0)return;let e=Number.POSITIVE_INFINITY;if(this.capabilityBySpaceUUID.forEach(s=>{const i=Number(s.expires_at||0)*1e3;Number.isFinite(i)&&i>0&&i<e&&(e=i)}),!Number.isFinite(e))return;const t=Math.max(1e3,e-Date.now()-this.capabilitySkewMs);this.capabilityRefreshTimer=setTimeout(()=>{this.requestCapabilityRefresh().catch(s=>{console.error("capability refresh failed:",s)})},t)});o(this,"sendWithCapability",(e,t)=>{const s=(i,r)=>{t(i||""),e&&r?this.lastCapabilityAction={attemptedAt:Date.now(),retried:!1,spaceUUID:e,sendFn:t}:this.lastCapabilityAction=null};if(!e){s(this.getCapabilityToken(e),!1);return}if(this.hasFreshCapability(e)){s(this.getCapabilityToken(e),!0);return}this.requestCapabilityRefresh().then(()=>{const i=this.getCapabilityToken(e);if(!i){p.alert("Session permissions expired. Please reopen the space.");return}s(i,!0)}).catch(i=>{console.error("capability refresh failed:",i),p.alert("Failed to refresh permissions. Please retry.")})});o(this,"retryCapabilityActionFromError",e=>{if(!String(e||"").toLowerCase().includes("unauthorized"))return!1;const s=this.lastCapabilityAction;return!s||s.retried?!1:Date.now()-s.attemptedAt>this.capabilityRetryWindowMs?(this.lastCapabilityAction=null,!1):(s.retried=!0,this.requestCapabilityRefresh().then(()=>{const i=this.getCapabilityToken(s.spaceUUID);if(!i){p.alert("Session permissions expired. Please reopen the space."),this.lastCapabilityAction=null;return}s.sendFn(i)}).catch(i=>{console.error("capability retry refresh failed:",i),p.alert(e||"Unauthorized")}),!0)});o(this,"joinAllSpaces",e=>{var t;if(((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const s=e.data.spaces.map(r=>r.uuid),i={};s.forEach(r=>{const d=this.getCapabilityToken(r);d&&(i[r]=d)}),this.socket.send(JSON.stringify({type:"join_all_spaces",data:{space_uuids:s,capability_tokens:i}}))}});o(this,"updateUsername",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"update_username",data:e}))});o(this,"createSpace",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"create_space",data:e}))});o(this,"deleteSpace",e=>{var t;if(((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const s=(e==null?void 0:e.uuid)||null;this.sendWithCapability(s,i=>{const r={...e};i&&(r.capability_token=i),this.socket.send(JSON.stringify({type:"delete_space",data:r}))})}});o(this,"createChannel",e=>{var t;if(((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const s=(e==null?void 0:e.space_uuid)||null;this.sendWithCapability(s,i=>{const r={...e};i&&(r.capability_token=i),this.socket.send(JSON.stringify({type:"create_channel",data:r}))})}});o(this,"deleteChannel",e=>{var t;if(((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const s=(e==null?void 0:e.space_uuid)||null;this.sendWithCapability(s,i=>{const r={...e};i&&(r.capability_token=i),this.socket.send(JSON.stringify({type:"delete_channel",data:r}))})}});o(this,"inviteUser",e=>{var t;if(((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const s=(e==null?void 0:e.space_uuid)||null;this.sendWithCapability(s,i=>{const r={...e};i&&(r.capability_token=i),this.socket.send(JSON.stringify({type:"invite_user",data:r}))})}});o(this,"acceptInvite",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"accept_invite",data:e}))});o(this,"declineInvite",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"decline_invite",data:e}))});o(this,"leaveSpace",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"leave_space",data:e}))});o(this,"removeSpaceUser",e=>{var t;if(((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const s=(e==null?void 0:e.space_uuid)||null;this.sendWithCapability(s,i=>{const r={...e};i&&(r.capability_token=i),this.socket.send(JSON.stringify({type:"remove_space_user",data:r}))})}});o(this,"joinChannel",(e,t=null)=>{var r;const s=t||e,i=t?e:null;((r=this.socket)==null?void 0:r.readyState)===WebSocket.OPEN&&this.sendWithCapability(i,d=>{const l={uuid:s};d&&(l.capability_token=d),this.socket.send(JSON.stringify({type:"join_channel",data:l}))})});o(this,"sendMessage",(e,t=null)=>{var s,i;if(((s=this.socket)==null?void 0:s.readyState)===WebSocket.OPEN){const r=t||((i=e==null?void 0:e.envelope)==null?void 0:i.space_uuid)||null;this.sendWithCapability(r,d=>{const l={...e};d&&(l.capability_token=d),this.socket.send(JSON.stringify({type:"chat",data:l}))})}});o(this,"getMessages",(e,t=null)=>{var s;((s=this.socket)==null?void 0:s.readyState)===WebSocket.OPEN&&this.sendWithCapability(t,i=>{const r={before_unix_time:e};i&&(r.capability_token=i),this.socket.send(JSON.stringify({type:"get_messages",data:r}))})});o(this,"hardClose",()=>{this.manualClose=!0,this.close()});o(this,"close",()=>{this.capabilityRefreshTimer&&(clearTimeout(this.capabilityRefreshTimer),this.capabilityRefreshTimer=null),this.rejectCapabilityRefreshRequest(new Error("socket closing")),this.socket&&this.socket.close()});this.returnToHostList=e.returnToHostList,this.updateAccountUsername=e.updateAccountUsername,this.dashboardInitialRender=e.dashboardInitialRender,this.openDashModal=e.openDashModal,this.closeDashModal=e.closeDashModal,this.renderChatAppMessage=e.renderChatAppMessage,this.handleCreateSpace=e.handleCreateSpace,this.handleCreateChannel=e.handleCreateChannel,this.handleDeleteSpace=e.handleDeleteSpace,this.handleDeleteChannel=e.handleDeleteChannel,this.handleCreateChannelUpdate=e.handleCreateChannelUpdate,this.handleDeleteChannelUpdate=e.handleDeleteChannelUpdate,this.handleInviteUser=e.handleInviteUser,this.handleAddInvite=e.handleAddInvite,this.handleAcceptInvite=e.handleAcceptInvite,this.handleAcceptInviteUpdate=e.handleAcceptInviteUpdate,this.handleDeclineInvite=e.handleDeclineInvite,this.handleLeaveSpace=e.handleLeaveSpace,this.handleLeaveSpaceUpdate=e.handleLeaveSpaceUpdate,this.handleIncomingMessages=e.handleIncomingMessages,this.socket=null,this.manualClose=!1,this.retryCount=0,this.maxRetries=2,this.capabilityBySpaceUUID=new Map,this.hasInitialDashboardData=!1,this.capabilityRefreshPromise=null,this.capabilityRefreshResolve=null,this.capabilityRefreshReject=null,this.capabilityRefreshTimer=null,this.lastCapabilityAction=null,this.capabilitySkewMs=30*1e3,this.capabilityRefreshTimeoutMs=7e3,this.capabilityRetryWindowMs=10*1e3,this.hostUUID=localStorage.getItem("hostUUID"),this.hostUUID?this.connect():(p.alert("Missing host key"),this.returnToHostList())}}class vt{constructor(e){o(this,"initialize",()=>{this.domComponent.append(a("div",{class:"initial-spinner"},[a("div",{},"Connecting To Host..."),a("br"),a("div",{class:"lds-dual-ring"})])),this.socketConn=new bt({returnToHostList:this.returnToHostList,updateAccountUsername:this.updateAccountUsername,dashboardInitialRender:this.initialRender,openDashModal:this.openDashModal,closeDashModal:this.closeDashModal,renderChatAppMessage:this.renderChatAppMessage,handleCreateSpace:this.handleCreateSpace,handleDeleteSpace:this.handleDeleteSpace,handleCreateChannel:this.handleCreateChannel,handleCreateChannelUpdate:this.handleCreateChannelUpdate,handleDeleteChannel:this.handleDeleteChannel,handleDeleteChannelUpdate:this.handleDeleteChannelUpdate,handleInviteUser:this.handleInviteUser,handleAddInvite:this.handleAddInvite,handleAcceptInvite:this.handleAcceptInvite,handleAcceptInviteUpdate:this.handleAcceptInviteUpdate,handleDeclineInvite:this.handleDeclineInvite,handleLeaveSpace:this.handleLeaveSpace,handleLeaveSpaceUpdate:this.handleLeaveSpaceUpdate,handleIncomingMessages:this.handleIncomingMessages}),this.dashModal=new et(this,this.socketConn),this.domComponent.append(this.dashModal.domComponent)});o(this,"initialRender",e=>{this.data=e,this.data.spaces||(this.data.spaces=[]),Array.isArray(this.data.active_devices)||(this.data.active_devices=[]),this.sidebar=new tt({data:this.data,socketConn:this.socketConn,returnToHostList:this.returnToHostList,domComponent:a("div",{class:"sidebar"}),openDashModal:this.openDashModal,closeDashModal:this.closeDashModal,getCurrentSpaceUUID:this.getCurrentSpaceUUID,openSpaceSettings:this.openSpaceSettings,loadChannel:this.loadChannel}),this.mainContent=new ft({socketConn:this.socketConn,data:this.data,domComponent:a("div",{id:"channel-content",class:"channel-content"})}),this.render()});o(this,"updateAccountUsername",(e,t)=>{this.data.user.username=e.data.username,this.sidebar.userAccountComponent.render(),this.openDashModal({type:"account",data:{user:this.data.user,active_devices:this.data.active_devices||[]}})});o(this,"getCurrentSpaceUUID",()=>this.currentSpaceUUID);o(this,"loadChannel",(e,t)=>{this.currentSpaceUUID=e,this.socketConn.joinChannel(e,t),this.sidebar.spaceUserListComponent.render(),this.mainContent.renderChannel(t)});o(this,"openDashModal",e=>this.dashModal.open(e));o(this,"closeDashModal",()=>{this.dashModal.close()});o(this,"openSpaceSettings",e=>{this.currentSpaceUUID=e.uuid,this.openDashModal({type:"space-settings",data:{space:e,user:this.data.user}})});o(this,"closeSpaceSettings",()=>{this.closeDashModal(),this.currentSpaceUUID=null});o(this,"handleCreateSpace",async e=>{this.data.spaces.push(e.data.space),this.sidebar.render()});o(this,"handleDeleteSpace",async()=>{if(!this.currentSpaceUUID)return;this.data.spaces=this.data.spaces.filter(t=>t.uuid!==this.currentSpaceUUID);const e=this.sidebar.spaceComponents.filter(t=>t.space.uuid!==this.currentSpaceUUID);this.sidebar.spaceComponents=e,this.currentSpaceUUID=null,this.mainContent.render(),this.sidebar.render(),this.sidebar.spaceUserListComponent.render(),this.closeSpaceSettings()});o(this,"handleInviteUser",e=>{window.alert("Invite sent")});o(this,"handleAddInvite",e=>{this.data.invites||(this.data.invites=[]),this.data.invites.push(e.data.invite)});o(this,"handleAcceptInvite",e=>{this.data.invites=this.data.invites.filter(t=>t.id!==e.data.space_user_id),this.data.spaces.push(e.data.space),this.sidebar.render(),this.openDashModal({type:"invites",data:{invites:this.data.invites,user:this.data.user}})});o(this,"handleAcceptInviteUpdate",e=>{console.log("invite update",e);const t=this.data.spaces.find(s=>s.uuid===e.data.space_uuid);t.users.find(s=>s.id===e.data.user.id||s.public_key&&e.data.user.public_key&&s.public_key===e.data.user.public_key)||t.users.push(e.data.user),t&&this.currentSpaceUUID===t.uuid&&this.data.user.id!==e.data.user.id&&this.sidebar.spaceUserListComponent.render()});o(this,"handleDeclineInvite",e=>{this.data.invites=this.data.invites.filter(t=>t.id!==e.data.space_user_id),this.openDashModal({type:"invites",data:{invites:this.data.invites,user:this.data.user}})});o(this,"handleLeaveSpace",()=>{this.data.spaces=this.data.spaces.filter(e=>e.uuid!==this.currentSpaceUUID),this.currentSpaceUUID=null,this.sidebar.render(),this.mainContent.render()});o(this,"handleLeaveSpaceUpdate",e=>{const t=this.data.spaces.find(s=>s.uuid===e.data.space_uuid);if(t&&this.currentSpaceUUID===t.uuid){const s=t.users.findIndex(i=>i.id===e.data.user_id||i.public_key&&e.data.user_public_key&&i.public_key===e.data.user_public_key);s>=0&&(t.users.splice(s,1),this.sidebar.spaceUserListComponent.render())}});o(this,"handleCreateChannel",e=>{const{space_uuid:t,channel:s}=e.data,i=this.data.spaces.find(d=>d.uuid===t);if(!i)return;i.channels.push(s);const r=this.sidebar.spaceComponents.find(d=>d.space.uuid===t);r&&r.render(),this.openDashModal({type:"space-settings",data:{space:i,user:this.data.user}})});o(this,"handleCreateChannelUpdate",e=>{const{space_uuid:t,channel:s}=e.data,i=this.data.spaces.find(l=>l.uuid===t);if(!i||i.channels.some(l=>l.uuid===s.uuid))return;i.channels.push(s);const d=this.sidebar.spaceComponents.find(l=>l.space.uuid===t);d&&d.render()});o(this,"handleDeleteChannel",e=>{const{uuid:t,space_uuid:s}=e.data,i=this.data.spaces.find(l=>l.uuid===s);if(!i)return;const r=i.channels.findIndex(l=>l.uuid===t);if(r===-1)return;i.channels.splice(r,1);const d=this.sidebar.spaceComponents.find(l=>l.space.uuid===s);d&&d.render(),this.openDashModal({type:"space-settings",data:{space:i,user:this.data.user}}),this.mainContent.currentChannelUUID===t&&(this.mainContent.currentChannelUUID=null,this.mainContent.chatApp=null,this.mainContent.render())});o(this,"handleDeleteChannelUpdate",e=>{const{uuid:t,space_uuid:s}=e.data,i=this.data.spaces.find(l=>l.uuid===s);if(!i)return;const r=i.channels.findIndex(l=>l.uuid===t);if(r===-1)return;i.channels.splice(r,1);const d=this.sidebar.spaceComponents.find(l=>l.space.uuid===s);d&&d.render(),this.mainContent.currentChannelUUID===t&&(this.mainContent.currentChannelUUID=null,this.mainContent.chatApp=null,this.mainContent.render())});o(this,"findSpaceByChannelUUID",e=>{var t;return!((t=this.data)!=null&&t.spaces)||!e?null:this.data.spaces.find(s=>(s.channels||[]).some(i=>i.uuid===e))||null});o(this,"resolveUsernameForAuthPublicKey",(e,t)=>{var i;if(!e||!((i=this.data)!=null&&i.spaces))return"unknown";const s=t?this.data.spaces.filter(r=>r.uuid===t):this.data.spaces;for(const r of s){const d=(r.users||[]).find(l=>l.public_key===e);if(d!=null&&d.username)return d.username}return"unknown"});o(this,"decryptWireMessage",async(e,t)=>{const s=await b.getOrCreateIdentity(),i=e==null?void 0:e.envelope;if(!i)throw new Error("Missing encrypted envelope");const r=await ye.decryptMessageForIdentity({envelope:i,identity:s}),d=i.sender_auth_public_key||"";return{...e,content:r,sender_auth_public_key:d,username:this.resolveUsernameForAuthPublicKey(d,t)}});o(this,"renderChatAppMessage",async e=>{if(this.mainContent.chatApp)try{const t=await this.decryptWireMessage(e.data,this.currentSpaceUUID),s=this.mainContent.chatApp.chatBoxComponent.chatBoxMessagesComponent;s.appendNewMessage(t),(t.sender_auth_public_key===this.data.user.public_key||s.isScrolledToBottom())&&s.scrollDown()}catch(t){console.error(t)}});o(this,"handleIncomingMessages",async e=>{if(e.data.messages&&this.mainContent.chatApp&&this.mainContent.chatApp.chatBoxComponent.channelUUID===e.data.channel_uuid){const t=this.mainContent.chatApp.chatBoxComponent.chatBoxMessagesComponent,s=t.domComponent,i=s.scrollHeight,r=s.scrollTop;t.hasMoreMessages=e.data.has_more_messages,t.isLoading=!1;const d=this.findSpaceByChannelUUID(e.data.channel_uuid),l=await Promise.all(e.data.messages.map(async v=>{try{return await this.decryptWireMessage(v,(d==null?void 0:d.uuid)||null)}catch(c){return console.error(c),{...v,content:"[Unable to decrypt message]",username:"unknown",sender_auth_public_key:""}}}));t.chatBoxMessages=[...l,...t.chatBoxMessages],t.render();const f=s.scrollHeight;s.scrollTop=f-i+r}});this.domComponent=a("div",{class:"dashboard-container"}),this.returnToHostList=e.returnToHostList,this.data=null,this.sidebar=null,this.dashModal=null,this.mainContent=null,this.currentSpaceUUID=null,this.socketConn=null}render(){this.domComponent.innerHTML="",this.domComponent.append(this.sidebar.domComponent,this.mainContent.domComponent,this.dashModal.domComponent)}}class gt{constructor(){o(this,"returnToHostList",async()=>{var e,t;localStorage.removeItem("hostUUID"),(e=this.dashboard)!=null&&e.socketConn&&this.dashboard.socketConn.hardClose(),(t=this.dashboard)!=null&&t.domComponent&&(this.dashboard.domComponent.innerHTML=""),this.dashboard=null,this.render({type:"host_form"})});o(this,"render",e=>{switch(this.domComponent.innerHTML="",e.type){case"dash":this.dashboard=new vt({returnToHostList:this.returnToHostList}),this.domComponent.append(this.dashboard.domComponent),this.dashboard.initialize();break;case"host_form":this.domComponent.append(this.hostForm.domComponent),this.hostForm.render({type:"known"});break;default:this.domComponent.append(this.hostForm.domComponent),this.hostForm.render({type:"known"})}});p.greet("Hello Parch").then(e=>console.log(e)),this.domComponent=document.getElementById("app"),this.hostForm=new Ct(this),this.render({type:"host_form"})}}class Ct{constructor(e){o(this,"renderHostList",e=>!e||!e.hosts||!e.hosts.length?[a("div",{class:"host-empty-state"},"No saved hosts yet.")]:e.hosts.map(s=>{const i=s.online==1;return a("div",{class:"host-item"},[a("div",{style:"display: flex; align-items: baseline"},[a("span",{class:i?"host-online-span":"host-offline-span"}),a("div",{class:"host-item-name"},`${s.name} `)]),a("button",{class:"btn-small btn-red"},"Remove",{type:"click",event:r=>{r.stopPropagation(),p.confirm("Are you sure you want to remove this host?").then(d=>{d&&(p.removeHost(s.uuid),r.target.parentElement.remove())})}})],{type:"click",event:()=>{i?(localStorage.setItem("hostUUID",s.uuid),this.app.render({type:"dash"})):p.alert("Host is not online")}})}));o(this,"renderKnownHosts",async()=>{const t=(await p.getHosts()).map(i=>i.uuid);let s=[];try{s=await(await fetch(`${Z}/api/hosts_by_uuids`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uuids:t})})).json()}catch(i){console.log(i),p.alert("Failed to connect to relay server")}this.domComponent.append(a("h2",{},"Connect to a Host"),a("p",{class:"host-screen-subtitle"},"Choose a saved host or add a new host key. Relay access is granted only after host challenge auth and per-space capability checks."),a("br"),a("button",{},"Refresh",{type:"click",event:()=>{this.render({type:"known"})}}),a("br"),a("div",{class:"host-list-index"},[...this.renderHostList(s)]),a("br"),a("div",{class:"host-divider-text"},"Or"),a("br"),a("button",{class:""},"Add Host Key",{type:"click",event:()=>{this.render({type:"new"})}}))});o(this,"renderNewHostForm",()=>{this.domComponent.append(a("h2",{},"Add Host Key"),a("p",{class:"host-screen-subtitle"},"Paste the key shared by your host operator. You will only connect if that host is online and authenticated."),a("form",{id:"hostForm",onsubmit:this.handleSubmit},[a("fieldset",{},[a("legend",{},"Host Connection"),a("div",{class:"input-container"},[a("label",{for:"hostKey"},"Host Access Key"),a("input",{type:"text",id:"hostKey",name:"hostKey",required:!0})]),a("br"),a("button",{type:"submit"},"Continue")])],{type:"submit",event:e=>{e.preventDefault();const t=this.domComponent.querySelector("#hostKey").value;if(!t)return!1;p.verifyHostKey(t).then(s=>{this.render({type:"known"})}).catch(s=>{p.alert("Invalid host key"),console.error(s)})}}),a("br"),a("button",{},"Back To Hosts",{type:"click",event:()=>{this.render({type:"known"})}}))});o(this,"render",e=>{switch(this.domComponent.innerHTML="",e.type){case"known":this.renderKnownHosts();break;case"new":this.renderNewHostForm();break;default:this.renderKnownHosts()}});this.app=e,this.domComponent=a("div",{class:"host-form-container"})}}new gt;
