var ge=Object.defineProperty;var Ce=(n,e,t)=>e in n?ge(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var r=(n,e,t)=>Ce(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();const Z="https://chat.parchchat.com",we="wss://chat.parchchat.com/ws",V="5837a5c3-5268-45e1-9ea4-ee87d959d067",ke="Parch Community";function a(n,e,t,s){if(typeof n>"u")return!1;var i=document.createElement(n);if(typeof e=="object")for(var o in e)i.setAttribute(o,e[o]);if(t)if(typeof t=="string"&&/<[^>]+>/.test(t))i.innerHTML=t;else{Array.isArray(t)||(t=[t]);for(var l=0;l<t.length;l++)t[l]instanceof Node?i.appendChild(t[l]):i.appendChild(document.createTextNode(t[l]))}if(s){Array.isArray(s)||(s=[s]);for(var d of s)i.addEventListener(d.type,d.event)}return i}const Q="parch.hosts";function F(){try{const n=localStorage.getItem(Q);if(!n)return[];const e=JSON.parse(n);return Array.isArray(e)?e:[]}catch{return[]}}function R(n){localStorage.setItem(Q,JSON.stringify(n))}const u={async greet(n){return`Hello ${n}, It's show time!`},async alert(n){window.alert(n)},async confirm(n){return window.confirm(n)},async openExternal(n){window.open(n,"_blank","noopener,noreferrer")},async getHosts(){const n=F();return n.some(e=>e.uuid===V)||(n.push({uuid:V,name:ke}),R(n)),n},async verifyHostKey(n){const e=await fetch(`${Z}/api/host/${n}`);if(!e.ok)throw new Error("host not found");const t=await e.json(),s=F();return s.some(i=>i.uuid===n)||(s.push({uuid:t.uuid,name:t.name}),R(s)),t},async removeHost(n){const e=F(),t=e.filter(s=>s.uuid!==n);if(t.length===e.length)throw new Error(`host with UUID ${n} not found`);R(t)}},I="parch.chat.identity",O="parch.chat.identity.sealed",z="parch.chat.device_id",ee="parch.chat.identity.last_exported_at",Se="parch.chat.identity.keys",_e=1,U="kv",J="device_wrap_key",te=21e4;let w=null,K=null,M=null,T=null,H=null,P=null;function f(){const n=globalThis==null?void 0:globalThis.crypto;if(!(n!=null&&n.subtle))throw new Error("WebCrypto API is not available");return n}function k(n){let e="";const t=n instanceof Uint8Array?n:new Uint8Array(n);for(let s=0;s<t.length;s+=1)e+=String.fromCharCode(t[s]);return btoa(e).replace(/=+$/g,"")}function S(n){const e=(4-n.length%4)%4,t=n+"=".repeat(e),s=atob(t),i=new Uint8Array(s.length);for(let o=0;o<s.length;o+=1)i[o]=s.charCodeAt(o);return i}function ne(){return typeof indexedDB<"u"}function se(){return ne()}function $(n){try{const e=localStorage.getItem(n);if(!e)return null;const t=JSON.parse(e);return!t||typeof t!="object"?null:t}catch{return null}}function A(n,e){localStorage.setItem(n,JSON.stringify(e))}function Ue(){w=null,K=null,M=null,T=null}function N(n){if(!n||typeof n!="object")throw new Error("Identity payload must be an object");const e=typeof n.publicKey=="string"?n.publicKey.trim():"",t=typeof n.privateKey=="string"?n.privateKey.trim():"",s=typeof n.encPublicKey=="string"?n.encPublicKey.trim():"",i=typeof n.encPrivateKey=="string"?n.encPrivateKey.trim():"",o=typeof n.username=="string"?n.username.trim():"";if(!e||!t||!s||!i)throw new Error("Identity must include auth and encryption keypairs");return{publicKey:e,privateKey:t,encPublicKey:s,encPrivateKey:i,username:o}}function ae(n){if(!n||typeof n!="object")return null;const e=typeof n.publicKey=="string"?n.publicKey.trim():"",t=typeof n.encPublicKey=="string"?n.encPublicKey.trim():"",s=typeof n.username=="string"?n.username.trim():"";return!e||!t?null:{version:2,publicKey:e,encPublicKey:t,username:s}}function Ie(n){if(!n||typeof n!="object")throw new Error("Invalid private key bundle");const e=typeof n.privateKey=="string"?n.privateKey.trim():"",t=typeof n.encPrivateKey=="string"?n.encPrivateKey.trim():"";if(!e||!t)throw new Error("Private key bundle is incomplete");return{privateKey:e,encPrivateKey:t}}function Ke(){const n=localStorage.getItem(z);if(typeof n=="string"&&n.trim()!=="")return n.trim();const e=k(f().getRandomValues(new Uint8Array(16)));return localStorage.setItem(z,e),e}function De(){var e;const n=(((e=globalThis==null?void 0:globalThis.navigator)==null?void 0:e.userAgent)||"").toLowerCase();return n.includes("edg/")?"Edge":n.includes("firefox/")?"Firefox":n.includes("safari/")&&!n.includes("chrome/")?"Safari":n.includes("chrome/")?"Chrome":"Browser"}function xe(){var i;const n=Ke(),e=De(),t=String(((i=globalThis==null?void 0:globalThis.navigator)==null?void 0:i.platform)||"Unknown"),s=`${e} on ${t}`.slice(0,80);return{deviceId:n,deviceName:s}}function Pe(){localStorage.setItem(ee,new Date().toISOString())}function Ee(){const n=localStorage.getItem(ee);return typeof n=="string"?n:""}function ie(n){const e=typeof n=="string"?n:"";if(e.length<8)throw new Error("Passphrase must be at least 8 characters");return e}async function j(n){return f().subtle.importKey("pkcs8",S(n),{name:"Ed25519"},!1,["sign"])}async function W(n){return f().subtle.importKey("pkcs8",S(n),{name:"ECDH",namedCurve:"P-256"},!1,["deriveBits"])}async function Ae(n){return f().subtle.importKey("raw",S(n),{name:"Ed25519"},!1,["verify"])}async function Me(n){return f().subtle.importKey("spki",S(n),{name:"ECDH",namedCurve:"P-256"},!1,[])}async function oe(n){const e=await j(n.privateKey),t=await Ae(n.publicKey),s=new TextEncoder().encode("parch-identity-check"),i=await f().subtle.sign({name:"Ed25519"},e,s);if(!await f().subtle.verify({name:"Ed25519"},t,i,s))throw new Error("Public/private key mismatch");await W(n.encPrivateKey),await Me(n.encPublicKey)}async function Te(){const n=f(),e=await n.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveBits"]),t=await n.subtle.exportKey("spki",e.publicKey),s=await n.subtle.exportKey("pkcs8",e.privateKey);return{encPublicKey:k(t),encPrivateKey:k(s)}}async function re(){return ne()?H||(H=new Promise(n=>{try{const e=indexedDB.open(Se,_e);e.onerror=()=>n(null),e.onupgradeneeded=()=>{const t=e.result;t.objectStoreNames.contains(U)||t.createObjectStore(U)},e.onsuccess=()=>n(e.result)}catch{n(null)}}),H):null}async function Ne(n,e){return new Promise(t=>{try{const o=n.transaction(U,"readonly").objectStore(U).get(e);o.onsuccess=()=>t(o.result||null),o.onerror=()=>t(null)}catch{t(null)}})}async function Le(n,e,t){return new Promise(s=>{try{const i=n.transaction(U,"readwrite");i.oncomplete=()=>s(!0),i.onerror=()=>s(!1),i.objectStore(U).put(t,e)}catch{s(!1)}})}async function He(n,e){return new Promise(t=>{try{const s=n.transaction(U,"readwrite");s.oncomplete=()=>t(!0),s.onerror=()=>t(!1),s.objectStore(U).delete(e)}catch{t(!1)}})}async function ce(){return se()?P||(P=(async()=>{const n=await re();if(!n)return null;const e=await Ne(n,J);if(e)return e;const t=await f().subtle.generateKey({name:"AES-GCM",length:256},!1,["encrypt","decrypt"]);return await Le(n,J,t)?t:null})().catch(()=>null),P):null}async function Oe(n,e,t){const s=new TextEncoder().encode(n),i=await f().subtle.importKey("raw",s,"PBKDF2",!1,["deriveKey"]);return f().subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",iterations:te,salt:e},i,{name:"AES-GCM",length:256},!1,t)}async function Be(n,e){const t=f().getRandomValues(new Uint8Array(16)),s=f().getRandomValues(new Uint8Array(12)),i=await Oe(e,t,["encrypt"]),o=await f().subtle.encrypt({name:"AES-GCM",iv:s},i,n);return{type:"parch.encrypted_identity_backup.v1",kdf:{name:"PBKDF2",hash:"SHA-256",iterations:te,salt:k(t)},cipher:{name:"AES-GCM",iv:k(s),ciphertext:k(o)}}}async function Fe(n,e){var y,c,h,p;if(!n||n.type!=="parch.encrypted_identity_backup.v1")throw new Error("Unsupported backup format");const t=Number((y=n==null?void 0:n.kdf)==null?void 0:y.iterations);if(!Number.isInteger(t)||t<1e5)throw new Error("Invalid backup key derivation settings");const s=S(String(((c=n==null?void 0:n.kdf)==null?void 0:c.salt)||"")),i=S(String(((h=n==null?void 0:n.cipher)==null?void 0:h.iv)||"")),o=S(String(((p=n==null?void 0:n.cipher)==null?void 0:p.ciphertext)||"")),l=new TextEncoder().encode(e),d=await f().subtle.importKey("raw",l,"PBKDF2",!1,["deriveKey"]),b=await f().subtle.deriveKey({name:"PBKDF2",hash:"SHA-256",iterations:t,salt:s},d,{name:"AES-GCM",length:256},!1,["decrypt"]);return f().subtle.decrypt({name:"AES-GCM",iv:i},b,o)}async function Re(n){const e=await ce();if(!e)return null;const t=f().getRandomValues(new Uint8Array(12)),s=new TextEncoder().encode(JSON.stringify(n)),i=await f().subtle.encrypt({name:"AES-GCM",iv:t},e,s);return{type:"parch.identity.sealed.v1",iv:k(t),ciphertext:k(i)}}async function Je(n){if(!n||n.type!=="parch.identity.sealed.v1")throw new Error("Missing sealed private key material");const e=await ce();if(!e)throw new Error("Secure key vault unavailable");const t=S(String(n.iv||"")),s=S(String(n.ciphertext||"")),i=await f().subtle.decrypt({name:"AES-GCM",iv:t},e,s),o=JSON.parse(new TextDecoder().decode(i));return Ie(o)}function $e(n){const e={publicKey:n.publicKey,encPublicKey:n.encPublicKey,username:n.username||""};return se()||(e.privateKey=n.privateKey,e.encPrivateKey=n.encPrivateKey),e}async function le(n){w=$e(n),K={privateKey:n.privateKey,encPrivateKey:n.encPrivateKey},M=await j(n.privateKey),T=await W(n.encPrivateKey)}async function B(n){const e=N(n);await oe(e);const t={version:2,publicKey:e.publicKey,encPublicKey:e.encPublicKey,username:e.username||""},s=await Re({privateKey:e.privateKey,encPrivateKey:e.encPrivateKey});return s?(A(I,t),A(O,s)):(A(I,e),localStorage.removeItem(O)),await le(e),w}async function Y(){const n=f(),e=await n.subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),t=await n.subtle.exportKey("raw",e.publicKey),s=await n.subtle.exportKey("pkcs8",e.privateKey),i=await Te();return B({publicKey:k(t),privateKey:k(s),encPublicKey:i.encPublicKey,encPrivateKey:i.encPrivateKey,username:""})}async function L(){if(w&&M&&T&&K)return w;const n=$(I);if(!n)return Y();if(typeof n.privateKey=="string"&&typeof n.encPrivateKey=="string"){const o=N(n);return B(o)}const e=ae(n);if(!e)return Y();const t=$(O);if(!t)throw new Error("Identity private keys are unavailable on this device. Import an encrypted backup or reset identity.");const s=await Je(t),i=N({publicKey:e.publicKey,privateKey:s.privateKey,encPublicKey:e.encPublicKey,encPrivateKey:s.encPrivateKey,username:e.username||""});return await oe(i),await le(i),w}async function de(n){if(n!=null&&n.privateKey)return j(n.privateKey);if(await L(),!M)throw new Error("Signing key unavailable");return M}async function je(n){if(n!=null&&n.encPrivateKey)return W(n.encPrivateKey);if(await L(),!T)throw new Error("Encryption key unavailable");return T}async function We(){return L()}async function qe(n,e){if(!e||typeof e!="string")throw new Error("Missing auth message");const t=new TextEncoder().encode(e),s=await de(n),i=await f().subtle.sign({name:"Ed25519"},s,t);return k(i)}async function Ge(n,e,t){const s=f(),i=S(n),o=S(t),l=await s.subtle.importKey("raw",i,{name:"Ed25519"},!1,["verify"]),d=new TextEncoder().encode(e);return s.subtle.verify({name:"Ed25519"},l,o,d)}async function Ve(){if(await L(),!w||!K)throw new Error("Identity not available");return JSON.stringify({...w,...K},null,2)}async function ze(n){const e=ie(n);if(await L(),!w||!K)throw new Error("Identity not available");const t=new TextEncoder().encode(JSON.stringify({...w,...K})),s=await Be(t,e);return JSON.stringify(s,null,2)}async function Ye(n){let e=n;if(typeof n=="string")try{e=JSON.parse(n)}catch{throw new Error("Identity import text must be valid JSON")}if((e==null?void 0:e.type)==="parch.encrypted_identity_backup.v1")throw new Error("Encrypted backup detected. Use passphrase import.");const t=N(e);return B(t)}async function Xe(n,e){const t=ie(e);let s=n;if(typeof n=="string")try{s=JSON.parse(n)}catch{throw new Error("Backup import text must be valid JSON")}const i=await Fe(s,t);let o;try{o=JSON.parse(new TextDecoder().decode(i))}catch{throw new Error("Invalid backup payload")}const l=N(o);return B(l)}function Ze(n){const e=(n||"").trim(),t=$(I);if(t&&typeof t.privateKey=="string"&&typeof t.encPrivateKey=="string")t.username=e,A(I,t);else if(t&&typeof t=="object"){const s=ae(t);s&&(s.username=e,A(I,s))}w&&(w.username=e)}function Qe(){Ue(),localStorage.removeItem(I),localStorage.removeItem(O),re().then(n=>n?He(n,J):!1).catch(()=>!1),P=null}const v={getOrCreateIdentity:We,getDeviceMetadata:xe,getSigningPrivateKey:de,getEncryptionPrivateKey:je,signAuthMessage:qe,verifyAuthSignature:Ge,exportIdentity:Ve,exportEncryptedIdentity:ze,markIdentityExportedNow:Pe,getLastExportedAt:Ee,importIdentity:Ye,importEncryptedIdentity:Xe,setIdentityUsername:Ze,clearIdentity:Qe};class et{constructor(e,t){r(this,"open",e=>(this.domComponent.style.display="block",this.render(e)));r(this,"close",()=>{this.domComponent.style.display="none"});r(this,"renderPrompt",e=>new Promise(t=>{this.promptResolver=t,this.domComponent.append(a("div",{class:"modal-content"},[a("div",{class:"modal-header"},[a("h2",{},e||"Enter a value")]),a("div",{class:"modal-body"},[a("input",{id:"prompt-input",type:"text",style:"width: 100%; margin-bottom: 10px;"}),a("div",{style:"text-align: right;"},[a("button",{class:"btn"},"OK",{type:"click",event:()=>{const s=this.domComponent.querySelector("#prompt-input").value;this.close(),this.promptResolver(s)}}),a("button",{class:"btn btn-red",style:"margin-left: 10px;"},"Cancel",{type:"click",event:()=>{this.close(),this.promptResolver(null)}})])])]))}));r(this,"renderAuthorSettings",e=>[a("div",{class:"settings-section"},[a("h3",{},"Space Management"),a("div",{class:"settings-actions"},[a("button",{class:"btn"},"Invite User",{type:"click",event:()=>{this.render({type:"prompt",data:{message:"Enter recipient public key"}}).then(t=>{t&&this.socketConn.inviteUser({public_key:t.trim(),space_uuid:e.uuid})})}}),a("button",{class:"btn btn-red"},"Delete Space",{type:"click",event:()=>{u.confirm("Are you sure you want to delete this space?").then(t=>{t&&this.socketConn.deleteSpace({uuid:e.uuid})})}})])]),a("div",{class:"settings-section"},[a("h3",{},"Channel Management"),a("div",{class:"settings-actions"},[a("button",{class:"btn"},"+ Create Channel",{type:"click",event:()=>{this.render({type:"prompt",data:{message:"Please enter Channel name"}}).then(t=>{t&&this.socketConn.createChannel({name:t.trim(),space_uuid:e.uuid})})}})]),a("div",{class:"channels-list"},e.channels.map(t=>a("div",{class:"channel-item"},[a("span",{},t.name),a("button",{class:"btn-small btn-red"},"Delete",{type:"click",event:()=>{u.confirm("Are you sure you want to delete this channel?").then(s=>{s&&this.socketConn.deleteChannel({uuid:t.uuid})})}})])))])]);r(this,"renderSpaceUserSettings",(e,t)=>[a("div",{class:"settings-section"},[a("h3",{},"Space Management"),a("div",{class:"settings-actions"},[a("button",{class:"btn btn-red"},"Leave Space",{type:"click",event:()=>{u.confirm("Are you sure you want to leave this space?").then(s=>{s&&this.socketConn.leaveSpace({space_uuid:e.uuid,user_id:t.id,user_public_key:t.public_key||"",user_enc_public_key:t.enc_public_key||""})})}})])])]);r(this,"renderAccount",(e,t=[])=>{const s=c=>{if(!c)return"Never";const h=new Date(c);return Number.isNaN(h.getTime())?"Unknown":h.toLocaleString()},i=c=>!c||typeof c!="string"?"Unknown":c.length<=20?c:`${c.slice(0,10)}...${c.slice(-8)}`,o=async(c,h)=>{var p;if((p=navigator.clipboard)!=null&&p.writeText){await navigator.clipboard.writeText(c);return}if(!h)throw new Error("No copy source");h.focus(),h.select(),document.execCommand("copy")},l=async()=>{const c=this.domComponent.querySelector("#identity-export-passphrase"),h=this.domComponent.querySelector("#identity-export-display"),p=((c==null?void 0:c.value)||"").trim();if(p.length<8)throw new Error("Enter a backup passphrase (8+ chars)");const m=await v.exportEncryptedIdentity(p);return h&&(h.value=m),m},d=async(c,h)=>{if(!c){u.alert("No backup data provided");return}if(!h||h.length<8){u.alert("Enter an import passphrase (8+ chars)");return}if(await u.confirm("Import identity and replace the current local identity on this browser?"))try{await v.importEncryptedIdentity(c,h),u.alert("Identity imported. Reloading..."),window.location.reload()}catch(m){console.error(m),u.alert((m==null?void 0:m.message)||"Failed to import encrypted backup")}},b=()=>{const c=this.domComponent.querySelector("#last-exported-at");c&&(c.textContent=s(v.getLastExportedAt()))},y=()=>{const c=this.domComponent.querySelector("#active-devices-list");if(!c)return;if(c.innerHTML="",!Array.isArray(t)||t.length===0){c.append(a("div",{class:"account-device-empty"},"No active device sessions detected on this host."));return}const h=t.map(p=>{const m=`${p.device_name||"Unknown Device"}${p.is_current?" (This device)":""}`,g=`Last seen: ${s(p.last_seen||"")}`;return a("div",{class:"account-device-item"},[a("div",{class:"account-device-name"},m),a("div",{class:"account-device-meta"},g)])});c.append(...h)};this.domComponent.append(a("div",{class:"modal-content account-modal-content"},[a("div",{class:"modal-header"},[a("h2",{},"Account"),a("button",{class:"close-modal"},"×",{type:"click",event:this.close})]),a("div",{class:"modal-body account-modal-body"},[a("div",{class:"account-overview"},[a("div",{class:"account-overview-row"},[a("div",{class:"account-overview-title"},e.username||"unknown"),a("div",{class:"account-overview-subtitle"},`Host User ID: ${e.id||"unknown"}`)]),a("div",{class:"account-overview-meta"},[a("span",{class:"account-meta-label"},"Last Exported"),a("span",{id:"last-exported-at",class:"account-meta-value"},"Never")])]),a("div",{class:"account-grid"},[a("div",{class:"settings-section account-card"},[a("div",{class:"account-card-title"},"Public Key"),a("p",{class:"account-help"},"Share this public key with space admins so they can invite this identity."),a("textarea",{id:"public-key-display",class:"account-textarea account-textarea--compact",readonly:"readonly",rows:"4"}),a("div",{class:"account-actions"},[a("button",{class:"btn",id:"copy-public-key-btn"},"Copy Public Key",{type:"click",event:async()=>{const c=this.domComponent.querySelector("#public-key-display"),h=((c==null?void 0:c.value)||"").trim();if(!h){u.alert("Public key not available yet");return}try{await o(h,c),u.alert("Public key copied")}catch{u.alert("Failed to copy public key")}}})]),a("p",{id:"account-key-fingerprint",class:"account-inline-mono"},`Fingerprint: ${i(e.public_key||"")}`)]),a("div",{class:"settings-section account-card"},[a("div",{class:"account-card-title"},"Active Devices"),a("p",{class:"account-help"},"Sessions currently active for this identity on this host."),a("div",{id:"active-devices-list",class:"account-device-list"})])]),a("div",{class:"account-grid"},[a("div",{class:"settings-section account-card"},[a("div",{class:"account-card-title"},"Create Encrypted Backup"),a("p",{class:"account-warning"},"If you lose both backup file and passphrase, this identity cannot be recovered."),a("div",{class:"input-container account-input-wrap"},[a("label",{for:"identity-export-passphrase"},"Backup Passphrase"),a("input",{id:"identity-export-passphrase",class:"account-input",type:"password",placeholder:"At least 8 characters",autocomplete:"new-password"})]),a("textarea",{id:"identity-export-display",class:"account-textarea",readonly:"readonly",rows:"6",placeholder:"Encrypted backup JSON appears here after generation"}),a("div",{class:"account-actions"},[a("button",{class:"btn",id:"generate-identity-backup-btn"},"Generate",{type:"click",event:async()=>{try{await l()}catch(c){u.alert((c==null?void 0:c.message)||"Failed to generate encrypted backup")}}}),a("button",{class:"btn",id:"copy-identity-btn"},"Copy Backup",{type:"click",event:async()=>{const c=this.domComponent.querySelector("#identity-export-display"),h=((c==null?void 0:c.value)||"").trim();if(!h){u.alert("Generate backup first");return}try{await o(h,c),v.markIdentityExportedNow(),b(),u.alert("Encrypted backup copied")}catch{u.alert("Failed to copy backup")}}}),a("button",{class:"btn",id:"download-identity-btn"},"Download File",{type:"click",event:async()=>{try{const c=this.domComponent.querySelector("#identity-export-display"),h=((c==null?void 0:c.value)||"").trim()||await l(),p=new Blob([h],{type:"application/json"}),m=URL.createObjectURL(p),g=document.createElement("a");g.href=m,g.download="parch-identity-backup.enc.json",document.body.appendChild(g),g.click(),g.remove(),URL.revokeObjectURL(m),v.markIdentityExportedNow(),b()}catch(c){u.alert((c==null?void 0:c.message)||"Failed to generate backup file")}}})])]),a("div",{class:"settings-section account-card"},[a("div",{class:"account-card-title"},"Restore Encrypted Backup"),a("p",{class:"account-help"},"Importing will replace the current local identity on this browser."),a("div",{class:"input-container account-input-wrap"},[a("label",{for:"identity-import-passphrase"},"Import Passphrase"),a("input",{id:"identity-import-passphrase",class:"account-input",type:"password",placeholder:"Passphrase used for backup",autocomplete:"off"})]),a("textarea",{id:"identity-import-input",class:"account-textarea",rows:"6",placeholder:"Paste encrypted backup JSON here to import"}),a("div",{class:"account-actions"},[a("button",{class:"btn",id:"import-identity-btn"},"Import Backup",{type:"click",event:async()=>{const c=this.domComponent.querySelector("#identity-import-input"),h=this.domComponent.querySelector("#identity-import-passphrase"),p=((c==null?void 0:c.value)||"").trim(),m=((h==null?void 0:h.value)||"").trim();if(!p){u.alert("Paste encrypted backup JSON to import");return}await d(p,m)}}),a("button",{class:"btn",id:"import-identity-file-btn"},"Load File",{type:"click",event:()=>{const c=this.domComponent.querySelector("#identity-import-file");c&&(c.value="",c.click())}})]),a("input",{id:"identity-import-file",type:"file",accept:"application/json,.json",style:"display: none;"},null,{type:"change",event:async c=>{var p,m;const h=(m=(p=c==null?void 0:c.target)==null?void 0:p.files)==null?void 0:m[0];if(h)try{const g=await h.text(),_=this.domComponent.querySelector("#identity-import-input");_&&(_.value=g)}catch{u.alert("Failed to read backup file")}}})])]),a("div",{class:"account-grid"},[a("div",{class:"settings-section account-card"},[a("div",{class:"account-card-title"},"Local Fallback Username"),a("p",{class:"account-help"},"Used as the default username sent during auth when this browser joins a host."),a("div",{class:"input-container account-input-wrap"},[a("label",{for:"local-identity-username"},"Local Username"),a("input",{id:"local-identity-username",name:"localIdentityUsername",class:"account-input",type:"text",value:"",placeholder:"Set local fallback username"})]),a("div",{class:"account-actions"},[a("button",{class:"btn"},"Save Local Username",{type:"click",event:()=>{const c=this.domComponent.querySelector("#local-identity-username"),h=((c==null?void 0:c.value)||"").trim();v.setIdentityUsername(h),u.alert("Local fallback username saved")}})])]),a("div",{class:"settings-section account-card"},[a("div",{class:"account-card-title"},"Host Profile Username"),a("p",{class:"account-help"},"This updates your username for this host only."),a("form",{id:"update-username-form",class:"account-form"},[a("div",{class:"input-container account-input-wrap"},[a("label",{for:"username"},"Host Username"),a("input",{id:"username",name:"username",class:"account-input",type:"text",required:!0,value:e.username||""})]),a("div",{class:"account-actions"},[a("button",{type:"submit"},"Update Username")])],{type:"submit",event:c=>{c.preventDefault();const h=new FormData(c.target),p=Object.fromEntries(h.entries());p.user_id=e.id,p.user_public_key=e.public_key||"",p.user_enc_public_key=e.enc_public_key||"",this.socketConn.updateUsername(p)}})])]),a("div",{class:"settings-section account-card account-danger-zone"},[a("div",{class:"account-card-title account-card-title--danger"},"Danger Zone"),a("p",{class:"account-help"},"Reset identity creates a new keypair and account identity for this browser."),a("div",{class:"account-actions"},[a("button",{class:"btn-red"},"Reset Identity",{type:"click",event:()=>{u.confirm("Reset local identity key? This creates a new account identity.").then(c=>{c&&(v.clearIdentity(),window.location.reload())})}})])])])])),v.getOrCreateIdentity().then(c=>{const h=this.domComponent.querySelector("#public-key-display"),p=this.domComponent.querySelector("#local-identity-username"),m=this.domComponent.querySelector("#account-key-fingerprint");h&&(h.value=c.publicKey||""),p&&(p.value=c.username||""),m&&(m.textContent=`Fingerprint: ${i(c.publicKey||"")}`)}).catch(()=>{const c=this.domComponent.querySelector("#public-key-display"),h=this.domComponent.querySelector("#local-identity-username"),p=this.domComponent.querySelector("#identity-export-display");c&&(c.value=""),h&&(h.value=""),p&&(p.value="")}),b(),y()});r(this,"renderInvites",(e,t)=>{this.domComponent.append(a("div",{class:"modal-content"},[a("div",{class:"modal-header"},[a("h2",{},"Space Invites"),a("button",{class:"close-modal"},"×",{type:"click",event:this.close})]),a("div",{class:"modal-body"},e&&e.length&&t?a("div",{class:"invites-section"},[...e.map(s=>a("div",{class:"pending-invites-item"},[a("span",{},s.name),a("div",{},[a("button",{class:"btn-small accept-invite"},"Accept",{type:"click",event:()=>this.socketConn.acceptInvite({space_user_id:s.id,user_id:t.id,user_public_key:t.public_key||"",user_enc_public_key:t.enc_public_key||""})}),a("button",{class:"btn-small btn-red decline-invite"},"Decline",{type:"click",event:()=>this.socketConn.declineInvite({space_user_id:s.id,user_id:t.id,user_public_key:t.public_key||"",user_enc_public_key:t.enc_public_key||""})})])]))]):"...No Invite Yet")]))});r(this,"render",e=>{var t;switch(this.domComponent.innerHTML="",e.type){case"prompt":if((t=e.data)!=null&&t.message)return this.renderPrompt(e.data.message);break;case"account":e.data.user&&this.renderAccount(e.data.user,e.data.active_devices||[]);break;case"invites":this.renderInvites(e.data.invites,e.data.user);break;case"space-settings":if(e.data.space&&e.data.user){const s=e.data.space,i=e.data.user,o=s.author_id===i.id;this.domComponent.append(a("div",{class:"modal-content"},[a("div",{class:"modal-header"},[a("h2",{},`Space Settings: ${s.name}`),a("button",{class:"close-modal"},"×",{type:"click",event:this.close})]),a("div",{class:"modal-body"},o?this.renderAuthorSettings(s):this.renderSpaceUserSettings(s,i))]))}break}});this.app=e,this.socketConn=t,this.domComponent=a("div",{class:"modal"}),this.promptResolver=null}}class tt{constructor(e){r(this,"initSpaceComponents",()=>{this.data.spaces&&(this.spaceComponents=this.data.spaces.map(e=>new X({domComponent:a("div",{class:"space-item"}),space:e,user:this.data.user,openSpaceSettings:this.openSpaceSettings,loadChannel:this.loadChannel})))});r(this,"addSpace",e=>{const t=new X({domComponent:a("div",{class:"space-item"}),space:e,user:this.data.user,openSpaceSettings:this.openSpaceSettings,loadChannel:this.loadChannel});this.spaceComponents.push(t),this.render()});r(this,"render",()=>{this.domComponent.innerHTML="",this.initSpaceComponents(),this.userAccountComponent=new nt({data:this.data,returnToHostList:this.returnToHostList,openDashModal:this.openDashModal,domComponent:a("div",{class:"user-component"})}),this.spaceUserListComponent=new st({data:this.data,socketConn:this.socketConn,getCurrentSpaceUUID:this.getCurrentSpaceUUID,domComponent:a("div",{class:"space-users-list",id:"space-users-list"})}),this.domComponent.append(a("div",{class:"sidebar-spaces-container"},[a("div",{id:"spaces-list"},this.spaceComponents.map(e=>e.domComponent)),a("button",{class:"create-space-btn",id:"new-space-btn"},"+ Create New Space",{type:"click",event:()=>{this.openDashModal({type:"prompt",data:{message:"Please enter Space 'Name'"}}).then(e=>{e&&(e.trim(),this.socketConn.createSpace({name:e}))})}})]),a("br"),this.spaceUserListComponent.domComponent,a("hr"),this.userAccountComponent.domComponent)});this.data=e.data,this.socketConn=e.socketConn,this.returnToHostList=e.returnToHostList,this.openDashModal=e.openDashModal,this.closeDashModal=e.closeDashModal,this.getCurrentSpaceUUID=e.getCurrentSpaceUUID,this.spaceComponents=[],this.domComponent=e.domComponent,this.openSpaceSettings=e.openSpaceSettings,this.loadChannel=e.loadChannel,this.render()}}class nt{constructor(e){r(this,"render",()=>{this.domComponent.innerHTML="",this.domComponent.append(a("a",{href:"#"},"Account",{type:"click",event:e=>{this.openDashModal({type:"account",data:{user:this.data.user,active_devices:this.data.active_devices||[]}})}}),a("a",{href:"#"},"Invites",{type:"click",event:e=>{this.openDashModal({type:"invites",data:{invites:this.data.invites,user:this.data.user}})}}),a("a",{href:"#"},"<- Host List",{type:"click",event:e=>{this.returnToHostList()}}))});this.data=e.data,this.returnToHostList=e.returnToHostList,this.openDashModal=e.openDashModal,this.domComponent=e.domComponent,this.render()}}class st{constructor(e){r(this,"isAuthor",(e,t)=>String(e.author_id)===String(t.id));r(this,"renderUserElement",(e,t)=>a("div",{class:"space-user-item",id:"space-user-item"},`${t.username} ${this.isAuthor(e,t)?"*":""}`,{type:"click",event:async()=>{this.isAuthor(e,this.data.user)&&this.data.user.id!=t.id&&u.confirm("Are you sure you want to remove this user?").then(s=>{s&&this.socketConn.removeSpaceUser({space_uuid:e.uuid,user_id:t.id,user_public_key:t.public_key||""})})}}));r(this,"renderSpaceUsersList",e=>{const t=[];return e.users&&e.users.map(s=>{t.push(this.renderUserElement(e,s))}),t});r(this,"render",()=>{this.domComponent.innerHTML="";const e=this.getCurrentSpaceUUID();if(e){const t=this.data.spaces.find(s=>s.uuid===e);if(!t)return;this.domComponent.append(a("h3",{},"Users"),...this.renderSpaceUsersList(t))}});this.data=e.data,this.socketConn=e.socketConn,this.getCurrentSpaceUUID=e.getCurrentSpaceUUID,this.domComponent=e.domComponent,this.render()}}class X{constructor(e){r(this,"isAuthor",()=>String(this.space.author_id)===String(this.user.id));r(this,"renderChannelList",()=>a("div",{class:"channel-list"},(this.space.channels||[]).map(e=>a("div",{class:"channel-item"},[a("span",{class:"channel-hash"},"#"),a("span",{},e.name)],{type:"click",event:()=>this.loadChannel(this.space.uuid,e.uuid)}))));r(this,"toggleChannels",()=>{this.channelsOpen=!this.channelsOpen,this.render()});r(this,"render",()=>{this.domComponent.textContent="",this.domComponent.className=`space-item${this.channelsOpen?" space-item--open":""}`,this.domComponent.append(a("div",{class:"space-header"},[a("span",{class:"space-chevron"}),a("span",{},this.space.name),a("div",{class:"space-actions"},a("button",{class:"btn-icon open-settings"},"⚙️",{type:"click",event:e=>{e.stopPropagation(),this.openSpaceSettings(this.space)}}))],{type:"click",event:this.toggleChannels}),...this.channelsOpen?[this.renderChannelList()]:[])});this.space=e.space,this.user=e.user,this.openSpaceSettings=e.openSpaceSettings,this.loadChannel=e.loadChannel,this.channelsOpen=!1,this.domComponent=e.domComponent,this.render()}}function at(n){const e=new Date(n),t=e.getFullYear(),s=(e.getMonth()+1).toString().padStart(2,"0"),i=e.getDate().toString().padStart(2,"0"),o=e.getHours(),l=e.getMinutes(),d=o%12||12,b=o<12?"am":"pm",y=l.toString().padStart(2,"0");return`${s}-${i}-${t} ${d}:${y}${b}`}const it="data:image/svg+xml;base64,"+btoa(`
    <svg xmlns="http://www.w3.org/2000/svg" width="150" height="100" viewBox="0 0 150 100">
      <rect width="150" height="100" fill="#aaaaa" />
      <text x="75" y="55" font-size="14" text-anchor="middle" fill="#a00" font-family="sans-serif">Image not found</text>
    </svg>
  `);function ot(n){const e=document.createElement("img");return e.src=n,e.alt="Image",e.style="max-width: 100%; max-height: 250px; margin: 5px; cursor: pointer;",e.onerror=()=>{e.src=it},e}function rt(n){const e=n.split(".");if(e.length<2)return!1;const t=e[e.length-1].toLowerCase().split("?")[0];return["jpg","jpeg","png","gif","webp","svg","tiff"].includes(t)}function x(){const n=globalThis==null?void 0:globalThis.crypto;if(!(n!=null&&n.subtle))throw new Error("WebCrypto API is not available");return n}function E(n){let e="";const t=n instanceof Uint8Array?n:new Uint8Array(n);for(let s=0;s<t.length;s+=1)e+=String.fromCharCode(t[s]);return btoa(e).replace(/=+$/g,"")}function D(n){const e=(4-n.length%4)%4,t=n+"=".repeat(e),s=atob(t),i=new Uint8Array(s.length);for(let o=0;o<s.length;o+=1)i[o]=s.charCodeAt(o);return i}function q(n){const e=Array.isArray(n.wrapped_keys)?[...n.wrapped_keys].sort((s,i)=>String(s.recipient_auth_public_key).localeCompare(String(i.recipient_auth_public_key))):[],t={v:n.v,alg:n.alg,message_id:n.message_id,sender_timestamp:n.sender_timestamp,space_uuid:n.space_uuid,channel_uuid:n.channel_uuid,sender_auth_public_key:n.sender_auth_public_key,sender_enc_public_key:n.sender_enc_public_key,content_iv:n.content_iv,ciphertext:n.ciphertext,wrapped_keys:e.map(s=>({recipient_auth_public_key:s.recipient_auth_public_key,iv:s.iv,ciphertext:s.ciphertext}))};return JSON.stringify(t)}function ct(){const n=x();return E(n.getRandomValues(new Uint8Array(16)))}async function he(n){return x().subtle.importKey("spki",D(n),{name:"ECDH",namedCurve:"P-256"},!1,[])}async function lt(n){return he(n)}async function dt(n){return x().subtle.importKey("pkcs8",D(n),{name:"ECDH",namedCurve:"P-256"},!1,["deriveBits"])}async function pe(n){return n!=null&&n.encPrivateKey?dt(n.encPrivateKey):v.getEncryptionPrivateKey(n)}async function ue(n,e,t){const s=x(),i=await s.subtle.deriveBits({name:"ECDH",public:e},n,256),o=await s.subtle.importKey("raw",i,"HKDF",!1,["deriveKey"]),l=new TextEncoder().encode(`parch-e2ee-wrap-salt:${t.space_uuid}:${t.channel_uuid}`),d=new TextEncoder().encode(`parch-e2ee-wrap-info:${t.sender_auth_public_key}`);return s.subtle.deriveKey({name:"HKDF",hash:"SHA-256",salt:l,info:d},o,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async function ht(n){const e=x(),{plaintext:t,spaceUUID:s,channelUUID:i,identity:o,recipients:l}=n;if(!(o!=null&&o.publicKey)||!(o!=null&&o.encPublicKey))throw new Error("Missing sender identity keys");if(!s||!i)throw new Error("Missing space/channel context");if(!Array.isArray(l)||l.length===0)throw new Error("No recipient keys available for encryption");const d=[],b=new Set;for(const C of l)!(C!=null&&C.authPublicKey)||!(C!=null&&C.encPublicKey)||b.has(C.authPublicKey)||(b.add(C.authPublicKey),d.push(C));b.has(o.publicKey)||d.push({authPublicKey:o.publicKey,encPublicKey:o.encPublicKey});const y=await e.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),c=new Uint8Array(await e.subtle.exportKey("raw",y)),h=e.getRandomValues(new Uint8Array(12)),p=new TextEncoder().encode(t),m=await e.subtle.encrypt({name:"AES-GCM",iv:h},y,p),g=await pe(o),_={v:1,alg:"p256-hkdf-aesgcm+ed25519",message_id:ct(),sender_timestamp:new Date().toISOString(),space_uuid:s,channel_uuid:i,sender_auth_public_key:o.publicKey,sender_enc_public_key:o.encPublicKey,content_iv:E(h),ciphertext:E(m),wrapped_keys:[]};for(const C of d){const fe=await he(C.encPublicKey),be=await ue(g,fe,_),G=e.getRandomValues(new Uint8Array(12)),ve=await e.subtle.encrypt({name:"AES-GCM",iv:G},be,c);_.wrapped_keys.push({recipient_auth_public_key:C.authPublicKey,iv:E(G),ciphertext:E(ve)})}const me=q(_);return _.sig=await v.signAuthMessage(o,me),_}async function pt(n){const e=x(),{envelope:t,identity:s}=n;if(!(t!=null&&t.sender_auth_public_key)||!(t!=null&&t.sender_enc_public_key)||!(t!=null&&t.sig))throw new Error("Invalid encrypted envelope");if(!(s!=null&&s.publicKey))throw new Error("Missing recipient identity");const i=q(t);if(!await v.verifyAuthSignature(t.sender_auth_public_key,i,t.sig))throw new Error("Invalid message signature");const l=(t.wrapped_keys||[]).find(m=>m.recipient_auth_public_key===s.publicKey);if(!l)throw new Error("No wrapped key for this identity");const d=await pe(s),b=await lt(t.sender_enc_public_key),y=await ue(d,b,t),c=await e.subtle.decrypt({name:"AES-GCM",iv:D(l.iv)},y,D(l.ciphertext)),h=await e.subtle.importKey("raw",c,{name:"AES-GCM",length:256},!1,["decrypt"]),p=await e.subtle.decrypt({name:"AES-GCM",iv:D(t.content_iv)},h,D(t.ciphertext));return new TextDecoder().decode(p)}const ye={encryptMessageForSpace:ht,decryptMessageForIdentity:pt,canonicalEnvelopeForSignature:q};class ut{constructor(e){r(this,"initialize",e=>{this.chatBoxComponent=new yt({domComponent:a("div"),data:this.data,socketConn:this.socketConn,channelUUID:e}),this.render();const t=new Date().toISOString();this.socketConn.getMessages(t)});r(this,"render",()=>{this.domComponent.innerHTML="",this.chatBoxComponent&&this.domComponent.append(this.chatBoxComponent.domComponent)});this.domComponent=e.domComponent,this.data=e.data,this.socketConn=e.socketConn,this.chatBoxComponent=null}}class yt{constructor(e){r(this,"render",()=>{this.domComponent.innerHTML="",this.domComponent.append(a("div",{class:"chatapp-channel-title"},this.channel.name),this.chatBoxMessagesComponent.domComponent,a("div",{class:"chat-box-form"},[a("textarea",{id:"chat-box-form-input",class:"chat-box-form-input",autofocus:!0,type:"text",required:!0,autocomplete:"off",placeholder:"Type message here..."},null,[{type:"input",event:e=>{const t=e.target;t.style.height="auto",t.style.height=`${t.scrollHeight}px`}},{type:"keydown",event:async e=>{var t,s;if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();const i=e.target,o=i.value.trim();if(o)try{const l=await v.getOrCreateIdentity(),d=(((t=this.space)==null?void 0:t.users)||[]).filter(y=>(y==null?void 0:y.public_key)&&(y==null?void 0:y.enc_public_key)).map(y=>({authPublicKey:y.public_key,encPublicKey:y.enc_public_key})),b=await ye.encryptMessageForSpace({plaintext:o,spaceUUID:(s=this.space)==null?void 0:s.uuid,channelUUID:this.channelUUID,identity:l,recipients:d});this.socketConn.sendMessage({envelope:b}),i.value="",i.style.height="auto",i.focus()}catch(l){console.error(l),u.alert((l==null?void 0:l.message)||"Failed to encrypt message")}}}}])]))});this.domComponent=e.domComponent,this.domComponent.className="chat-box-container",this.data=e.data,this.socketConn=e.socketConn,this.channelUUID=e.channelUUID;for(const t of this.data.spaces){const s=t.channels.find(i=>i.uuid===this.channelUUID);if(s){this.space=t,this.channel=s;break}}this.chatBoxMessagesComponent=new mt({domComponent:a("div",{class:"chat-box-messages",id:"chat-box-messages"}),channelUUID:this.channelUUID,socketConn:this.socketConn}),this.render()}}class mt{constructor(e){r(this,"getPreviousMessagesDebounce",()=>{this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.debounceTimeout=setTimeout(()=>{this.getPreviousMessages()},300)});r(this,"getPreviousMessages",()=>{if(this.isLoading||!this.hasMoreMessages||!this.chatBoxMessages.length||!this.isScrolledToTop())return;this.isLoading=!0;const e=this.chatBoxMessages[0].timestamp;this.socketConn.getMessages(e)});r(this,"scrollDown",()=>{this.domComponent.scrollTop=this.domComponent.scrollHeight});r(this,"isScrolledToTop",()=>this.domComponent.scrollTop<=20);r(this,"isScrolledToBottom",()=>this.domComponent.scrollHeight-this.domComponent.scrollTop<=this.domComponent.clientHeight+40);r(this,"appendNewMessage",e=>{const t=this.isScrolledToBottom();this.chatBoxMessages.push(e),this.render(),t&&requestAnimationFrame(()=>this.scrollDown())});r(this,"createMessage",e=>{const t=s=>{const i=/(https?:\/\/[^\s]+)/g,o=/^https?:\/\/[^\s]+$/;return s.split(i).map(d=>o.test(d)?rt(d)?ot(d):a("a",{href:d,target:"_blank",rel:"noopener noreferrer",style:"margin: 0 5px;"},d):d)};return a("div",{class:"chat-box-message-content"},[a("div",{style:"display: flex; align-items: flex-end;"},[a("small",{style:"margin-right: var(--main-distance); color: var(--main-gray);"},at(e.timestamp)),a("div",{style:"font-weight: bold; margin-right: var(--main-distance); color: var(--light-yellow);"},e.username)]),a("div",{class:"chat-box-message-text"},[...t(e.content)]),a("hr")])});r(this,"render",()=>{this.domComponent.innerHTML="";const e=this.chatBoxMessages.map(t=>this.createMessage(t));this.domComponent.append(...e)});this.chatBoxMessages=[],this.channelUUID=e.channelUUID,this.socketConn=e.socketConn,this.messageRequestSize=50,this.hasMoreMessages=!0,this.debounceTimeout=null,this.isLoading=!1,this.domComponent=a("div",{class:"chat-box-messages",id:"chat-box-messages"},null,{type:"scroll",event:()=>{this.getPreviousMessagesDebounce()}})}}class ft{constructor(e){r(this,"renderChannel",e=>{this.currentChannelUUID=e,this.domComponent.innerHTML="";const t=a("div",{class:"chatapp-container"});this.domComponent.append(t),this.chatApp?this.chatApp.domComponent=t:this.chatApp=new ut({domComponent:t,data:this.data,socketConn:this.socketConn}),this.chatApp.initialize(e)});r(this,"cleanup",()=>{var e,t;this.chatApp&&((t=(e=this.chatApp).cleanup)==null||t.call(e),this.chatApp=null),this.currentChannelUUID=null});r(this,"render",()=>{this.cleanup(),this.domComponent.innerHTML="",this.domComponent.append(a("div",{class:"no-channel-selected"},[a("h2",{},"Select a channel to start chatting")]))});this.domComponent=e.domComponent,this.data=e.data,this.socketConn=e.socketConn,this.chatApp=null,this.currentChannelUUID=null,this.render()}}class bt{constructor(e){r(this,"retryConnection",()=>{if(this.retryCount+=1,this.retryCount>this.maxRetries){u.alert("Unable to reconnect to host. Returning to home."),this.returnToHostList();return}setTimeout(()=>{var t;((t=this.socket)==null?void 0:t.readyState)!==WebSocket.OPEN&&this.connect()},2e3)});r(this,"connect",()=>{this.socket=new WebSocket(we),this.socket.onopen=()=>{this.joinHost()},this.socket.onerror=e=>{console.error("WebSocket error:",e)},this.socket.onclose=()=>{this.manualClose||this.retryConnection()},this.socket.onmessage=async e=>{var t,s;try{const i=JSON.parse(e.data);switch(i.type){case"join_ack":break;case"join_error":u.alert(((t=i.data)==null?void 0:t.error)||"Failed to join host"),this.returnToHostList();break;case"auth_challenge":await this.authenticateWithPublicKey((s=i.data)==null?void 0:s.challenge);break;case"auth_pubkey_success":this.closeDashModal(),this.getDashboardData();break;case"dash_data_payload":this.dashboardInitialRender(i.data),this.joinAllSpaces(i);break;case"update_username_success":this.updateAccountUsername(i,this.hostUUID),v.setIdentityUsername(i.data.username);break;case"create_space_success":this.handleCreateSpace(i);break;case"delete_space_success":this.handleDeleteSpace();break;case"create_channel_success":this.handleCreateChannel(i);break;case"create_channel_update":this.handleCreateChannelUpdate(i);break;case"delete_channel_success":this.handleDeleteChannel(i);break;case"delete_channel_update":this.handleDeleteChannelUpdate(i);break;case"invite_user_success":this.handleInviteUser(i);break;case"invite_user_update":this.handleAddInvite(i);break;case"accept_invite_success":this.handleAcceptInvite(i);break;case"accept_invite_update":this.handleAcceptInviteUpdate(i);break;case"decline_invite_success":this.handleDeclineInvite(i);break;case"leave_space_success":this.handleLeaveSpace();break;case"leave_space_update":this.handleLeaveSpaceUpdate(i);break;case"chat":await this.renderChatAppMessage(i);break;case"get_messages_success":await this.handleIncomingMessages(i);break;case"error":u.alert(i.data.error);break;case"authentication-error":u.alert(i.data.error||"Authentication failed");break;case"author_error":u.alert("Failed to connect to host. Host is offline."),this.returnToHostList();break;default:break}}catch(i){console.error("JSON parsing error:",i)}}});r(this,"authenticateWithPublicKey",async e=>{if(!e){u.alert("Missing auth challenge from server");return}try{const t=await v.getOrCreateIdentity(),s=v.getDeviceMetadata(),i=`parch-chat-auth:${this.hostUUID}:${e}:${t.encPublicKey}`,o=await v.signAuthMessage(t,i),l={type:"auth_pubkey",data:{public_key:t.publicKey,enc_public_key:t.encPublicKey,device_id:s.deviceId,device_name:s.deviceName,username:t.username||"",challenge:e,signature:o}};this.socket.send(JSON.stringify(l))}catch(t){console.error(t),u.alert("Failed to initialize public-key identity")}});r(this,"joinHost",()=>{var e;((e=this.socket)==null?void 0:e.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"join_host",data:{uuid:this.hostUUID}}))});r(this,"getDashboardData",()=>{var e;((e=this.socket)==null?void 0:e.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"get_dash_data",data:""}))});r(this,"joinAllSpaces",e=>{var t;if(((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const s=e.data.spaces.map(i=>i.uuid);this.socket.send(JSON.stringify({type:"join_all_spaces",data:{space_uuids:s}}))}});r(this,"updateUsername",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"update_username",data:e}))});r(this,"createSpace",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"create_space",data:e}))});r(this,"deleteSpace",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"delete_space",data:e}))});r(this,"createChannel",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"create_channel",data:e}))});r(this,"deleteChannel",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"delete_channel",data:e}))});r(this,"inviteUser",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"invite_user",data:e}))});r(this,"acceptInvite",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"accept_invite",data:e}))});r(this,"declineInvite",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"decline_invite",data:e}))});r(this,"leaveSpace",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"leave_space",data:e}))});r(this,"removeSpaceUser",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"remove_space_user",data:e}))});r(this,"joinChannel",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"join_channel",data:{uuid:e}}))});r(this,"sendMessage",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"chat",data:e}))});r(this,"getMessages",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"get_messages",data:{before_unix_time:e}}))});r(this,"hardClose",()=>{this.manualClose=!0,this.close()});r(this,"close",()=>{this.socket&&this.socket.close()});this.returnToHostList=e.returnToHostList,this.updateAccountUsername=e.updateAccountUsername,this.dashboardInitialRender=e.dashboardInitialRender,this.openDashModal=e.openDashModal,this.closeDashModal=e.closeDashModal,this.renderChatAppMessage=e.renderChatAppMessage,this.handleCreateSpace=e.handleCreateSpace,this.handleCreateChannel=e.handleCreateChannel,this.handleDeleteSpace=e.handleDeleteSpace,this.handleDeleteChannel=e.handleDeleteChannel,this.handleCreateChannelUpdate=e.handleCreateChannelUpdate,this.handleDeleteChannelUpdate=e.handleDeleteChannelUpdate,this.handleInviteUser=e.handleInviteUser,this.handleAddInvite=e.handleAddInvite,this.handleAcceptInvite=e.handleAcceptInvite,this.handleAcceptInviteUpdate=e.handleAcceptInviteUpdate,this.handleDeclineInvite=e.handleDeclineInvite,this.handleLeaveSpace=e.handleLeaveSpace,this.handleLeaveSpaceUpdate=e.handleLeaveSpaceUpdate,this.handleIncomingMessages=e.handleIncomingMessages,this.socket=null,this.manualClose=!1,this.retryCount=0,this.maxRetries=2,this.hostUUID=localStorage.getItem("hostUUID"),this.hostUUID?this.connect():(u.alert("Missing host key"),this.returnToHostList())}}class vt{constructor(e){r(this,"initialize",()=>{this.domComponent.append(a("div",{class:"initial-spinner"},[a("div",{},"Connecting To Host..."),a("br"),a("div",{class:"lds-dual-ring"})])),this.socketConn=new bt({returnToHostList:this.returnToHostList,updateAccountUsername:this.updateAccountUsername,dashboardInitialRender:this.initialRender,openDashModal:this.openDashModal,closeDashModal:this.closeDashModal,renderChatAppMessage:this.renderChatAppMessage,handleCreateSpace:this.handleCreateSpace,handleDeleteSpace:this.handleDeleteSpace,handleCreateChannel:this.handleCreateChannel,handleCreateChannelUpdate:this.handleCreateChannelUpdate,handleDeleteChannel:this.handleDeleteChannel,handleDeleteChannelUpdate:this.handleDeleteChannelUpdate,handleInviteUser:this.handleInviteUser,handleAddInvite:this.handleAddInvite,handleAcceptInvite:this.handleAcceptInvite,handleAcceptInviteUpdate:this.handleAcceptInviteUpdate,handleDeclineInvite:this.handleDeclineInvite,handleLeaveSpace:this.handleLeaveSpace,handleLeaveSpaceUpdate:this.handleLeaveSpaceUpdate,handleIncomingMessages:this.handleIncomingMessages}),this.dashModal=new et(this,this.socketConn),this.domComponent.append(this.dashModal.domComponent)});r(this,"initialRender",e=>{this.data=e,this.data.spaces||(this.data.spaces=[]),Array.isArray(this.data.active_devices)||(this.data.active_devices=[]),this.sidebar=new tt({data:this.data,socketConn:this.socketConn,returnToHostList:this.returnToHostList,domComponent:a("div",{class:"sidebar"}),openDashModal:this.openDashModal,closeDashModal:this.closeDashModal,getCurrentSpaceUUID:this.getCurrentSpaceUUID,openSpaceSettings:this.openSpaceSettings,loadChannel:this.loadChannel}),this.mainContent=new ft({socketConn:this.socketConn,data:this.data,domComponent:a("div",{id:"channel-content",class:"channel-content"})}),this.render()});r(this,"updateAccountUsername",(e,t)=>{this.data.user.username=e.data.username,this.sidebar.userAccountComponent.render(),this.openDashModal({type:"account",data:{user:this.data.user,active_devices:this.data.active_devices||[]}})});r(this,"getCurrentSpaceUUID",()=>this.currentSpaceUUID);r(this,"loadChannel",(e,t)=>{this.currentSpaceUUID=e,this.socketConn.joinChannel(t),this.sidebar.spaceUserListComponent.render(),this.mainContent.renderChannel(t)});r(this,"openDashModal",e=>this.dashModal.open(e));r(this,"closeDashModal",()=>{this.dashModal.close()});r(this,"openSpaceSettings",e=>{this.currentSpaceUUID=e.uuid,this.openDashModal({type:"space-settings",data:{space:e,user:this.data.user}})});r(this,"closeSpaceSettings",()=>{this.closeDashModal(),this.currentSpaceUUID=null});r(this,"handleCreateSpace",async e=>{this.data.spaces.push(e.data.space),this.sidebar.render()});r(this,"handleDeleteSpace",async()=>{if(!this.currentSpaceUUID)return;this.data.spaces=this.data.spaces.filter(t=>t.uuid!==this.currentSpaceUUID);const e=this.sidebar.spaceComponents.filter(t=>t.space.uuid!==this.currentSpaceUUID);this.sidebar.spaceComponents=e,this.currentSpaceUUID=null,this.mainContent.render(),this.sidebar.render(),this.sidebar.spaceUserListComponent.render(),this.closeSpaceSettings()});r(this,"handleInviteUser",e=>{window.alert("Invite sent")});r(this,"handleAddInvite",e=>{this.data.invites||(this.data.invites=[]),this.data.invites.push(e.data.invite)});r(this,"handleAcceptInvite",e=>{this.data.invites=this.data.invites.filter(t=>t.id!==e.data.space_user_id),this.data.spaces.push(e.data.space),this.sidebar.render(),this.openDashModal({type:"invites",data:{invites:this.data.invites,user:this.data.user}})});r(this,"handleAcceptInviteUpdate",e=>{console.log("invite update",e);const t=this.data.spaces.find(s=>s.uuid===e.data.space_uuid);t.users.find(s=>s.id===e.data.user.id||s.public_key&&e.data.user.public_key&&s.public_key===e.data.user.public_key)||t.users.push(e.data.user),t&&this.currentSpaceUUID===t.uuid&&this.data.user.id!==e.data.user.id&&this.sidebar.spaceUserListComponent.render()});r(this,"handleDeclineInvite",e=>{this.data.invites=this.data.invites.filter(t=>t.id!==e.data.space_user_id),this.openDashModal({type:"invites",data:{invites:this.data.invites,user:this.data.user}})});r(this,"handleLeaveSpace",()=>{this.data.spaces=this.data.spaces.filter(e=>e.uuid!==this.currentSpaceUUID),this.currentSpaceUUID=null,this.sidebar.render(),this.mainContent.render()});r(this,"handleLeaveSpaceUpdate",e=>{const t=this.data.spaces.find(s=>s.uuid===e.data.space_uuid);if(t&&this.currentSpaceUUID===t.uuid){const s=t.users.findIndex(i=>i.id===e.data.user_id||i.public_key&&e.data.user_public_key&&i.public_key===e.data.user_public_key);s>=0&&(t.users.splice(s,1),this.sidebar.spaceUserListComponent.render())}});r(this,"handleCreateChannel",e=>{const{space_uuid:t,channel:s}=e.data,i=this.data.spaces.find(l=>l.uuid===t);if(!i)return;i.channels.push(s);const o=this.sidebar.spaceComponents.find(l=>l.space.uuid===t);o&&o.render(),this.openDashModal({type:"space-settings",data:{space:i,user:this.data.user}})});r(this,"handleCreateChannelUpdate",e=>{const{space_uuid:t,channel:s}=e.data,i=this.data.spaces.find(d=>d.uuid===t);if(!i||i.channels.some(d=>d.uuid===s.uuid))return;i.channels.push(s);const l=this.sidebar.spaceComponents.find(d=>d.space.uuid===t);l&&l.render()});r(this,"handleDeleteChannel",e=>{const{uuid:t,space_uuid:s}=e.data,i=this.data.spaces.find(d=>d.uuid===s);if(!i)return;const o=i.channels.findIndex(d=>d.uuid===t);if(o===-1)return;i.channels.splice(o,1);const l=this.sidebar.spaceComponents.find(d=>d.space.uuid===s);l&&l.render(),this.openDashModal({type:"space-settings",data:{space:i,user:this.data.user}}),this.mainContent.currentChannelUUID===t&&(this.mainContent.currentChannelUUID=null,this.mainContent.chatApp=null,this.mainContent.render())});r(this,"handleDeleteChannelUpdate",e=>{const{uuid:t,space_uuid:s}=e.data,i=this.data.spaces.find(d=>d.uuid===s);if(!i)return;const o=i.channels.findIndex(d=>d.uuid===t);if(o===-1)return;i.channels.splice(o,1);const l=this.sidebar.spaceComponents.find(d=>d.space.uuid===s);l&&l.render(),this.mainContent.currentChannelUUID===t&&(this.mainContent.currentChannelUUID=null,this.mainContent.chatApp=null,this.mainContent.render())});r(this,"findSpaceByChannelUUID",e=>{var t;return!((t=this.data)!=null&&t.spaces)||!e?null:this.data.spaces.find(s=>(s.channels||[]).some(i=>i.uuid===e))||null});r(this,"resolveUsernameForAuthPublicKey",(e,t)=>{var i;if(!e||!((i=this.data)!=null&&i.spaces))return"unknown";const s=t?this.data.spaces.filter(o=>o.uuid===t):this.data.spaces;for(const o of s){const l=(o.users||[]).find(d=>d.public_key===e);if(l!=null&&l.username)return l.username}return"unknown"});r(this,"decryptWireMessage",async(e,t)=>{const s=await v.getOrCreateIdentity(),i=e==null?void 0:e.envelope;if(!i)throw new Error("Missing encrypted envelope");const o=await ye.decryptMessageForIdentity({envelope:i,identity:s}),l=i.sender_auth_public_key||"";return{...e,content:o,sender_auth_public_key:l,username:this.resolveUsernameForAuthPublicKey(l,t)}});r(this,"renderChatAppMessage",async e=>{if(this.mainContent.chatApp)try{const t=await this.decryptWireMessage(e.data,this.currentSpaceUUID),s=this.mainContent.chatApp.chatBoxComponent.chatBoxMessagesComponent;s.appendNewMessage(t),(t.sender_auth_public_key===this.data.user.public_key||s.isScrolledToBottom())&&s.scrollDown()}catch(t){console.error(t)}});r(this,"handleIncomingMessages",async e=>{if(e.data.messages&&this.mainContent.chatApp&&this.mainContent.chatApp.chatBoxComponent.channelUUID===e.data.channel_uuid){const t=this.mainContent.chatApp.chatBoxComponent.chatBoxMessagesComponent,s=t.domComponent,i=s.scrollHeight,o=s.scrollTop;t.hasMoreMessages=e.data.has_more_messages,t.isLoading=!1;const l=this.findSpaceByChannelUUID(e.data.channel_uuid),d=await Promise.all(e.data.messages.map(async y=>{try{return await this.decryptWireMessage(y,(l==null?void 0:l.uuid)||null)}catch(c){return console.error(c),{...y,content:"[Unable to decrypt message]",username:"unknown",sender_auth_public_key:""}}}));t.chatBoxMessages=[...d,...t.chatBoxMessages],t.render();const b=s.scrollHeight;s.scrollTop=b-i+o}});this.domComponent=a("div",{class:"dashboard-container"}),this.returnToHostList=e.returnToHostList,this.data=null,this.sidebar=null,this.dashModal=null,this.mainContent=null,this.currentSpaceUUID=null,this.socketConn=null}render(){this.domComponent.innerHTML="",this.domComponent.append(this.sidebar.domComponent,this.mainContent.domComponent,this.dashModal.domComponent)}}class gt{constructor(){r(this,"returnToHostList",async()=>{var e,t;localStorage.removeItem("hostUUID"),(e=this.dashboard)!=null&&e.socketConn&&this.dashboard.socketConn.hardClose(),(t=this.dashboard)!=null&&t.domComponent&&(this.dashboard.domComponent.innerHTML=""),this.dashboard=null,this.render({type:"host_form"})});r(this,"render",e=>{switch(this.domComponent.innerHTML="",e.type){case"dash":this.dashboard=new vt({returnToHostList:this.returnToHostList}),this.domComponent.append(this.dashboard.domComponent),this.dashboard.initialize();break;case"host_form":this.domComponent.append(this.hostForm.domComponent),this.hostForm.render({type:"known"});break;default:this.domComponent.append(this.hostForm.domComponent),this.hostForm.render({type:"known"})}});u.greet("Hello Parch").then(e=>console.log(e)),this.domComponent=document.getElementById("app"),this.hostForm=new Ct(this),this.render({type:"host_form"})}}class Ct{constructor(e){r(this,"renderHostList",e=>!e||!e.hosts||!e.hosts.length?[a("div",{},"...No Hosts")]:e.hosts.map(s=>{const i=s.online==1;return a("div",{class:"host-item"},[a("div",{style:"display: flex; align-items: baseline"},[a("span",{class:i?"host-online-span":"host-offline-span"}),a("div",{class:"host-item-name"},`${s.name} `)]),a("button",{class:"btn-small btn-red"},"Remove",{type:"click",event:o=>{o.stopPropagation(),u.confirm("Are you sure you want to remove this host?").then(l=>{l&&(u.removeHost(s.uuid),o.target.parentElement.remove())})}})],{type:"click",event:()=>{i?(localStorage.setItem("hostUUID",s.uuid),this.app.render({type:"dash"})):u.alert("Host is not online")}})}));r(this,"renderKnownHosts",async()=>{const t=(await u.getHosts()).map(i=>i.uuid);let s=[];try{s=await(await fetch(`${Z}/api/hosts_by_uuids`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uuids:t})})).json()}catch(i){console.log(i),u.alert("Failed to connect to relay server")}this.domComponent.append(a("h2",{},"Select From Known Hosts"),a("br"),a("button",{},"Refresh",{type:"click",event:()=>{this.render({type:"known"})}}),a("br"),a("div",{class:"host-list-index"},[...this.renderHostList(s)]),a("br"),a("div",{},"Or"),a("br"),a("button",{class:""},"Add New Host",{type:"click",event:()=>{this.render({type:"new"})}}))});r(this,"renderNewHostForm",()=>{this.domComponent.append(a("h2",{},"Enter Host Key"),a("form",{id:"hostForm",onsubmit:this.handleSubmit},[a("fieldset",{},[a("legend",{},"New Host"),a("div",{class:"input-container"},[a("label",{for:"hostKey"},"Host Key"),a("input",{type:"text",id:"hostKey",name:"hostKey",required:!0})]),a("br"),a("button",{type:"submit"},"Continue")])],{type:"submit",event:e=>{e.preventDefault();const t=this.domComponent.querySelector("#hostKey").value;if(!t)return!1;u.verifyHostKey(t).then(s=>{this.render({type:"known"})}).catch(s=>{u.alert("Invalid host key"),console.error(s)})}}),a("br"),a("button",{},"Return To List",{type:"click",event:()=>{this.render({type:"known"})}}))});r(this,"render",e=>{switch(this.domComponent.innerHTML="",e.type){case"known":this.renderKnownHosts();break;case"new":this.renderNewHostForm();break;default:this.renderKnownHosts()}});this.app=e,this.domComponent=a("div",{class:"host-form-container"})}}new gt;
