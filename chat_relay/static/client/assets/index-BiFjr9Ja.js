var D=Object.defineProperty;var _=(i,e,t)=>e in i?D(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var o=(i,e,t)=>_(i,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))n(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function t(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(a){if(a.ep)return;a.ep=!0;const r=t(a);fetch(a.href,r)}})();const v="https://chat.parchchat.com",x="wss://chat.parchchat.com/ws",g="5837a5c3-5268-45e1-9ea4-ee87d959d067",M="Parch Community";function s(i,e,t,n){if(typeof i>"u")return!1;var a=document.createElement(i);if(typeof e=="object")for(var r in e)a.setAttribute(r,e[r]);if(t)if(typeof t=="string"&&/<[^>]+>/.test(t))a.innerHTML=t;else{Array.isArray(t)||(t=[t]);for(var c=0;c<t.length;c++)t[c]instanceof Node?a.appendChild(t[c]):a.appendChild(document.createTextNode(t[c]))}if(n){Array.isArray(n)||(n=[n]);for(var d of n)a.addEventListener(d.type,d.event)}return a}const k="parch.hosts";function p(){try{const i=localStorage.getItem(k);if(!i)return[];const e=JSON.parse(i);return Array.isArray(e)?e:[]}catch{return[]}}function u(i){localStorage.setItem(k,JSON.stringify(i))}const h={async greet(i){return`Hello ${i}, It's show time!`},async alert(i){window.alert(i)},async confirm(i){return window.confirm(i)},async openExternal(i){window.open(i,"_blank","noopener,noreferrer")},async getHosts(){const i=p();return i.some(e=>e.uuid===g)||(i.push({uuid:g,name:M}),u(i)),i},async verifyHostKey(i){const e=await fetch(`${v}/api/host/${i}`);if(!e.ok)throw new Error("host not found");const t=await e.json(),n=p();return n.some(a=>a.uuid===i)||(n.push({uuid:t.uuid,name:t.name}),u(n)),t},async removeHost(i){const e=p(),t=e.filter(n=>n.uuid!==i);if(t.length===e.length)throw new Error(`host with UUID ${i} not found`);u(t)}},f="parch.chat.identity";function m(i){let e="";const t=i instanceof Uint8Array?i:new Uint8Array(i);for(let n=0;n<t.length;n+=1)e+=String.fromCharCode(t[n]);return btoa(e).replace(/=+$/g,"")}function y(i){const e=(4-i.length%4)%4,t=i+"=".repeat(e),n=atob(t),a=new Uint8Array(n.length);for(let r=0;r<n.length;r+=1)a[r]=n.charCodeAt(r);return a}function S(){try{const i=localStorage.getItem(f);if(!i)return null;const e=JSON.parse(i);return!e.publicKey||!e.privateKey?null:e}catch{return null}}function C(i){localStorage.setItem(f,JSON.stringify(i))}function A(i){if(!i||typeof i!="object")throw new Error("Identity payload must be an object");const e=typeof i.publicKey=="string"?i.publicKey.trim():"",t=typeof i.privateKey=="string"?i.privateKey.trim():"",n=typeof i.username=="string"?i.username.trim():"";if(!e||!t)throw new Error("Identity must include publicKey and privateKey");return{publicKey:e,privateKey:t,username:n}}async function L(){var a;if(!((a=window.crypto)!=null&&a.subtle))throw new Error("WebCrypto API is not available");const i=await window.crypto.subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),e=await window.crypto.subtle.exportKey("raw",i.publicKey),t=await window.crypto.subtle.exportKey("pkcs8",i.privateKey),n={publicKey:m(e),privateKey:m(t),username:""};return C(n),n}async function U(){const i=S();return i||L()}async function T(i,e){const t=y(i.privateKey),n=await window.crypto.subtle.importKey("pkcs8",t,{name:"Ed25519"},!1,["sign"]),a=new TextEncoder().encode(e),r=await window.crypto.subtle.sign({name:"Ed25519"},n,a);return m(r)}async function H(i){const e=y(i.privateKey),t=y(i.publicKey),n=await window.crypto.subtle.importKey("pkcs8",e,{name:"Ed25519"},!1,["sign"]),a=await window.crypto.subtle.importKey("raw",t,{name:"Ed25519"},!1,["verify"]),r=new TextEncoder().encode("parch-identity-check"),c=await window.crypto.subtle.sign({name:"Ed25519"},n,r);if(!await window.crypto.subtle.verify({name:"Ed25519"},a,c,r))throw new Error("Public/private key mismatch")}async function O(){return U()}async function N(){const i=await U();return JSON.stringify(i,null,2)}async function E(i){let e=i;if(typeof i=="string")try{e=JSON.parse(i)}catch{throw new Error("Identity import text must be valid JSON")}const t=A(e);return await H(t),C(t),t}function K(i){const e=S();e&&(e.username=(i||"").trim(),C(e))}function P(){localStorage.removeItem(f)}const l={getOrCreateIdentity:O,signAuthMessage:T,exportIdentity:N,importIdentity:E,setIdentityUsername:K,clearIdentity:P};class B{constructor(e,t){o(this,"open",e=>(this.domComponent.style.display="block",this.render(e)));o(this,"close",()=>{this.domComponent.style.display="none"});o(this,"renderPrompt",e=>new Promise(t=>{this.promptResolver=t,this.domComponent.append(s("div",{class:"modal-content"},[s("div",{class:"modal-header"},[s("h2",{},e||"Enter a value")]),s("div",{class:"modal-body"},[s("input",{id:"prompt-input",type:"text",style:"width: 100%; margin-bottom: 10px;"}),s("div",{style:"text-align: right;"},[s("button",{class:"btn"},"OK",{type:"click",event:()=>{const n=this.domComponent.querySelector("#prompt-input").value;this.close(),this.promptResolver(n)}}),s("button",{class:"btn btn-red",style:"margin-left: 10px;"},"Cancel",{type:"click",event:()=>{this.close(),this.promptResolver(null)}})])])]))}));o(this,"renderAuthorSettings",e=>[s("div",{class:"settings-section"},[s("h3",{},"Space Management"),s("div",{class:"settings-actions"},[s("button",{class:"btn"},"Invite User",{type:"click",event:()=>{this.render({type:"prompt",data:{message:"Enter recipient public key"}}).then(t=>{t&&this.socketConn.inviteUser({public_key:t.trim(),space_uuid:e.uuid})})}}),s("button",{class:"btn btn-red"},"Delete Space",{type:"click",event:()=>{h.confirm("Are you sure you want to delete this space?").then(t=>{t&&this.socketConn.deleteSpace({uuid:e.uuid})})}})])]),s("div",{class:"settings-section"},[s("h3",{},"Channel Management"),s("div",{class:"settings-actions"},[s("button",{class:"btn"},"+ Create Channel",{type:"click",event:()=>{this.render({type:"prompt",data:{message:"Please enter Channel name"}}).then(t=>{t&&this.socketConn.createChannel({name:t.trim(),space_uuid:e.uuid})})}})]),s("div",{class:"channels-list"},e.channels.map(t=>s("div",{class:"channel-item"},[s("span",{},t.name),s("button",{class:"btn-small btn-red"},"Delete",{type:"click",event:()=>{h.confirm("Are you sure you want to delete this channel?").then(n=>{n&&this.socketConn.deleteChannel({uuid:t.uuid})})}})])))])]);o(this,"renderSpaceUserSettings",(e,t)=>[s("div",{class:"settings-section"},[s("h3",{},"Space Management"),s("div",{class:"settings-actions"},[s("button",{class:"btn btn-red"},"Leave Space",{type:"click",event:()=>{h.confirm("Are you sure you want to leave this space?").then(n=>{n&&this.socketConn.leaveSpace({space_uuid:e.uuid,user_id:t.id,user_public_key:t.public_key||""})})}})])])]);o(this,"renderAccount",e=>{const t=async n=>{if(!n){h.alert("No identity data provided");return}if(await h.confirm("Import identity and replace the current local identity on this browser?"))try{await l.importIdentity(n),h.alert("Identity imported. Reloading..."),window.location.reload()}catch(r){console.error(r),h.alert((r==null?void 0:r.message)||"Failed to import identity")}};this.domComponent.append(s("div",{class:"modal-content"},[s("div",{class:"modal-header"},[s("h2",{},"Account"),s("button",{class:"close-modal"},"×",{type:"click",event:this.close})]),s("div",{class:"modal-body"},[s("h3",{},`Username: "${e.username}"`),s("div",{class:"settings-section"},[s("h3",{},"Public Key (Share for Invites)"),s("p",{style:"display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--main-gray);"},"Share this public key with space admins so they can invite you."),s("textarea",{id:"public-key-display",readonly:"readonly",rows:"4",style:"width: 100%; font-size: 0.8rem; padding: 8px; background: var(--second-dark); color: var(--a-blue); border: 1px solid var(--main-gray); border-radius: 4px; resize: vertical;"}),s("br"),s("button",{class:"btn",id:"copy-public-key-btn"},"Copy Public Key",{type:"click",event:async()=>{var r;const n=this.domComponent.querySelector("#public-key-display"),a=((n==null?void 0:n.value)||"").trim();if(!a){h.alert("Public key not available yet");return}try{(r=navigator.clipboard)!=null&&r.writeText?await navigator.clipboard.writeText(a):(n.focus(),n.select(),document.execCommand("copy")),h.alert("Public key copied")}catch{h.alert("Failed to copy public key")}}})]),s("div",{class:"settings-section"},[s("h3",{},"Identity Transfer (Private Key)"),s("p",{style:"display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--light-red);"},"Anyone with your identity JSON can access your account. Share it only with yourself."),s("p",{style:"display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--main-gray);"},"Export on this browser, then import on another browser/device to keep the same identity."),s("textarea",{id:"identity-export-display",readonly:"readonly",rows:"6",style:"width: 100%; font-size: 0.78rem; padding: 8px; background: var(--second-dark); color: var(--main-white); border: 1px solid var(--main-gray); border-radius: 4px; resize: vertical; margin-bottom: 8px;"}),s("button",{class:"btn",id:"copy-identity-btn"},"Copy Identity JSON",{type:"click",event:async()=>{var r;const n=this.domComponent.querySelector("#identity-export-display"),a=((n==null?void 0:n.value)||"").trim();if(!a){h.alert("Identity export is not ready");return}try{(r=navigator.clipboard)!=null&&r.writeText?await navigator.clipboard.writeText(a):(n.focus(),n.select(),document.execCommand("copy")),h.alert("Identity JSON copied")}catch{h.alert("Failed to copy identity JSON")}}}),s("button",{class:"btn",id:"download-identity-btn",style:"margin-left: 8px;"},"Download Identity File",{type:"click",event:async()=>{try{const n=await l.exportIdentity(),a=new Blob([n],{type:"application/json"}),r=URL.createObjectURL(a),c=document.createElement("a");c.href=r,c.download="parch-identity.json",document.body.appendChild(c),c.click(),c.remove(),URL.revokeObjectURL(r)}catch{h.alert("Failed to generate identity file")}}}),s("br"),s("textarea",{id:"identity-import-input",rows:"6",placeholder:"Paste identity JSON here to import",style:"width: 100%; font-size: 0.78rem; padding: 8px; background: var(--second-dark); color: var(--a-blue); border: 1px solid var(--main-gray); border-radius: 4px; resize: vertical; margin-bottom: 8px;"}),s("button",{class:"btn",id:"import-identity-btn"},"Import Identity JSON",{type:"click",event:async()=>{const n=this.domComponent.querySelector("#identity-import-input"),a=((n==null?void 0:n.value)||"").trim();if(!a){h.alert("Paste identity JSON to import");return}await t(a)}}),s("button",{class:"btn",id:"import-identity-file-btn",style:"margin-left: 8px;"},"Import Identity File",{type:"click",event:()=>{const n=this.domComponent.querySelector("#identity-import-file");n&&(n.value="",n.click())}}),s("input",{id:"identity-import-file",type:"file",accept:"application/json,.json",style:"display: none;"},null,{type:"change",event:async n=>{var r,c;const a=(c=(r=n==null?void 0:n.target)==null?void 0:r.files)==null?void 0:c[0];if(a)try{const d=await a.text();await t(d)}catch{h.alert("Failed to read identity file")}}})]),s("div",{class:"settings-section"},[s("h3",{},"Local Fallback Username"),s("p",{style:"display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--main-gray);"},"Used as the default username sent during auth when joining a host for the first time."),s("div",{class:"input-container"},[s("label",{for:"local-identity-username"},"Local Username"),s("input",{id:"local-identity-username",name:"localIdentityUsername",type:"text",value:"",placeholder:"Set local fallback username"})]),s("br"),s("button",{class:"btn"},"Save Local Username",{type:"click",event:()=>{const n=this.domComponent.querySelector("#local-identity-username"),a=((n==null?void 0:n.value)||"").trim();l.setIdentityUsername(a),h.alert("Local fallback username saved")}})]),s("form",{id:"update-username-form"},[s("fieldset",{},[s("legend",{},"Update Username"),s("div",{class:"input-container"},[s("label",{for:"username"},"Username"),s("input",{id:"username",name:"username",type:"text",required:!0,autofocus:!0,value:e.username||""})]),s("br"),s("button",{type:"submit"},"Submit")])],{type:"submit",event:n=>{n.preventDefault();const a=new FormData(n.target),r=Object.fromEntries(a.entries());r.user_id=e.id,r.user_public_key=e.public_key||"",this.socketConn.updateUsername(r)}}),s("br"),s("button",{class:"btn-red"},"Reset Identity",{type:"click",event:()=>{h.confirm("Reset local identity key? This creates a new account identity.").then(n=>{n&&(l.clearIdentity(),window.location.reload())})}})])])),l.getOrCreateIdentity().then(n=>{const a=this.domComponent.querySelector("#public-key-display"),r=this.domComponent.querySelector("#identity-export-display"),c=this.domComponent.querySelector("#local-identity-username");a&&(a.value=n.publicKey||""),c&&(c.value=n.username||""),r&&l.exportIdentity().then(d=>{r.value=d}).catch(()=>{r.value=""})}).catch(()=>{const n=this.domComponent.querySelector("#public-key-display"),a=this.domComponent.querySelector("#identity-export-display"),r=this.domComponent.querySelector("#local-identity-username");n&&(n.value=""),r&&(r.value=""),a&&(a.value="")})});o(this,"renderInvites",(e,t)=>{this.domComponent.append(s("div",{class:"modal-content"},[s("div",{class:"modal-header"},[s("h2",{},"Space Invites"),s("button",{class:"close-modal"},"×",{type:"click",event:this.close})]),s("div",{class:"modal-body"},e&&e.length&&t?s("div",{class:"invites-section"},[...e.map(n=>s("div",{class:"pending-invites-item"},[s("span",{},n.name),s("div",{},[s("button",{class:"btn-small accept-invite"},"Accept",{type:"click",event:()=>this.socketConn.acceptInvite({space_user_id:n.id,user_id:t.id,user_public_key:t.public_key||""})}),s("button",{class:"btn-small btn-red decline-invite"},"Decline",{type:"click",event:()=>this.socketConn.declineInvite({space_user_id:n.id,user_id:t.id,user_public_key:t.public_key||""})})])]))]):"...No Invite Yet")]))});o(this,"render",e=>{var t;switch(this.domComponent.innerHTML="",e.type){case"prompt":if((t=e.data)!=null&&t.message)return this.renderPrompt(e.data.message);break;case"account":e.data.user&&this.renderAccount(e.data.user);break;case"invites":this.renderInvites(e.data.invites,e.data.user);break;case"space-settings":if(e.data.space&&e.data.user){const n=e.data.space,a=e.data.user,r=n.author_id===a.id;this.domComponent.append(s("div",{class:"modal-content"},[s("div",{class:"modal-header"},[s("h2",{},`Space Settings: ${n.name}`),s("button",{class:"close-modal"},"×",{type:"click",event:this.close})]),s("div",{class:"modal-body"},r?this.renderAuthorSettings(n):this.renderSpaceUserSettings(n,a))]))}break}});this.app=e,this.socketConn=t,this.domComponent=s("div",{class:"modal"}),this.promptResolver=null}}class J{constructor(e){o(this,"initSpaceComponents",()=>{this.data.spaces&&(this.spaceComponents=this.data.spaces.map(e=>new b({domComponent:s("div",{class:"space-item"}),space:e,user:this.data.user,openSpaceSettings:this.openSpaceSettings,loadChannel:this.loadChannel})))});o(this,"addSpace",e=>{const t=new b({domComponent:s("div",{class:"space-item"}),space:e,user:this.data.user,openSpaceSettings:this.openSpaceSettings,loadChannel:this.loadChannel});this.spaceComponents.push(t),this.render()});o(this,"render",()=>{this.domComponent.innerHTML="",this.initSpaceComponents(),this.userAccountComponent=new R({data:this.data,returnToHostList:this.returnToHostList,openDashModal:this.openDashModal,domComponent:s("div",{class:"user-component"})}),this.spaceUserListComponent=new j({data:this.data,socketConn:this.socketConn,getCurrentSpaceUUID:this.getCurrentSpaceUUID,domComponent:s("div",{class:"space-users-list",id:"space-users-list"})}),this.domComponent.append(s("div",{class:"sidebar-spaces-container"},[s("div",{id:"spaces-list"},this.spaceComponents.map(e=>e.domComponent)),s("button",{class:"create-space-btn",id:"new-space-btn"},"+ Create New Space",{type:"click",event:()=>{this.openDashModal({type:"prompt",data:{message:"Please enter Space 'Name'"}}).then(e=>{e&&(e.trim(),this.socketConn.createSpace({name:e}))})}})]),s("br"),this.spaceUserListComponent.domComponent,s("hr"),this.userAccountComponent.domComponent)});this.data=e.data,this.socketConn=e.socketConn,this.returnToHostList=e.returnToHostList,this.openDashModal=e.openDashModal,this.closeDashModal=e.closeDashModal,this.getCurrentSpaceUUID=e.getCurrentSpaceUUID,this.spaceComponents=[],this.domComponent=e.domComponent,this.openSpaceSettings=e.openSpaceSettings,this.loadChannel=e.loadChannel,this.render()}}class R{constructor(e){o(this,"render",()=>{this.domComponent.innerHTML="",this.domComponent.append(s("a",{href:"#"},"Account",{type:"click",event:e=>{this.openDashModal({type:"account",data:{user:this.data.user}})}}),s("a",{href:"#"},"Invites",{type:"click",event:e=>{this.openDashModal({type:"invites",data:{invites:this.data.invites,user:this.data.user}})}}),s("a",{href:"#"},"<- Host List",{type:"click",event:e=>{this.returnToHostList()}}))});this.data=e.data,this.returnToHostList=e.returnToHostList,this.openDashModal=e.openDashModal,this.domComponent=e.domComponent,this.render()}}class j{constructor(e){o(this,"isAuthor",(e,t)=>String(e.author_id)===String(t.id));o(this,"renderUserElement",(e,t)=>s("div",{class:"space-user-item",id:"space-user-item"},`${t.username} ${this.isAuthor(e,t)?"*":""}`,{type:"click",event:async()=>{this.isAuthor(e,this.data.user)&&this.data.user.id!=t.id&&h.confirm("Are you sure you want to remove this user?").then(n=>{n&&this.socketConn.removeSpaceUser({space_uuid:e.uuid,user_id:t.id,user_public_key:t.public_key||""})})}}));o(this,"renderSpaceUsersList",e=>{const t=[];return e.users&&e.users.map(n=>{t.push(this.renderUserElement(e,n))}),t});o(this,"render",()=>{this.domComponent.innerHTML="";const e=this.getCurrentSpaceUUID();if(e){const t=this.data.spaces.find(n=>n.uuid===e);if(!t)return;this.domComponent.append(s("h3",{},"Users"),...this.renderSpaceUsersList(t))}});this.data=e.data,this.socketConn=e.socketConn,this.getCurrentSpaceUUID=e.getCurrentSpaceUUID,this.domComponent=e.domComponent,this.render()}}class b{constructor(e){o(this,"isAuthor",()=>String(this.space.author_id)===String(this.user.id));o(this,"renderChannelList",()=>s("div",{class:"channel-list"},(this.space.channels||[]).map(e=>s("div",{class:"channel-item"},[s("span",{class:"channel-hash"},"#"),s("span",{},e.name)],{type:"click",event:()=>this.loadChannel(this.space.uuid,e.uuid)}))));o(this,"toggleChannels",()=>{this.channelsOpen=!this.channelsOpen,this.render()});o(this,"render",()=>{this.domComponent.textContent="",this.domComponent.className=`space-item${this.channelsOpen?" space-item--open":""}`,this.domComponent.append(s("div",{class:"space-header"},[s("span",{class:"space-chevron"}),s("span",{},this.space.name),s("div",{class:"space-actions"},s("button",{class:"btn-icon open-settings"},"⚙️",{type:"click",event:e=>{e.stopPropagation(),this.openSpaceSettings(this.space)}}))],{type:"click",event:this.toggleChannels}),...this.channelsOpen?[this.renderChannelList()]:[])});this.space=e.space,this.user=e.user,this.openSpaceSettings=e.openSpaceSettings,this.loadChannel=e.loadChannel,this.channelsOpen=!1,this.domComponent=e.domComponent,this.render()}}function F(i){const e=new Date(i),t=e.getFullYear(),n=(e.getMonth()+1).toString().padStart(2,"0"),a=e.getDate().toString().padStart(2,"0"),r=e.getHours(),c=e.getMinutes(),d=r%12||12,w=r<12?"am":"pm",I=c.toString().padStart(2,"0");return`${n}-${a}-${t} ${d}:${I}${w}`}const W="data:image/svg+xml;base64,"+btoa(`
    <svg xmlns="http://www.w3.org/2000/svg" width="150" height="100" viewBox="0 0 150 100">
      <rect width="150" height="100" fill="#aaaaa" />
      <text x="75" y="55" font-size="14" text-anchor="middle" fill="#a00" font-family="sans-serif">Image not found</text>
    </svg>
  `);function $(i){const e=document.createElement("img");return e.src=i,e.alt="Image",e.style="max-width: 100%; max-height: 250px; margin: 5px; cursor: pointer;",e.onerror=()=>{e.src=W},e}function q(i){const e=i.split(".");if(e.length<2)return!1;const t=e[e.length-1].toLowerCase().split("?")[0];return["jpg","jpeg","png","gif","webp","svg","tiff"].includes(t)}class z{constructor(e){o(this,"initialize",e=>{this.chatBoxComponent=new Y({domComponent:s("div"),data:this.data,socketConn:this.socketConn,channelUUID:e}),this.render();const t=new Date().toISOString();this.socketConn.getMessages(t)});o(this,"render",()=>{this.domComponent.innerHTML="",this.chatBoxComponent&&this.domComponent.append(this.chatBoxComponent.domComponent)});this.domComponent=e.domComponent,this.data=e.data,this.socketConn=e.socketConn,this.chatBoxComponent=null}}class Y{constructor(e){o(this,"render",()=>{this.domComponent.innerHTML="",this.domComponent.append(s("div",{class:"chatapp-channel-title"},this.channel.name),this.chatBoxMessagesComponent.domComponent,s("div",{class:"chat-box-form"},[s("textarea",{id:"chat-box-form-input",class:"chat-box-form-input",autofocus:!0,type:"text",required:!0,autocomplete:"off",placeholder:"Type message here..."},null,[{type:"input",event:e=>{const t=e.target;t.style.height="auto",t.style.height=`${t.scrollHeight}px`}},{type:"keydown",event:e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();const t=e.target,n=t.value.trim();n&&(this.socketConn.sendMessage(n),t.value="",t.style.height="auto",t.focus())}}}])]))});this.domComponent=e.domComponent,this.domComponent.className="chat-box-container",this.data=e.data,this.socketConn=e.socketConn,this.channelUUID=e.channelUUID;for(const t of this.data.spaces){const n=t.channels.find(a=>a.uuid===this.channelUUID);if(n){this.space=t,this.channel=n;break}}this.chatBoxMessagesComponent=new V({domComponent:s("div",{class:"chat-box-messages",id:"chat-box-messages"}),channelUUID:this.channelUUID,socketConn:this.socketConn}),this.render()}}class V{constructor(e){o(this,"getPreviousMessagesDebounce",()=>{this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.debounceTimeout=setTimeout(()=>{this.getPreviousMessages()},300)});o(this,"getPreviousMessages",()=>{if(this.isLoading||!this.hasMoreMessages||!this.chatBoxMessages.length||!this.isScrolledToTop())return;this.isLoading=!0;const e=this.chatBoxMessages[0].timestamp;this.socketConn.getMessages(e)});o(this,"scrollDown",()=>{this.domComponent.scrollTop=this.domComponent.scrollHeight});o(this,"isScrolledToTop",()=>this.domComponent.scrollTop<=20);o(this,"isScrolledToBottom",()=>this.domComponent.scrollHeight-this.domComponent.scrollTop<=this.domComponent.clientHeight+40);o(this,"appendNewMessage",e=>{const t=this.isScrolledToBottom();this.chatBoxMessages.push(e),this.render(),t&&requestAnimationFrame(()=>this.scrollDown())});o(this,"createMessage",e=>{const t=n=>{const a=/(https?:\/\/[^\s]+)/g,r=/^https?:\/\/[^\s]+$/;return n.split(a).map(d=>r.test(d)?q(d)?$(d):s("a",{href:d,target:"_blank",rel:"noopener noreferrer",style:"margin: 0 5px;"},d):d)};return s("div",{class:"chat-box-message-content"},[s("div",{style:"display: flex; align-items: flex-end;"},[s("small",{style:"margin-right: var(--main-distance); color: var(--main-gray);"},F(e.timestamp)),s("div",{style:"font-weight: bold; margin-right: var(--main-distance); color: var(--light-yellow);"},e.username)]),s("div",{class:"chat-box-message-text"},[...t(e.content)]),s("hr")])});o(this,"render",()=>{this.domComponent.innerHTML="";const e=this.chatBoxMessages.map(t=>this.createMessage(t));this.domComponent.append(...e)});this.chatBoxMessages=[],this.channelUUID=e.channelUUID,this.socketConn=e.socketConn,this.messageRequestSize=50,this.hasMoreMessages=!0,this.debounceTimeout=null,this.isLoading=!1,this.domComponent=s("div",{class:"chat-box-messages",id:"chat-box-messages"},null,{type:"scroll",event:()=>{this.getPreviousMessagesDebounce()}})}}class G{constructor(e){o(this,"renderChannel",e=>{this.currentChannelUUID=e,this.domComponent.innerHTML="";const t=s("div",{class:"chatapp-container"});this.domComponent.append(t),this.chatApp?this.chatApp.domComponent=t:this.chatApp=new z({domComponent:t,data:this.data,socketConn:this.socketConn}),this.chatApp.initialize(e)});o(this,"cleanup",()=>{var e,t;this.chatApp&&((t=(e=this.chatApp).cleanup)==null||t.call(e),this.chatApp=null),this.currentChannelUUID=null});o(this,"render",()=>{this.cleanup(),this.domComponent.innerHTML="",this.domComponent.append(s("div",{class:"no-channel-selected"},[s("h2",{},"Select a channel to start chatting")]))});this.domComponent=e.domComponent,this.data=e.data,this.socketConn=e.socketConn,this.chatApp=null,this.currentChannelUUID=null,this.render()}}class Q{constructor(e){o(this,"retryConnection",()=>{if(this.retryCount+=1,this.retryCount>this.maxRetries){h.alert("Unable to reconnect to host. Returning to home."),this.returnToHostList();return}setTimeout(()=>{var t;((t=this.socket)==null?void 0:t.readyState)!==WebSocket.OPEN&&this.connect()},2e3)});o(this,"connect",()=>{this.socket=new WebSocket(x),this.socket.onopen=()=>{this.joinHost()},this.socket.onerror=e=>{console.error("WebSocket error:",e)},this.socket.onclose=()=>{this.manualClose||this.retryConnection()},this.socket.onmessage=async e=>{var t;try{const n=JSON.parse(e.data);switch(n.type){case"join_ack":break;case"auth_challenge":await this.authenticateWithPublicKey((t=n.data)==null?void 0:t.challenge);break;case"auth_pubkey_success":this.closeDashModal(),this.getDashboardData();break;case"dash_data_payload":this.dashboardInitialRender(n.data),this.joinAllSpaces(n);break;case"update_username_success":this.updateAccountUsername(n,this.hostUUID),l.setIdentityUsername(n.data.username);break;case"create_space_success":this.handleCreateSpace(n);break;case"delete_space_success":this.handleDeleteSpace();break;case"create_channel_success":this.handleCreateChannel(n);break;case"create_channel_update":this.handleCreateChannelUpdate(n);break;case"delete_channel_success":this.handleDeleteChannel(n);break;case"delete_channel_update":this.handleDeleteChannelUpdate(n);break;case"invite_user_success":this.handleInviteUser(n);break;case"invite_user_update":this.handleAddInvite(n);break;case"accept_invite_success":this.handleAcceptInvite(n);break;case"accept_invite_update":this.handleAcceptInviteUpdate(n);break;case"decline_invite_success":this.handleDeclineInvite(n);break;case"leave_space_success":this.handleLeaveSpace();break;case"leave_space_update":this.handleLeaveSpaceUpdate(n);break;case"chat":this.renderChatAppMessage(n);break;case"get_messages_success":this.handleIncomingMessages(n);break;case"error":h.alert(n.data.error);break;case"authentication-error":h.alert(n.data.error||"Authentication failed");break;case"author_error":h.alert("Failed to connect to host. Host is offline."),this.returnToHostList();break;default:break}}catch(n){console.error("JSON parsing error:",n)}}});o(this,"authenticateWithPublicKey",async e=>{if(!e){h.alert("Missing auth challenge from server");return}try{const t=await l.getOrCreateIdentity(),n=`parch-chat-auth:${this.hostUUID}:${e}`,a=await l.signAuthMessage(t,n),r={type:"auth_pubkey",data:{public_key:t.publicKey,username:t.username||"",challenge:e,signature:a}};this.socket.send(JSON.stringify(r))}catch(t){console.error(t),h.alert("Failed to initialize public-key identity")}});o(this,"joinHost",()=>{var e;((e=this.socket)==null?void 0:e.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"join_host",data:{uuid:this.hostUUID}}))});o(this,"getDashboardData",()=>{var e;((e=this.socket)==null?void 0:e.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"get_dash_data",data:""}))});o(this,"joinAllSpaces",e=>{var t;if(((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const n=e.data.spaces.map(a=>a.uuid);this.socket.send(JSON.stringify({type:"join_all_spaces",data:{space_uuids:n}}))}});o(this,"updateUsername",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"update_username",data:e}))});o(this,"createSpace",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"create_space",data:e}))});o(this,"deleteSpace",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"delete_space",data:e}))});o(this,"createChannel",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"create_channel",data:e}))});o(this,"deleteChannel",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"delete_channel",data:e}))});o(this,"inviteUser",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"invite_user",data:e}))});o(this,"acceptInvite",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"accept_invite",data:e}))});o(this,"declineInvite",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"decline_invite",data:e}))});o(this,"leaveSpace",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"leave_space",data:e}))});o(this,"removeSpaceUser",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"remove_space_user",data:e}))});o(this,"joinChannel",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"join_channel",data:{uuid:e}}))});o(this,"sendMessage",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"chat",data:{content:e}}))});o(this,"getMessages",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"get_messages",data:{before_unix_time:e}}))});o(this,"hardClose",()=>{this.manualClose=!0,this.close()});o(this,"close",()=>{this.socket&&this.socket.close()});this.returnToHostList=e.returnToHostList,this.updateAccountUsername=e.updateAccountUsername,this.dashboardInitialRender=e.dashboardInitialRender,this.openDashModal=e.openDashModal,this.closeDashModal=e.closeDashModal,this.renderChatAppMessage=e.renderChatAppMessage,this.handleCreateSpace=e.handleCreateSpace,this.handleCreateChannel=e.handleCreateChannel,this.handleDeleteSpace=e.handleDeleteSpace,this.handleDeleteChannel=e.handleDeleteChannel,this.handleCreateChannelUpdate=e.handleCreateChannelUpdate,this.handleDeleteChannelUpdate=e.handleDeleteChannelUpdate,this.handleInviteUser=e.handleInviteUser,this.handleAddInvite=e.handleAddInvite,this.handleAcceptInvite=e.handleAcceptInvite,this.handleAcceptInviteUpdate=e.handleAcceptInviteUpdate,this.handleDeclineInvite=e.handleDeclineInvite,this.handleLeaveSpace=e.handleLeaveSpace,this.handleLeaveSpaceUpdate=e.handleLeaveSpaceUpdate,this.handleIncomingMessages=e.handleIncomingMessages,this.socket=null,this.manualClose=!1,this.retryCount=0,this.maxRetries=2,this.hostUUID=localStorage.getItem("hostUUID"),this.hostUUID?this.connect():(h.alert("Missing host key"),this.returnToHostList())}}class X{constructor(e){o(this,"initialize",()=>{this.domComponent.append(s("div",{class:"initial-spinner"},[s("div",{},"Connecting To Host..."),s("br"),s("div",{class:"lds-dual-ring"})])),this.socketConn=new Q({returnToHostList:this.returnToHostList,updateAccountUsername:this.updateAccountUsername,dashboardInitialRender:this.initialRender,openDashModal:this.openDashModal,closeDashModal:this.closeDashModal,renderChatAppMessage:this.renderChatAppMessage,handleCreateSpace:this.handleCreateSpace,handleDeleteSpace:this.handleDeleteSpace,handleCreateChannel:this.handleCreateChannel,handleCreateChannelUpdate:this.handleCreateChannelUpdate,handleDeleteChannel:this.handleDeleteChannel,handleDeleteChannelUpdate:this.handleDeleteChannelUpdate,handleInviteUser:this.handleInviteUser,handleAddInvite:this.handleAddInvite,handleAcceptInvite:this.handleAcceptInvite,handleAcceptInviteUpdate:this.handleAcceptInviteUpdate,handleDeclineInvite:this.handleDeclineInvite,handleLeaveSpace:this.handleLeaveSpace,handleLeaveSpaceUpdate:this.handleLeaveSpaceUpdate,handleIncomingMessages:this.handleIncomingMessages}),this.dashModal=new B(this,this.socketConn),this.domComponent.append(this.dashModal.domComponent)});o(this,"initialRender",e=>{this.data=e,this.data.spaces||(this.data.spaces=[]),this.sidebar=new J({data:this.data,socketConn:this.socketConn,returnToHostList:this.returnToHostList,domComponent:s("div",{class:"sidebar"}),openDashModal:this.openDashModal,closeDashModal:this.closeDashModal,getCurrentSpaceUUID:this.getCurrentSpaceUUID,openSpaceSettings:this.openSpaceSettings,loadChannel:this.loadChannel}),this.mainContent=new G({socketConn:this.socketConn,data:this.data,domComponent:s("div",{id:"channel-content",class:"channel-content"})}),this.render()});o(this,"updateAccountUsername",(e,t)=>{this.data.user.username=e.data.username,this.sidebar.userAccountComponent.render(),this.openDashModal({type:"account",data:{user:this.data.user}})});o(this,"getCurrentSpaceUUID",()=>this.currentSpaceUUID);o(this,"loadChannel",(e,t)=>{this.currentSpaceUUID=e,this.socketConn.joinChannel(t),this.sidebar.spaceUserListComponent.render(),this.mainContent.renderChannel(t)});o(this,"openDashModal",e=>this.dashModal.open(e));o(this,"closeDashModal",()=>{this.dashModal.close()});o(this,"openSpaceSettings",e=>{this.currentSpaceUUID=e.uuid,this.openDashModal({type:"space-settings",data:{space:e,user:this.data.user}})});o(this,"closeSpaceSettings",()=>{this.closeDashModal(),this.currentSpaceUUID=null});o(this,"handleCreateSpace",async e=>{this.data.spaces.push(e.data.space),this.sidebar.render()});o(this,"handleDeleteSpace",async()=>{if(!this.currentSpaceUUID)return;this.data.spaces=this.data.spaces.filter(t=>t.uuid!==this.currentSpaceUUID);const e=this.sidebar.spaceComponents.filter(t=>t.space.uuid!==this.currentSpaceUUID);this.sidebar.spaceComponents=e,this.currentSpaceUUID=null,this.mainContent.render(),this.sidebar.render(),this.sidebar.spaceUserListComponent.render(),this.closeSpaceSettings()});o(this,"handleInviteUser",e=>{window.alert("Invite sent")});o(this,"handleAddInvite",e=>{this.data.invites||(this.data.invites=[]),this.data.invites.push(e.data.invite)});o(this,"handleAcceptInvite",e=>{this.data.invites=this.data.invites.filter(t=>t.id!==e.data.space_user_id),this.data.spaces.push(e.data.space),this.sidebar.render(),this.openDashModal({type:"invites",data:{invites:this.data.invites,user:this.data.user}})});o(this,"handleAcceptInviteUpdate",e=>{console.log("invite update",e);const t=this.data.spaces.find(n=>n.uuid===e.data.space_uuid);t.users.find(n=>n.id===e.data.user.id||n.public_key&&e.data.user.public_key&&n.public_key===e.data.user.public_key)||t.users.push(e.data.user),t&&this.currentSpaceUUID===t.uuid&&this.data.user.id!==e.data.user.id&&this.sidebar.spaceUserListComponent.render()});o(this,"handleDeclineInvite",e=>{this.data.invites=this.data.invites.filter(t=>t.id!==e.data.space_user_id),this.openDashModal({type:"invites",data:{invites:this.data.invites,user:this.data.user}})});o(this,"handleLeaveSpace",()=>{this.data.spaces=this.data.spaces.filter(e=>e.uuid!==this.currentSpaceUUID),this.currentSpaceUUID=null,this.sidebar.render(),this.mainContent.render()});o(this,"handleLeaveSpaceUpdate",e=>{const t=this.data.spaces.find(n=>n.uuid===e.data.space_uuid);if(t&&this.currentSpaceUUID===t.uuid){const n=t.users.findIndex(a=>a.id===e.data.user_id||a.public_key&&e.data.user_public_key&&a.public_key===e.data.user_public_key);n>=0&&(t.users.splice(n,1),this.sidebar.spaceUserListComponent.render())}});o(this,"handleCreateChannel",e=>{const{space_uuid:t,channel:n}=e.data,a=this.data.spaces.find(c=>c.uuid===t);if(!a)return;a.channels.push(n);const r=this.sidebar.spaceComponents.find(c=>c.space.uuid===t);r&&r.render(),this.openDashModal({type:"space-settings",data:{space:a,user:this.data.user}})});o(this,"handleCreateChannelUpdate",e=>{const{space_uuid:t,channel:n}=e.data,a=this.data.spaces.find(d=>d.uuid===t);if(!a||a.channels.some(d=>d.uuid===n.uuid))return;a.channels.push(n);const c=this.sidebar.spaceComponents.find(d=>d.space.uuid===t);c&&c.render()});o(this,"handleDeleteChannel",e=>{const{uuid:t,space_uuid:n}=e.data,a=this.data.spaces.find(d=>d.uuid===n);if(!a)return;const r=a.channels.findIndex(d=>d.uuid===t);if(r===-1)return;a.channels.splice(r,1);const c=this.sidebar.spaceComponents.find(d=>d.space.uuid===n);c&&c.render(),this.openDashModal({type:"space-settings",data:{space:a,user:this.data.user}}),this.mainContent.currentChannelUUID===t&&(this.mainContent.currentChannelUUID=null,this.mainContent.chatApp=null,this.mainContent.render())});o(this,"handleDeleteChannelUpdate",e=>{const{uuid:t,space_uuid:n}=e.data,a=this.data.spaces.find(d=>d.uuid===n);if(!a)return;const r=a.channels.findIndex(d=>d.uuid===t);if(r===-1)return;a.channels.splice(r,1);const c=this.sidebar.spaceComponents.find(d=>d.space.uuid===n);c&&c.render(),this.mainContent.currentChannelUUID===t&&(this.mainContent.currentChannelUUID=null,this.mainContent.chatApp=null,this.mainContent.render())});o(this,"renderChatAppMessage",e=>{this.mainContent.chatApp&&(this.mainContent.chatApp.chatBoxComponent.chatBoxMessagesComponent.appendNewMessage(e.data),e.data.username===this.data.user.username?this.mainContent.chatApp.chatBoxComponent.chatBoxMessagesComponent.scrollDown():this.mainContent.chatApp.chatBoxComponent.chatBoxMessagesComponent.isScrolledToBottom()&&this.mainContent.chatApp.chatBoxComponent.chatBoxMessagesComponent.scrollDown())});o(this,"handleIncomingMessages",e=>{if(e.data.messages&&this.mainContent.chatApp&&this.mainContent.chatApp.chatBoxComponent.channelUUID===e.data.channel_uuid){const t=this.mainContent.chatApp.chatBoxComponent.chatBoxMessagesComponent,n=t.domComponent,a=n.scrollHeight,r=n.scrollTop;t.hasMoreMessages=e.data.has_more_messages,t.isLoading=!1,t.chatBoxMessages=[...e.data.messages,...t.chatBoxMessages],t.render();const c=n.scrollHeight;n.scrollTop=c-a+r}});this.domComponent=s("div",{class:"dashboard-container"}),this.returnToHostList=e.returnToHostList,this.data=null,this.sidebar=null,this.dashModal=null,this.mainContent=null,this.currentSpaceUUID=null,this.socketConn=null}render(){this.domComponent.innerHTML="",this.domComponent.append(this.sidebar.domComponent,this.mainContent.domComponent,this.dashModal.domComponent)}}class Z{constructor(){o(this,"returnToHostList",async()=>{var e,t;localStorage.removeItem("hostUUID"),(e=this.dashboard)!=null&&e.socketConn&&this.dashboard.socketConn.hardClose(),(t=this.dashboard)!=null&&t.domComponent&&(this.dashboard.domComponent.innerHTML=""),this.dashboard=null,this.render({type:"host_form"})});o(this,"render",e=>{switch(this.domComponent.innerHTML="",e.type){case"dash":this.dashboard=new X({returnToHostList:this.returnToHostList}),this.domComponent.append(this.dashboard.domComponent),this.dashboard.initialize();break;case"host_form":this.domComponent.append(this.hostForm.domComponent),this.hostForm.render({type:"known"});break;default:this.domComponent.append(this.hostForm.domComponent),this.hostForm.render({type:"known"})}});h.greet("Hello Parch").then(e=>console.log(e)),this.domComponent=document.getElementById("app"),this.hostForm=new ee(this),this.render({type:"host_form"})}}class ee{constructor(e){o(this,"renderHostList",e=>!e||!e.hosts||!e.hosts.length?[s("div",{},"...No Hosts")]:e.hosts.map(n=>{const a=n.online==1;return s("div",{class:"host-item"},[s("div",{style:"display: flex; align-items: baseline"},[s("span",{class:a?"host-online-span":"host-offline-span"}),s("div",{class:"host-item-name"},`${n.name} `)]),s("button",{class:"btn-small btn-red"},"Remove",{type:"click",event:r=>{r.stopPropagation(),h.confirm("Are you sure you want to remove this host?").then(c=>{c&&(h.removeHost(n.uuid),r.target.parentElement.remove())})}})],{type:"click",event:()=>{a?(localStorage.setItem("hostUUID",n.uuid),this.app.render({type:"dash"})):h.alert("Host is not online")}})}));o(this,"renderKnownHosts",async()=>{const t=(await h.getHosts()).map(a=>a.uuid);let n=[];try{n=await(await fetch(`${v}/api/hosts_by_uuids`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uuids:t})})).json()}catch(a){console.log(a),h.alert("Failed to connect to relay server")}this.domComponent.append(s("h2",{},"Select From Known Hosts"),s("br"),s("button",{},"Refresh",{type:"click",event:()=>{this.render({type:"known"})}}),s("br"),s("div",{class:"host-list-index"},[...this.renderHostList(n)]),s("br"),s("div",{},"Or"),s("br"),s("button",{class:""},"Add New Host",{type:"click",event:()=>{this.render({type:"new"})}}))});o(this,"renderNewHostForm",()=>{this.domComponent.append(s("h2",{},"Enter Host Key"),s("form",{id:"hostForm",onsubmit:this.handleSubmit},[s("fieldset",{},[s("legend",{},"New Host"),s("div",{class:"input-container"},[s("label",{for:"hostKey"},"Host Key"),s("input",{type:"text",id:"hostKey",name:"hostKey",required:!0})]),s("br"),s("button",{type:"submit"},"Continue")])],{type:"submit",event:e=>{e.preventDefault();const t=this.domComponent.querySelector("#hostKey").value;if(!t)return!1;h.verifyHostKey(t).then(n=>{this.render({type:"known"})}).catch(n=>{h.alert("Invalid host key"),console.error(n)})}}),s("br"),s("button",{},"Return To List",{type:"click",event:()=>{this.render({type:"known"})}}))});o(this,"render",e=>{switch(this.domComponent.innerHTML="",e.type){case"known":this.renderKnownHosts();break;case"new":this.renderNewHostForm();break;default:this.renderKnownHosts()}});this.app=e,this.domComponent=s("div",{class:"host-form-container"})}}new Z;
