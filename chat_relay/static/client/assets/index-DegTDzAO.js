var G=Object.defineProperty;var V=(a,e,t)=>e in a?G(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var r=(a,e,t)=>V(a,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();const T="https://chat.parchchat.com",Y="wss://chat.parchchat.com/ws",P="5837a5c3-5268-45e1-9ea4-ee87d959d067",Q="Parch Community";function s(a,e,t,n){if(typeof a>"u")return!1;var i=document.createElement(a);if(typeof e=="object")for(var o in e)i.setAttribute(o,e[o]);if(t)if(typeof t=="string"&&/<[^>]+>/.test(t))i.innerHTML=t;else{Array.isArray(t)||(t=[t]);for(var c=0;c<t.length;c++)t[c]instanceof Node?i.appendChild(t[c]):i.appendChild(document.createTextNode(t[c]))}if(n){Array.isArray(n)||(n=[n]);for(var d of n)i.addEventListener(d.type,d.event)}return i}const H="parch.hosts";function D(){try{const a=localStorage.getItem(H);if(!a)return[];const e=JSON.parse(a);return Array.isArray(e)?e:[]}catch{return[]}}function x(a){localStorage.setItem(H,JSON.stringify(a))}const l={async greet(a){return`Hello ${a}, It's show time!`},async alert(a){window.alert(a)},async confirm(a){return window.confirm(a)},async openExternal(a){window.open(a,"_blank","noopener,noreferrer")},async getHosts(){const a=D();return a.some(e=>e.uuid===P)||(a.push({uuid:P,name:Q}),x(a)),a},async verifyHostKey(a){const e=await fetch(`${T}/api/host/${a}`);if(!e.ok)throw new Error("host not found");const t=await e.json(),n=D();return n.some(i=>i.uuid===a)||(n.push({uuid:t.uuid,name:t.name}),x(n)),t},async removeHost(a){const e=D(),t=e.filter(n=>n.uuid!==a);if(t.length===e.length)throw new Error(`host with UUID ${a} not found`);x(t)}},K="parch.chat.identity";function v(){const a=globalThis==null?void 0:globalThis.crypto;if(!(a!=null&&a.subtle))throw new Error("WebCrypto API is not available");return a}function C(a){let e="";const t=a instanceof Uint8Array?a:new Uint8Array(a);for(let n=0;n<t.length;n+=1)e+=String.fromCharCode(t[n]);return btoa(e).replace(/=+$/g,"")}function y(a){const e=(4-a.length%4)%4,t=a+"=".repeat(e),n=atob(t),i=new Uint8Array(n.length);for(let o=0;o<n.length;o+=1)i[o]=n.charCodeAt(o);return i}function L(){try{const a=localStorage.getItem(K);if(!a)return null;const e=JSON.parse(a);return!e.publicKey||!e.privateKey?null:e}catch{return null}}function _(a){localStorage.setItem(K,JSON.stringify(a))}function X(a){if(!a||typeof a!="object")throw new Error("Identity payload must be an object");const e=typeof a.publicKey=="string"?a.publicKey.trim():"",t=typeof a.privateKey=="string"?a.privateKey.trim():"",n=typeof a.encPublicKey=="string"?a.encPublicKey.trim():"",i=typeof a.encPrivateKey=="string"?a.encPrivateKey.trim():"",o=typeof a.username=="string"?a.username.trim():"";if(!e||!t||!n||!i)throw new Error("Identity must include auth and encryption keypairs");return{publicKey:e,privateKey:t,encPublicKey:n,encPrivateKey:i,username:o}}async function O(){const a=v(),e=await a.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveBits"]),t=await a.subtle.exportKey("spki",e.publicKey),n=await a.subtle.exportKey("pkcs8",e.privateKey);return{encPublicKey:C(t),encPrivateKey:C(n)}}async function Z(){const a=v(),e=await a.subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),t=await a.subtle.exportKey("raw",e.publicKey),n=await a.subtle.exportKey("pkcs8",e.privateKey),i=await O(),o={publicKey:C(t),privateKey:C(n),encPublicKey:i.encPublicKey,encPrivateKey:i.encPrivateKey,username:""};return _(o),o}async function N(){const a=L();if(a){if(!a.encPublicKey||!a.encPrivateKey){const e=await O(),t={...a,encPublicKey:e.encPublicKey,encPrivateKey:e.encPrivateKey};return _(t),t}return a}return Z()}async function ee(a,e){const t=v(),n=y(a.privateKey),i=await t.subtle.importKey("pkcs8",n,{name:"Ed25519"},!1,["sign"]),o=new TextEncoder().encode(e),c=await t.subtle.sign({name:"Ed25519"},i,o);return C(c)}async function te(a,e,t){const n=v(),i=y(a),o=y(t),c=await n.subtle.importKey("raw",i,{name:"Ed25519"},!1,["verify"]),d=new TextEncoder().encode(e);return n.subtle.verify({name:"Ed25519"},c,o,d)}async function ne(a){const e=v(),t=y(a.privateKey),n=y(a.publicKey),i=y(a.encPrivateKey),o=y(a.encPublicKey),c=await e.subtle.importKey("pkcs8",t,{name:"Ed25519"},!1,["sign"]),d=await e.subtle.importKey("raw",n,{name:"Ed25519"},!1,["verify"]),p=new TextEncoder().encode("parch-identity-check"),h=await e.subtle.sign({name:"Ed25519"},c,p);if(!await e.subtle.verify({name:"Ed25519"},d,h,p))throw new Error("Public/private key mismatch");await e.subtle.importKey("pkcs8",i,{name:"ECDH",namedCurve:"P-256"},!1,["deriveBits"]),await e.subtle.importKey("spki",o,{name:"ECDH",namedCurve:"P-256"},!1,[])}async function se(){return N()}async function ae(){const a=await N();return JSON.stringify(a,null,2)}async function ie(a){let e=a;if(typeof a=="string")try{e=JSON.parse(a)}catch{throw new Error("Identity import text must be valid JSON")}const t=X(e);return await ne(t),_(t),t}function oe(a){const e=L();e&&(e.username=(a||"").trim(),_(e))}function re(){localStorage.removeItem(K)}const u={getOrCreateIdentity:se,signAuthMessage:ee,verifyAuthSignature:te,exportIdentity:ae,importIdentity:ie,setIdentityUsername:oe,clearIdentity:re};class ce{constructor(e,t){r(this,"open",e=>(this.domComponent.style.display="block",this.render(e)));r(this,"close",()=>{this.domComponent.style.display="none"});r(this,"renderPrompt",e=>new Promise(t=>{this.promptResolver=t,this.domComponent.append(s("div",{class:"modal-content"},[s("div",{class:"modal-header"},[s("h2",{},e||"Enter a value")]),s("div",{class:"modal-body"},[s("input",{id:"prompt-input",type:"text",style:"width: 100%; margin-bottom: 10px;"}),s("div",{style:"text-align: right;"},[s("button",{class:"btn"},"OK",{type:"click",event:()=>{const n=this.domComponent.querySelector("#prompt-input").value;this.close(),this.promptResolver(n)}}),s("button",{class:"btn btn-red",style:"margin-left: 10px;"},"Cancel",{type:"click",event:()=>{this.close(),this.promptResolver(null)}})])])]))}));r(this,"renderAuthorSettings",e=>[s("div",{class:"settings-section"},[s("h3",{},"Space Management"),s("div",{class:"settings-actions"},[s("button",{class:"btn"},"Invite User",{type:"click",event:()=>{this.render({type:"prompt",data:{message:"Enter recipient public key"}}).then(t=>{t&&this.socketConn.inviteUser({public_key:t.trim(),space_uuid:e.uuid})})}}),s("button",{class:"btn btn-red"},"Delete Space",{type:"click",event:()=>{l.confirm("Are you sure you want to delete this space?").then(t=>{t&&this.socketConn.deleteSpace({uuid:e.uuid})})}})])]),s("div",{class:"settings-section"},[s("h3",{},"Channel Management"),s("div",{class:"settings-actions"},[s("button",{class:"btn"},"+ Create Channel",{type:"click",event:()=>{this.render({type:"prompt",data:{message:"Please enter Channel name"}}).then(t=>{t&&this.socketConn.createChannel({name:t.trim(),space_uuid:e.uuid})})}})]),s("div",{class:"channels-list"},e.channels.map(t=>s("div",{class:"channel-item"},[s("span",{},t.name),s("button",{class:"btn-small btn-red"},"Delete",{type:"click",event:()=>{l.confirm("Are you sure you want to delete this channel?").then(n=>{n&&this.socketConn.deleteChannel({uuid:t.uuid})})}})])))])]);r(this,"renderSpaceUserSettings",(e,t)=>[s("div",{class:"settings-section"},[s("h3",{},"Space Management"),s("div",{class:"settings-actions"},[s("button",{class:"btn btn-red"},"Leave Space",{type:"click",event:()=>{l.confirm("Are you sure you want to leave this space?").then(n=>{n&&this.socketConn.leaveSpace({space_uuid:e.uuid,user_id:t.id,user_public_key:t.public_key||"",user_enc_public_key:t.enc_public_key||""})})}})])])]);r(this,"renderAccount",e=>{const t=async n=>{if(!n){l.alert("No identity data provided");return}if(await l.confirm("Import identity and replace the current local identity on this browser?"))try{await u.importIdentity(n),l.alert("Identity imported. Reloading..."),window.location.reload()}catch(o){console.error(o),l.alert((o==null?void 0:o.message)||"Failed to import identity")}};this.domComponent.append(s("div",{class:"modal-content"},[s("div",{class:"modal-header"},[s("h2",{},"Account"),s("button",{class:"close-modal"},"×",{type:"click",event:this.close})]),s("div",{class:"modal-body"},[s("h3",{},`Username: "${e.username}"`),s("div",{class:"settings-section"},[s("h3",{},"Public Key (Share for Invites)"),s("p",{style:"display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--main-gray);"},"Share this public key with space admins so they can invite you."),s("textarea",{id:"public-key-display",readonly:"readonly",rows:"4",style:"width: 100%; font-size: 0.8rem; padding: 8px; background: var(--second-dark); color: var(--a-blue); border: 1px solid var(--main-gray); border-radius: 4px; resize: vertical;"}),s("br"),s("button",{class:"btn",id:"copy-public-key-btn"},"Copy Public Key",{type:"click",event:async()=>{var o;const n=this.domComponent.querySelector("#public-key-display"),i=((n==null?void 0:n.value)||"").trim();if(!i){l.alert("Public key not available yet");return}try{(o=navigator.clipboard)!=null&&o.writeText?await navigator.clipboard.writeText(i):(n.focus(),n.select(),document.execCommand("copy")),l.alert("Public key copied")}catch{l.alert("Failed to copy public key")}}})]),s("div",{class:"settings-section"},[s("h3",{},"Identity Transfer (Private Key)"),s("p",{style:"display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--light-red);"},"Anyone with your identity JSON can access your account. Share it only with yourself."),s("p",{style:"display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--main-gray);"},"Export on this browser, then import on another browser/device to keep the same identity."),s("textarea",{id:"identity-export-display",readonly:"readonly",rows:"6",style:"width: 100%; font-size: 0.78rem; padding: 8px; background: var(--second-dark); color: var(--main-white); border: 1px solid var(--main-gray); border-radius: 4px; resize: vertical; margin-bottom: 8px;"}),s("button",{class:"btn",id:"copy-identity-btn"},"Copy Identity JSON",{type:"click",event:async()=>{var o;const n=this.domComponent.querySelector("#identity-export-display"),i=((n==null?void 0:n.value)||"").trim();if(!i){l.alert("Identity export is not ready");return}try{(o=navigator.clipboard)!=null&&o.writeText?await navigator.clipboard.writeText(i):(n.focus(),n.select(),document.execCommand("copy")),l.alert("Identity JSON copied")}catch{l.alert("Failed to copy identity JSON")}}}),s("button",{class:"btn",id:"download-identity-btn",style:"margin-left: 8px;"},"Download Identity File",{type:"click",event:async()=>{try{const n=await u.exportIdentity(),i=new Blob([n],{type:"application/json"}),o=URL.createObjectURL(i),c=document.createElement("a");c.href=o,c.download="parch-identity.json",document.body.appendChild(c),c.click(),c.remove(),URL.revokeObjectURL(o)}catch{l.alert("Failed to generate identity file")}}}),s("br"),s("textarea",{id:"identity-import-input",rows:"6",placeholder:"Paste identity JSON here to import",style:"width: 100%; font-size: 0.78rem; padding: 8px; background: var(--second-dark); color: var(--a-blue); border: 1px solid var(--main-gray); border-radius: 4px; resize: vertical; margin-bottom: 8px;"}),s("button",{class:"btn",id:"import-identity-btn"},"Import Identity JSON",{type:"click",event:async()=>{const n=this.domComponent.querySelector("#identity-import-input"),i=((n==null?void 0:n.value)||"").trim();if(!i){l.alert("Paste identity JSON to import");return}await t(i)}}),s("button",{class:"btn",id:"import-identity-file-btn",style:"margin-left: 8px;"},"Import Identity File",{type:"click",event:()=>{const n=this.domComponent.querySelector("#identity-import-file");n&&(n.value="",n.click())}}),s("input",{id:"identity-import-file",type:"file",accept:"application/json,.json",style:"display: none;"},null,{type:"change",event:async n=>{var o,c;const i=(c=(o=n==null?void 0:n.target)==null?void 0:o.files)==null?void 0:c[0];if(i)try{const d=await i.text();await t(d)}catch{l.alert("Failed to read identity file")}}})]),s("div",{class:"settings-section"},[s("h3",{},"Local Fallback Username"),s("p",{style:"display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--main-gray);"},"Used as the default username sent during auth when joining a host for the first time."),s("div",{class:"input-container"},[s("label",{for:"local-identity-username"},"Local Username"),s("input",{id:"local-identity-username",name:"localIdentityUsername",type:"text",value:"",placeholder:"Set local fallback username"})]),s("br"),s("button",{class:"btn"},"Save Local Username",{type:"click",event:()=>{const n=this.domComponent.querySelector("#local-identity-username"),i=((n==null?void 0:n.value)||"").trim();u.setIdentityUsername(i),l.alert("Local fallback username saved")}})]),s("form",{id:"update-username-form"},[s("fieldset",{},[s("legend",{},"Update Username"),s("div",{class:"input-container"},[s("label",{for:"username"},"Username"),s("input",{id:"username",name:"username",type:"text",required:!0,autofocus:!0,value:e.username||""})]),s("br"),s("button",{type:"submit"},"Submit")])],{type:"submit",event:n=>{n.preventDefault();const i=new FormData(n.target),o=Object.fromEntries(i.entries());o.user_id=e.id,o.user_public_key=e.public_key||"",o.user_enc_public_key=e.enc_public_key||"",this.socketConn.updateUsername(o)}}),s("br"),s("button",{class:"btn-red"},"Reset Identity",{type:"click",event:()=>{l.confirm("Reset local identity key? This creates a new account identity.").then(n=>{n&&(u.clearIdentity(),window.location.reload())})}})])])),u.getOrCreateIdentity().then(n=>{const i=this.domComponent.querySelector("#public-key-display"),o=this.domComponent.querySelector("#identity-export-display"),c=this.domComponent.querySelector("#local-identity-username");i&&(i.value=n.publicKey||""),c&&(c.value=n.username||""),o&&u.exportIdentity().then(d=>{o.value=d}).catch(()=>{o.value=""})}).catch(()=>{const n=this.domComponent.querySelector("#public-key-display"),i=this.domComponent.querySelector("#identity-export-display"),o=this.domComponent.querySelector("#local-identity-username");n&&(n.value=""),o&&(o.value=""),i&&(i.value="")})});r(this,"renderInvites",(e,t)=>{this.domComponent.append(s("div",{class:"modal-content"},[s("div",{class:"modal-header"},[s("h2",{},"Space Invites"),s("button",{class:"close-modal"},"×",{type:"click",event:this.close})]),s("div",{class:"modal-body"},e&&e.length&&t?s("div",{class:"invites-section"},[...e.map(n=>s("div",{class:"pending-invites-item"},[s("span",{},n.name),s("div",{},[s("button",{class:"btn-small accept-invite"},"Accept",{type:"click",event:()=>this.socketConn.acceptInvite({space_user_id:n.id,user_id:t.id,user_public_key:t.public_key||"",user_enc_public_key:t.enc_public_key||""})}),s("button",{class:"btn-small btn-red decline-invite"},"Decline",{type:"click",event:()=>this.socketConn.declineInvite({space_user_id:n.id,user_id:t.id,user_public_key:t.public_key||"",user_enc_public_key:t.enc_public_key||""})})])]))]):"...No Invite Yet")]))});r(this,"render",e=>{var t;switch(this.domComponent.innerHTML="",e.type){case"prompt":if((t=e.data)!=null&&t.message)return this.renderPrompt(e.data.message);break;case"account":e.data.user&&this.renderAccount(e.data.user);break;case"invites":this.renderInvites(e.data.invites,e.data.user);break;case"space-settings":if(e.data.space&&e.data.user){const n=e.data.space,i=e.data.user,o=n.author_id===i.id;this.domComponent.append(s("div",{class:"modal-content"},[s("div",{class:"modal-header"},[s("h2",{},`Space Settings: ${n.name}`),s("button",{class:"close-modal"},"×",{type:"click",event:this.close})]),s("div",{class:"modal-body"},o?this.renderAuthorSettings(n):this.renderSpaceUserSettings(n,i))]))}break}});this.app=e,this.socketConn=t,this.domComponent=s("div",{class:"modal"}),this.promptResolver=null}}class de{constructor(e){r(this,"initSpaceComponents",()=>{this.data.spaces&&(this.spaceComponents=this.data.spaces.map(e=>new E({domComponent:s("div",{class:"space-item"}),space:e,user:this.data.user,openSpaceSettings:this.openSpaceSettings,loadChannel:this.loadChannel})))});r(this,"addSpace",e=>{const t=new E({domComponent:s("div",{class:"space-item"}),space:e,user:this.data.user,openSpaceSettings:this.openSpaceSettings,loadChannel:this.loadChannel});this.spaceComponents.push(t),this.render()});r(this,"render",()=>{this.domComponent.innerHTML="",this.initSpaceComponents(),this.userAccountComponent=new le({data:this.data,returnToHostList:this.returnToHostList,openDashModal:this.openDashModal,domComponent:s("div",{class:"user-component"})}),this.spaceUserListComponent=new he({data:this.data,socketConn:this.socketConn,getCurrentSpaceUUID:this.getCurrentSpaceUUID,domComponent:s("div",{class:"space-users-list",id:"space-users-list"})}),this.domComponent.append(s("div",{class:"sidebar-spaces-container"},[s("div",{id:"spaces-list"},this.spaceComponents.map(e=>e.domComponent)),s("button",{class:"create-space-btn",id:"new-space-btn"},"+ Create New Space",{type:"click",event:()=>{this.openDashModal({type:"prompt",data:{message:"Please enter Space 'Name'"}}).then(e=>{e&&(e.trim(),this.socketConn.createSpace({name:e}))})}})]),s("br"),this.spaceUserListComponent.domComponent,s("hr"),this.userAccountComponent.domComponent)});this.data=e.data,this.socketConn=e.socketConn,this.returnToHostList=e.returnToHostList,this.openDashModal=e.openDashModal,this.closeDashModal=e.closeDashModal,this.getCurrentSpaceUUID=e.getCurrentSpaceUUID,this.spaceComponents=[],this.domComponent=e.domComponent,this.openSpaceSettings=e.openSpaceSettings,this.loadChannel=e.loadChannel,this.render()}}class le{constructor(e){r(this,"render",()=>{this.domComponent.innerHTML="",this.domComponent.append(s("a",{href:"#"},"Account",{type:"click",event:e=>{this.openDashModal({type:"account",data:{user:this.data.user}})}}),s("a",{href:"#"},"Invites",{type:"click",event:e=>{this.openDashModal({type:"invites",data:{invites:this.data.invites,user:this.data.user}})}}),s("a",{href:"#"},"<- Host List",{type:"click",event:e=>{this.returnToHostList()}}))});this.data=e.data,this.returnToHostList=e.returnToHostList,this.openDashModal=e.openDashModal,this.domComponent=e.domComponent,this.render()}}class he{constructor(e){r(this,"isAuthor",(e,t)=>String(e.author_id)===String(t.id));r(this,"renderUserElement",(e,t)=>s("div",{class:"space-user-item",id:"space-user-item"},`${t.username} ${this.isAuthor(e,t)?"*":""}`,{type:"click",event:async()=>{this.isAuthor(e,this.data.user)&&this.data.user.id!=t.id&&l.confirm("Are you sure you want to remove this user?").then(n=>{n&&this.socketConn.removeSpaceUser({space_uuid:e.uuid,user_id:t.id,user_public_key:t.public_key||""})})}}));r(this,"renderSpaceUsersList",e=>{const t=[];return e.users&&e.users.map(n=>{t.push(this.renderUserElement(e,n))}),t});r(this,"render",()=>{this.domComponent.innerHTML="";const e=this.getCurrentSpaceUUID();if(e){const t=this.data.spaces.find(n=>n.uuid===e);if(!t)return;this.domComponent.append(s("h3",{},"Users"),...this.renderSpaceUsersList(t))}});this.data=e.data,this.socketConn=e.socketConn,this.getCurrentSpaceUUID=e.getCurrentSpaceUUID,this.domComponent=e.domComponent,this.render()}}class E{constructor(e){r(this,"isAuthor",()=>String(this.space.author_id)===String(this.user.id));r(this,"renderChannelList",()=>s("div",{class:"channel-list"},(this.space.channels||[]).map(e=>s("div",{class:"channel-item"},[s("span",{class:"channel-hash"},"#"),s("span",{},e.name)],{type:"click",event:()=>this.loadChannel(this.space.uuid,e.uuid)}))));r(this,"toggleChannels",()=>{this.channelsOpen=!this.channelsOpen,this.render()});r(this,"render",()=>{this.domComponent.textContent="",this.domComponent.className=`space-item${this.channelsOpen?" space-item--open":""}`,this.domComponent.append(s("div",{class:"space-header"},[s("span",{class:"space-chevron"}),s("span",{},this.space.name),s("div",{class:"space-actions"},s("button",{class:"btn-icon open-settings"},"⚙️",{type:"click",event:e=>{e.stopPropagation(),this.openSpaceSettings(this.space)}}))],{type:"click",event:this.toggleChannels}),...this.channelsOpen?[this.renderChannelList()]:[])});this.space=e.space,this.user=e.user,this.openSpaceSettings=e.openSpaceSettings,this.loadChannel=e.loadChannel,this.channelsOpen=!1,this.domComponent=e.domComponent,this.render()}}function pe(a){const e=new Date(a),t=e.getFullYear(),n=(e.getMonth()+1).toString().padStart(2,"0"),i=e.getDate().toString().padStart(2,"0"),o=e.getHours(),c=e.getMinutes(),d=o%12||12,p=o<12?"am":"pm",h=c.toString().padStart(2,"0");return`${n}-${i}-${t} ${d}:${h}${p}`}const ue="data:image/svg+xml;base64,"+btoa(`
    <svg xmlns="http://www.w3.org/2000/svg" width="150" height="100" viewBox="0 0 150 100">
      <rect width="150" height="100" fill="#aaaaa" />
      <text x="75" y="55" font-size="14" text-anchor="middle" fill="#a00" font-family="sans-serif">Image not found</text>
    </svg>
  `);function me(a){const e=document.createElement("img");return e.src=a,e.alt="Image",e.style="max-width: 100%; max-height: 250px; margin: 5px; cursor: pointer;",e.onerror=()=>{e.src=ue},e}function ye(a){const e=a.split(".");if(e.length<2)return!1;const t=e[e.length-1].toLowerCase().split("?")[0];return["jpg","jpeg","png","gif","webp","svg","tiff"].includes(t)}function k(){const a=globalThis==null?void 0:globalThis.crypto;if(!(a!=null&&a.subtle))throw new Error("WebCrypto API is not available");return a}function w(a){let e="";const t=a instanceof Uint8Array?a:new Uint8Array(a);for(let n=0;n<t.length;n+=1)e+=String.fromCharCode(t[n]);return btoa(e).replace(/=+$/g,"")}function b(a){const e=(4-a.length%4)%4,t=a+"=".repeat(e),n=atob(t),i=new Uint8Array(n.length);for(let o=0;o<n.length;o+=1)i[o]=n.charCodeAt(o);return i}function M(a){const e=Array.isArray(a.wrapped_keys)?[...a.wrapped_keys].sort((n,i)=>String(n.recipient_auth_public_key).localeCompare(String(i.recipient_auth_public_key))):[],t={v:a.v,alg:a.alg,space_uuid:a.space_uuid,channel_uuid:a.channel_uuid,sender_auth_public_key:a.sender_auth_public_key,sender_enc_public_key:a.sender_enc_public_key,content_iv:a.content_iv,ciphertext:a.ciphertext,wrapped_keys:e.map(n=>({recipient_auth_public_key:n.recipient_auth_public_key,iv:n.iv,ciphertext:n.ciphertext}))};return JSON.stringify(t)}async function B(a){return k().subtle.importKey("spki",b(a),{name:"ECDH",namedCurve:"P-256"},!1,[])}async function fe(a){return B(a)}async function R(a){return k().subtle.importKey("pkcs8",b(a),{name:"ECDH",namedCurve:"P-256"},!1,["deriveBits"])}async function F(a,e,t){const n=k(),i=await n.subtle.deriveBits({name:"ECDH",public:e},a,256),o=await n.subtle.importKey("raw",i,"HKDF",!1,["deriveKey"]),c=new TextEncoder().encode(`parch-e2ee-wrap-salt:${t.space_uuid}:${t.channel_uuid}`),d=new TextEncoder().encode(`parch-e2ee-wrap-info:${t.sender_auth_public_key}`);return n.subtle.deriveKey({name:"HKDF",hash:"SHA-256",salt:c,info:d},o,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async function be(a){const e=k(),{plaintext:t,spaceUUID:n,channelUUID:i,identity:o,recipients:c}=a;if(!(o!=null&&o.publicKey)||!(o!=null&&o.privateKey)||!(o!=null&&o.encPublicKey)||!(o!=null&&o.encPrivateKey))throw new Error("Missing sender identity keys");if(!n||!i)throw new Error("Missing space/channel context");if(!Array.isArray(c)||c.length===0)throw new Error("No recipient keys available for encryption");const d=[],p=new Set;for(const m of c)!(m!=null&&m.authPublicKey)||!(m!=null&&m.encPublicKey)||p.has(m.authPublicKey)||(p.add(m.authPublicKey),d.push(m));p.has(o.publicKey)||d.push({authPublicKey:o.publicKey,encPublicKey:o.encPublicKey});const h=await e.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),f=new Uint8Array(await e.subtle.exportKey("raw",h)),S=e.getRandomValues(new Uint8Array(12)),U=new TextEncoder().encode(t),I=await e.subtle.encrypt({name:"AES-GCM",iv:S},h,U),$=await R(o.encPrivateKey),g={v:1,alg:"p256-hkdf-aesgcm+ed25519",space_uuid:n,channel_uuid:i,sender_auth_public_key:o.publicKey,sender_enc_public_key:o.encPublicKey,content_iv:w(S),ciphertext:w(I),wrapped_keys:[]};for(const m of d){const j=await B(m.encPublicKey),q=await F($,j,g),A=e.getRandomValues(new Uint8Array(12)),z=await e.subtle.encrypt({name:"AES-GCM",iv:A},q,f);g.wrapped_keys.push({recipient_auth_public_key:m.authPublicKey,iv:w(A),ciphertext:w(z)})}const W=M(g);return g.sig=await u.signAuthMessage(o,W),g}async function ge(a){const e=k(),{envelope:t,identity:n}=a;if(!(t!=null&&t.sender_auth_public_key)||!(t!=null&&t.sender_enc_public_key)||!(t!=null&&t.sig))throw new Error("Invalid encrypted envelope");if(!(n!=null&&n.publicKey)||!(n!=null&&n.encPrivateKey))throw new Error("Missing recipient identity");const i=M(t);if(!await u.verifyAuthSignature(t.sender_auth_public_key,i,t.sig))throw new Error("Invalid message signature");const c=(t.wrapped_keys||[]).find(I=>I.recipient_auth_public_key===n.publicKey);if(!c)throw new Error("No wrapped key for this identity");const d=await R(n.encPrivateKey),p=await fe(t.sender_enc_public_key),h=await F(d,p,t),f=await e.subtle.decrypt({name:"AES-GCM",iv:b(c.iv)},h,b(c.ciphertext)),S=await e.subtle.importKey("raw",f,{name:"AES-GCM",length:256},!1,["decrypt"]),U=await e.subtle.decrypt({name:"AES-GCM",iv:b(t.content_iv)},S,b(t.ciphertext));return new TextDecoder().decode(U)}const J={encryptMessageForSpace:be,decryptMessageForIdentity:ge,canonicalEnvelopeForSignature:M};class Ce{constructor(e){r(this,"initialize",e=>{this.chatBoxComponent=new ve({domComponent:s("div"),data:this.data,socketConn:this.socketConn,channelUUID:e}),this.render();const t=new Date().toISOString();this.socketConn.getMessages(t)});r(this,"render",()=>{this.domComponent.innerHTML="",this.chatBoxComponent&&this.domComponent.append(this.chatBoxComponent.domComponent)});this.domComponent=e.domComponent,this.data=e.data,this.socketConn=e.socketConn,this.chatBoxComponent=null}}class ve{constructor(e){r(this,"render",()=>{this.domComponent.innerHTML="",this.domComponent.append(s("div",{class:"chatapp-channel-title"},this.channel.name),this.chatBoxMessagesComponent.domComponent,s("div",{class:"chat-box-form"},[s("textarea",{id:"chat-box-form-input",class:"chat-box-form-input",autofocus:!0,type:"text",required:!0,autocomplete:"off",placeholder:"Type message here..."},null,[{type:"input",event:e=>{const t=e.target;t.style.height="auto",t.style.height=`${t.scrollHeight}px`}},{type:"keydown",event:async e=>{var t,n;if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();const i=e.target,o=i.value.trim();if(o)try{const c=await u.getOrCreateIdentity(),d=(((t=this.space)==null?void 0:t.users)||[]).filter(h=>(h==null?void 0:h.public_key)&&(h==null?void 0:h.enc_public_key)).map(h=>({authPublicKey:h.public_key,encPublicKey:h.enc_public_key})),p=await J.encryptMessageForSpace({plaintext:o,spaceUUID:(n=this.space)==null?void 0:n.uuid,channelUUID:this.channelUUID,identity:c,recipients:d});this.socketConn.sendMessage({envelope:p}),i.value="",i.style.height="auto",i.focus()}catch(c){console.error(c),l.alert((c==null?void 0:c.message)||"Failed to encrypt message")}}}}])]))});this.domComponent=e.domComponent,this.domComponent.className="chat-box-container",this.data=e.data,this.socketConn=e.socketConn,this.channelUUID=e.channelUUID;for(const t of this.data.spaces){const n=t.channels.find(i=>i.uuid===this.channelUUID);if(n){this.space=t,this.channel=n;break}}this.chatBoxMessagesComponent=new ke({domComponent:s("div",{class:"chat-box-messages",id:"chat-box-messages"}),channelUUID:this.channelUUID,socketConn:this.socketConn}),this.render()}}class ke{constructor(e){r(this,"getPreviousMessagesDebounce",()=>{this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.debounceTimeout=setTimeout(()=>{this.getPreviousMessages()},300)});r(this,"getPreviousMessages",()=>{if(this.isLoading||!this.hasMoreMessages||!this.chatBoxMessages.length||!this.isScrolledToTop())return;this.isLoading=!0;const e=this.chatBoxMessages[0].timestamp;this.socketConn.getMessages(e)});r(this,"scrollDown",()=>{this.domComponent.scrollTop=this.domComponent.scrollHeight});r(this,"isScrolledToTop",()=>this.domComponent.scrollTop<=20);r(this,"isScrolledToBottom",()=>this.domComponent.scrollHeight-this.domComponent.scrollTop<=this.domComponent.clientHeight+40);r(this,"appendNewMessage",e=>{const t=this.isScrolledToBottom();this.chatBoxMessages.push(e),this.render(),t&&requestAnimationFrame(()=>this.scrollDown())});r(this,"createMessage",e=>{const t=n=>{const i=/(https?:\/\/[^\s]+)/g,o=/^https?:\/\/[^\s]+$/;return n.split(i).map(d=>o.test(d)?ye(d)?me(d):s("a",{href:d,target:"_blank",rel:"noopener noreferrer",style:"margin: 0 5px;"},d):d)};return s("div",{class:"chat-box-message-content"},[s("div",{style:"display: flex; align-items: flex-end;"},[s("small",{style:"margin-right: var(--main-distance); color: var(--main-gray);"},pe(e.timestamp)),s("div",{style:"font-weight: bold; margin-right: var(--main-distance); color: var(--light-yellow);"},e.username)]),s("div",{class:"chat-box-message-text"},[...t(e.content)]),s("hr")])});r(this,"render",()=>{this.domComponent.innerHTML="";const e=this.chatBoxMessages.map(t=>this.createMessage(t));this.domComponent.append(...e)});this.chatBoxMessages=[],this.channelUUID=e.channelUUID,this.socketConn=e.socketConn,this.messageRequestSize=50,this.hasMoreMessages=!0,this.debounceTimeout=null,this.isLoading=!1,this.domComponent=s("div",{class:"chat-box-messages",id:"chat-box-messages"},null,{type:"scroll",event:()=>{this.getPreviousMessagesDebounce()}})}}class Se{constructor(e){r(this,"renderChannel",e=>{this.currentChannelUUID=e,this.domComponent.innerHTML="";const t=s("div",{class:"chatapp-container"});this.domComponent.append(t),this.chatApp?this.chatApp.domComponent=t:this.chatApp=new Ce({domComponent:t,data:this.data,socketConn:this.socketConn}),this.chatApp.initialize(e)});r(this,"cleanup",()=>{var e,t;this.chatApp&&((t=(e=this.chatApp).cleanup)==null||t.call(e),this.chatApp=null),this.currentChannelUUID=null});r(this,"render",()=>{this.cleanup(),this.domComponent.innerHTML="",this.domComponent.append(s("div",{class:"no-channel-selected"},[s("h2",{},"Select a channel to start chatting")]))});this.domComponent=e.domComponent,this.data=e.data,this.socketConn=e.socketConn,this.chatApp=null,this.currentChannelUUID=null,this.render()}}class we{constructor(e){r(this,"retryConnection",()=>{if(this.retryCount+=1,this.retryCount>this.maxRetries){l.alert("Unable to reconnect to host. Returning to home."),this.returnToHostList();return}setTimeout(()=>{var t;((t=this.socket)==null?void 0:t.readyState)!==WebSocket.OPEN&&this.connect()},2e3)});r(this,"connect",()=>{this.socket=new WebSocket(Y),this.socket.onopen=()=>{this.joinHost()},this.socket.onerror=e=>{console.error("WebSocket error:",e)},this.socket.onclose=()=>{this.manualClose||this.retryConnection()},this.socket.onmessage=async e=>{var t;try{const n=JSON.parse(e.data);switch(n.type){case"join_ack":break;case"auth_challenge":await this.authenticateWithPublicKey((t=n.data)==null?void 0:t.challenge);break;case"auth_pubkey_success":this.closeDashModal(),this.getDashboardData();break;case"dash_data_payload":this.dashboardInitialRender(n.data),this.joinAllSpaces(n);break;case"update_username_success":this.updateAccountUsername(n,this.hostUUID),u.setIdentityUsername(n.data.username);break;case"create_space_success":this.handleCreateSpace(n);break;case"delete_space_success":this.handleDeleteSpace();break;case"create_channel_success":this.handleCreateChannel(n);break;case"create_channel_update":this.handleCreateChannelUpdate(n);break;case"delete_channel_success":this.handleDeleteChannel(n);break;case"delete_channel_update":this.handleDeleteChannelUpdate(n);break;case"invite_user_success":this.handleInviteUser(n);break;case"invite_user_update":this.handleAddInvite(n);break;case"accept_invite_success":this.handleAcceptInvite(n);break;case"accept_invite_update":this.handleAcceptInviteUpdate(n);break;case"decline_invite_success":this.handleDeclineInvite(n);break;case"leave_space_success":this.handleLeaveSpace();break;case"leave_space_update":this.handleLeaveSpaceUpdate(n);break;case"chat":await this.renderChatAppMessage(n);break;case"get_messages_success":await this.handleIncomingMessages(n);break;case"error":l.alert(n.data.error);break;case"authentication-error":l.alert(n.data.error||"Authentication failed");break;case"author_error":l.alert("Failed to connect to host. Host is offline."),this.returnToHostList();break;default:break}}catch(n){console.error("JSON parsing error:",n)}}});r(this,"authenticateWithPublicKey",async e=>{if(!e){l.alert("Missing auth challenge from server");return}try{const t=await u.getOrCreateIdentity(),n=`parch-chat-auth:${this.hostUUID}:${e}:${t.encPublicKey}`,i=await u.signAuthMessage(t,n),o={type:"auth_pubkey",data:{public_key:t.publicKey,enc_public_key:t.encPublicKey,username:t.username||"",challenge:e,signature:i}};this.socket.send(JSON.stringify(o))}catch(t){console.error(t),l.alert("Failed to initialize public-key identity")}});r(this,"joinHost",()=>{var e;((e=this.socket)==null?void 0:e.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"join_host",data:{uuid:this.hostUUID}}))});r(this,"getDashboardData",()=>{var e;((e=this.socket)==null?void 0:e.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"get_dash_data",data:""}))});r(this,"joinAllSpaces",e=>{var t;if(((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const n=e.data.spaces.map(i=>i.uuid);this.socket.send(JSON.stringify({type:"join_all_spaces",data:{space_uuids:n}}))}});r(this,"updateUsername",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"update_username",data:e}))});r(this,"createSpace",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"create_space",data:e}))});r(this,"deleteSpace",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"delete_space",data:e}))});r(this,"createChannel",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"create_channel",data:e}))});r(this,"deleteChannel",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"delete_channel",data:e}))});r(this,"inviteUser",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"invite_user",data:e}))});r(this,"acceptInvite",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"accept_invite",data:e}))});r(this,"declineInvite",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"decline_invite",data:e}))});r(this,"leaveSpace",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"leave_space",data:e}))});r(this,"removeSpaceUser",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"remove_space_user",data:e}))});r(this,"joinChannel",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"join_channel",data:{uuid:e}}))});r(this,"sendMessage",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"chat",data:e}))});r(this,"getMessages",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"get_messages",data:{before_unix_time:e}}))});r(this,"hardClose",()=>{this.manualClose=!0,this.close()});r(this,"close",()=>{this.socket&&this.socket.close()});this.returnToHostList=e.returnToHostList,this.updateAccountUsername=e.updateAccountUsername,this.dashboardInitialRender=e.dashboardInitialRender,this.openDashModal=e.openDashModal,this.closeDashModal=e.closeDashModal,this.renderChatAppMessage=e.renderChatAppMessage,this.handleCreateSpace=e.handleCreateSpace,this.handleCreateChannel=e.handleCreateChannel,this.handleDeleteSpace=e.handleDeleteSpace,this.handleDeleteChannel=e.handleDeleteChannel,this.handleCreateChannelUpdate=e.handleCreateChannelUpdate,this.handleDeleteChannelUpdate=e.handleDeleteChannelUpdate,this.handleInviteUser=e.handleInviteUser,this.handleAddInvite=e.handleAddInvite,this.handleAcceptInvite=e.handleAcceptInvite,this.handleAcceptInviteUpdate=e.handleAcceptInviteUpdate,this.handleDeclineInvite=e.handleDeclineInvite,this.handleLeaveSpace=e.handleLeaveSpace,this.handleLeaveSpaceUpdate=e.handleLeaveSpaceUpdate,this.handleIncomingMessages=e.handleIncomingMessages,this.socket=null,this.manualClose=!1,this.retryCount=0,this.maxRetries=2,this.hostUUID=localStorage.getItem("hostUUID"),this.hostUUID?this.connect():(l.alert("Missing host key"),this.returnToHostList())}}class _e{constructor(e){r(this,"initialize",()=>{this.domComponent.append(s("div",{class:"initial-spinner"},[s("div",{},"Connecting To Host..."),s("br"),s("div",{class:"lds-dual-ring"})])),this.socketConn=new we({returnToHostList:this.returnToHostList,updateAccountUsername:this.updateAccountUsername,dashboardInitialRender:this.initialRender,openDashModal:this.openDashModal,closeDashModal:this.closeDashModal,renderChatAppMessage:this.renderChatAppMessage,handleCreateSpace:this.handleCreateSpace,handleDeleteSpace:this.handleDeleteSpace,handleCreateChannel:this.handleCreateChannel,handleCreateChannelUpdate:this.handleCreateChannelUpdate,handleDeleteChannel:this.handleDeleteChannel,handleDeleteChannelUpdate:this.handleDeleteChannelUpdate,handleInviteUser:this.handleInviteUser,handleAddInvite:this.handleAddInvite,handleAcceptInvite:this.handleAcceptInvite,handleAcceptInviteUpdate:this.handleAcceptInviteUpdate,handleDeclineInvite:this.handleDeclineInvite,handleLeaveSpace:this.handleLeaveSpace,handleLeaveSpaceUpdate:this.handleLeaveSpaceUpdate,handleIncomingMessages:this.handleIncomingMessages}),this.dashModal=new ce(this,this.socketConn),this.domComponent.append(this.dashModal.domComponent)});r(this,"initialRender",e=>{this.data=e,this.data.spaces||(this.data.spaces=[]),this.sidebar=new de({data:this.data,socketConn:this.socketConn,returnToHostList:this.returnToHostList,domComponent:s("div",{class:"sidebar"}),openDashModal:this.openDashModal,closeDashModal:this.closeDashModal,getCurrentSpaceUUID:this.getCurrentSpaceUUID,openSpaceSettings:this.openSpaceSettings,loadChannel:this.loadChannel}),this.mainContent=new Se({socketConn:this.socketConn,data:this.data,domComponent:s("div",{id:"channel-content",class:"channel-content"})}),this.render()});r(this,"updateAccountUsername",(e,t)=>{this.data.user.username=e.data.username,this.sidebar.userAccountComponent.render(),this.openDashModal({type:"account",data:{user:this.data.user}})});r(this,"getCurrentSpaceUUID",()=>this.currentSpaceUUID);r(this,"loadChannel",(e,t)=>{this.currentSpaceUUID=e,this.socketConn.joinChannel(t),this.sidebar.spaceUserListComponent.render(),this.mainContent.renderChannel(t)});r(this,"openDashModal",e=>this.dashModal.open(e));r(this,"closeDashModal",()=>{this.dashModal.close()});r(this,"openSpaceSettings",e=>{this.currentSpaceUUID=e.uuid,this.openDashModal({type:"space-settings",data:{space:e,user:this.data.user}})});r(this,"closeSpaceSettings",()=>{this.closeDashModal(),this.currentSpaceUUID=null});r(this,"handleCreateSpace",async e=>{this.data.spaces.push(e.data.space),this.sidebar.render()});r(this,"handleDeleteSpace",async()=>{if(!this.currentSpaceUUID)return;this.data.spaces=this.data.spaces.filter(t=>t.uuid!==this.currentSpaceUUID);const e=this.sidebar.spaceComponents.filter(t=>t.space.uuid!==this.currentSpaceUUID);this.sidebar.spaceComponents=e,this.currentSpaceUUID=null,this.mainContent.render(),this.sidebar.render(),this.sidebar.spaceUserListComponent.render(),this.closeSpaceSettings()});r(this,"handleInviteUser",e=>{window.alert("Invite sent")});r(this,"handleAddInvite",e=>{this.data.invites||(this.data.invites=[]),this.data.invites.push(e.data.invite)});r(this,"handleAcceptInvite",e=>{this.data.invites=this.data.invites.filter(t=>t.id!==e.data.space_user_id),this.data.spaces.push(e.data.space),this.sidebar.render(),this.openDashModal({type:"invites",data:{invites:this.data.invites,user:this.data.user}})});r(this,"handleAcceptInviteUpdate",e=>{console.log("invite update",e);const t=this.data.spaces.find(n=>n.uuid===e.data.space_uuid);t.users.find(n=>n.id===e.data.user.id||n.public_key&&e.data.user.public_key&&n.public_key===e.data.user.public_key)||t.users.push(e.data.user),t&&this.currentSpaceUUID===t.uuid&&this.data.user.id!==e.data.user.id&&this.sidebar.spaceUserListComponent.render()});r(this,"handleDeclineInvite",e=>{this.data.invites=this.data.invites.filter(t=>t.id!==e.data.space_user_id),this.openDashModal({type:"invites",data:{invites:this.data.invites,user:this.data.user}})});r(this,"handleLeaveSpace",()=>{this.data.spaces=this.data.spaces.filter(e=>e.uuid!==this.currentSpaceUUID),this.currentSpaceUUID=null,this.sidebar.render(),this.mainContent.render()});r(this,"handleLeaveSpaceUpdate",e=>{const t=this.data.spaces.find(n=>n.uuid===e.data.space_uuid);if(t&&this.currentSpaceUUID===t.uuid){const n=t.users.findIndex(i=>i.id===e.data.user_id||i.public_key&&e.data.user_public_key&&i.public_key===e.data.user_public_key);n>=0&&(t.users.splice(n,1),this.sidebar.spaceUserListComponent.render())}});r(this,"handleCreateChannel",e=>{const{space_uuid:t,channel:n}=e.data,i=this.data.spaces.find(c=>c.uuid===t);if(!i)return;i.channels.push(n);const o=this.sidebar.spaceComponents.find(c=>c.space.uuid===t);o&&o.render(),this.openDashModal({type:"space-settings",data:{space:i,user:this.data.user}})});r(this,"handleCreateChannelUpdate",e=>{const{space_uuid:t,channel:n}=e.data,i=this.data.spaces.find(d=>d.uuid===t);if(!i||i.channels.some(d=>d.uuid===n.uuid))return;i.channels.push(n);const c=this.sidebar.spaceComponents.find(d=>d.space.uuid===t);c&&c.render()});r(this,"handleDeleteChannel",e=>{const{uuid:t,space_uuid:n}=e.data,i=this.data.spaces.find(d=>d.uuid===n);if(!i)return;const o=i.channels.findIndex(d=>d.uuid===t);if(o===-1)return;i.channels.splice(o,1);const c=this.sidebar.spaceComponents.find(d=>d.space.uuid===n);c&&c.render(),this.openDashModal({type:"space-settings",data:{space:i,user:this.data.user}}),this.mainContent.currentChannelUUID===t&&(this.mainContent.currentChannelUUID=null,this.mainContent.chatApp=null,this.mainContent.render())});r(this,"handleDeleteChannelUpdate",e=>{const{uuid:t,space_uuid:n}=e.data,i=this.data.spaces.find(d=>d.uuid===n);if(!i)return;const o=i.channels.findIndex(d=>d.uuid===t);if(o===-1)return;i.channels.splice(o,1);const c=this.sidebar.spaceComponents.find(d=>d.space.uuid===n);c&&c.render(),this.mainContent.currentChannelUUID===t&&(this.mainContent.currentChannelUUID=null,this.mainContent.chatApp=null,this.mainContent.render())});r(this,"findSpaceByChannelUUID",e=>{var t;return!((t=this.data)!=null&&t.spaces)||!e?null:this.data.spaces.find(n=>(n.channels||[]).some(i=>i.uuid===e))||null});r(this,"resolveUsernameForAuthPublicKey",(e,t)=>{var i;if(!e||!((i=this.data)!=null&&i.spaces))return"unknown";const n=t?this.data.spaces.filter(o=>o.uuid===t):this.data.spaces;for(const o of n){const c=(o.users||[]).find(d=>d.public_key===e);if(c!=null&&c.username)return c.username}return"unknown"});r(this,"decryptWireMessage",async(e,t)=>{const n=await u.getOrCreateIdentity(),i=e==null?void 0:e.envelope;if(!i)throw new Error("Missing encrypted envelope");const o=await J.decryptMessageForIdentity({envelope:i,identity:n}),c=i.sender_auth_public_key||"";return{...e,content:o,sender_auth_public_key:c,username:this.resolveUsernameForAuthPublicKey(c,t)}});r(this,"renderChatAppMessage",async e=>{if(this.mainContent.chatApp)try{const t=await this.decryptWireMessage(e.data,this.currentSpaceUUID),n=this.mainContent.chatApp.chatBoxComponent.chatBoxMessagesComponent;n.appendNewMessage(t),(t.sender_auth_public_key===this.data.user.public_key||n.isScrolledToBottom())&&n.scrollDown()}catch(t){console.error(t)}});r(this,"handleIncomingMessages",async e=>{if(e.data.messages&&this.mainContent.chatApp&&this.mainContent.chatApp.chatBoxComponent.channelUUID===e.data.channel_uuid){const t=this.mainContent.chatApp.chatBoxComponent.chatBoxMessagesComponent,n=t.domComponent,i=n.scrollHeight,o=n.scrollTop;t.hasMoreMessages=e.data.has_more_messages,t.isLoading=!1;const c=this.findSpaceByChannelUUID(e.data.channel_uuid),d=await Promise.all(e.data.messages.map(async h=>{try{return await this.decryptWireMessage(h,(c==null?void 0:c.uuid)||null)}catch(f){return console.error(f),{...h,content:"[Unable to decrypt message]",username:"unknown",sender_auth_public_key:""}}}));t.chatBoxMessages=[...d,...t.chatBoxMessages],t.render();const p=n.scrollHeight;n.scrollTop=p-i+o}});this.domComponent=s("div",{class:"dashboard-container"}),this.returnToHostList=e.returnToHostList,this.data=null,this.sidebar=null,this.dashModal=null,this.mainContent=null,this.currentSpaceUUID=null,this.socketConn=null}render(){this.domComponent.innerHTML="",this.domComponent.append(this.sidebar.domComponent,this.mainContent.domComponent,this.dashModal.domComponent)}}class Ue{constructor(){r(this,"returnToHostList",async()=>{var e,t;localStorage.removeItem("hostUUID"),(e=this.dashboard)!=null&&e.socketConn&&this.dashboard.socketConn.hardClose(),(t=this.dashboard)!=null&&t.domComponent&&(this.dashboard.domComponent.innerHTML=""),this.dashboard=null,this.render({type:"host_form"})});r(this,"render",e=>{switch(this.domComponent.innerHTML="",e.type){case"dash":this.dashboard=new _e({returnToHostList:this.returnToHostList}),this.domComponent.append(this.dashboard.domComponent),this.dashboard.initialize();break;case"host_form":this.domComponent.append(this.hostForm.domComponent),this.hostForm.render({type:"known"});break;default:this.domComponent.append(this.hostForm.domComponent),this.hostForm.render({type:"known"})}});l.greet("Hello Parch").then(e=>console.log(e)),this.domComponent=document.getElementById("app"),this.hostForm=new Ie(this),this.render({type:"host_form"})}}class Ie{constructor(e){r(this,"renderHostList",e=>!e||!e.hosts||!e.hosts.length?[s("div",{},"...No Hosts")]:e.hosts.map(n=>{const i=n.online==1;return s("div",{class:"host-item"},[s("div",{style:"display: flex; align-items: baseline"},[s("span",{class:i?"host-online-span":"host-offline-span"}),s("div",{class:"host-item-name"},`${n.name} `)]),s("button",{class:"btn-small btn-red"},"Remove",{type:"click",event:o=>{o.stopPropagation(),l.confirm("Are you sure you want to remove this host?").then(c=>{c&&(l.removeHost(n.uuid),o.target.parentElement.remove())})}})],{type:"click",event:()=>{i?(localStorage.setItem("hostUUID",n.uuid),this.app.render({type:"dash"})):l.alert("Host is not online")}})}));r(this,"renderKnownHosts",async()=>{const t=(await l.getHosts()).map(i=>i.uuid);let n=[];try{n=await(await fetch(`${T}/api/hosts_by_uuids`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uuids:t})})).json()}catch(i){console.log(i),l.alert("Failed to connect to relay server")}this.domComponent.append(s("h2",{},"Select From Known Hosts"),s("br"),s("button",{},"Refresh",{type:"click",event:()=>{this.render({type:"known"})}}),s("br"),s("div",{class:"host-list-index"},[...this.renderHostList(n)]),s("br"),s("div",{},"Or"),s("br"),s("button",{class:""},"Add New Host",{type:"click",event:()=>{this.render({type:"new"})}}))});r(this,"renderNewHostForm",()=>{this.domComponent.append(s("h2",{},"Enter Host Key"),s("form",{id:"hostForm",onsubmit:this.handleSubmit},[s("fieldset",{},[s("legend",{},"New Host"),s("div",{class:"input-container"},[s("label",{for:"hostKey"},"Host Key"),s("input",{type:"text",id:"hostKey",name:"hostKey",required:!0})]),s("br"),s("button",{type:"submit"},"Continue")])],{type:"submit",event:e=>{e.preventDefault();const t=this.domComponent.querySelector("#hostKey").value;if(!t)return!1;l.verifyHostKey(t).then(n=>{this.render({type:"known"})}).catch(n=>{l.alert("Invalid host key"),console.error(n)})}}),s("br"),s("button",{},"Return To List",{type:"click",event:()=>{this.render({type:"known"})}}))});r(this,"render",e=>{switch(this.domComponent.innerHTML="",e.type){case"known":this.renderKnownHosts();break;case"new":this.renderNewHostForm();break;default:this.renderKnownHosts()}});this.app=e,this.domComponent=s("div",{class:"host-form-container"})}}new Ue;
