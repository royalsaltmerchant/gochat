var Y=Object.defineProperty;var X=(n,e,t)=>e in n?Y(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var c=(n,e,t)=>X(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const d of r.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&a(d)}).observe(document,{childList:!0,subtree:!0});function t(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(i){if(i.ep)return;i.ep=!0;const r=t(i);fetch(i.href,r)}})();const L="https://chat.parchchat.com",Q="wss://chat.parchchat.com/ws",P="5837a5c3-5268-45e1-9ea4-ee87d959d067",Z="Parch Community";function s(n,e,t,a){if(typeof n>"u")return!1;var i=document.createElement(n);if(typeof e=="object")for(var r in e)i.setAttribute(r,e[r]);if(t)if(typeof t=="string"&&/<[^>]+>/.test(t))i.innerHTML=t;else{Array.isArray(t)||(t=[t]);for(var d=0;d<t.length;d++)t[d]instanceof Node?i.appendChild(t[d]):i.appendChild(document.createTextNode(t[d]))}if(a){Array.isArray(a)||(a=[a]);for(var o of a)i.addEventListener(o.type,o.event)}return i}const H="parch.hosts";function D(){try{const n=localStorage.getItem(H);if(!n)return[];const e=JSON.parse(n);return Array.isArray(e)?e:[]}catch{return[]}}function x(n){localStorage.setItem(H,JSON.stringify(n))}const p={async greet(n){return`Hello ${n}, It's show time!`},async alert(n){window.alert(n)},async confirm(n){return window.confirm(n)},async openExternal(n){window.open(n,"_blank","noopener,noreferrer")},async getHosts(){const n=D();return n.some(e=>e.uuid===P)||(n.push({uuid:P,name:Z}),x(n)),n},async verifyHostKey(n){const e=await fetch(`${L}/api/host/${n}`);if(!e.ok)throw new Error("host not found");const t=await e.json(),a=D();return a.some(i=>i.uuid===n)||(a.push({uuid:t.uuid,name:t.name}),x(a)),t},async removeHost(n){const e=D(),t=e.filter(a=>a.uuid!==n);if(t.length===e.length)throw new Error(`host with UUID ${n} not found`);x(t)}},K="parch.chat.identity",E="parch.chat.device_id",N="parch.chat.identity.last_exported_at";function C(){const n=globalThis==null?void 0:globalThis.crypto;if(!(n!=null&&n.subtle))throw new Error("WebCrypto API is not available");return n}function v(n){let e="";const t=n instanceof Uint8Array?n:new Uint8Array(n);for(let a=0;a<t.length;a+=1)e+=String.fromCharCode(t[a]);return btoa(e).replace(/=+$/g,"")}function g(n){const e=(4-n.length%4)%4,t=n+"=".repeat(e),a=atob(t),i=new Uint8Array(a.length);for(let r=0;r<a.length;r+=1)i[r]=a.charCodeAt(r);return i}function O(){try{const n=localStorage.getItem(K);if(!n)return null;const e=JSON.parse(n);return!e.publicKey||!e.privateKey?null:e}catch{return null}}function w(n){localStorage.setItem(K,JSON.stringify(n))}function ee(){const n=localStorage.getItem(E);if(typeof n=="string"&&n.trim()!=="")return n.trim();const e=v(C().getRandomValues(new Uint8Array(16)));return localStorage.setItem(E,e),e}function te(){var e;const n=(((e=globalThis==null?void 0:globalThis.navigator)==null?void 0:e.userAgent)||"").toLowerCase();return n.includes("edg/")?"Edge":n.includes("firefox/")?"Firefox":n.includes("safari/")&&!n.includes("chrome/")?"Safari":n.includes("chrome/")?"Chrome":"Browser"}function ne(){var i;const n=ee(),e=te(),t=String(((i=globalThis==null?void 0:globalThis.navigator)==null?void 0:i.platform)||"Unknown"),a=`${e} on ${t}`.slice(0,80);return{deviceId:n,deviceName:a}}function se(){localStorage.setItem(N,new Date().toISOString())}function ae(){const n=localStorage.getItem(N);return typeof n=="string"?n:""}function ie(n){if(!n||typeof n!="object")throw new Error("Identity payload must be an object");const e=typeof n.publicKey=="string"?n.publicKey.trim():"",t=typeof n.privateKey=="string"?n.privateKey.trim():"",a=typeof n.encPublicKey=="string"?n.encPublicKey.trim():"",i=typeof n.encPrivateKey=="string"?n.encPrivateKey.trim():"",r=typeof n.username=="string"?n.username.trim():"";if(!e||!t||!a||!i)throw new Error("Identity must include auth and encryption keypairs");return{publicKey:e,privateKey:t,encPublicKey:a,encPrivateKey:i,username:r}}async function B(){const n=C(),e=await n.subtle.generateKey({name:"ECDH",namedCurve:"P-256"},!0,["deriveBits"]),t=await n.subtle.exportKey("spki",e.publicKey),a=await n.subtle.exportKey("pkcs8",e.privateKey);return{encPublicKey:v(t),encPrivateKey:v(a)}}async function oe(){const n=C(),e=await n.subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),t=await n.subtle.exportKey("raw",e.publicKey),a=await n.subtle.exportKey("pkcs8",e.privateKey),i=await B(),r={publicKey:v(t),privateKey:v(a),encPublicKey:i.encPublicKey,encPrivateKey:i.encPrivateKey,username:""};return w(r),r}async function R(){const n=O();if(n){if(!n.encPublicKey||!n.encPrivateKey){const e=await B(),t={...n,encPublicKey:e.encPublicKey,encPrivateKey:e.encPrivateKey};return w(t),t}return n}return oe()}async function re(n,e){const t=C(),a=g(n.privateKey),i=await t.subtle.importKey("pkcs8",a,{name:"Ed25519"},!1,["sign"]),r=new TextEncoder().encode(e),d=await t.subtle.sign({name:"Ed25519"},i,r);return v(d)}async function ce(n,e,t){const a=C(),i=g(n),r=g(t),d=await a.subtle.importKey("raw",i,{name:"Ed25519"},!1,["verify"]),o=new TextEncoder().encode(e);return a.subtle.verify({name:"Ed25519"},d,r,o)}async function de(n){const e=C(),t=g(n.privateKey),a=g(n.publicKey),i=g(n.encPrivateKey),r=g(n.encPublicKey),d=await e.subtle.importKey("pkcs8",t,{name:"Ed25519"},!1,["sign"]),o=await e.subtle.importKey("raw",a,{name:"Ed25519"},!1,["verify"]),h=new TextEncoder().encode("parch-identity-check"),l=await e.subtle.sign({name:"Ed25519"},d,h);if(!await e.subtle.verify({name:"Ed25519"},o,l,h))throw new Error("Public/private key mismatch");await e.subtle.importKey("pkcs8",i,{name:"ECDH",namedCurve:"P-256"},!1,["deriveBits"]),await e.subtle.importKey("spki",r,{name:"ECDH",namedCurve:"P-256"},!1,[])}async function le(){return R()}async function he(){const n=await R();return JSON.stringify(n,null,2)}async function pe(n){let e=n;if(typeof n=="string")try{e=JSON.parse(n)}catch{throw new Error("Identity import text must be valid JSON")}const t=ie(e);return await de(t),w(t),t}function ue(n){const e=O();e&&(e.username=(n||"").trim(),w(e))}function me(){localStorage.removeItem(K)}const m={getOrCreateIdentity:le,getDeviceMetadata:ne,signAuthMessage:re,verifyAuthSignature:ce,exportIdentity:he,markIdentityExportedNow:se,getLastExportedAt:ae,importIdentity:pe,setIdentityUsername:ue,clearIdentity:me};class ye{constructor(e,t){c(this,"open",e=>(this.domComponent.style.display="block",this.render(e)));c(this,"close",()=>{this.domComponent.style.display="none"});c(this,"renderPrompt",e=>new Promise(t=>{this.promptResolver=t,this.domComponent.append(s("div",{class:"modal-content"},[s("div",{class:"modal-header"},[s("h2",{},e||"Enter a value")]),s("div",{class:"modal-body"},[s("input",{id:"prompt-input",type:"text",style:"width: 100%; margin-bottom: 10px;"}),s("div",{style:"text-align: right;"},[s("button",{class:"btn"},"OK",{type:"click",event:()=>{const a=this.domComponent.querySelector("#prompt-input").value;this.close(),this.promptResolver(a)}}),s("button",{class:"btn btn-red",style:"margin-left: 10px;"},"Cancel",{type:"click",event:()=>{this.close(),this.promptResolver(null)}})])])]))}));c(this,"renderAuthorSettings",e=>[s("div",{class:"settings-section"},[s("h3",{},"Space Management"),s("div",{class:"settings-actions"},[s("button",{class:"btn"},"Invite User",{type:"click",event:()=>{this.render({type:"prompt",data:{message:"Enter recipient public key"}}).then(t=>{t&&this.socketConn.inviteUser({public_key:t.trim(),space_uuid:e.uuid})})}}),s("button",{class:"btn btn-red"},"Delete Space",{type:"click",event:()=>{p.confirm("Are you sure you want to delete this space?").then(t=>{t&&this.socketConn.deleteSpace({uuid:e.uuid})})}})])]),s("div",{class:"settings-section"},[s("h3",{},"Channel Management"),s("div",{class:"settings-actions"},[s("button",{class:"btn"},"+ Create Channel",{type:"click",event:()=>{this.render({type:"prompt",data:{message:"Please enter Channel name"}}).then(t=>{t&&this.socketConn.createChannel({name:t.trim(),space_uuid:e.uuid})})}})]),s("div",{class:"channels-list"},e.channels.map(t=>s("div",{class:"channel-item"},[s("span",{},t.name),s("button",{class:"btn-small btn-red"},"Delete",{type:"click",event:()=>{p.confirm("Are you sure you want to delete this channel?").then(a=>{a&&this.socketConn.deleteChannel({uuid:t.uuid})})}})])))])]);c(this,"renderSpaceUserSettings",(e,t)=>[s("div",{class:"settings-section"},[s("h3",{},"Space Management"),s("div",{class:"settings-actions"},[s("button",{class:"btn btn-red"},"Leave Space",{type:"click",event:()=>{p.confirm("Are you sure you want to leave this space?").then(a=>{a&&this.socketConn.leaveSpace({space_uuid:e.uuid,user_id:t.id,user_public_key:t.public_key||"",user_enc_public_key:t.enc_public_key||""})})}})])])]);c(this,"renderAccount",(e,t=[])=>{const a=async o=>{if(!o){p.alert("No identity data provided");return}if(await p.confirm("Import identity and replace the current local identity on this browser?"))try{await m.importIdentity(o),p.alert("Identity imported. Reloading..."),window.location.reload()}catch(l){console.error(l),p.alert((l==null?void 0:l.message)||"Failed to import identity")}},i=o=>{if(!o)return"Never";const h=new Date(o);return Number.isNaN(h.getTime())?"Unknown":h.toLocaleString()},r=()=>{const o=this.domComponent.querySelector("#last-exported-at");o&&(o.textContent=i(m.getLastExportedAt()))},d=()=>{const o=this.domComponent.querySelector("#active-devices-list");if(!o)return;if(o.innerHTML="",!Array.isArray(t)||t.length===0){o.append(s("div",{style:"font-size: 0.85rem; color: var(--main-gray);"},"No active device sessions detected on this host."));return}const h=t.map(l=>{const u=`${l.device_name||"Unknown Device"}${l.is_current?" (This device)":""}`,f=`Last seen: ${i(l.last_seen||"")}`;return s("div",{class:"channel-item"},[s("div",{style:"font-size: 0.92rem; color: var(--bright-white);"},u),s("div",{style:"font-size: 0.8rem; color: var(--main-gray);"},f)])});o.append(...h)};this.domComponent.append(s("div",{class:"modal-content"},[s("div",{class:"modal-header"},[s("h2",{},"Account"),s("button",{class:"close-modal"},"×",{type:"click",event:this.close})]),s("div",{class:"modal-body"},[s("h3",{},`Username: "${e.username}"`),s("div",{class:"settings-section"},[s("h3",{},"Public Key (Share for Invites)"),s("p",{style:"display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--main-gray);"},"Share this public key with space admins so they can invite you."),s("textarea",{id:"public-key-display",readonly:"readonly",rows:"4",style:"width: 100%; font-size: 0.8rem; padding: 8px; background: var(--second-dark); color: var(--a-blue); border: 1px solid var(--main-gray); border-radius: 4px; resize: vertical;"}),s("br"),s("button",{class:"btn",id:"copy-public-key-btn"},"Copy Public Key",{type:"click",event:async()=>{var l;const o=this.domComponent.querySelector("#public-key-display"),h=((o==null?void 0:o.value)||"").trim();if(!h){p.alert("Public key not available yet");return}try{(l=navigator.clipboard)!=null&&l.writeText?await navigator.clipboard.writeText(h):(o.focus(),o.select(),document.execCommand("copy")),p.alert("Public key copied")}catch{p.alert("Failed to copy public key")}}})]),s("div",{class:"settings-section"},[s("h3",{},"Identity Transfer (Private Key)"),s("p",{style:"display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--light-red);"},"Anyone with your identity JSON can access your account. Share it only with yourself."),s("p",{style:"display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--main-gray);"},"Export on this browser, then import on another browser/device to keep the same identity."),s("textarea",{id:"identity-export-display",readonly:"readonly",rows:"6",style:"width: 100%; font-size: 0.78rem; padding: 8px; background: var(--second-dark); color: var(--main-white); border: 1px solid var(--main-gray); border-radius: 4px; resize: vertical; margin-bottom: 8px;"}),s("button",{class:"btn",id:"copy-identity-btn"},"Copy Identity JSON",{type:"click",event:async()=>{var l;const o=this.domComponent.querySelector("#identity-export-display"),h=((o==null?void 0:o.value)||"").trim();if(!h){p.alert("Identity export is not ready");return}try{(l=navigator.clipboard)!=null&&l.writeText?await navigator.clipboard.writeText(h):(o.focus(),o.select(),document.execCommand("copy")),m.markIdentityExportedNow(),r(),p.alert("Identity JSON copied")}catch{p.alert("Failed to copy identity JSON")}}}),s("button",{class:"btn",id:"download-identity-btn",style:"margin-left: 8px;"},"Download Identity File",{type:"click",event:async()=>{try{const o=await m.exportIdentity(),h=new Blob([o],{type:"application/json"}),l=URL.createObjectURL(h),u=document.createElement("a");u.href=l,u.download="parch-identity.json",document.body.appendChild(u),u.click(),u.remove(),URL.revokeObjectURL(l),m.markIdentityExportedNow(),r()}catch{p.alert("Failed to generate identity file")}}}),s("p",{style:"display: block; margin: 8px 0 6px; font-size: 0.82rem; color: var(--main-gray);"},["Last exported: ",s("span",{id:"last-exported-at"},"Never")]),s("br"),s("textarea",{id:"identity-import-input",rows:"6",placeholder:"Paste identity JSON here to import",style:"width: 100%; font-size: 0.78rem; padding: 8px; background: var(--second-dark); color: var(--a-blue); border: 1px solid var(--main-gray); border-radius: 4px; resize: vertical; margin-bottom: 8px;"}),s("button",{class:"btn",id:"import-identity-btn"},"Import Identity JSON",{type:"click",event:async()=>{const o=this.domComponent.querySelector("#identity-import-input"),h=((o==null?void 0:o.value)||"").trim();if(!h){p.alert("Paste identity JSON to import");return}await a(h)}}),s("button",{class:"btn",id:"import-identity-file-btn",style:"margin-left: 8px;"},"Import Identity File",{type:"click",event:()=>{const o=this.domComponent.querySelector("#identity-import-file");o&&(o.value="",o.click())}}),s("input",{id:"identity-import-file",type:"file",accept:"application/json,.json",style:"display: none;"},null,{type:"change",event:async o=>{var l,u;const h=(u=(l=o==null?void 0:o.target)==null?void 0:l.files)==null?void 0:u[0];if(h)try{const f=await h.text();await a(f)}catch{p.alert("Failed to read identity file")}}})]),s("div",{class:"settings-section"},[s("h3",{},"Active Devices"),s("p",{style:"display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--main-gray);"},"Shows active sessions for this identity on this host."),s("div",{id:"active-devices-list",class:"channels-list"})]),s("div",{class:"settings-section"},[s("h3",{},"Local Fallback Username"),s("p",{style:"display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--main-gray);"},"Used as the default username sent during auth when joining a host for the first time."),s("div",{class:"input-container"},[s("label",{for:"local-identity-username"},"Local Username"),s("input",{id:"local-identity-username",name:"localIdentityUsername",type:"text",value:"",placeholder:"Set local fallback username"})]),s("br"),s("button",{class:"btn"},"Save Local Username",{type:"click",event:()=>{const o=this.domComponent.querySelector("#local-identity-username"),h=((o==null?void 0:o.value)||"").trim();m.setIdentityUsername(h),p.alert("Local fallback username saved")}})]),s("form",{id:"update-username-form"},[s("fieldset",{},[s("legend",{},"Update Username"),s("div",{class:"input-container"},[s("label",{for:"username"},"Username"),s("input",{id:"username",name:"username",type:"text",required:!0,autofocus:!0,value:e.username||""})]),s("br"),s("button",{type:"submit"},"Submit")])],{type:"submit",event:o=>{o.preventDefault();const h=new FormData(o.target),l=Object.fromEntries(h.entries());l.user_id=e.id,l.user_public_key=e.public_key||"",l.user_enc_public_key=e.enc_public_key||"",this.socketConn.updateUsername(l)}}),s("br"),s("button",{class:"btn-red"},"Reset Identity",{type:"click",event:()=>{p.confirm("Reset local identity key? This creates a new account identity.").then(o=>{o&&(m.clearIdentity(),window.location.reload())})}})])])),m.getOrCreateIdentity().then(o=>{const h=this.domComponent.querySelector("#public-key-display"),l=this.domComponent.querySelector("#identity-export-display"),u=this.domComponent.querySelector("#local-identity-username");h&&(h.value=o.publicKey||""),u&&(u.value=o.username||""),l&&m.exportIdentity().then(f=>{l.value=f}).catch(()=>{l.value=""})}).catch(()=>{const o=this.domComponent.querySelector("#public-key-display"),h=this.domComponent.querySelector("#identity-export-display"),l=this.domComponent.querySelector("#local-identity-username");o&&(o.value=""),l&&(l.value=""),h&&(h.value="")}),r(),d()});c(this,"renderInvites",(e,t)=>{this.domComponent.append(s("div",{class:"modal-content"},[s("div",{class:"modal-header"},[s("h2",{},"Space Invites"),s("button",{class:"close-modal"},"×",{type:"click",event:this.close})]),s("div",{class:"modal-body"},e&&e.length&&t?s("div",{class:"invites-section"},[...e.map(a=>s("div",{class:"pending-invites-item"},[s("span",{},a.name),s("div",{},[s("button",{class:"btn-small accept-invite"},"Accept",{type:"click",event:()=>this.socketConn.acceptInvite({space_user_id:a.id,user_id:t.id,user_public_key:t.public_key||"",user_enc_public_key:t.enc_public_key||""})}),s("button",{class:"btn-small btn-red decline-invite"},"Decline",{type:"click",event:()=>this.socketConn.declineInvite({space_user_id:a.id,user_id:t.id,user_public_key:t.public_key||"",user_enc_public_key:t.enc_public_key||""})})])]))]):"...No Invite Yet")]))});c(this,"render",e=>{var t;switch(this.domComponent.innerHTML="",e.type){case"prompt":if((t=e.data)!=null&&t.message)return this.renderPrompt(e.data.message);break;case"account":e.data.user&&this.renderAccount(e.data.user,e.data.active_devices||[]);break;case"invites":this.renderInvites(e.data.invites,e.data.user);break;case"space-settings":if(e.data.space&&e.data.user){const a=e.data.space,i=e.data.user,r=a.author_id===i.id;this.domComponent.append(s("div",{class:"modal-content"},[s("div",{class:"modal-header"},[s("h2",{},`Space Settings: ${a.name}`),s("button",{class:"close-modal"},"×",{type:"click",event:this.close})]),s("div",{class:"modal-body"},r?this.renderAuthorSettings(a):this.renderSpaceUserSettings(a,i))]))}break}});this.app=e,this.socketConn=t,this.domComponent=s("div",{class:"modal"}),this.promptResolver=null}}class fe{constructor(e){c(this,"initSpaceComponents",()=>{this.data.spaces&&(this.spaceComponents=this.data.spaces.map(e=>new T({domComponent:s("div",{class:"space-item"}),space:e,user:this.data.user,openSpaceSettings:this.openSpaceSettings,loadChannel:this.loadChannel})))});c(this,"addSpace",e=>{const t=new T({domComponent:s("div",{class:"space-item"}),space:e,user:this.data.user,openSpaceSettings:this.openSpaceSettings,loadChannel:this.loadChannel});this.spaceComponents.push(t),this.render()});c(this,"render",()=>{this.domComponent.innerHTML="",this.initSpaceComponents(),this.userAccountComponent=new ge({data:this.data,returnToHostList:this.returnToHostList,openDashModal:this.openDashModal,domComponent:s("div",{class:"user-component"})}),this.spaceUserListComponent=new be({data:this.data,socketConn:this.socketConn,getCurrentSpaceUUID:this.getCurrentSpaceUUID,domComponent:s("div",{class:"space-users-list",id:"space-users-list"})}),this.domComponent.append(s("div",{class:"sidebar-spaces-container"},[s("div",{id:"spaces-list"},this.spaceComponents.map(e=>e.domComponent)),s("button",{class:"create-space-btn",id:"new-space-btn"},"+ Create New Space",{type:"click",event:()=>{this.openDashModal({type:"prompt",data:{message:"Please enter Space 'Name'"}}).then(e=>{e&&(e.trim(),this.socketConn.createSpace({name:e}))})}})]),s("br"),this.spaceUserListComponent.domComponent,s("hr"),this.userAccountComponent.domComponent)});this.data=e.data,this.socketConn=e.socketConn,this.returnToHostList=e.returnToHostList,this.openDashModal=e.openDashModal,this.closeDashModal=e.closeDashModal,this.getCurrentSpaceUUID=e.getCurrentSpaceUUID,this.spaceComponents=[],this.domComponent=e.domComponent,this.openSpaceSettings=e.openSpaceSettings,this.loadChannel=e.loadChannel,this.render()}}class ge{constructor(e){c(this,"render",()=>{this.domComponent.innerHTML="",this.domComponent.append(s("a",{href:"#"},"Account",{type:"click",event:e=>{this.openDashModal({type:"account",data:{user:this.data.user,active_devices:this.data.active_devices||[]}})}}),s("a",{href:"#"},"Invites",{type:"click",event:e=>{this.openDashModal({type:"invites",data:{invites:this.data.invites,user:this.data.user}})}}),s("a",{href:"#"},"<- Host List",{type:"click",event:e=>{this.returnToHostList()}}))});this.data=e.data,this.returnToHostList=e.returnToHostList,this.openDashModal=e.openDashModal,this.domComponent=e.domComponent,this.render()}}class be{constructor(e){c(this,"isAuthor",(e,t)=>String(e.author_id)===String(t.id));c(this,"renderUserElement",(e,t)=>s("div",{class:"space-user-item",id:"space-user-item"},`${t.username} ${this.isAuthor(e,t)?"*":""}`,{type:"click",event:async()=>{this.isAuthor(e,this.data.user)&&this.data.user.id!=t.id&&p.confirm("Are you sure you want to remove this user?").then(a=>{a&&this.socketConn.removeSpaceUser({space_uuid:e.uuid,user_id:t.id,user_public_key:t.public_key||""})})}}));c(this,"renderSpaceUsersList",e=>{const t=[];return e.users&&e.users.map(a=>{t.push(this.renderUserElement(e,a))}),t});c(this,"render",()=>{this.domComponent.innerHTML="";const e=this.getCurrentSpaceUUID();if(e){const t=this.data.spaces.find(a=>a.uuid===e);if(!t)return;this.domComponent.append(s("h3",{},"Users"),...this.renderSpaceUsersList(t))}});this.data=e.data,this.socketConn=e.socketConn,this.getCurrentSpaceUUID=e.getCurrentSpaceUUID,this.domComponent=e.domComponent,this.render()}}class T{constructor(e){c(this,"isAuthor",()=>String(this.space.author_id)===String(this.user.id));c(this,"renderChannelList",()=>s("div",{class:"channel-list"},(this.space.channels||[]).map(e=>s("div",{class:"channel-item"},[s("span",{class:"channel-hash"},"#"),s("span",{},e.name)],{type:"click",event:()=>this.loadChannel(this.space.uuid,e.uuid)}))));c(this,"toggleChannels",()=>{this.channelsOpen=!this.channelsOpen,this.render()});c(this,"render",()=>{this.domComponent.textContent="",this.domComponent.className=`space-item${this.channelsOpen?" space-item--open":""}`,this.domComponent.append(s("div",{class:"space-header"},[s("span",{class:"space-chevron"}),s("span",{},this.space.name),s("div",{class:"space-actions"},s("button",{class:"btn-icon open-settings"},"⚙️",{type:"click",event:e=>{e.stopPropagation(),this.openSpaceSettings(this.space)}}))],{type:"click",event:this.toggleChannels}),...this.channelsOpen?[this.renderChannelList()]:[])});this.space=e.space,this.user=e.user,this.openSpaceSettings=e.openSpaceSettings,this.loadChannel=e.loadChannel,this.channelsOpen=!1,this.domComponent=e.domComponent,this.render()}}function ve(n){const e=new Date(n),t=e.getFullYear(),a=(e.getMonth()+1).toString().padStart(2,"0"),i=e.getDate().toString().padStart(2,"0"),r=e.getHours(),d=e.getMinutes(),o=r%12||12,h=r<12?"am":"pm",l=d.toString().padStart(2,"0");return`${a}-${i}-${t} ${o}:${l}${h}`}const Ce="data:image/svg+xml;base64,"+btoa(`
    <svg xmlns="http://www.w3.org/2000/svg" width="150" height="100" viewBox="0 0 150 100">
      <rect width="150" height="100" fill="#aaaaa" />
      <text x="75" y="55" font-size="14" text-anchor="middle" fill="#a00" font-family="sans-serif">Image not found</text>
    </svg>
  `);function ke(n){const e=document.createElement("img");return e.src=n,e.alt="Image",e.style="max-width: 100%; max-height: 250px; margin: 5px; cursor: pointer;",e.onerror=()=>{e.src=Ce},e}function Se(n){const e=n.split(".");if(e.length<2)return!1;const t=e[e.length-1].toLowerCase().split("?")[0];return["jpg","jpeg","png","gif","webp","svg","tiff"].includes(t)}function k(){const n=globalThis==null?void 0:globalThis.crypto;if(!(n!=null&&n.subtle))throw new Error("WebCrypto API is not available");return n}function _(n){let e="";const t=n instanceof Uint8Array?n:new Uint8Array(n);for(let a=0;a<t.length;a+=1)e+=String.fromCharCode(t[a]);return btoa(e).replace(/=+$/g,"")}function b(n){const e=(4-n.length%4)%4,t=n+"=".repeat(e),a=atob(t),i=new Uint8Array(a.length);for(let r=0;r<a.length;r+=1)i[r]=a.charCodeAt(r);return i}function M(n){const e=Array.isArray(n.wrapped_keys)?[...n.wrapped_keys].sort((a,i)=>String(a.recipient_auth_public_key).localeCompare(String(i.recipient_auth_public_key))):[],t={v:n.v,alg:n.alg,message_id:n.message_id,sender_timestamp:n.sender_timestamp,space_uuid:n.space_uuid,channel_uuid:n.channel_uuid,sender_auth_public_key:n.sender_auth_public_key,sender_enc_public_key:n.sender_enc_public_key,content_iv:n.content_iv,ciphertext:n.ciphertext,wrapped_keys:e.map(a=>({recipient_auth_public_key:a.recipient_auth_public_key,iv:a.iv,ciphertext:a.ciphertext}))};return JSON.stringify(t)}function _e(){const n=k();return _(n.getRandomValues(new Uint8Array(16)))}async function F(n){return k().subtle.importKey("spki",b(n),{name:"ECDH",namedCurve:"P-256"},!1,[])}async function we(n){return F(n)}async function J(n){return k().subtle.importKey("pkcs8",b(n),{name:"ECDH",namedCurve:"P-256"},!1,["deriveBits"])}async function $(n,e,t){const a=k(),i=await a.subtle.deriveBits({name:"ECDH",public:e},n,256),r=await a.subtle.importKey("raw",i,"HKDF",!1,["deriveKey"]),d=new TextEncoder().encode(`parch-e2ee-wrap-salt:${t.space_uuid}:${t.channel_uuid}`),o=new TextEncoder().encode(`parch-e2ee-wrap-info:${t.sender_auth_public_key}`);return a.subtle.deriveKey({name:"HKDF",hash:"SHA-256",salt:d,info:o},r,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async function Ue(n){const e=k(),{plaintext:t,spaceUUID:a,channelUUID:i,identity:r,recipients:d}=n;if(!(r!=null&&r.publicKey)||!(r!=null&&r.privateKey)||!(r!=null&&r.encPublicKey)||!(r!=null&&r.encPrivateKey))throw new Error("Missing sender identity keys");if(!a||!i)throw new Error("Missing space/channel context");if(!Array.isArray(d)||d.length===0)throw new Error("No recipient keys available for encryption");const o=[],h=new Set;for(const y of d)!(y!=null&&y.authPublicKey)||!(y!=null&&y.encPublicKey)||h.has(y.authPublicKey)||(h.add(y.authPublicKey),o.push(y));h.has(r.publicKey)||o.push({authPublicKey:r.publicKey,encPublicKey:r.encPublicKey});const l=await e.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),u=new Uint8Array(await e.subtle.exportKey("raw",l)),f=e.getRandomValues(new Uint8Array(12)),U=new TextEncoder().encode(t),I=await e.subtle.encrypt({name:"AES-GCM",iv:f},l,U),W=await J(r.encPrivateKey),S={v:1,alg:"p256-hkdf-aesgcm+ed25519",message_id:_e(),sender_timestamp:new Date().toISOString(),space_uuid:a,channel_uuid:i,sender_auth_public_key:r.publicKey,sender_enc_public_key:r.encPublicKey,content_iv:_(f),ciphertext:_(I),wrapped_keys:[]};for(const y of o){const z=await F(y.encPublicKey),V=await $(W,z,S),A=e.getRandomValues(new Uint8Array(12)),G=await e.subtle.encrypt({name:"AES-GCM",iv:A},V,u);S.wrapped_keys.push({recipient_auth_public_key:y.authPublicKey,iv:_(A),ciphertext:_(G)})}const q=M(S);return S.sig=await m.signAuthMessage(r,q),S}async function Ie(n){const e=k(),{envelope:t,identity:a}=n;if(!(t!=null&&t.sender_auth_public_key)||!(t!=null&&t.sender_enc_public_key)||!(t!=null&&t.sig))throw new Error("Invalid encrypted envelope");if(!(a!=null&&a.publicKey)||!(a!=null&&a.encPrivateKey))throw new Error("Missing recipient identity");const i=M(t);if(!await m.verifyAuthSignature(t.sender_auth_public_key,i,t.sig))throw new Error("Invalid message signature");const d=(t.wrapped_keys||[]).find(I=>I.recipient_auth_public_key===a.publicKey);if(!d)throw new Error("No wrapped key for this identity");const o=await J(a.encPrivateKey),h=await we(t.sender_enc_public_key),l=await $(o,h,t),u=await e.subtle.decrypt({name:"AES-GCM",iv:b(d.iv)},l,b(d.ciphertext)),f=await e.subtle.importKey("raw",u,{name:"AES-GCM",length:256},!1,["decrypt"]),U=await e.subtle.decrypt({name:"AES-GCM",iv:b(t.content_iv)},f,b(t.ciphertext));return new TextDecoder().decode(U)}const j={encryptMessageForSpace:Ue,decryptMessageForIdentity:Ie,canonicalEnvelopeForSignature:M};class De{constructor(e){c(this,"initialize",e=>{this.chatBoxComponent=new xe({domComponent:s("div"),data:this.data,socketConn:this.socketConn,channelUUID:e}),this.render();const t=new Date().toISOString();this.socketConn.getMessages(t)});c(this,"render",()=>{this.domComponent.innerHTML="",this.chatBoxComponent&&this.domComponent.append(this.chatBoxComponent.domComponent)});this.domComponent=e.domComponent,this.data=e.data,this.socketConn=e.socketConn,this.chatBoxComponent=null}}class xe{constructor(e){c(this,"render",()=>{this.domComponent.innerHTML="",this.domComponent.append(s("div",{class:"chatapp-channel-title"},this.channel.name),this.chatBoxMessagesComponent.domComponent,s("div",{class:"chat-box-form"},[s("textarea",{id:"chat-box-form-input",class:"chat-box-form-input",autofocus:!0,type:"text",required:!0,autocomplete:"off",placeholder:"Type message here..."},null,[{type:"input",event:e=>{const t=e.target;t.style.height="auto",t.style.height=`${t.scrollHeight}px`}},{type:"keydown",event:async e=>{var t,a;if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();const i=e.target,r=i.value.trim();if(r)try{const d=await m.getOrCreateIdentity(),o=(((t=this.space)==null?void 0:t.users)||[]).filter(l=>(l==null?void 0:l.public_key)&&(l==null?void 0:l.enc_public_key)).map(l=>({authPublicKey:l.public_key,encPublicKey:l.enc_public_key})),h=await j.encryptMessageForSpace({plaintext:r,spaceUUID:(a=this.space)==null?void 0:a.uuid,channelUUID:this.channelUUID,identity:d,recipients:o});this.socketConn.sendMessage({envelope:h}),i.value="",i.style.height="auto",i.focus()}catch(d){console.error(d),p.alert((d==null?void 0:d.message)||"Failed to encrypt message")}}}}])]))});this.domComponent=e.domComponent,this.domComponent.className="chat-box-container",this.data=e.data,this.socketConn=e.socketConn,this.channelUUID=e.channelUUID;for(const t of this.data.spaces){const a=t.channels.find(i=>i.uuid===this.channelUUID);if(a){this.space=t,this.channel=a;break}}this.chatBoxMessagesComponent=new Ke({domComponent:s("div",{class:"chat-box-messages",id:"chat-box-messages"}),channelUUID:this.channelUUID,socketConn:this.socketConn}),this.render()}}class Ke{constructor(e){c(this,"getPreviousMessagesDebounce",()=>{this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.debounceTimeout=setTimeout(()=>{this.getPreviousMessages()},300)});c(this,"getPreviousMessages",()=>{if(this.isLoading||!this.hasMoreMessages||!this.chatBoxMessages.length||!this.isScrolledToTop())return;this.isLoading=!0;const e=this.chatBoxMessages[0].timestamp;this.socketConn.getMessages(e)});c(this,"scrollDown",()=>{this.domComponent.scrollTop=this.domComponent.scrollHeight});c(this,"isScrolledToTop",()=>this.domComponent.scrollTop<=20);c(this,"isScrolledToBottom",()=>this.domComponent.scrollHeight-this.domComponent.scrollTop<=this.domComponent.clientHeight+40);c(this,"appendNewMessage",e=>{const t=this.isScrolledToBottom();this.chatBoxMessages.push(e),this.render(),t&&requestAnimationFrame(()=>this.scrollDown())});c(this,"createMessage",e=>{const t=a=>{const i=/(https?:\/\/[^\s]+)/g,r=/^https?:\/\/[^\s]+$/;return a.split(i).map(o=>r.test(o)?Se(o)?ke(o):s("a",{href:o,target:"_blank",rel:"noopener noreferrer",style:"margin: 0 5px;"},o):o)};return s("div",{class:"chat-box-message-content"},[s("div",{style:"display: flex; align-items: flex-end;"},[s("small",{style:"margin-right: var(--main-distance); color: var(--main-gray);"},ve(e.timestamp)),s("div",{style:"font-weight: bold; margin-right: var(--main-distance); color: var(--light-yellow);"},e.username)]),s("div",{class:"chat-box-message-text"},[...t(e.content)]),s("hr")])});c(this,"render",()=>{this.domComponent.innerHTML="";const e=this.chatBoxMessages.map(t=>this.createMessage(t));this.domComponent.append(...e)});this.chatBoxMessages=[],this.channelUUID=e.channelUUID,this.socketConn=e.socketConn,this.messageRequestSize=50,this.hasMoreMessages=!0,this.debounceTimeout=null,this.isLoading=!1,this.domComponent=s("div",{class:"chat-box-messages",id:"chat-box-messages"},null,{type:"scroll",event:()=>{this.getPreviousMessagesDebounce()}})}}class Me{constructor(e){c(this,"renderChannel",e=>{this.currentChannelUUID=e,this.domComponent.innerHTML="";const t=s("div",{class:"chatapp-container"});this.domComponent.append(t),this.chatApp?this.chatApp.domComponent=t:this.chatApp=new De({domComponent:t,data:this.data,socketConn:this.socketConn}),this.chatApp.initialize(e)});c(this,"cleanup",()=>{var e,t;this.chatApp&&((t=(e=this.chatApp).cleanup)==null||t.call(e),this.chatApp=null),this.currentChannelUUID=null});c(this,"render",()=>{this.cleanup(),this.domComponent.innerHTML="",this.domComponent.append(s("div",{class:"no-channel-selected"},[s("h2",{},"Select a channel to start chatting")]))});this.domComponent=e.domComponent,this.data=e.data,this.socketConn=e.socketConn,this.chatApp=null,this.currentChannelUUID=null,this.render()}}class Ae{constructor(e){c(this,"retryConnection",()=>{if(this.retryCount+=1,this.retryCount>this.maxRetries){p.alert("Unable to reconnect to host. Returning to home."),this.returnToHostList();return}setTimeout(()=>{var t;((t=this.socket)==null?void 0:t.readyState)!==WebSocket.OPEN&&this.connect()},2e3)});c(this,"connect",()=>{this.socket=new WebSocket(Q),this.socket.onopen=()=>{this.joinHost()},this.socket.onerror=e=>{console.error("WebSocket error:",e)},this.socket.onclose=()=>{this.manualClose||this.retryConnection()},this.socket.onmessage=async e=>{var t,a;try{const i=JSON.parse(e.data);switch(i.type){case"join_ack":break;case"join_error":p.alert(((t=i.data)==null?void 0:t.error)||"Failed to join host"),this.returnToHostList();break;case"auth_challenge":await this.authenticateWithPublicKey((a=i.data)==null?void 0:a.challenge);break;case"auth_pubkey_success":this.closeDashModal(),this.getDashboardData();break;case"dash_data_payload":this.dashboardInitialRender(i.data),this.joinAllSpaces(i);break;case"update_username_success":this.updateAccountUsername(i,this.hostUUID),m.setIdentityUsername(i.data.username);break;case"create_space_success":this.handleCreateSpace(i);break;case"delete_space_success":this.handleDeleteSpace();break;case"create_channel_success":this.handleCreateChannel(i);break;case"create_channel_update":this.handleCreateChannelUpdate(i);break;case"delete_channel_success":this.handleDeleteChannel(i);break;case"delete_channel_update":this.handleDeleteChannelUpdate(i);break;case"invite_user_success":this.handleInviteUser(i);break;case"invite_user_update":this.handleAddInvite(i);break;case"accept_invite_success":this.handleAcceptInvite(i);break;case"accept_invite_update":this.handleAcceptInviteUpdate(i);break;case"decline_invite_success":this.handleDeclineInvite(i);break;case"leave_space_success":this.handleLeaveSpace();break;case"leave_space_update":this.handleLeaveSpaceUpdate(i);break;case"chat":await this.renderChatAppMessage(i);break;case"get_messages_success":await this.handleIncomingMessages(i);break;case"error":p.alert(i.data.error);break;case"authentication-error":p.alert(i.data.error||"Authentication failed");break;case"author_error":p.alert("Failed to connect to host. Host is offline."),this.returnToHostList();break;default:break}}catch(i){console.error("JSON parsing error:",i)}}});c(this,"authenticateWithPublicKey",async e=>{if(!e){p.alert("Missing auth challenge from server");return}try{const t=await m.getOrCreateIdentity(),a=m.getDeviceMetadata(),i=`parch-chat-auth:${this.hostUUID}:${e}:${t.encPublicKey}`,r=await m.signAuthMessage(t,i),d={type:"auth_pubkey",data:{public_key:t.publicKey,enc_public_key:t.encPublicKey,device_id:a.deviceId,device_name:a.deviceName,username:t.username||"",challenge:e,signature:r}};this.socket.send(JSON.stringify(d))}catch(t){console.error(t),p.alert("Failed to initialize public-key identity")}});c(this,"joinHost",()=>{var e;((e=this.socket)==null?void 0:e.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"join_host",data:{uuid:this.hostUUID}}))});c(this,"getDashboardData",()=>{var e;((e=this.socket)==null?void 0:e.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"get_dash_data",data:""}))});c(this,"joinAllSpaces",e=>{var t;if(((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const a=e.data.spaces.map(i=>i.uuid);this.socket.send(JSON.stringify({type:"join_all_spaces",data:{space_uuids:a}}))}});c(this,"updateUsername",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"update_username",data:e}))});c(this,"createSpace",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"create_space",data:e}))});c(this,"deleteSpace",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"delete_space",data:e}))});c(this,"createChannel",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"create_channel",data:e}))});c(this,"deleteChannel",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"delete_channel",data:e}))});c(this,"inviteUser",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"invite_user",data:e}))});c(this,"acceptInvite",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"accept_invite",data:e}))});c(this,"declineInvite",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"decline_invite",data:e}))});c(this,"leaveSpace",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"leave_space",data:e}))});c(this,"removeSpaceUser",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"remove_space_user",data:e}))});c(this,"joinChannel",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"join_channel",data:{uuid:e}}))});c(this,"sendMessage",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"chat",data:e}))});c(this,"getMessages",e=>{var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.send(JSON.stringify({type:"get_messages",data:{before_unix_time:e}}))});c(this,"hardClose",()=>{this.manualClose=!0,this.close()});c(this,"close",()=>{this.socket&&this.socket.close()});this.returnToHostList=e.returnToHostList,this.updateAccountUsername=e.updateAccountUsername,this.dashboardInitialRender=e.dashboardInitialRender,this.openDashModal=e.openDashModal,this.closeDashModal=e.closeDashModal,this.renderChatAppMessage=e.renderChatAppMessage,this.handleCreateSpace=e.handleCreateSpace,this.handleCreateChannel=e.handleCreateChannel,this.handleDeleteSpace=e.handleDeleteSpace,this.handleDeleteChannel=e.handleDeleteChannel,this.handleCreateChannelUpdate=e.handleCreateChannelUpdate,this.handleDeleteChannelUpdate=e.handleDeleteChannelUpdate,this.handleInviteUser=e.handleInviteUser,this.handleAddInvite=e.handleAddInvite,this.handleAcceptInvite=e.handleAcceptInvite,this.handleAcceptInviteUpdate=e.handleAcceptInviteUpdate,this.handleDeclineInvite=e.handleDeclineInvite,this.handleLeaveSpace=e.handleLeaveSpace,this.handleLeaveSpaceUpdate=e.handleLeaveSpaceUpdate,this.handleIncomingMessages=e.handleIncomingMessages,this.socket=null,this.manualClose=!1,this.retryCount=0,this.maxRetries=2,this.hostUUID=localStorage.getItem("hostUUID"),this.hostUUID?this.connect():(p.alert("Missing host key"),this.returnToHostList())}}class Pe{constructor(e){c(this,"initialize",()=>{this.domComponent.append(s("div",{class:"initial-spinner"},[s("div",{},"Connecting To Host..."),s("br"),s("div",{class:"lds-dual-ring"})])),this.socketConn=new Ae({returnToHostList:this.returnToHostList,updateAccountUsername:this.updateAccountUsername,dashboardInitialRender:this.initialRender,openDashModal:this.openDashModal,closeDashModal:this.closeDashModal,renderChatAppMessage:this.renderChatAppMessage,handleCreateSpace:this.handleCreateSpace,handleDeleteSpace:this.handleDeleteSpace,handleCreateChannel:this.handleCreateChannel,handleCreateChannelUpdate:this.handleCreateChannelUpdate,handleDeleteChannel:this.handleDeleteChannel,handleDeleteChannelUpdate:this.handleDeleteChannelUpdate,handleInviteUser:this.handleInviteUser,handleAddInvite:this.handleAddInvite,handleAcceptInvite:this.handleAcceptInvite,handleAcceptInviteUpdate:this.handleAcceptInviteUpdate,handleDeclineInvite:this.handleDeclineInvite,handleLeaveSpace:this.handleLeaveSpace,handleLeaveSpaceUpdate:this.handleLeaveSpaceUpdate,handleIncomingMessages:this.handleIncomingMessages}),this.dashModal=new ye(this,this.socketConn),this.domComponent.append(this.dashModal.domComponent)});c(this,"initialRender",e=>{this.data=e,this.data.spaces||(this.data.spaces=[]),Array.isArray(this.data.active_devices)||(this.data.active_devices=[]),this.sidebar=new fe({data:this.data,socketConn:this.socketConn,returnToHostList:this.returnToHostList,domComponent:s("div",{class:"sidebar"}),openDashModal:this.openDashModal,closeDashModal:this.closeDashModal,getCurrentSpaceUUID:this.getCurrentSpaceUUID,openSpaceSettings:this.openSpaceSettings,loadChannel:this.loadChannel}),this.mainContent=new Me({socketConn:this.socketConn,data:this.data,domComponent:s("div",{id:"channel-content",class:"channel-content"})}),this.render()});c(this,"updateAccountUsername",(e,t)=>{this.data.user.username=e.data.username,this.sidebar.userAccountComponent.render(),this.openDashModal({type:"account",data:{user:this.data.user,active_devices:this.data.active_devices||[]}})});c(this,"getCurrentSpaceUUID",()=>this.currentSpaceUUID);c(this,"loadChannel",(e,t)=>{this.currentSpaceUUID=e,this.socketConn.joinChannel(t),this.sidebar.spaceUserListComponent.render(),this.mainContent.renderChannel(t)});c(this,"openDashModal",e=>this.dashModal.open(e));c(this,"closeDashModal",()=>{this.dashModal.close()});c(this,"openSpaceSettings",e=>{this.currentSpaceUUID=e.uuid,this.openDashModal({type:"space-settings",data:{space:e,user:this.data.user}})});c(this,"closeSpaceSettings",()=>{this.closeDashModal(),this.currentSpaceUUID=null});c(this,"handleCreateSpace",async e=>{this.data.spaces.push(e.data.space),this.sidebar.render()});c(this,"handleDeleteSpace",async()=>{if(!this.currentSpaceUUID)return;this.data.spaces=this.data.spaces.filter(t=>t.uuid!==this.currentSpaceUUID);const e=this.sidebar.spaceComponents.filter(t=>t.space.uuid!==this.currentSpaceUUID);this.sidebar.spaceComponents=e,this.currentSpaceUUID=null,this.mainContent.render(),this.sidebar.render(),this.sidebar.spaceUserListComponent.render(),this.closeSpaceSettings()});c(this,"handleInviteUser",e=>{window.alert("Invite sent")});c(this,"handleAddInvite",e=>{this.data.invites||(this.data.invites=[]),this.data.invites.push(e.data.invite)});c(this,"handleAcceptInvite",e=>{this.data.invites=this.data.invites.filter(t=>t.id!==e.data.space_user_id),this.data.spaces.push(e.data.space),this.sidebar.render(),this.openDashModal({type:"invites",data:{invites:this.data.invites,user:this.data.user}})});c(this,"handleAcceptInviteUpdate",e=>{console.log("invite update",e);const t=this.data.spaces.find(a=>a.uuid===e.data.space_uuid);t.users.find(a=>a.id===e.data.user.id||a.public_key&&e.data.user.public_key&&a.public_key===e.data.user.public_key)||t.users.push(e.data.user),t&&this.currentSpaceUUID===t.uuid&&this.data.user.id!==e.data.user.id&&this.sidebar.spaceUserListComponent.render()});c(this,"handleDeclineInvite",e=>{this.data.invites=this.data.invites.filter(t=>t.id!==e.data.space_user_id),this.openDashModal({type:"invites",data:{invites:this.data.invites,user:this.data.user}})});c(this,"handleLeaveSpace",()=>{this.data.spaces=this.data.spaces.filter(e=>e.uuid!==this.currentSpaceUUID),this.currentSpaceUUID=null,this.sidebar.render(),this.mainContent.render()});c(this,"handleLeaveSpaceUpdate",e=>{const t=this.data.spaces.find(a=>a.uuid===e.data.space_uuid);if(t&&this.currentSpaceUUID===t.uuid){const a=t.users.findIndex(i=>i.id===e.data.user_id||i.public_key&&e.data.user_public_key&&i.public_key===e.data.user_public_key);a>=0&&(t.users.splice(a,1),this.sidebar.spaceUserListComponent.render())}});c(this,"handleCreateChannel",e=>{const{space_uuid:t,channel:a}=e.data,i=this.data.spaces.find(d=>d.uuid===t);if(!i)return;i.channels.push(a);const r=this.sidebar.spaceComponents.find(d=>d.space.uuid===t);r&&r.render(),this.openDashModal({type:"space-settings",data:{space:i,user:this.data.user}})});c(this,"handleCreateChannelUpdate",e=>{const{space_uuid:t,channel:a}=e.data,i=this.data.spaces.find(o=>o.uuid===t);if(!i||i.channels.some(o=>o.uuid===a.uuid))return;i.channels.push(a);const d=this.sidebar.spaceComponents.find(o=>o.space.uuid===t);d&&d.render()});c(this,"handleDeleteChannel",e=>{const{uuid:t,space_uuid:a}=e.data,i=this.data.spaces.find(o=>o.uuid===a);if(!i)return;const r=i.channels.findIndex(o=>o.uuid===t);if(r===-1)return;i.channels.splice(r,1);const d=this.sidebar.spaceComponents.find(o=>o.space.uuid===a);d&&d.render(),this.openDashModal({type:"space-settings",data:{space:i,user:this.data.user}}),this.mainContent.currentChannelUUID===t&&(this.mainContent.currentChannelUUID=null,this.mainContent.chatApp=null,this.mainContent.render())});c(this,"handleDeleteChannelUpdate",e=>{const{uuid:t,space_uuid:a}=e.data,i=this.data.spaces.find(o=>o.uuid===a);if(!i)return;const r=i.channels.findIndex(o=>o.uuid===t);if(r===-1)return;i.channels.splice(r,1);const d=this.sidebar.spaceComponents.find(o=>o.space.uuid===a);d&&d.render(),this.mainContent.currentChannelUUID===t&&(this.mainContent.currentChannelUUID=null,this.mainContent.chatApp=null,this.mainContent.render())});c(this,"findSpaceByChannelUUID",e=>{var t;return!((t=this.data)!=null&&t.spaces)||!e?null:this.data.spaces.find(a=>(a.channels||[]).some(i=>i.uuid===e))||null});c(this,"resolveUsernameForAuthPublicKey",(e,t)=>{var i;if(!e||!((i=this.data)!=null&&i.spaces))return"unknown";const a=t?this.data.spaces.filter(r=>r.uuid===t):this.data.spaces;for(const r of a){const d=(r.users||[]).find(o=>o.public_key===e);if(d!=null&&d.username)return d.username}return"unknown"});c(this,"decryptWireMessage",async(e,t)=>{const a=await m.getOrCreateIdentity(),i=e==null?void 0:e.envelope;if(!i)throw new Error("Missing encrypted envelope");const r=await j.decryptMessageForIdentity({envelope:i,identity:a}),d=i.sender_auth_public_key||"";return{...e,content:r,sender_auth_public_key:d,username:this.resolveUsernameForAuthPublicKey(d,t)}});c(this,"renderChatAppMessage",async e=>{if(this.mainContent.chatApp)try{const t=await this.decryptWireMessage(e.data,this.currentSpaceUUID),a=this.mainContent.chatApp.chatBoxComponent.chatBoxMessagesComponent;a.appendNewMessage(t),(t.sender_auth_public_key===this.data.user.public_key||a.isScrolledToBottom())&&a.scrollDown()}catch(t){console.error(t)}});c(this,"handleIncomingMessages",async e=>{if(e.data.messages&&this.mainContent.chatApp&&this.mainContent.chatApp.chatBoxComponent.channelUUID===e.data.channel_uuid){const t=this.mainContent.chatApp.chatBoxComponent.chatBoxMessagesComponent,a=t.domComponent,i=a.scrollHeight,r=a.scrollTop;t.hasMoreMessages=e.data.has_more_messages,t.isLoading=!1;const d=this.findSpaceByChannelUUID(e.data.channel_uuid),o=await Promise.all(e.data.messages.map(async l=>{try{return await this.decryptWireMessage(l,(d==null?void 0:d.uuid)||null)}catch(u){return console.error(u),{...l,content:"[Unable to decrypt message]",username:"unknown",sender_auth_public_key:""}}}));t.chatBoxMessages=[...o,...t.chatBoxMessages],t.render();const h=a.scrollHeight;a.scrollTop=h-i+r}});this.domComponent=s("div",{class:"dashboard-container"}),this.returnToHostList=e.returnToHostList,this.data=null,this.sidebar=null,this.dashModal=null,this.mainContent=null,this.currentSpaceUUID=null,this.socketConn=null}render(){this.domComponent.innerHTML="",this.domComponent.append(this.sidebar.domComponent,this.mainContent.domComponent,this.dashModal.domComponent)}}class Ee{constructor(){c(this,"returnToHostList",async()=>{var e,t;localStorage.removeItem("hostUUID"),(e=this.dashboard)!=null&&e.socketConn&&this.dashboard.socketConn.hardClose(),(t=this.dashboard)!=null&&t.domComponent&&(this.dashboard.domComponent.innerHTML=""),this.dashboard=null,this.render({type:"host_form"})});c(this,"render",e=>{switch(this.domComponent.innerHTML="",e.type){case"dash":this.dashboard=new Pe({returnToHostList:this.returnToHostList}),this.domComponent.append(this.dashboard.domComponent),this.dashboard.initialize();break;case"host_form":this.domComponent.append(this.hostForm.domComponent),this.hostForm.render({type:"known"});break;default:this.domComponent.append(this.hostForm.domComponent),this.hostForm.render({type:"known"})}});p.greet("Hello Parch").then(e=>console.log(e)),this.domComponent=document.getElementById("app"),this.hostForm=new Te(this),this.render({type:"host_form"})}}class Te{constructor(e){c(this,"renderHostList",e=>!e||!e.hosts||!e.hosts.length?[s("div",{},"...No Hosts")]:e.hosts.map(a=>{const i=a.online==1;return s("div",{class:"host-item"},[s("div",{style:"display: flex; align-items: baseline"},[s("span",{class:i?"host-online-span":"host-offline-span"}),s("div",{class:"host-item-name"},`${a.name} `)]),s("button",{class:"btn-small btn-red"},"Remove",{type:"click",event:r=>{r.stopPropagation(),p.confirm("Are you sure you want to remove this host?").then(d=>{d&&(p.removeHost(a.uuid),r.target.parentElement.remove())})}})],{type:"click",event:()=>{i?(localStorage.setItem("hostUUID",a.uuid),this.app.render({type:"dash"})):p.alert("Host is not online")}})}));c(this,"renderKnownHosts",async()=>{const t=(await p.getHosts()).map(i=>i.uuid);let a=[];try{a=await(await fetch(`${L}/api/hosts_by_uuids`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uuids:t})})).json()}catch(i){console.log(i),p.alert("Failed to connect to relay server")}this.domComponent.append(s("h2",{},"Select From Known Hosts"),s("br"),s("button",{},"Refresh",{type:"click",event:()=>{this.render({type:"known"})}}),s("br"),s("div",{class:"host-list-index"},[...this.renderHostList(a)]),s("br"),s("div",{},"Or"),s("br"),s("button",{class:""},"Add New Host",{type:"click",event:()=>{this.render({type:"new"})}}))});c(this,"renderNewHostForm",()=>{this.domComponent.append(s("h2",{},"Enter Host Key"),s("form",{id:"hostForm",onsubmit:this.handleSubmit},[s("fieldset",{},[s("legend",{},"New Host"),s("div",{class:"input-container"},[s("label",{for:"hostKey"},"Host Key"),s("input",{type:"text",id:"hostKey",name:"hostKey",required:!0})]),s("br"),s("button",{type:"submit"},"Continue")])],{type:"submit",event:e=>{e.preventDefault();const t=this.domComponent.querySelector("#hostKey").value;if(!t)return!1;p.verifyHostKey(t).then(a=>{this.render({type:"known"})}).catch(a=>{p.alert("Invalid host key"),console.error(a)})}}),s("br"),s("button",{},"Return To List",{type:"click",event:()=>{this.render({type:"known"})}}))});c(this,"render",e=>{switch(this.domComponent.innerHTML="",e.type){case"known":this.renderKnownHosts();break;case"new":this.renderNewHostForm();break;default:this.renderKnownHosts()}});this.app=e,this.domComponent=s("div",{class:"host-form-container"})}}new Ee;
