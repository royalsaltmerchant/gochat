var de=Object.defineProperty;var he=(o,e,t)=>e in o?de(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var l=(o,e,t)=>he(o,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();const E="https://parchchat.com",pe="wss://parchchat.com/ws",ue="wss://sfu.parchchat.com/ws";function i(o,e,t,s){if(typeof o>"u")return!1;var n=document.createElement(o);if(typeof e=="object")for(var r in e)n.setAttribute(r,e[r]);if(t)if(typeof t=="string"&&/<[^>]+>/.test(t))n.innerHTML=t;else{Array.isArray(t)||(t=[t]);for(var a=0;a<t.length;a++)t[a]instanceof Node?n.appendChild(t[a]):n.appendChild(document.createTextNode(t[a]))}if(s){Array.isArray(s)||(s=[s]);for(var c of s)n.addEventListener(c.type,c.event)}return n}const me={greet(o){return window.go.main.App.Greet(o)},alert(o){return window.go.main.App.Alert(o)},confirm(o){return window.go.main.App.Confirm(o)},openExternal(o){return window.go.main.App.OpenInBrowser(o)},saveAuthToken(o){return window.go.main.App.SaveAuthToken(o)},loadAuthToken(){return window.go.main.App.LoadAuthToken()},removeAuthToken(){return window.go.main.App.RemoveAuthToken()},getHosts(){return window.go.main.App.GetHosts()},verifyHostKey(o){return window.go.main.App.VerifyHostKey(o)},removeHost(o){return window.go.main.App.RemoveHost(o)}},V="parch.auth.token",ne="parch.hosts";function j(){try{const o=localStorage.getItem(ne);if(!o)return[];const e=JSON.parse(o);return Array.isArray(e)?e:[]}catch{return[]}}function z(o){localStorage.setItem(ne,JSON.stringify(o))}const fe={async greet(o){return`Hello ${o}, It's show time!`},async alert(o){window.alert(o)},async confirm(o){return window.confirm(o)},async openExternal(o){window.open(o,"_blank","noopener,noreferrer")},async saveAuthToken(o){localStorage.setItem(V,o)},async loadAuthToken(){return localStorage.getItem(V)||""},async removeAuthToken(){localStorage.removeItem(V)},async getHosts(){return j()},async verifyHostKey(o){const e=await fetch(`${E}/api/host/${o}`);if(!e.ok)throw new Error("host not found");const t=await e.json(),s=j();return s.some(n=>n.uuid===o)||(s.push({uuid:t.uuid,name:t.name}),z(s)),t},async removeHost(o){const e=j(),t=e.filter(s=>s.uuid!==o);if(t.length===e.length)throw new Error(`host with UUID ${o} not found`);z(t)}};function ge(){var o,e;return!!((e=(o=window==null?void 0:window.go)==null?void 0:o.main)!=null&&e.App)}const m=ge()?me:fe;class ve{constructor(e,t){l(this,"open",e=>(this.domComponent.style.display="block",this.render(e)));l(this,"close",()=>{this.domComponent.style.display="none"});l(this,"renderPrompt",e=>new Promise(t=>{this.promptResolver=t,this.domComponent.append(i("div",{class:"modal-content"},[i("div",{class:"modal-header"},[i("h2",{},e||"Enter a value")]),i("div",{class:"modal-body"},[i("input",{id:"prompt-input",type:"text",style:"width: 100%; margin-bottom: 10px;"}),i("div",{style:"text-align: right;"},[i("button",{class:"btn"},"OK",{type:"click",event:()=>{const s=this.domComponent.querySelector("#prompt-input").value;this.close(),this.promptResolver(s)}}),i("button",{class:"btn btn-red",style:"margin-left: 10px;"},"Cancel",{type:"click",event:()=>{this.close(),this.promptResolver(null)}})])])]))}));l(this,"renderCheckbox",(e,t)=>e.allow_voice?i("input",{type:"checkbox",checked:!0},null,{type:"change",event:s=>{const n=s.target.checked?1:0;this.socketConn.channelAllowVoice(e.uuid,t.uuid,n),e.allow_voice=n}}):i("input",{type:"checkbox"},null,{type:"change",event:s=>{const n=s.target.checked?1:0;this.socketConn.channelAllowVoice(e.uuid,t.uuid,n),e.allow_voice=n}}));l(this,"renderChannelSettings",(e,t)=>{this.domComponent.append(i("div",{class:"modal-content"},[i("div",{class:"modal-header"},[i("h2",{},`Channel Settings: ${e.name}`),i("button",{class:"close-modal"},"Ã—",{type:"click",event:this.close})]),i("div",{class:"settings-actions"},[i("div",{},"Allow Voice"),this.renderCheckbox(e,t)])]))});l(this,"renderAuthorSettings",e=>[i("div",{class:"settings-section"},[i("h3",{},"Space Management"),i("div",{class:"settings-actions"},[i("button",{class:"btn"},"Invite User",{type:"click",event:()=>{this.render({type:"prompt",data:{message:"Enter email address of user"}}).then(t=>{t&&(t.trim(),this.socketConn.inviteUser({email:t,space_uuid:e.uuid}))})}}),i("button",{class:"btn btn-red"},"Delete Space",{type:"click",event:()=>{m.confirm("Are you sure you want to delete this space?").then(t=>{t&&this.socketConn.deleteSpace({uuid:e.uuid})})}})])]),i("div",{class:"settings-section"},[i("h3",{},"Channel Management"),i("div",{class:"settings-actions"},[i("button",{class:"btn"},"+ Create Channel",{type:"click",event:()=>{this.render({type:"prompt",data:{message:"Please enter Channel 'Name'"}}).then(t=>{t&&(t.trim(),this.socketConn.createChannel({name:t,space_uuid:e.uuid}))})}})]),i("div",{class:"channels-list"},e.channels.map(t=>i("div",{class:"channel-item"},[i("span",{},t.name),i("div",{style:"display: flex;"},[i("button",{class:"btn-small btn-gray",style:"margin-right: 5px;"},"Settings",{type:"click",event:()=>{this.open({type:"channel-settings",data:{channel:t,space:e}})}}),i("button",{class:"btn-small btn-red"},"Delete",{type:"click",event:()=>{m.confirm("Are you sure you want to delete this channel?").then(s=>{s&&this.socketConn.deleteChannel({uuid:t.uuid})})}})])])))])]);l(this,"renderSpaceUserSettings",(e,t)=>[i("div",{class:"settings-section"},[i("h3",{},"Space Management"),i("div",{class:"settings-actions"},[i("button",{class:"btn btn-red"},"Leave Space",{type:"click",event:()=>{m.confirm("Are you sure you want to leave this space?").then(s=>{s&&this.socketConn.leaveSpace({space_uuid:e.uuid,user_id:t.id})})}})])])]);l(this,"renderLoginForm",()=>{this.domComponent.append(i("div",{class:"modal-content"},[i("div",{class:"modal-header"},[i("h2",{},"Login")]),i("div",{class:"modal-body"},[i("div",{id:"toast-message",class:"toast-warning"}),i("form",{id:"login-form"},[i("fieldset",{},[i("legend",{},"Login"),i("div",{class:"input-container"},[i("label",{for:"email"},"Email"),i("input",{name:"email",type:"email",required:!0,autofocus:!0})]),i("br"),i("div",{class:"input-container"},[i("label",{for:"password"},"Password"),i("input",{name:"password",type:"password",required:!0})]),i("br"),i("button",{type:"submit"},"Submit")])],{type:"submit",event:e=>{e.preventDefault();const t=e.target,s=new FormData(t),n=Object.fromEntries(s.entries());this.socketConn.loginUser(n)}}),i("br"),i("a",{},"Register",{type:"click",event:e=>{e.preventDefault(),this.render({type:"register",data:{}})}}),i("a",{},"Forgot Password?",{type:"click",event:()=>{m.openExternal(`${E}/forgot_password`)}})])]))});l(this,"renderRegisterForm",()=>{this.domComponent.append(i("div",{class:"modal-content"},[i("div",{class:"modal-header"},[i("h2",{},"Register")]),i("div",{class:"modal-body"},[i("div",{id:"toast-message",class:"toast-warning"}),i("form",{id:"register-form"},[i("fieldset",{},[i("legend",{},"Register"),i("div",{class:"input-container"},[i("label",{for:"username"},"Username"),i("input",{name:"username",type:"text",required:!0,autofocus:!0})]),i("div",{class:"input-container"},[i("label",{for:"email"},"Email"),i("input",{name:"email",type:"email",required:!0,autofocus:!0})]),i("br"),i("div",{class:"input-container"},[i("label",{for:"password"},"Password"),i("input",{name:"password",type:"password",required:!0})]),i("br"),i("button",{type:"submit"},"Submit")])],{type:"submit",event:e=>{e.preventDefault();const t=e.target,s=new FormData(t),n=Object.fromEntries(s.entries());this.socketConn.registerUser(n)}}),i("br"),i("a",{},"Login",{type:"click",event:e=>{e.preventDefault(),this.render({type:"login",data:{}})}})])]))});l(this,"renderAccount",e=>{this.domComponent.append(i("div",{class:"modal-content"},[i("div",{class:"modal-header"},[i("h2",{},"Account"),i("button",{class:"close-modal"},"Ã—",{type:"click",event:this.close})]),i("div",{class:"modal-body"},[i("div",{id:"toast-message",class:"toast-warning"}),i("h3",{},`Username: "${e.username}"`),i("form",{id:"update-username-form"},[i("fieldset",{},[i("legend",{},"Update Username"),i("div",{class:"input-container"},[i("label",{for:"username"},"Username"),i("input",{name:"username",type:"text",required:!0,autofocus:!0,value:e.username||""})]),i("br"),i("button",{type:"submit"},"Submit")])],{type:"submit",event:t=>{t.preventDefault();const s=t.target,n=new FormData(s),r=Object.fromEntries(n.entries());r.user_id=e.id,this.socketConn.updateUsername(r)}}),i("br"),i("button",{class:"btn-red"},"Logout",{type:"click",event:t=>{m.removeAuthToken().then(()=>{console.log("Token removed for",this.socketConn.hostUUID)}),this.open({type:"login",data:{}})}})])]))});l(this,"renderInvites",(e,t)=>{this.domComponent.append(i("div",{class:"modal-content"},[i("div",{class:"modal-header"},[i("h2",{},"Space Invites"),i("button",{class:"close-modal"},"Ã—",{type:"click",event:this.close})]),i("div",{class:"modal-body"},e&&e.length&&t?i("div",{class:"invites-section"},[...e.map(s=>i("div",{class:"pending-invites-item"},[i("span",{},s.name),i("div",{},[i("button",{class:"btn-small accept-invite"},"Accept",{type:"click",event:()=>this.socketConn.acceptInvite({space_user_id:s.id,user_id:t.id})}),i("button",{class:"btn-small btn-red decline-invite"},"Decline",{type:"click",event:()=>this.socketConn.declineInvite({space_user_id:s.id,user_id:t.id})})])]))]):"...No Invite Yet")]))});l(this,"render",e=>{var t;switch(this.domComponent.innerHTML="",e.type){case"prompt":if((t=e.data)!=null&&t.message)return this.renderPrompt(e.data.message);break;case"login":this.renderLoginForm();break;case"register":this.renderRegisterForm();break;case"account":e.data.user&&this.renderAccount(e.data.user);break;case"invites":this.renderInvites(e.data.invites,e.data.user);break;case"channel-settings":this.renderChannelSettings(e.data.channel,e.data.space);break;case"space-settings":if(e.data.space&&e.data.user){const s=e.data.space,n=e.data.user,r=s.author_id===n.id;this.domComponent.append(i("div",{class:"modal-content"},[i("div",{class:"modal-header"},[i("h2",{},`Space Settings: ${s.name}`),i("button",{class:"close-modal"},"Ã—",{type:"click",event:this.close})]),i("div",{class:"modal-body"},r?this.renderAuthorSettings(s):this.renderSpaceUserSettings(s,n))]))}break;default:console.log("")}});this.app=e,this.socketConn=t,this.domComponent=i("div",{class:"modal"}),this.promptResolver=null}}class Ce{constructor(e){l(this,"initSpaceComponents",()=>{this.data.spaces&&(this.spaceComponents=this.data.spaces.map(e=>new G({domComponent:i("div",{class:"space-item"}),space:e,user:this.data.user,openSpaceSettings:this.openSpaceSettings,loadChannel:this.loadChannel})))});l(this,"addSpace",e=>{const t=new G({domComponent:i("div",{class:"space-item"}),space:e,user:this.data.user,openSpaceSettings:this.openSpaceSettings,loadChannel:this.loadChannel});this.spaceComponents.push(t),this.render()});l(this,"render",()=>{this.domComponent.innerHTML="",this.initSpaceComponents(),this.userAccountComponent=new ye({data:this.data,returnToHostList:this.returnToHostList,openDashModal:this.openDashModal,domComponent:i("div",{class:"user-component"})}),this.spaceUserListComponent=new Se({data:this.data,socketConn:this.socketConn,getCurrentSpaceUUID:this.getCurrentSpaceUUID,domComponent:i("div",{class:"space-users-list",id:"space-users-list"})}),this.domComponent.append(i("div",{class:"sidebar-spaces-container"},[i("div",{id:"spaces-list"},this.spaceComponents.map(e=>e.domComponent)),i("button",{class:"create-space-btn",id:"new-space-btn"},"+ Create New Space",{type:"click",event:()=>{this.openDashModal({type:"prompt",data:{message:"Please enter Space 'Name'"}}).then(e=>{e&&(e.trim(),this.socketConn.createSpace({name:e}))})}})]),i("br"),this.spaceUserListComponent.domComponent,i("hr"),this.userAccountComponent.domComponent)});this.data=e.data,this.socketConn=e.socketConn,this.returnToHostList=e.returnToHostList,this.openDashModal=e.openDashModal,this.closeDashModal=e.closeDashModal,this.getCurrentSpaceUUID=e.getCurrentSpaceUUID,this.spaceComponents=[],this.domComponent=e.domComponent,this.openSpaceSettings=e.openSpaceSettings,this.loadChannel=e.loadChannel,this.render()}}class ye{constructor(e){l(this,"render",()=>{this.domComponent.innerHTML="",this.domComponent.append(i("a",{href:"#"},"Account",{type:"click",event:e=>{this.openDashModal({type:"account",data:{user:this.data.user}})}}),i("a",{href:"#"},"Invites",{type:"click",event:e=>{this.openDashModal({type:"invites",data:{invites:this.data.invites,user:this.data.user}})}}),i("a",{href:"#"},"<- Host List",{type:"click",event:e=>{this.returnToHostList()}}))});this.data=e.data,this.returnToHostList=e.returnToHostList,this.openDashModal=e.openDashModal,this.domComponent=e.domComponent,this.render()}}class Se{constructor(e){l(this,"isAuthor",(e,t)=>String(e.author_id)===String(t.id));l(this,"renderUserElement",(e,t)=>i("div",{class:"space-user-item",id:"space-user-item"},`${t.username} ${this.isAuthor(e,t)?"*":""}`,{type:"click",event:async()=>{this.isAuthor(e,this.data.user)&&this.data.user.id!=t.id&&m.confirm("Are you sure you want to remove this user?").then(s=>{s&&this.socketConn.removeSpaceUser({space_uuid:e.uuid,user_id:t.id})})}}));l(this,"renderSpaceUsersList",e=>{const t=[];return e.users&&e.users.map(s=>{t.push(this.renderUserElement(e,s))}),t});l(this,"render",()=>{this.domComponent.innerHTML="";const e=this.getCurrentSpaceUUID();if(e){const t=this.data.spaces.find(s=>s.uuid===e);if(!t)return;this.domComponent.append(i("h3",{},"Users"),...this.renderSpaceUsersList(t))}});this.data=e.data,this.socketConn=e.socketConn,this.getCurrentSpaceUUID=e.getCurrentSpaceUUID,this.domComponent=e.domComponent,this.render()}}class G{constructor(e){l(this,"isAuthor",()=>String(this.space.author_id)===String(this.user.id));l(this,"renderChannelList",()=>i("div",{class:"channel-list"},(this.space.channels||[]).map(e=>i("div",{class:"channel-item"},e.name,{type:"click",event:()=>this.loadChannel(this.space.uuid,e.uuid)}))));l(this,"toggleChannels",()=>{this.channelsOpen=!this.channelsOpen,this.render()});l(this,"render",()=>{this.domComponent.innerHTML="",this.domComponent.append(i("div",{class:"space-header"},[i("span",{},this.space.name),i("div",{class:"space-actions"},i("button",{class:"btn-icon open-settings"},"âš™ï¸",{type:"click",event:e=>{e.stopPropagation(),this.openSpaceSettings(this.space)}}))],{type:"click",event:this.toggleChannels}),...this.channelsOpen?[this.renderChannelList()]:[])});this.space=e.space,this.user=e.user,this.openSpaceSettings=e.openSpaceSettings,this.loadChannel=e.loadChannel,this.channelsOpen=!1,this.domComponent=e.domComponent,this.render()}}function ke(o){const e=new Date(o),t=e.getFullYear(),s=(e.getMonth()+1).toString().padStart(2,"0"),n=e.getDate().toString().padStart(2,"0"),r=e.getHours(),a=e.getMinutes(),c=r%12||12,d=r<12?"am":"pm",h=a.toString().padStart(2,"0");return`${s}-${n}-${t} ${c}:${h}${d}`}const be="data:image/svg+xml;base64,"+btoa(`
    <svg xmlns="http://www.w3.org/2000/svg" width="150" height="100" viewBox="0 0 150 100">
      <rect width="150" height="100" fill="#aaaaa" />
      <text x="75" y="55" font-size="14" text-anchor="middle" fill="#a00" font-family="sans-serif">Image not found</text>
    </svg>
  `);function we(o){const e=document.createElement("img");return e.src=o,e.alt="Image",e.style="max-width: 100%; max-height: 250px; margin: 5px; cursor: pointer;",e.onerror=()=>{e.src=be},e}function Ue(o){const e=o.split(".");if(e.length<2)return!1;const t=e[e.length-1].toLowerCase().split("?")[0];return["jpg","jpeg","png","gif","webp","svg","tiff"].includes(t)}function De(o){if(Object.prototype.hasOwnProperty.call(o,"__esModule"))return o;var e=o.default;if(typeof e=="function"){var t=function s(){return this instanceof s?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(o).forEach(function(s){var n=Object.getOwnPropertyDescriptor(o,s);Object.defineProperty(t,s,n.get?n:{enumerable:!0,get:function(){return o[s]}})}),t}var B={},I={},J={},X;function oe(){return X||(X=1,function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.makeRemote=o.LocalStream=o.VideoConstraints=void 0;const e=["qvga","vga","shd","hd","fhd","qhd"];o.VideoConstraints={qvga:{resolution:{width:{ideal:320},height:{ideal:180},frameRate:{ideal:15,max:30}},encodings:{maxBitrate:15e4,maxFramerate:15}},vga:{resolution:{width:{ideal:640},height:{ideal:360},frameRate:{ideal:30,max:60}},encodings:{maxBitrate:5e5,maxFramerate:30}},shd:{resolution:{width:{ideal:960},height:{ideal:540},frameRate:{ideal:30,max:60}},encodings:{maxBitrate:12e5,maxFramerate:30}},hd:{resolution:{width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30,max:60}},encodings:{maxBitrate:25e5,maxFramerate:30}},fhd:{resolution:{width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:30,max:60}},encodings:{maxBitrate:4e6,maxFramerate:30}},qhd:{resolution:{width:{ideal:2560},height:{ideal:1440},frameRate:{ideal:30,max:60}},encodings:{maxBitrate:8e6,maxFramerate:30}}};const t={resolution:"hd",codec:"vp8",audio:!0,video:!0,simulcast:!1};class s extends MediaStream{constructor(a,c){super(a),this.constraints=c}static async getUserMedia(a=t){const c=await navigator.mediaDevices.getUserMedia({audio:s.computeAudioConstraints({...t,...a}),video:s.computeVideoConstraints({...t,...a})});return new s(c,{...t,...a})}static async getDisplayMedia(a={codec:"vp8",resolution:"hd",audio:!1,video:!0,simulcast:!1}){const c=await navigator.mediaDevices.getDisplayMedia(a);return new s(c,{...t,...a})}static computeAudioConstraints(a){return a.audio}static computeVideoConstraints(a){return a.video instanceof Object?a.video:a.video&&a.resolution?{...o.VideoConstraints[a.resolution].resolution}:a.video}getTrack(a){let c;return a==="video"?(c=this.getVideoTracks(),c.length>0?this.getVideoTracks()[0]:void 0):(c=this.getAudioTracks(),c.length>0?this.getAudioTracks()[0]:void 0)}async getNewTrack(a){return(await navigator.mediaDevices.getUserMedia({[a]:a==="video"?s.computeVideoConstraints(this.constraints):s.computeAudioConstraints(this.constraints)})).getTracks()[0]}publishTrack(a){if(this.pc){const c={streams:[this],direction:"sendonly"};if(a.kind==="video")if(this.encodingParams)c.sendEncodings=this.encodingParams;else if(this.constraints.simulcast){const h=e.indexOf(this.constraints.resolution),p=[{rid:"f",maxBitrate:o.VideoConstraints[e[h]].encodings.maxBitrate,maxFramerate:o.VideoConstraints[e[h]].encodings.maxFramerate}];h-1>=0&&p.push({rid:"h",scaleResolutionDownBy:2,maxBitrate:o.VideoConstraints[e[h-1]].encodings.maxBitrate,maxFramerate:o.VideoConstraints[e[h-1]].encodings.maxFramerate}),h-2>=0&&p.push({rid:"q",scaleResolutionDownBy:4,maxBitrate:o.VideoConstraints[e[h-2]].encodings.maxBitrate,maxFramerate:o.VideoConstraints[e[h-2]].encodings.maxFramerate}),c.sendEncodings=p}else c.sendEncodings=[o.VideoConstraints[this.constraints.resolution].encodings];const d=this.pc.addTransceiver(a,c);this.setPreferredCodec(d,a.kind)}}setPreferredCodec(a,c){if("setCodecPreferences"in a){const d=RTCRtpSender.getCapabilities(c);if(!d)return;let h;if(this.constraints.preferredCodecProfile&&c==="video"){const p=d.codecs.filter(f=>f.mimeType.toLowerCase()===`video/${this.constraints.codec.toLowerCase()}`);if(!p)return;h=p.find(f=>{var u;return f.sdpFmtpLine&&((u=f.sdpFmtpLine)===null||u===void 0?void 0:u.indexOf(`profile-level-id=${this.constraints.preferredCodecProfile}`))>=0}),h||(h=p[0])}else h=d.codecs.find(p=>p.mimeType.toLowerCase()===`video/${this.constraints.codec.toLowerCase()}`||p.mimeType.toLowerCase()==="audio/opus");h&&a.setCodecPreferences([h])}}updateTrack(a,c){this.addTrack(a),c?(this.removeTrack(c),c.stop(),this.pc&&this.pc.getSenders().forEach(async d=>{var h,p;((h=d==null?void 0:d.track)===null||h===void 0?void 0:h.kind)===a.kind&&((p=d.track)===null||p===void 0||p.stop(),d.replaceTrack(a))})):this.pc&&this.publishTrack(a)}initAudioEmptyTrack(){const a=window.AudioContext||window.webkitAudioContext,c=new a,d=c.createOscillator();d.frequency.setValueAtTime(2e4,c.currentTime);const h=d.connect(c.createMediaStreamDestination());return d.start(),h.stream.getAudioTracks()[0]}initVideoEmptyTrack(a,c){var d;const h=Object.assign(document.createElement("canvas"),{width:a,height:c});return(d=h.getContext("2d"))===null||d===void 0||d.fillRect(0,0,a,c),h.captureStream().getVideoTracks()[0]}publish(a,c){this.pc=a.pc,this.api=a.api,this.encodingParams=c,this.getTracks().forEach(this.publishTrack.bind(this))}unpublish(){if(this.pc){const a=this.getTracks();this.pc.getSenders().forEach(c=>{c.track&&a.includes(c.track)&&this.pc.removeTrack(c)})}}async switchDevice(a,c){this.constraints={...this.constraints,[a]:this.constraints[a]instanceof Object?{...this.constraints[a],deviceId:c}:{deviceId:c}};const d=this.getTrack(a);d&&d.stop();const h=await this.getNewTrack(a);this.updateTrack(h,d)}mute(a){const c=this.getTrack(a);if(c&&this.constraints.sendEmptyOnMute){const d=a==="audio"?this.initAudioEmptyTrack():this.initVideoEmptyTrack((c==null?void 0:c.getSettings().width)||640,(c==null?void 0:c.getSettings().height)||360);d.enabled=!1,this.updateTrack(d,c);return}c&&c.stop()}async unmute(a){const c=this.getTrack(a),d=await this.getNewTrack(a);this.updateTrack(d,c)}async enableLayers(a){const c={streamId:this.id,layers:a};JSON.stringify(c),this.api&&(this.api.readyState!=="open"?this.api.onopen=()=>{var h;return(h=this.api)===null||h===void 0?void 0:h.send(JSON.stringify(c))}:this.api.send(JSON.stringify(c)));const d=["high","medium","low"];await Promise.all(d.map(async h=>{await this.updateMediaEncodingParams({active:a.includes(h)},h)}))}async updateMediaEncodingParams(a,c){var d;if(!this.pc)return;const h=this.getTracks();await Promise.all((d=this.pc)===null||d===void 0?void 0:d.getSenders().filter(p=>p.track&&h.includes(p.track)).map(async p=>{const f=p.getParameters();f.encodings||(f.encodings=[{}]);let u=0;if(this.constraints.simulcast&&c){const g=c==="high"?"f":c==="medium"?"h":"q";if(u=f.encodings.findIndex(b=>b.rid===g),f.encodings.length<u+1)return}f.encodings[u]={...f.encodings[u],...a},await p.setParameters(f)}))}}o.LocalStream=s;function n(r,a){const c=r;c.audio=!0,c.video="none",c.framerate="high",c._videoPreMute="high";const d=()=>{const h={streamId:c.id,video:c.video,audio:c.audio,framerate:c.framerate};a.api&&(a.api.readyState!=="open"?a.api.onopen=()=>{var p;return(p=a.api)===null||p===void 0?void 0:p.send(JSON.stringify(h))}:a.api.send(JSON.stringify(h)))};return c.preferLayer=h=>{c.video=h,d()},c.preferFramerate=h=>{c.framerate=h,d()},c.mute=h=>{h==="audio"?c.audio=!1:h==="video"&&(c._videoPreMute=c.video,c.video="none"),d()},c.unmute=h=>{h==="audio"?c.audio=!0:h==="video"&&(c.video=c._videoPreMute),d()},c}o.makeRemote=n}(J)),J}var Q;function Ae(){if(Q)return I;Q=1,Object.defineProperty(I,"__esModule",{value:!0}),I.Transport=void 0;const o=oe(),e="ion-sfu",t="no active session, join first";var s;(function(a){a[a.pub=0]="pub",a[a.sub=1]="sub"})(s||(s={}));class n{constructor(c,d,h){this.signal=d,this.pc=new RTCPeerConnection(h),this.candidates=[],c===s.pub&&this.pc.createDataChannel(e),this.pc.onicecandidate=({candidate:p})=>{p&&this.signal.trickle({target:c,candidate:p})},this.pc.oniceconnectionstatechange=async p=>{this.pc.iceConnectionState==="disconnected"&&this.pc.restartIce!==void 0&&this.pc.restartIce()}}}I.Transport=n;class r{constructor(c,d={codec:"vp8",iceServers:[{urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302"]}]}){this.signal=c,this.config=d,c.onnegotiate=this.negotiate.bind(this),c.ontrickle=this.trickle.bind(this)}async join(c,d){this.transports={[s.pub]:new n(s.pub,this.signal,this.config),[s.sub]:new n(s.sub,this.signal,this.config)},this.transports[s.sub].pc.ontrack=u=>{const g=u.streams[0],b=o.makeRemote(g,this.transports[s.sub]);this.ontrack&&this.ontrack(u.track,b)};const h=new Promise(u=>{this.transports[s.sub].pc.ondatachannel=g=>{if(g.channel.label===e){this.transports[s.sub].api=g.channel,this.transports[s.pub].api=g.channel,g.channel.onmessage=b=>{try{const D=JSON.parse(b.data);this.processChannelMessage(D)}catch(D){console.error(D)}},u();return}this.ondatachannel&&this.ondatachannel(g)}}),p=await this.transports[s.pub].pc.createOffer();await this.transports[s.pub].pc.setLocalDescription(p);const f=await this.signal.join(c,d,p);return await this.transports[s.pub].pc.setRemoteDescription(f),this.transports[s.pub].candidates.forEach(u=>this.transports[s.pub].pc.addIceCandidate(u)),this.transports[s.pub].pc.onnegotiationneeded=this.onNegotiationNeeded.bind(this),h}leave(){this.transports&&(Object.values(this.transports).forEach(c=>c.pc.close()),delete this.transports)}getPubStats(c){if(!this.transports)throw Error(t);return this.transports[s.pub].pc.getStats(c)}getSubStats(c){if(!this.transports)throw Error(t);return this.transports[s.sub].pc.getStats(c)}publish(c,d){if(!this.transports)throw Error(t);c.publish(this.transports[s.pub],d)}restartIce(){this.renegotiate(!0)}createDataChannel(c){if(!this.transports)throw Error(t);return this.transports[s.pub].pc.createDataChannel(c)}close(){this.transports&&Object.values(this.transports).forEach(c=>c.pc.close()),this.signal.close()}trickle({candidate:c,target:d}){if(!this.transports)throw Error(t);this.transports[d].pc.remoteDescription?this.transports[d].pc.addIceCandidate(c):this.transports[d].candidates.push(c)}async negotiate(c){if(!this.transports)throw Error(t);let d;try{await this.transports[s.sub].pc.setRemoteDescription(c),this.transports[s.sub].candidates.forEach(h=>this.transports[s.sub].pc.addIceCandidate(h)),this.transports[s.sub].candidates=[],d=await this.transports[s.sub].pc.createAnswer(),await this.transports[s.sub].pc.setLocalDescription(d),this.signal.answer(d)}catch(h){console.error(h),this.onerrnegotiate&&this.onerrnegotiate(s.sub,h,c,d)}}onNegotiationNeeded(){this.renegotiate(!1)}async renegotiate(c){if(!this.transports)throw Error(t);let d,h;try{d=await this.transports[s.pub].pc.createOffer({iceRestart:c}),await this.transports[s.pub].pc.setLocalDescription(d),h=await this.signal.offer(d),await this.transports[s.pub].pc.setRemoteDescription(h)}catch(p){console.error(p),this.onerrnegotiate&&this.onerrnegotiate(s.pub,p,d,h)}}processChannelMessage(c){if(c.method!==void 0&&c.params!==void 0)switch(c.method){case"audioLevels":this.onspeaker&&this.onspeaker(c.params);break;case"activeLayer":this.onactivelayer&&this.onactivelayer(c.params);break}else this.onspeaker&&this.onspeaker(c)}}return I.default=r,I}var Z;function Ie(){return Z||(Z=1,function(o){Object.defineProperty(o,"__esModule",{value:!0}),o.LocalStream=o.Client=void 0;const e=Ae();o.Client=e.default;const t=oe();Object.defineProperty(o,"LocalStream",{enumerable:!0,get:function(){return t.LocalStream}})}(B)),B}var ee=Ie(),M={},L,Me=new Uint8Array(16);function ae(){if(!L&&(L=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||typeof msCrypto<"u"&&typeof msCrypto.getRandomValues=="function"&&msCrypto.getRandomValues.bind(msCrypto),!L))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return L(Me)}const _e=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function N(o){return typeof o=="string"&&_e.test(o)}var v=[];for(var F=0;F<256;++F)v.push((F+256).toString(16).substr(1));function R(o){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,t=(v[o[e+0]]+v[o[e+1]]+v[o[e+2]]+v[o[e+3]]+"-"+v[o[e+4]]+v[o[e+5]]+"-"+v[o[e+6]]+v[o[e+7]]+"-"+v[o[e+8]]+v[o[e+9]]+"-"+v[o[e+10]]+v[o[e+11]]+v[o[e+12]]+v[o[e+13]]+v[o[e+14]]+v[o[e+15]]).toLowerCase();if(!N(t))throw TypeError("Stringified UUID is invalid");return t}var te,q,W=0,$=0;function Te(o,e,t){var s=e&&t||0,n=e||new Array(16);o=o||{};var r=o.node||te,a=o.clockseq!==void 0?o.clockseq:q;if(r==null||a==null){var c=o.random||(o.rng||ae)();r==null&&(r=te=[c[0]|1,c[1],c[2],c[3],c[4],c[5]]),a==null&&(a=q=(c[6]<<8|c[7])&16383)}var d=o.msecs!==void 0?o.msecs:Date.now(),h=o.nsecs!==void 0?o.nsecs:$+1,p=d-W+(h-$)/1e4;if(p<0&&o.clockseq===void 0&&(a=a+1&16383),(p<0||d>W)&&o.nsecs===void 0&&(h=0),h>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");W=d,$=h,q=a,d+=122192928e5;var f=((d&268435455)*1e4+h)%4294967296;n[s++]=f>>>24&255,n[s++]=f>>>16&255,n[s++]=f>>>8&255,n[s++]=f&255;var u=d/4294967296*1e4&268435455;n[s++]=u>>>8&255,n[s++]=u&255,n[s++]=u>>>24&15|16,n[s++]=u>>>16&255,n[s++]=a>>>8|128,n[s++]=a&255;for(var g=0;g<6;++g)n[s+g]=r[g];return e||R(n)}function ie(o){if(!N(o))throw TypeError("Invalid UUID");var e,t=new Uint8Array(16);return t[0]=(e=parseInt(o.slice(0,8),16))>>>24,t[1]=e>>>16&255,t[2]=e>>>8&255,t[3]=e&255,t[4]=(e=parseInt(o.slice(9,13),16))>>>8,t[5]=e&255,t[6]=(e=parseInt(o.slice(14,18),16))>>>8,t[7]=e&255,t[8]=(e=parseInt(o.slice(19,23),16))>>>8,t[9]=e&255,t[10]=(e=parseInt(o.slice(24,36),16))/1099511627776&255,t[11]=e/4294967296&255,t[12]=e>>>24&255,t[13]=e>>>16&255,t[14]=e>>>8&255,t[15]=e&255,t}function xe(o){o=unescape(encodeURIComponent(o));for(var e=[],t=0;t<o.length;++t)e.push(o.charCodeAt(t));return e}var Oe="6ba7b810-9dad-11d1-80b4-00c04fd430c8",Le="6ba7b811-9dad-11d1-80b4-00c04fd430c8";function re(o,e,t){function s(n,r,a,c){if(typeof n=="string"&&(n=xe(n)),typeof r=="string"&&(r=ie(r)),r.length!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var d=new Uint8Array(16+n.length);if(d.set(r),d.set(n,r.length),d=t(d),d[6]=d[6]&15|e,d[8]=d[8]&63|128,a){c=c||0;for(var h=0;h<16;++h)a[c+h]=d[h];return a}return R(d)}try{s.name=o}catch{}return s.DNS=Oe,s.URL=Le,s}function Ee(o){if(typeof o=="string"){var e=unescape(encodeURIComponent(o));o=new Uint8Array(e.length);for(var t=0;t<e.length;++t)o[t]=e.charCodeAt(t)}return Ne(Re(He(o),o.length*8))}function Ne(o){for(var e=[],t=o.length*32,s="0123456789abcdef",n=0;n<t;n+=8){var r=o[n>>5]>>>n%32&255,a=parseInt(s.charAt(r>>>4&15)+s.charAt(r&15),16);e.push(a)}return e}function ce(o){return(o+64>>>9<<4)+14+1}function Re(o,e){o[e>>5]|=128<<e%32,o[ce(e)-1]=e;for(var t=1732584193,s=-271733879,n=-1732584194,r=271733878,a=0;a<o.length;a+=16){var c=t,d=s,h=n,p=r;t=C(t,s,n,r,o[a],7,-680876936),r=C(r,t,s,n,o[a+1],12,-389564586),n=C(n,r,t,s,o[a+2],17,606105819),s=C(s,n,r,t,o[a+3],22,-1044525330),t=C(t,s,n,r,o[a+4],7,-176418897),r=C(r,t,s,n,o[a+5],12,1200080426),n=C(n,r,t,s,o[a+6],17,-1473231341),s=C(s,n,r,t,o[a+7],22,-45705983),t=C(t,s,n,r,o[a+8],7,1770035416),r=C(r,t,s,n,o[a+9],12,-1958414417),n=C(n,r,t,s,o[a+10],17,-42063),s=C(s,n,r,t,o[a+11],22,-1990404162),t=C(t,s,n,r,o[a+12],7,1804603682),r=C(r,t,s,n,o[a+13],12,-40341101),n=C(n,r,t,s,o[a+14],17,-1502002290),s=C(s,n,r,t,o[a+15],22,1236535329),t=y(t,s,n,r,o[a+1],5,-165796510),r=y(r,t,s,n,o[a+6],9,-1069501632),n=y(n,r,t,s,o[a+11],14,643717713),s=y(s,n,r,t,o[a],20,-373897302),t=y(t,s,n,r,o[a+5],5,-701558691),r=y(r,t,s,n,o[a+10],9,38016083),n=y(n,r,t,s,o[a+15],14,-660478335),s=y(s,n,r,t,o[a+4],20,-405537848),t=y(t,s,n,r,o[a+9],5,568446438),r=y(r,t,s,n,o[a+14],9,-1019803690),n=y(n,r,t,s,o[a+3],14,-187363961),s=y(s,n,r,t,o[a+8],20,1163531501),t=y(t,s,n,r,o[a+13],5,-1444681467),r=y(r,t,s,n,o[a+2],9,-51403784),n=y(n,r,t,s,o[a+7],14,1735328473),s=y(s,n,r,t,o[a+12],20,-1926607734),t=S(t,s,n,r,o[a+5],4,-378558),r=S(r,t,s,n,o[a+8],11,-2022574463),n=S(n,r,t,s,o[a+11],16,1839030562),s=S(s,n,r,t,o[a+14],23,-35309556),t=S(t,s,n,r,o[a+1],4,-1530992060),r=S(r,t,s,n,o[a+4],11,1272893353),n=S(n,r,t,s,o[a+7],16,-155497632),s=S(s,n,r,t,o[a+10],23,-1094730640),t=S(t,s,n,r,o[a+13],4,681279174),r=S(r,t,s,n,o[a],11,-358537222),n=S(n,r,t,s,o[a+3],16,-722521979),s=S(s,n,r,t,o[a+6],23,76029189),t=S(t,s,n,r,o[a+9],4,-640364487),r=S(r,t,s,n,o[a+12],11,-421815835),n=S(n,r,t,s,o[a+15],16,530742520),s=S(s,n,r,t,o[a+2],23,-995338651),t=k(t,s,n,r,o[a],6,-198630844),r=k(r,t,s,n,o[a+7],10,1126891415),n=k(n,r,t,s,o[a+14],15,-1416354905),s=k(s,n,r,t,o[a+5],21,-57434055),t=k(t,s,n,r,o[a+12],6,1700485571),r=k(r,t,s,n,o[a+3],10,-1894986606),n=k(n,r,t,s,o[a+10],15,-1051523),s=k(s,n,r,t,o[a+1],21,-2054922799),t=k(t,s,n,r,o[a+8],6,1873313359),r=k(r,t,s,n,o[a+15],10,-30611744),n=k(n,r,t,s,o[a+6],15,-1560198380),s=k(s,n,r,t,o[a+13],21,1309151649),t=k(t,s,n,r,o[a+4],6,-145523070),r=k(r,t,s,n,o[a+11],10,-1120210379),n=k(n,r,t,s,o[a+2],15,718787259),s=k(s,n,r,t,o[a+9],21,-343485551),t=A(t,c),s=A(s,d),n=A(n,h),r=A(r,p)}return[t,s,n,r]}function He(o){if(o.length===0)return[];for(var e=o.length*8,t=new Uint32Array(ce(e)),s=0;s<e;s+=8)t[s>>5]|=(o[s/8]&255)<<s%32;return t}function A(o,e){var t=(o&65535)+(e&65535),s=(o>>16)+(e>>16)+(t>>16);return s<<16|t&65535}function Pe(o,e){return o<<e|o>>>32-e}function H(o,e,t,s,n,r){return A(Pe(A(A(e,o),A(s,r)),n),t)}function C(o,e,t,s,n,r,a){return H(e&t|~e&s,o,e,n,r,a)}function y(o,e,t,s,n,r,a){return H(e&s|t&~s,o,e,n,r,a)}function S(o,e,t,s,n,r,a){return H(e^t^s,o,e,n,r,a)}function k(o,e,t,s,n,r,a){return H(t^(e|~s),o,e,n,r,a)}var Ve=re("v3",48,Ee);function je(o,e,t){o=o||{};var s=o.random||(o.rng||ae)();if(s[6]=s[6]&15|64,s[8]=s[8]&63|128,e){t=t||0;for(var n=0;n<16;++n)e[t+n]=s[n];return e}return R(s)}function Be(o,e,t,s){switch(o){case 0:return e&t^~e&s;case 1:return e^t^s;case 2:return e&t^e&s^t&s;case 3:return e^t^s}}function K(o,e){return o<<e|o>>>32-e}function Je(o){var e=[1518500249,1859775393,2400959708,3395469782],t=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof o=="string"){var s=unescape(encodeURIComponent(o));o=[];for(var n=0;n<s.length;++n)o.push(s.charCodeAt(n))}else Array.isArray(o)||(o=Array.prototype.slice.call(o));o.push(128);for(var r=o.length/4+2,a=Math.ceil(r/16),c=new Array(a),d=0;d<a;++d){for(var h=new Uint32Array(16),p=0;p<16;++p)h[p]=o[d*64+p*4]<<24|o[d*64+p*4+1]<<16|o[d*64+p*4+2]<<8|o[d*64+p*4+3];c[d]=h}c[a-1][14]=(o.length-1)*8/Math.pow(2,32),c[a-1][14]=Math.floor(c[a-1][14]),c[a-1][15]=(o.length-1)*8&4294967295;for(var f=0;f<a;++f){for(var u=new Uint32Array(80),g=0;g<16;++g)u[g]=c[f][g];for(var b=16;b<80;++b)u[b]=K(u[b-3]^u[b-8]^u[b-14]^u[b-16],1);for(var D=t[0],_=t[1],T=t[2],x=t[3],P=t[4],O=0;O<80;++O){var Y=Math.floor(O/20),le=K(D,5)+Be(Y,_,T,x)+P+e[Y]+u[O]>>>0;P=x,x=T,T=K(_,30)>>>0,_=D,D=le}t[0]=t[0]+D>>>0,t[1]=t[1]+_>>>0,t[2]=t[2]+T>>>0,t[3]=t[3]+x>>>0,t[4]=t[4]+P>>>0}return[t[0]>>24&255,t[0]>>16&255,t[0]>>8&255,t[0]&255,t[1]>>24&255,t[1]>>16&255,t[1]>>8&255,t[1]&255,t[2]>>24&255,t[2]>>16&255,t[2]>>8&255,t[2]&255,t[3]>>24&255,t[3]>>16&255,t[3]>>8&255,t[3]&255,t[4]>>24&255,t[4]>>16&255,t[4]>>8&255,t[4]&255]}var Fe=re("v5",80,Je);const qe="00000000-0000-0000-0000-000000000000";function We(o){if(!N(o))throw TypeError("Invalid UUID");return parseInt(o.substr(14,1),16)}const $e=Object.freeze(Object.defineProperty({__proto__:null,NIL:qe,parse:ie,stringify:R,v1:Te,v3:Ve,v4:je,v5:Fe,validate:N,version:We},Symbol.toStringTag,{value:"Module"})),Ke=De($e);var se;function Ye(){if(se)return M;se=1,Object.defineProperty(M,"__esModule",{value:!0}),M.IonSFUJSONRPCSignal=void 0;const o=Ke;class e{constructor(s){this.socket=new WebSocket(s),this._notifyhandlers={},this.socket.addEventListener("open",()=>{this._onopen&&this._onopen()}),this.socket.addEventListener("error",n=>{this._onerror&&this._onerror(n)}),this.socket.addEventListener("close",n=>{this._onclose&&this._onclose(n)}),this.socket.addEventListener("message",async n=>{const r=JSON.parse(n.data);if(r.method==="offer")this.onnegotiate&&this.onnegotiate(r.params);else if(r.method==="trickle")this.ontrickle&&this.ontrickle(r.params);else{const a=this._notifyhandlers[r.method];a&&a(r.params)}})}on_notify(s,n){this._notifyhandlers[s]=n}async call(s,n){const r=o.v4();return this.socket.send(JSON.stringify({method:s,params:n,id:r})),new Promise((a,c)=>{const d=h=>{const p=JSON.parse(h.data);p.id===r&&(p.error?c(p.error):a(p.result),this.socket.removeEventListener("message",d))};this.socket.addEventListener("message",d)})}notify(s,n){this.socket.send(JSON.stringify({method:s,params:n}))}async join(s,n,r){return this.call("join",{sid:s,uid:n,offer:r})}trickle(s){this.notify("trickle",s)}async offer(s){return this.call("offer",{desc:s})}answer(s){this.notify("answer",{desc:s})}close(){this.socket.close()}set onopen(s){this.socket.readyState===WebSocket.OPEN&&s(),this._onopen=s}set onerror(s){this._onerror=s}set onclose(s){this._onclose=s}}return M.IonSFUJSONRPCSignal=e,M}var ze=Ye();class Ge{constructor(e){l(this,"init",async()=>{try{const e=await fetch(`${E}/api/turn_credentials`),t=await e.json();if(e.ok)this.peerConfig={iceServers:[{urls:t.url,username:t.username,credential:t.credential,credentialType:"password"},{urls:"stun:stun.l.google.com:19302"}],iceTransportPolicy:"all"},console.log(this.peerConfig);else throw new Error("Failed to fetch credentials for TURN server")}catch(e){console.log(e),m.alert("Failed to fetch credentials for TURN server")}});l(this,"start",async()=>{this.signal=new ze.IonSFUJSONRPCSignal(this.sfuUrl),this.client=new ee.Client(this.signal,this.peerConfig),this.client.ontrack=(e,t)=>{console.log("ðŸŽ§ Remote track received:",e.kind),w.addRemoteStream(t)},this.signal.onopen=async()=>{console.log("ðŸ”— Signal connection open, joining room:",this.room),await this.client.join(this.room,String(this.userID)),this.localStream=await ee.LocalStream.getUserMedia({audio:!0,video:!1}),this.client.publish(this.localStream),console.log("ðŸ“¤ Local stream published",this.localStream),this.socketConn.joinVoiceChannel(this.localStream.id)}});l(this,"close",async()=>{this.client&&(this.client.close(),this.client=null),this.signal&&(this.signal.close(),this.signal=null),console.log("ðŸ”Œ RTC connection closed")});this.socketConn=e.socketConn,this.room=e.room,this.userID=e.userID,this.sfuUrl=ue,this.peerConfig=null,this.signal=null,this.client=null,this.localStream=null}}class Xe{constructor(){l(this,"joinVoice",async({channelUUID:e,userID:t})=>{this.currentChannelUUID=e,this.currentRTCConn=new Ge({room:this.currentChannelUUID,userID:t,socketConn:this.socketConn}),await this.currentRTCConn.init(),await this.currentRTCConn.start()});l(this,"addRemoteStream",e=>{this.remoteStreams.has(e.id)||(e.onremovetrack=t=>{const s=t.target;this.removeRemoteStream(s.id)},this.remoteStreams.set(e.id,{stream:e}),this.onStreamAdded&&this.onStreamAdded(e))});l(this,"removeRemoteStream",e=>{this.remoteStreams.get(e)&&(this.remoteStreams.delete(e),this.onStreamRemoved&&this.onStreamRemoved(e))});l(this,"removeAllRemoteStreams",()=>{for(const e of this.remoteStreams.keys())this.removeRemoteStream(e)});l(this,"getAudioElements",()=>Array.from(this.remoteStreams.values()).map(e=>e.element));l(this,"leaveVoice",async()=>{this.currentChannelUUID=null,this.currentRTCConn&&(await this.currentRTCConn.close(),this.currentRTCConn=null),this.socketConn.leaveVoiceChannel(),this.removeAllRemoteStreams()});this.socketConn=null,this.currentRTCConn=null,this.onStreamAdded=null,this.onStreamRemoved=null,this.currentChannelUUID=null,this.remoteStreams=new Map,this.voiceSubscriptions=[]}}const w=new Xe;class Qe{constructor(){this.domComponent=i("div",{class:"voice-elem-control"}),this.audioElements=new Map,w.onStreamAdded=e=>{const t=w.voiceSubscriptions.find(c=>e.id==c.stream_id),s=document.createElement("div");s.className="audio-container";const n=document.createElement("audio");n.className="voice-elem",n.id=`audio-item-${e.id}`,n.srcObject=e,n.autoplay=!0,n.controls=!1;const r=document.createElement("div");r.style.cursor="pointer",r.textContent="ðŸ”Š",r.onclick=()=>{n.paused?(n.play(),r.textContent="ðŸ”Š"):(n.pause(),r.textContent="ðŸ”‡")};const a=document.createElement("input");a.type="range",a.min="0",a.max="1",a.step="0.01",a.value=n.volume,a.oninput=c=>{n.volume=c.target.value},s.appendChild(n),s.appendChild(r),s.appendChild(a),t&&(s.username=t.username),this.audioElements.set(e.id,s),U.isOpen&&U.render()},w.onStreamRemoved=e=>{this.audioElements.get(e)&&this.audioElements.delete(e),U.isOpen&&U.render()}}}const Ze=new Qe;class et{constructor(){l(this,"open",e=>(this.domComponent.style.display="block",this.isOpen=!0,this.render(e)));l(this,"close",()=>{this.domComponent.style.display="none",this.isOpen=!1});l(this,"render",()=>{this.domComponent.innerHTML="",this.domComponent.append(i("div",{class:"voice-elem-container-content"},[i("div",{style:"display: flex; align-items: baseline; justify-content: space-between;"},[i("div",{},"Voices"),i("div",{style:"cursor: pointer; font-size: 30px;"},"Ã—",{type:"click",event:()=>{this.close()}})]),...Array.from(Ze.audioElements.values(),e=>i("div",{class:"voice-elem-wrapper"},[i("div",{style:"margin-right: 5px;"},e.username?e.username:"Unknown"),e]))]))});this.domComponent=i("div",{class:"voice-elem-container"}),this.isOpen=!1}}const U=new et;class tt{constructor(e){l(this,"initialize",e=>{this.chatBoxComponent=new st({domComponent:i("div"),data:this.data,socketConn:this.socketConn,channelUUID:e}),this.render();const t=new Date().toISOString();this.socketConn.getMessages(t)});l(this,"render",()=>{this.domComponent.innerHTML="",this.chatBoxComponent&&this.domComponent.append(this.chatBoxComponent.domComponent)});this.domComponent=e.domComponent,this.data=e.data,this.socketConn=e.socketConn,this.chatBoxComponent=null}}class st{constructor(e){l(this,"renderVoiceChatComponent",()=>this.channel.allow_voice==1?this.voiceChatComponent.domComponent:"");l(this,"render",()=>{this.domComponent.innerHTML="",this.domComponent.append(i("div",{class:"chatapp-channel-title"},this.channel.name),this.chatBoxMessagesComponent.domComponent,this.renderVoiceChatComponent(),i("div",{class:"chat-box-form"},[i("textarea",{id:"chat-box-form-input",class:"chat-box-form-input",autofocus:!0,type:"text",required:!0,autocomplete:"off",placeholder:"Type message here..."},null,[{type:"input",event:e=>{const t=e.target;t.style.height="auto",t.style.height=`${t.scrollHeight}px`}},{type:"keydown",event:e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();const t=e.target,s=t.value.trim();s&&(this.socketConn.sendMessage(s),t.value="",t.style.height="auto",t.focus())}}}])]))});this.domComponent=e.domComponent,this.domComponent.className="chat-box-container",this.data=e.data,this.socketConn=e.socketConn,this.channelUUID=e.channelUUID;for(const t of this.data.spaces){const s=t.channels.find(n=>n.uuid===this.channelUUID);if(s){this.space=t,this.channel=s;break}}this.chatBoxMessagesComponent=new nt({domComponent:i("div",{class:"chat-box-messages",id:"chat-box-messages"}),channelUUID:this.channelUUID,socketConn:this.socketConn}),this.voiceChatComponent=new ot({domComponent:i("div",{class:"voice-chat-component",id:"voice-chat-component"}),channelUUID:this.channelUUID,user:this.data.user}),this.render()}}class nt{constructor(e){l(this,"getPreviousMessagesDebounce",()=>{this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.debounceTimeout=setTimeout(()=>{this.getPreviousMessages()},300)});l(this,"getPreviousMessages",()=>{if(this.isLoading||!this.hasMoreMessages||!this.chatBoxMessages.length||!this.isScrolledToTop())return;this.isLoading=!0;const e=this.chatBoxMessages[0].timestamp;this.socketConn.getMessages(e)});l(this,"scrollDown",()=>{this.domComponent.scrollTop=this.domComponent.scrollHeight});l(this,"isScrolledToTop",()=>this.domComponent.scrollTop<=20);l(this,"isScrolledToBottom",()=>this.domComponent.scrollHeight-this.domComponent.scrollTop<=this.domComponent.clientHeight+40);l(this,"appendNewMessage",e=>{const t=this.isScrolledToBottom();this.chatBoxMessages.push(e),this.render(),t&&requestAnimationFrame(()=>this.scrollDown())});l(this,"prependMessages",e=>{const t=this.domComponent.scrollHeight;this.chatBoxMessages=[...e,...this.chatBoxMessages],this.render(),requestAnimationFrame(()=>{const s=this.domComponent.scrollHeight;this.domComponent.scrollTop+=s-t})});l(this,"createMessage",(e,t=!1)=>{const s=r=>{const a=/(https?:\/\/[^\s]+)/g,c=/^https?:\/\/[^\s]+$/;return r.split(a).map(h=>c.test(h)?Ue(h)?we(h):i("a",{href:h,target:"_blank",rel:"noopener noreferrer",style:"margin: 0 5px;"},h):h)},n=i("div",{class:"chat-box-message-content"},[i("div",{style:"display: flex; align-items: flex-end;"},[i("small",{style:"margin-right: var(--main-distance); color: var(--main-gray);"},ke(e.timestamp)),i("div",{style:"font-weight: bold; margin-right: var(--main-distance); color: var(--light-yellow);"},e.username)]),i("div",{class:"chat-box-message-text"},[...s(e.content)]),i("hr")]);return t&&(n.style.animation="highlightFade 1s ease-out"),n});l(this,"render",()=>{this.domComponent.innerHTML="";const e=this.chatBoxMessages.map(t=>this.createMessage(t));this.domComponent.append(...e)});this.chatBoxMessages=[],this.channelUUID=e.channelUUID,this.socketConn=e.socketConn,this.messageRequestSize=50,this.hasMoreMessages=!0,this.debounceTimeout=null,this.isLoading=!1,this.domComponent=i("div",{class:"chat-box-messages",id:"chat-box-messages"},null,{type:"scroll",event:()=>{this.getPreviousMessagesDebounce()}})}}class ot{constructor(e){l(this,"renderVoiceComponent",()=>w.currentChannelUUID===this.channelUUID?i("div",{class:"voice-chat-toolbar"},[i("button",{class:"voice-leave-btn btn-red",style:"margin-right: 5px;"},"ðŸ”Š Leave Voice",{type:"click",event:async()=>{await w.leaveVoice(),U.isOpen&&U.close(),this.render()}}),i("button",{class:"voice-options-btn"},"Show Voices",{type:"click",event:()=>{U.isOpen||U.open()}})]):i("button",{class:"chat-box-btn"},"ðŸ”Š Join Voice",{type:"click",event:async()=>{await w.leaveVoice(),await w.joinVoice({channelUUID:this.channelUUID,userID:this.user.id}),this.render(),U.open()}}));l(this,"render",()=>{this.domComponent.innerHTML="",this.domComponent.append(this.renderVoiceComponent())});this.domComponent=e.domComponent,this.channelUUID=e.channelUUID,this.user=e.user,this.voiceManager=null,this.render()}}class at{constructor(e){l(this,"renderChannel",e=>{this.currentChannelUUID=e,this.domComponent.innerHTML="";const t=i("div",{class:"chatapp-container"});this.domComponent.append(t),this.chatApp?this.chatApp.domComponent=t:this.chatApp=new tt({domComponent:t,data:this.data,socketConn:this.socketConn}),this.chatApp.initialize(e)});l(this,"cleanup",()=>{var e,t;this.chatApp&&((t=(e=this.chatApp).cleanup)==null||t.call(e),this.chatApp=null),this.currentChannelUUID=null});l(this,"render",()=>{this.cleanup(),this.domComponent.innerHTML="",this.domComponent.append(i("div",{class:"no-channel-selected"},[i("h2",{},"Select a channel to start chatting")]))});this.domComponent=e.domComponent,this.data=e.data,this.socketConn=e.socketConn,this.chatApp=null,this.currentChannelUUID=null,this.render()}}class it{constructor(e){l(this,"retryConnection",()=>{if(this.retryCount+=1,this.retryCount>this.maxRetries){console.log("Max WebSocket reconnection attempts exceeded."),m.alert("Unable to reconnect to host. Returning to home."),this.returnToHostList();return}console.log(`Retrying WebSocket connection (#${this.retryCount}) in ${2e3/1e3} seconds...`),setTimeout(()=>{var t;((t=this.socket)==null?void 0:t.readyState)!==WebSocket.OPEN&&this.connect()},2e3)});l(this,"connect",()=>{const e=pe;console.log("Connecting to WebSocket:",e),this.socket=new WebSocket(e),this.socket.onopen=()=>{console.log("WebSocket connection established"),this.joinHost()},this.socket.onerror=t=>{console.error("WebSocket error:",t)},this.socket.onclose=t=>{console.warn("WebSocket connection closed:",t.reason||"No reason"),this.hostStatus=!1,!this.manualClose&&this.retryConnection()},this.socket.onmessage=t=>{try{const s=JSON.parse(t.data);switch(s.type){case"host_status_result":if(console.log("Host status result message:",s),s.data.error){console.log("Retrying"),setTimeout(()=>{this.getHostStatus()},1e3);break}this.hostStatus=!0,this.joinHost();break;case"join_ack":console.log("Joining Result",s),m.loadAuthToken().then(n=>{n?this.loginUserByToken({token:n}):this.openDashModal({type:"login"})});break;case"join_error":console.log("Joining Result",s),m.alert(s.data.error);case"login_user_success":console.log("Login user success",s),m.saveAuthToken(s.data.token),this.closeDashModal(),this.getDashboardData();break;case"dash_data_payload":console.log("Dash data payload",s),this.dashboardInitialRender(s.data),this.joinAllSpaces(s);break;case"update_username_success":console.log("Update username success",s),this.updateAccountUsername(s,this.hostUUID);break;case"create_space_success":console.log("Create space success",s),this.handleCreateSpace(s);break;case"delete_space_success":console.log("Delete space success",s),this.handleDeleteSpace();break;case"create_channel_success":console.log("Create channel success",s),this.handleCreateChannel(s);break;case"create_channel_update":console.log("Create channel update",s),this.handleCreateChannelUpdate(s);break;case"delete_channel_success":console.log("delete channel success",s),this.handleDeleteChannel(s);break;case"delete_channel_update":console.log("delete_channel_update",s),this.handleDeleteChannelUpdate(s);break;case"invite_user_success":console.log("invite user success",s),this.handleInviteUser(s);break;case"invite_user_update":console.log("invite user update",s),this.handleAddInvite(s);break;case"accept_invite_success":console.log("accept invite succes",s),this.handleAcceptInvite(s);break;case"accept_invite_update":console.log("accept invite update",s),this.handleAcceptInviteUpdate(s);break;case"decline_invite_success":console.log("decline invite success",s),this.handleDeclineInvite(s);break;case"leave_space_success":console.log("leave space success",s),this.handleLeaveSpace();break;case"leave_space_update":console.log("leave space update",s),this.handleLeaveSpaceUpdate(s);break;case"joined_channel":console.log("Join message:",s);break;case"left_channel":console.log("Leave message:",s);break;case"chat":console.log("Chat message:",s),this.renderChatAppMessage(s);break;case"get_messages_success":console.log("Get messages success",s),this.handleIncomingMessages(s);break;case"joined_voice_channel":console.log("Joined voice channel",s),w.voiceSubscriptions=s.data.voice_subs;break;case"left_voice_channel":console.log("Left voice channel",s),w.voiceSubscriptions=s.data.voice_subs;break;case"channel_allow_voice_update":console.log("Channel allow voice update",s),this.handleAllowVoiceUpdate(s);break;case"error":console.error("An error message from socket:",s),m.alert(s.data.error);break;case"authentication-error":console.error("Authentication error",s),this.openDashModal({type:"login"});break;case"author_error":console.error("An error message from socket:",s),m.alert("Failed to connect to Host. Host is not currently connected to the relay server."),this.returnToHostList();break;default:console.log("Unhandled message type",s)}}catch(s){console.error("JSON parsing error:",s)}}});l(this,"joinHost",()=>{var e,t;if(console.log("Attempting to join host:"),((e=this.socket)==null?void 0:e.readyState)===WebSocket.OPEN){const s={type:"join_host",data:{uuid:this.hostUUID,id:this.hostAuthorID}};this.socket.send(JSON.stringify(s))}else console.error("Socket is not open. State:",(t=this.socket)==null?void 0:t.readyState)});l(this,"getHostStatus",()=>{var e,t;if(console.log("Attempting to get host status:"),((e=this.socket)==null?void 0:e.readyState)===WebSocket.OPEN){const s={type:"host_status",data:{uuid:this.hostUUID}};this.socket.send(JSON.stringify(s))}else console.error("Socket is not open. State:",(t=this.socket)==null?void 0:t.readyState)});l(this,"registerUser",e=>{var t,s;if(console.log("Attempting to register user:",e),((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const n={type:"register_user",data:e};this.socket.send(JSON.stringify(n))}else console.error("Socket is not open. State:",(s=this.socket)==null?void 0:s.readyState)});l(this,"loginUser",e=>{var t,s;if(console.log("Attempting to login user:",e),((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const n={type:"login_user",data:e};this.socket.send(JSON.stringify(n))}else console.error("Socket is not open. State:",(s=this.socket)==null?void 0:s.readyState)});l(this,"loginUserByToken",e=>{var t,s;if(console.log("Attempting to login user by token:",e),((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const n={type:"login_user_by_token",data:e};this.socket.send(JSON.stringify(n))}else console.error("Socket is not open. State:",(s=this.socket)==null?void 0:s.readyState)});l(this,"approveLoginUser",e=>{var t,s;if(console.log("Attempting to approve login user:",e),((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const n={type:"login_approved",data:e};this.socket.send(JSON.stringify(n))}else console.error("Socket is not open. State:",(s=this.socket)==null?void 0:s.readyState)});l(this,"getDashboardData",()=>{var e,t;if(console.log("Attempting to get dashboard data"),((e=this.socket)==null?void 0:e.readyState)===WebSocket.OPEN){const s={type:"get_dash_data",data:""};this.socket.send(JSON.stringify(s))}else console.error("Socket is not open. State:",(t=this.socket)==null?void 0:t.readyState)});l(this,"joinAllSpaces",e=>{var t,s;if(console.log("Attempting to join all spaces"),((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const r={type:"join_all_spaces",data:{space_uuids:e.data.spaces.map(a=>a.uuid)}};this.socket.send(JSON.stringify(r))}else console.error("Socket is not open. State:",(s=this.socket)==null?void 0:s.readyState)});l(this,"updateUsername",e=>{var t,s;if(console.log("Attempting to update username:",e),((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const n={type:"update_username",data:e};this.socket.send(JSON.stringify(n))}else console.error("Socket is not open. State:",(s=this.socket)==null?void 0:s.readyState)});l(this,"createSpace",e=>{var t,s;if(console.log("Attempting to create new space:",e),((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const n={type:"create_space",data:e};this.socket.send(JSON.stringify(n))}else console.error("Socket is not open. State:",(s=this.socket)==null?void 0:s.readyState)});l(this,"deleteSpace",e=>{var t,s;if(console.log("Attempting to delete space:",e),((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const n={type:"delete_space",data:e};this.socket.send(JSON.stringify(n))}else console.error("Socket is not open. State:",(s=this.socket)==null?void 0:s.readyState)});l(this,"createChannel",e=>{var t,s;if(console.log("Attempting to create new channel:",e),((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const n={type:"create_channel",data:e};this.socket.send(JSON.stringify(n))}else console.error("Socket is not open. State:",(s=this.socket)==null?void 0:s.readyState)});l(this,"deleteChannel",e=>{var t,s;if(console.log("Attempting to delete channel:",e),((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const n={type:"delete_channel",data:e};this.socket.send(JSON.stringify(n))}else console.error("Socket is not open. State:",(s=this.socket)==null?void 0:s.readyState)});l(this,"inviteUser",e=>{var t,s;if(console.log("Attempting to invite user:",e),((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const n={type:"invite_user",data:e};this.socket.send(JSON.stringify(n))}else console.error("Socket is not open. State:",(s=this.socket)==null?void 0:s.readyState)});l(this,"acceptInvite",e=>{var t,s;if(console.log("Attempting to accept invite:",e),((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const n={type:"accept_invite",data:e};this.socket.send(JSON.stringify(n))}else console.error("Socket is not open. State:",(s=this.socket)==null?void 0:s.readyState)});l(this,"declineInvite",e=>{var t,s;if(console.log("Attempting to decline invite:",e),((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const n={type:"decline_invite",data:e};this.socket.send(JSON.stringify(n))}else console.error("Socket is not open. State:",(s=this.socket)==null?void 0:s.readyState)});l(this,"leaveSpace",e=>{var t,s;if(console.log("Attempting to leave space:",e),((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const n={type:"leave_space",data:e};this.socket.send(JSON.stringify(n))}else console.error("Socket is not open. State:",(s=this.socket)==null?void 0:s.readyState)});l(this,"removeSpaceUser",e=>{var t,s;if(console.log("Attempting to remove space user:",e),((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const n={type:"remove_space_user",data:e};this.socket.send(JSON.stringify(n))}else console.error("Socket is not open. State:",(s=this.socket)==null?void 0:s.readyState)});l(this,"joinChannel",e=>{var t,s;if(console.log("Attempting to join channel:",e),((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){const n={type:"join_channel",data:{uuid:e}};this.socket.send(JSON.stringify(n))}else console.error("Socket is not open. State:",(s=this.socket)==null?void 0:s.readyState)});l(this,"sendMessage",e=>{var t,s;if(console.log("Attempting to send message:",e),((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){console.log("Socket is open, sending message");const n={type:"chat",data:{content:e}};this.socket.send(JSON.stringify(n))}else console.error("Socket is not open. State:",(s=this.socket)==null?void 0:s.readyState)});l(this,"getMessages",e=>{var t,s;if(console.log("Attempting to get messages:"),((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){console.log("Socket is open, sending message");const n={type:"get_messages",data:{before_unix_time:e}};this.socket.send(JSON.stringify(n))}else console.error("Socket is not open. State:",(s=this.socket)==null?void 0:s.readyState)});l(this,"channelAllowVoice",(e,t,s)=>{var n,r;if(console.log("Attempting to allow voice for channel:"),((n=this.socket)==null?void 0:n.readyState)===WebSocket.OPEN){console.log("Socket is open, sending message");const a={type:"channel_allow_voice",data:{uuid:e,space_uuid:t,allow:s}};this.socket.send(JSON.stringify(a))}else console.error("Socket is not open. State:",(r=this.socket)==null?void 0:r.readyState)});l(this,"joinVoiceChannel",e=>{var t,s;if(console.log("Attempting to join voice channel:"),((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN){console.log("Socket is open, sending message");const n={type:"join_voice_channel",data:{stream_id:e}};this.socket.send(JSON.stringify(n))}else console.error("Socket is not open. State:",(s=this.socket)==null?void 0:s.readyState)});l(this,"leaveVoiceChannel",()=>{var e,t;if(console.log("Attempting to leave voice channel:"),((e=this.socket)==null?void 0:e.readyState)===WebSocket.OPEN){console.log("Socket is open, sending message");const s={type:"leave_voice_channel",data:""};this.socket.send(JSON.stringify(s))}else console.error("Socket is not open. State:",(t=this.socket)==null?void 0:t.readyState)});l(this,"hardClose",()=>{this.manualClose=!0,this.close()});l(this,"close",()=>{this.socket&&(console.log("Closing WebSocket connection"),this.socket.close())});this.returnToHostList=e.returnToHostList,this.updateAccountUsername=e.updateAccountUsername,this.dashboardInitialRender=e.dashboardInitialRender,this.openDashModal=e.openDashModal,this.closeDashModal=e.closeDashModal,this.renderChatAppMessage=e.renderChatAppMessage,this.handleCreateSpace=e.handleCreateSpace,this.handleCreateChannel=e.handleCreateChannel,this.handleDeleteSpace=e.handleDeleteSpace,this.handleDeleteChannel=e.handleDeleteChannel,this.handleNewChannel=e.handleNewChannel,this.handleCreateChannelUpdate=e.handleCreateChannelUpdate,this.handleDeleteChannel=e.handleDeleteChannel,this.handleDeleteChannelUpdate=e.handleDeleteChannelUpdate,this.handleInviteUser=e.handleInviteUser,this.handleAddInvite=e.handleAddInvite,this.handleAcceptInvite=e.handleAcceptInvite,this.handleAcceptInviteUpdate=e.handleAcceptInviteUpdate,this.handleDeclineInvite=e.handleDeclineInvite,this.handleLeaveSpace=e.handleLeaveSpace,this.handleLeaveSpaceUpdate=e.handleLeaveSpaceUpdate,this.handleIncomingMessages=e.handleIncomingMessages,this.handleAllowVoiceUpdate=e.handleAllowVoiceUpdate,this.socket=null,this.manualClose=!1,this.hostStatus=!1,this.retryCount=0,this.maxRetries=1,this.hostUUID=localStorage.getItem("hostUUID"),this.hostUUID?(console.log("Host Key:",this.hostUUID),this.connect()):(console.log("Missing host key"),m.alert("App failed to start because of missing HOST KEY"),this.returnToHostList())}}class rt{constructor(e){l(this,"initialize",()=>{this.domComponent.append(i("div",{class:"initial-spinner"},[i("div",{},"Connecting To Host..."),i("br"),i("div",{class:"lds-dual-ring"})])),this.socketConn=new it({returnToHostList:this.returnToHostList,updateAccountUsername:this.updateAccountUsername,dashboardInitialRender:this.initialRender,openDashModal:this.openDashModal,closeDashModal:this.closeDashModal,renderChatAppMessage:this.renderChatAppMessage,handleCreateSpace:this.handleCreateSpace,handleDeleteSpace:this.handleDeleteSpace,handleCreateChannel:this.handleCreateChannel,handleCreateChannelUpdate:this.handleCreateChannelUpdate,handleDeleteChannel:this.handleDeleteChannel,handleDeleteChannelUpdate:this.handleDeleteChannelUpdate,handleInviteUser:this.handleInviteUser,handleAddInvite:this.handleAddInvite,handleAcceptInvite:this.handleAcceptInvite,handleAcceptInviteUpdate:this.handleAcceptInviteUpdate,handleDeclineInvite:this.handleDeclineInvite,handleLeaveSpace:this.handleLeaveSpace,handleLeaveSpaceUpdate:this.handleLeaveSpaceUpdate,handleIncomingMessages:this.handleIncomingMessages,handleAllowVoiceUpdate:this.handleAllowVoiceUpdate}),w.socketConn=this.socketConn,this.dashModal=new ve(this,this.socketConn),this.domComponent.append(this.dashModal.domComponent)});l(this,"initialRender",e=>{this.data=e,this.data.spaces||(this.data.spaces=[]),this.sidebar=new Ce({data:this.data,socketConn:this.socketConn,returnToHostList:this.returnToHostList,domComponent:i("div",{class:"sidebar"}),openDashModal:this.openDashModal,closeDashModal:this.closeDashModal,getCurrentSpaceUUID:this.getCurrentSpaceUUID,openSpaceSettings:this.openSpaceSettings,loadChannel:this.loadChannel}),this.mainContent=new at({socketConn:this.socketConn,data:this.data,domComponent:i("div",{id:"channel-content",class:"channel-content"})}),this.render()});l(this,"updateAccountUsername",(e,t)=>{this.data.user.username=e.data.username,m.saveAuthToken(e.data.token),this.sidebar.userAccountComponent.render(),this.openDashModal({type:"account",data:{user:this.data.user}})});l(this,"getCurrentSpaceUUID",()=>this.currentSpaceUUID);l(this,"loadChannel",(e,t)=>{this.currentSpaceUUID=e,this.socketConn.joinChannel(t),this.sidebar.spaceUserListComponent.render(),this.mainContent.renderChannel(t)});l(this,"openDashModal",e=>this.dashModal.open(e));l(this,"closeDashModal",()=>{this.dashModal.close()});l(this,"openSpaceSettings",e=>{this.currentSpaceUUID=e.uuid,this.openDashModal({type:"space-settings",data:{space:e,user:this.data.user}})});l(this,"closeSpaceSettings",()=>{this.closeDashModal(),this.currentSpaceUUID=null});l(this,"handleCreateSpace",async e=>{this.data.spaces.push(e.data.space),this.sidebar.render()});l(this,"handleDeleteSpace",async()=>{if(!this.currentSpaceUUID)return;this.data.spaces=this.data.spaces.filter(t=>t.uuid!==this.currentSpaceUUID);const e=this.sidebar.spaceComponents.filter(t=>t.space.uuid!==this.currentSpaceUUID);this.sidebar.spaceComponents=e,this.currentSpaceUUID=null,this.mainContent.render(),this.sidebar.render(),this.sidebar.spaceUserListComponent.render(),this.closeSpaceSettings()});l(this,"handleInviteUser",e=>{m.alert(`Successfully invited user by email: ${e.data.email}`)});l(this,"handleAddInvite",e=>{this.data.invites||(this.data.invites=[]),this.data.invites.push(e.data.invite)});l(this,"handleAcceptInvite",e=>{this.data.invites=this.data.invites.filter(t=>t.id!==e.data.space_user_id),this.data.spaces.push(e.data.space),this.sidebar.render(),this.openDashModal({type:"invites",data:{invites:this.data.invites,user:this.data.user}})});l(this,"handleAcceptInviteUpdate",e=>{console.log("invite update",e);const t=this.data.spaces.find(s=>s.uuid===e.data.space_uuid);t.users.find(s=>s.id===e.data.user.id)||t.users.push(e.data.user),t&&this.currentSpaceUUID===t.uuid&&this.data.user.id!==e.data.user.id&&this.sidebar.spaceUserListComponent.render()});l(this,"handleDeclineInvite",e=>{this.data.invites=this.data.invites.filter(t=>t.id!==e.data.space_user_id),this.openDashModal({type:"invites",data:{invites:this.data.invites,user:this.data.user}})});l(this,"handleLeaveSpace",()=>{this.data.spaces=this.data.spaces.filter(e=>e.uuid!==this.currentSpaceUUID),this.currentSpaceUUID=null,this.sidebar.render(),this.mainContent.render()});l(this,"handleLeaveSpaceUpdate",e=>{const t=this.data.spaces.find(s=>s.uuid===e.data.space_uuid);if(t&&this.currentSpaceUUID===t.uuid){const s=t.users.findIndex(n=>n.id===e.data.user_id);t.users.splice(s,1),this.sidebar.spaceUserListComponent.render()}});l(this,"handleCreateChannel",e=>{const{space_uuid:t,channel:s}=e.data,n=this.data.spaces.find(a=>a.uuid===t);if(!n)return;n.channels.push(s);const r=this.sidebar.spaceComponents.find(a=>a.space.uuid===t);r&&r.render(),this.openDashModal({type:"space-settings",data:{space:n,user:this.data.user}})});l(this,"handleCreateChannelUpdate",e=>{const{space_uuid:t,channel:s}=e.data,n=this.data.spaces.find(c=>c.uuid===t);if(!n||n.channels.some(c=>c.uuid===s.uuid))return;n.channels.push(s);const a=this.sidebar.spaceComponents.find(c=>c.space.uuid===t);a&&a.render()});l(this,"handleDeleteChannel",e=>{const{uuid:t,space_uuid:s}=e.data,n=this.data.spaces.find(c=>c.uuid===s);if(!n)return;const r=n.channels.findIndex(c=>c.uuid===t);if(r===-1)return;n.channels.splice(r,1);const a=this.sidebar.spaceComponents.find(c=>c.space.uuid===s);a&&a.render(),this.openDashModal({type:"space-settings",data:{space:n,user:this.data.user}}),this.mainContent.currentChannelUUID===t&&(this.mainContent.currentChannelUUID=null,this.mainContent.chatApp=null,this.mainContent.render())});l(this,"handleDeleteChannelUpdate",e=>{const{uuid:t,space_uuid:s}=e.data,n=this.data.spaces.find(c=>c.uuid===s);if(!n)return;const r=n.channels.findIndex(c=>c.uuid===t);if(r===-1)return;n.channels.splice(r,1);const a=this.sidebar.spaceComponents.find(c=>c.space.uuid===s);a&&a.render(),this.mainContent.currentChannelUUID===t&&(this.mainContent.currentChannelUUID=null,this.mainContent.chatApp=null,this.mainContent.render())});l(this,"renderChatAppMessage",e=>{this.mainContent.chatApp&&(this.mainContent.chatApp.chatBoxComponent.chatBoxMessagesComponent.appendNewMessage(e.data),e.data.username===this.data.user.username?this.mainContent.chatApp.chatBoxComponent.chatBoxMessagesComponent.scrollDown():this.mainContent.chatApp.chatBoxComponent.chatBoxMessagesComponent.isScrolledToBottom()&&this.mainContent.chatApp.chatBoxComponent.chatBoxMessagesComponent.scrollDown())});l(this,"handleIncomingMessages",e=>{if(e.data.messages&&this.mainContent.chatApp&&this.mainContent.chatApp.chatBoxComponent.channelUUID===e.data.channel_uuid){const t=this.mainContent.chatApp.chatBoxComponent.chatBoxMessagesComponent,s=t.domComponent,n=s.scrollHeight,r=s.scrollTop;t.hasMoreMessages=e.data.has_more_messages,t.isLoading=!1,t.chatBoxMessages=[...e.data.messages,...t.chatBoxMessages],t.render();const a=s.scrollHeight;s.scrollTop=a-n+r}});l(this,"handleAllowVoiceUpdate",e=>{const{uuid:t,space_uuid:s,allow:n}=e.data,r=this.data.spaces.find(c=>c.uuid===s);if(!r)return;const a=r.channels.find(c=>c.uuid===t);a&&(a.allow_voice=n)});this.domComponent=i("div",{class:"dashboard-container"}),this.returnToHostList=e.returnToHostList,this.data=null,this.sidebar=null,this.dashModal=null,this.mainContent=null,this.currentSpaceUUID=null,this.socketConn=null}render(){this.domComponent.innerHTML="",this.domComponent.append(this.sidebar.domComponent,this.mainContent.domComponent,U.domComponent,this.dashModal.domComponent)}}class ct{constructor(){l(this,"returnToHostList",async()=>{localStorage.removeItem("hostUUID"),await w.leaveVoice(),this.dashboard.socketConn.hardClose(),this.dashboard.innerHTML="",this.dashboard=null,this.render({type:"host_form"})});l(this,"render",e=>{switch(this.domComponent.innerHTML="",e.type){case"dash":this.dashboard=new rt({returnToHostList:this.returnToHostList}),this.domComponent.append(this.dashboard.domComponent),this.dashboard.initialize();break;case"host_form":this.domComponent.append(this.hostForm.domComponent),this.hostForm.render({type:"known"});break;default:this.domComponent.append(this.hostForm.domComponent),this.hostForm.render({type:"known"})}});m.greet("Hello Parch").then(e=>console.log(e)),this.domComponent=document.getElementById("app"),this.hostForm=new lt(this),this.render({type:"host_form"})}}class lt{constructor(e){l(this,"renderHostList",e=>!e||!e.hosts||!e.hosts.length?[i("div",{},"...No Hosts")]:e.hosts.map(s=>{const n=s.online==1;return i("div",{class:"host-item"},[i("div",{style:"display: flex; align-items: baseline"},[i("span",{class:n?"host-online-span":"host-offline-span"}),i("div",{class:"host-item-name"},`${s.name} `)]),i("button",{class:"btn-small btn-red"},"Remove",{type:"click",event:r=>{r.stopPropagation(),m.confirm("Are you sure you want to remove this host?").then(a=>{a&&(m.removeHost(s.uuid),r.target.parentElement.remove())})}})],{type:"click",event:()=>{n?(localStorage.setItem("hostUUID",s.uuid),this.app.render({type:"dash"})):m.alert("Host is not online")}})}));l(this,"renderKnownHosts",async()=>{const t=(await m.getHosts()).map(n=>n.uuid);let s=[];try{s=await(await fetch(`${E}/api/hosts_by_uuids`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({uuids:t})})).json()}catch(n){console.log(n),m.alert("Failed to connect to relay server")}this.domComponent.append(i("h2",{},"Select From Known Hosts"),i("br"),i("button",{},"Refresh",{type:"click",event:()=>{this.render({type:"known"})}}),i("br"),i("div",{class:"host-list-index"},[...this.renderHostList(s)]),i("br"),i("div",{},"Or"),i("br"),i("button",{class:""},"Add New Host",{type:"click",event:()=>{this.render({type:"new"})}}))});l(this,"renderNewHostForm",()=>{this.domComponent.append(i("h2",{},"Enter Host Key"),i("form",{id:"hostForm",onsubmit:this.handleSubmit},[i("fieldset",{},[i("legend",{},"New Host"),i("div",{class:"input-container"},[i("label",{for:"host-key"},"Host Key"),i("input",{type:"text",id:"hostKey",name:"hostKey",required:!0})]),i("br"),i("button",{type:"submit"},"Continue")])],{type:"submit",event:e=>{e.preventDefault();const t=this.domComponent.querySelector("#hostKey").value;if(!t)return!1;m.verifyHostKey(t).then(s=>{this.render({type:"known"})}).catch(s=>{m.alert("Invalid host key"),console.error(s)})}}),i("br"),i("button",{},"Return To List",{type:"click",event:()=>{this.render({type:"known"})}}))});l(this,"render",e=>{switch(this.domComponent.innerHTML="",e.type){case"known":this.renderKnownHosts();break;case"new":this.renderNewHostForm();break;default:this.renderKnownHosts()}});this.app=e,this.domComponent=i("div",{class:"host-form-container"})}}new ct;
