<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Reset Password - Parch Calls</title>
    <link rel="icon" type="image/webp" href="/static/parchclient_icon.webp" />
    <link rel="stylesheet" href="/static/parch-core.css" />
    <style>
        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            background: linear-gradient(145deg, var(--parch-dark) 0%, var(--parch-second-dark) 40%, var(--parch-black) 100%);
            color: var(--parch-white);
            letter-spacing: 0.5px;
            font-family: Georgia, Cambria, "Times New Roman", Times, serif;
        }

        .card {
            width: min(92vw, 420px);
            padding: 24px;
            border-radius: 12px;
            border: 1px solid rgba(89, 96, 117, 0.35);
            background: rgba(25, 29, 37, 0.85);
            box-shadow: 0 20px 35px rgba(0, 0, 0, 0.35);
        }

        h1 {
            margin: 0 0 10px 0;
            color: var(--parch-bright-white);
            font-size: 1.6rem;
        }

        p {
            margin: 0 0 16px 0;
            color: var(--parch-gray);
            font-size: 0.92rem;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.84rem;
            color: var(--parch-accent-blue);
        }

        input {
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid rgba(89, 96, 117, 0.55);
            background: rgba(19, 20, 24, 0.75);
            color: var(--parch-bright-white);
        }

        button {
            width: 100%;
            margin-top: 4px;
            padding: 11px 14px;
            border: 0;
            border-radius: 8px;
            cursor: pointer;
            background: var(--parch-light-blue);
            color: var(--parch-bright-white);
            font-weight: 600;
            letter-spacing: 0.4px;
        }

        .error {
            color: var(--parch-light-red);
            font-size: 0.85rem;
            margin-top: 8px;
        }

        .success {
            color: var(--parch-green);
            font-size: 0.88rem;
            margin-top: 10px;
        }

        .back-link {
            display: inline-block;
            margin-top: 14px;
            color: var(--parch-accent-blue);
            text-decoration: none;
        }
    </style>
</head>
<body>
    <main class="card">
        <h1>Reset Password</h1>
        <p>Set a new password for your Parch Calls account.</p>
        <form id="resetForm">
            <label for="newPassword">New password</label>
            <input id="newPassword" type="password" minlength="8" required placeholder="At least 8 characters" />

            <label for="confirmPassword">Confirm password</label>
            <input id="confirmPassword" type="password" minlength="8" required placeholder="Re-enter password" />

            <button type="submit">Update Password</button>
            <div id="errorMsg" class="error" hidden></div>
            <div id="successMsg" class="success" hidden></div>
        </form>
        <a class="back-link" href="/call?auth=signin">Back to sign in</a>
    </main>

    <script>
        const params = new URLSearchParams(window.location.search);
        const token = params.get('token');
        const form = document.getElementById('resetForm');
        const errorMsg = document.getElementById('errorMsg');
        const successMsg = document.getElementById('successMsg');

        function showError(message) {
            errorMsg.textContent = message;
            errorMsg.hidden = false;
            successMsg.hidden = true;
        }

        function showSuccess(message) {
            successMsg.textContent = message;
            successMsg.hidden = false;
            errorMsg.hidden = true;
        }

        if (!token) {
            showError('This reset link is invalid. Request a new one from Sign In.');
        }

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            errorMsg.hidden = true;
            successMsg.hidden = true;

            if (!token) return;

            const password = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;

            if (password.length < 8) {
                showError('Password must be at least 8 characters.');
                return;
            }
            if (password !== confirm) {
                showError('Passwords do not match.');
                return;
            }

            try {
                const res = await fetch('/call/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, password }),
                });
                const data = await res.json();
                if (!res.ok) {
                    showError(data.error || 'Reset failed.');
                    return;
                }

                showSuccess('Password updated. Redirecting to sign in...');
                setTimeout(() => {
                    window.location.href = '/call?auth=signin';
                }, 1200);
            } catch (err) {
                showError('Network error. Please try again.');
            }
        });
    </script>
</body>
</html>
